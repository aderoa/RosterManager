<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NBA Injury Report</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

:root {
  --bg: #0a0a0c;
  --surface: #141418;
  --surface2: #1c1c22;
  --border: #2a2a32;
  --text: #e8e8ec;
  --text2: #8a8a96;
  --accent: #3b82f6;
  --out: #ef4444;
  --left-game: #f43f5e;
  --doubtful: #f97316;
  --questionable: #eab308;
  --probable: #22c55e;
  --available: #10b981;
  --modified-bg: rgba(59,130,246,0.06);
  --modified-border: rgba(59,130,246,0.25);
}

* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

/* ============ ADMIN VIEW ============ */
.admin-container { max-width:1100px; margin:0 auto; padding:16px 20px 80px; }

.admin-header {
  display:flex; align-items:center; gap:16px; padding:20px 0 16px;
  border-bottom:1px solid var(--border); margin-bottom:16px;
}
.admin-header h1 { font-size:20px; font-weight:700; letter-spacing:-0.02em; }
.admin-header .subtitle { color:var(--text2); font-size:13px; margin-left:auto; }

/* Sticky toolbar */
.admin-toolbar {
  position:sticky; top:0; z-index:100; background:var(--bg);
  border-bottom:1px solid var(--border);
  padding:10px 0; margin-bottom:16px;
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
}
.admin-toolbar button {
  font-family:inherit; font-size:12px; font-weight:600;
  padding:7px 14px; border-radius:6px; border:1px solid var(--border);
  background:var(--surface); color:var(--text); cursor:pointer;
  transition:all 0.15s;
}
.admin-toolbar button:hover { background:var(--surface2); border-color:#444; }
.admin-toolbar button.primary { background:var(--accent); border-color:var(--accent); color:#fff; }
.admin-toolbar button.primary:hover { background:#2563eb; }
.admin-toolbar button.success { background:#059669!important; border-color:#059669!important; color:#fff!important; }
.admin-toolbar .spacer { flex:1; }
.admin-toolbar .badge {
  font-family:'JetBrains Mono',monospace; font-size:11px; font-weight:500;
  padding:4px 10px; border-radius:99px; background:var(--surface2); color:var(--text2);
}
.admin-toolbar .badge.has-changes { background:rgba(59,130,246,0.15); color:var(--accent); }

/* Search / filter */
.filter-bar {
  display:flex; gap:8px; margin-bottom:16px; align-items:center;
}
.filter-bar input {
  font-family:inherit; font-size:13px; padding:8px 12px; border-radius:6px;
  border:1px solid var(--border); background:var(--surface); color:var(--text);
  flex:1; max-width:320px; outline:none;
}
.filter-bar input:focus { border-color:var(--accent); }
.filter-bar .filter-btn {
  font-family:inherit; font-size:12px; font-weight:600;
  padding:7px 12px; border-radius:6px; border:1px solid var(--border);
  background:var(--surface); color:var(--text2); cursor:pointer; transition:all 0.15s;
}
.filter-bar .filter-btn:hover { color:var(--text); border-color:#444; }
.filter-bar .filter-btn.active { background:var(--accent); border-color:var(--accent); color:#fff; }

/* Team sections */
.team-section { margin-bottom:8px; }
.team-header {
  display:flex; align-items:center; gap:10px; padding:10px 12px;
  background:var(--surface); border:1px solid var(--border); border-radius:8px;
  cursor:pointer; user-select:none; transition:all 0.15s;
}
.team-header:hover { background:var(--surface2); }
.team-header img { width:28px; height:28px; }
.team-header .team-name { font-size:14px; font-weight:600; }
.team-header .team-count { font-size:12px; color:var(--text2); margin-left:auto; }
.team-header .team-injured {
  font-size:11px; font-weight:600; padding:2px 8px; border-radius:99px;
  background:rgba(239,68,68,0.12); color:var(--out);
}
.team-header .team-injured.none { display:none; }
.team-header .chevron {
  color:var(--text2); font-size:14px; transition:transform 0.2s;
  margin-left:8px;
}
.team-section.collapsed .chevron { transform:rotate(-90deg); }
.team-section.collapsed .team-players { display:none; }

.team-players { border:1px solid var(--border); border-top:none; border-radius:0 0 8px 8px; overflow:hidden; }

/* Player row */
.player-row {
  display:grid;
  grid-template-columns: 1fr 90px 130px 1fr 110px;
  gap:8px; align-items:center;
  padding:6px 12px; border-bottom:1px solid var(--border);
  font-size:13px; transition:background 0.15s;
}
.player-row:last-child { border-bottom:none; }
.player-row:hover { background:rgba(255,255,255,0.02); }
.player-row.modified { background:var(--modified-bg); border-color:var(--modified-border); }

.player-name { font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.player-salary { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--text2); text-align:right; }

.player-row select {
  font-family:inherit; font-size:12px; font-weight:600; padding:4px 6px;
  border-radius:4px; border:1px solid var(--border); background:var(--surface);
  color:var(--text); cursor:pointer; outline:none; width:100%;
}
.player-row select:focus { border-color:var(--accent); }
.player-row select.s-out { color:var(--out); }
.player-row select.s-left-game { color:var(--left-game); }
.player-row select.s-doubtful { color:var(--doubtful); }
.player-row select.s-questionable { color:var(--questionable); }
.player-row select.s-probable { color:var(--probable); }
.player-row select.s-available { color:var(--available); }

.player-row input[type="text"] {
  font-family:inherit; font-size:12px; padding:4px 6px;
  border-radius:4px; border:1px solid var(--border); background:var(--surface);
  color:var(--text); outline:none; width:100%;
}
.player-row input[type="text"]:focus { border-color:var(--accent); }
.player-row input[type="text"].inactive { color:var(--text2); border-color:transparent; background:transparent; }

.player-row input[type="date"] {
  font-family:'JetBrains Mono',monospace; font-size:11px; padding:4px 4px;
  border-radius:4px; border:1px solid var(--border); background:var(--surface);
  color:var(--text); outline:none; width:100%;
  color-scheme:dark;
}
.player-row input[type="date"]:focus { border-color:var(--accent); }
.player-row input[type="date"].inactive { color:var(--text2); border-color:transparent; background:transparent; }

/* Column headers */
.col-headers {
  display:grid;
  grid-template-columns: 1fr 90px 130px 1fr 110px;
  gap:8px; padding:8px 12px;
  font-size:11px; font-weight:600; color:var(--text2); text-transform:uppercase; letter-spacing:0.05em;
  background:var(--surface); border-bottom:1px solid var(--border);
  position:sticky; top:50px; z-index:50;
}
.col-headers span:nth-child(2) { text-align:right; }

/* Loading state */
.loading-state {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  padding:80px 0; color:var(--text2);
}
.loading-spinner {
  width:32px; height:32px; border:3px solid var(--border); border-top-color:var(--accent);
  border-radius:50%; animation:spin 0.8s linear infinite; margin-bottom:16px;
}
@keyframes spin { to { transform:rotate(360deg); } }

/* ============ REPORT VIEW (non-admin) ============ */
.report-container { max-width:900px; margin:0 auto; padding:16px 20px 80px; }

.report-toolbar {
  display:flex; gap:8px; flex-wrap:wrap; padding:12px 0;
  border-bottom:1px solid var(--border); margin-bottom:16px;
}
.report-toolbar button {
  font-family:inherit; font-size:12px; font-weight:600;
  padding:7px 14px; border-radius:6px; border:1px solid var(--border);
  background:var(--surface); color:var(--text); cursor:pointer; transition:all 0.15s;
}
.report-toolbar button:hover { background:var(--surface2); }
.report-toolbar button.success { background:#059669!important; border-color:#059669!important; color:#fff!important; }

.tab-bar { display:flex; gap:4px; margin-bottom:16px; }
.tab-bar button {
  font-family:inherit; font-size:12px; font-weight:600;
  padding:7px 14px; border-radius:6px; border:1px solid transparent;
  background:transparent; color:var(--text2); cursor:pointer; transition:all 0.15s;
}
.tab-bar button:hover { color:var(--text); }
.tab-bar button.active { background:var(--surface); color:var(--text); border-color:var(--border); }

.preview { padding:8px 0; }
.preview table { font-size:13px; }

.error-msg { padding:40px; text-align:center; color:var(--out); }

/* Purge button */
.btn-purge {
  font-family:inherit; font-size:12px; font-weight:600;
  padding:7px 14px; border-radius:6px; border:1px solid rgba(239,68,68,0.3);
  background:rgba(239,68,68,0.08); color:var(--out); cursor:pointer; transition:all 0.15s;
}
.btn-purge:hover { background:rgba(239,68,68,0.15); }
</style>
</head>
<body>

<script>
// ===== CONFIG =====
const SHEET_ID = '2PACX-1vQ-TNS1Zxbcq2Altxh0-yY0LFEPvOXlwI8DjD8FdbSypf_sSWc3Xi6F88DwiOdSmR0FmXLzNicgCDwL';
const INJ_GID = '306285159';
const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=${INJ_GID}&single=true&output=csv`;
const ROSTER_SHEET_ID = '2PACX-1vSg6im6IYB6HXMGzQbmmBnLw9SfQLzxCSo8OfChxlJLhsB6BBCO0wPF_TMch0YgAbtFqYkwDWrsxRe7';
const ROSTER_GID = '0';
const ROSTER_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${ROSTER_SHEET_ID}/pub?gid=${ROSTER_GID}&single=true&output=csv`;
const JSON_URL = 'injuries.json';

const NBA_TEAMS = [
  'Atlanta','Boston','Brooklyn','Charlotte','Chicago','Cleveland',
  'Dallas','Denver','Detroit','Golden State','Houston','Indiana',
  'LA Clippers','LA Lakers','Memphis','Miami','Milwaukee','Minnesota',
  'New Orleans','New York','Oklahoma City','Orlando','Philadelphia','Phoenix',
  'Portland','Sacramento','San Antonio','Toronto','Utah','Washington'
];
const TEAM_IDS = {
  'Atlanta':1610612737,'Boston':1610612738,'Brooklyn':1610612751,
  'Charlotte':1610612766,'Chicago':1610612741,'Cleveland':1610612739,
  'Dallas':1610612742,'Denver':1610612743,'Detroit':1610612765,
  'Golden State':1610612744,'Houston':1610612745,'Indiana':1610612754,
  'LA Clippers':1610612746,'LA Lakers':1610612747,'Memphis':1610612763,
  'Miami':1610612748,'Milwaukee':1610612749,'Minnesota':1610612750,
  'New Orleans':1610612740,'New York':1610612752,'Oklahoma City':1610612760,
  'Orlando':1610612753,'Philadelphia':1610612755,'Phoenix':1610612756,
  'Portland':1610612757,'Sacramento':1610612758,'San Antonio':1610612759,
  'Toronto':1610612761,'Utah':1610612762,'Washington':1610612764
};
const TEAM_ABBREV = {
  'Atlanta':'ATL','Boston':'BOS','Brooklyn':'BKN','Charlotte':'CHA','Chicago':'CHI','Cleveland':'CLE',
  'Dallas':'DAL','Denver':'DEN','Detroit':'DET','Golden State':'GSW','Houston':'HOU','Indiana':'IND',
  'LA Clippers':'LAC','LA Lakers':'LAL','Memphis':'MEM','Miami':'MIA','Milwaukee':'MIL','Minnesota':'MIN',
  'New Orleans':'NOP','New York':'NYK','Oklahoma City':'OKC','Orlando':'ORL','Philadelphia':'PHI','Phoenix':'PHX',
  'Portland':'POR','Sacramento':'SAC','San Antonio':'SAS','Toronto':'TOR','Utah':'UTA','Washington':'WAS'
};
const STATUSES = ['Available','Probable','Questionable','Doubtful','Left Game','Out'];
const STATUS_GRAVITY = { 'Out':0,'Left Game':1,'Doubtful':2,'Questionable':3,'Probable':4,'Available':5 };

function teamLogo(t) { const id=TEAM_IDS[t]; return id ? `https://cdn.nba.com/logos/nba/${id}/primary/L/logo.svg` : ''; }
function logoImg(t) { const u=teamLogo(t); return u ? `<img src="${u}" width="28" height="28" style="vertical-align:middle;">` : ''; }
function fmtSal(n) { if(n>=1e6) return '$'+(n/1e6).toFixed(1)+'M'; if(n>=1e3) return '$'+(n/1e3).toFixed(0)+'K'; return '$'+n.toLocaleString(); }
function fmtSalFull(n) { return '$'+n.toLocaleString(); }
function fmtDate(iso) { const d=new Date(iso+'T00:00:00'); const m=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return m[d.getMonth()]+' '+d.getDate(); }
function sColor(s) { return {Out:'#ef4444','Left Game':'#f43f5e',Doubtful:'#f97316',Questionable:'#eab308',Probable:'#22c55e',Available:'#10b981'}[s]||'#888'; }
function sSpan(s) { return `<span style="color:${sColor(s)};font-weight:700;">${s}</span>`; }
function statusClass(s) { return 's-'+s.toLowerCase().replace(/\s+/g,'-'); }
function lastName(name) { const parts = name.trim().split(/\s+/); return parts.length > 1 ? parts[parts.length-1] : name; }
function todayISO() { return new Date().toLocaleDateString('en-CA', { timeZone: 'America/Los_Angeles' }); }

function parseCSV(text) {
  const rows=[]; let cur='',inQ=false,row=[];
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(c==='"'){if(inQ&&text[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}
    else if(c===','&&!inQ){row.push(cur);cur='';}
    else if((c==='\n'||c==='\r')&&!inQ){if(c==='\r'&&text[i+1]==='\n')i++;row.push(cur);cur='';rows.push(row);row=[];}
    else cur+=c;
  }
  if(cur||row.length){row.push(cur);rows.push(row);}
  return rows;
}

// ===== SHARED STATE =====
let roster = {};      // player -> {team, salary}
let teamSalaries = {}; // team -> total salary
let daysMap = {};     // player -> days since last game
let jsonEntries = []; // raw injuries.json
let latestStatus = {}; // player -> {status, injury, date}
let modifications = {}; // player -> {status, injury, date} (admin edits)

// ===== DATA LOADING =====
async function loadData() {
  const [csvR, rosterR, jsonR] = await Promise.all([
    fetch(CSV_URL),
    fetch(ROSTER_CSV_URL),
    fetch(JSON_URL + '?t=' + Date.now())
  ]);
  if (!csvR.ok) throw new Error('Injuries CSV fetch failed: ' + csvR.status);
  if (!rosterR.ok) throw new Error('Roster CSV fetch failed: ' + rosterR.status);
  if (!jsonR.ok) throw new Error('injuries.json fetch failed: ' + jsonR.status);

  const csvText = await csvR.text();
  const rosterText = await rosterR.text();
  const injuries = await jsonR.json();
  const injRows = parseCSV(csvText);
  const rosterRows = parseCSV(rosterText);

  // Parse roster by header names (same source as Depth Charts)
  roster = {}; teamSalaries = {};
  if (rosterRows.length > 1) {
    const header = rosterRows[0];
    const col = n => header.findIndex(h => h.toUpperCase().trim() === n.toUpperCase());
    const playerIdx = col('PLAYER'), teamIdx = col('TEAM'), salaryIdx = col('2026');
    if (playerIdx >= 0 && teamIdx >= 0) {
      for (let i = 1; i < rosterRows.length; i++) {
        const row = rosterRows[i];
        const player = (row[playerIdx] || '').trim();
        const team = (row[teamIdx] || '').trim();
        const salRaw = salaryIdx >= 0 ? (row[salaryIdx] || '0').replace(/[$,]/g, '') : '0';
        const salary = parseInt(salRaw) || 0;
        if (player && team) {
          roster[player] = { team, salary };
          teamSalaries[team] = (teamSalaries[team] || 0) + salary;
        }
      }
    }
  }

  // Days since last game: cols 71(player), 73(days) from Injuries CSV
  daysMap = {};
  for (const r of injRows) {
    if (r.length > 73) {
      const p = (r[71] || '').trim(), d = (r[73] || '').trim();
      if (p && /^\d+$/.test(d)) daysMap[p] = parseInt(d);
    }
  }

  // Process JSON entries
  jsonEntries = injuries;
  latestStatus = {};
  const prev = {};
  for (const e of injuries) {
    if (latestStatus[e.player]) prev[e.player] = latestStatus[e.player];
    latestStatus[e.player] = { status: e.status, injury: e.injury, date: e.date };
  }

  return { prev };
}

// ===== IS ADMIN? =====
const isAdmin = new URLSearchParams(window.location.search).has('admin');

if (isAdmin) {
  document.body.innerHTML = `
    <div class="admin-container">
      <div class="admin-header">
        <h1>üè• Injury Report ‚Äî Admin</h1>
        <span class="subtitle" id="lastUpdate"></span>
      </div>
      <div class="admin-toolbar" id="toolbar">
        <button class="primary" onclick="copyPrestoHTML(this)">üìã Copy Presto HTML</button>
        <button onclick="copyJSON(this)">üìã Copy Updated JSON</button>
        <button onclick="window.open('https://github.com/aderoa/Injuries/edit/main/injuries.json','_blank')">‚úèÔ∏è Open on GitHub</button>
        <button class="btn-purge" onclick="purgeAvailable(this)">üßπ Purge Available</button>
        <button id="undoBtn" style="display:none;" onclick="undoPurge(this)">‚Ü© Undo Purge</button>
        <button onclick="resetAll()">üóë Reset All</button>
        <span class="spacer"></span>
        <span class="badge" id="changesBadge">0 changes</span>
      </div>
      <div class="filter-bar">
        <input type="text" id="searchInput" placeholder="Search player or team..." oninput="filterPlayers()">
        <button class="filter-btn" onclick="toggleFilter('modified',this)" title="Show only modified">‚úé Modified</button>
        <button class="filter-btn" onclick="toggleFilter('injured',this)" title="Show only injured">üî¥ Injured</button>
        <button class="filter-btn" onclick="toggleFilter('available',this)" title="Show only available">üü¢ Available</button>
      </div>
      <div class="col-headers">
        <span>Player</span><span>Salary</span><span>Status</span><span>Injury</span><span>Date</span>
      </div>
      <div id="rosterArea"><div class="loading-state"><div class="loading-spinner"></div><p>Loading roster...</p></div></div>
    </div>
  `;
  initAdmin();
} else {
  document.body.innerHTML = `
    <div class="report-container">
      <div class="admin-header">
        <h1>üè• NBA Injury Report</h1>
      </div>
      <div class="report-toolbar" id="reportToolbar">
        <button onclick="copyAll(this)">üìã Copy Full Report</button>
        <button onclick="copySection(0,this)">üìã Today's Updates</button>
        <button onclick="copySection(1,this)">üìã Full Report</button>
        <button onclick="copySection(2,this)">üìã Salary Per Team</button>
        <button onclick="copySection(3,this)">üìã Highest-Paid</button>
        <button onclick="refreshReport(this)">üîÑ Refresh</button>
        <button class="btn-purge" onclick="togglePurge(this)">üßπ Purge Available</button>
      </div>
      <div class="tab-bar" id="tabBar">
        <button onclick="showTab(0,this)">Today's Updates</button>
        <button onclick="showTab(1,this)">Full Report</button>
        <button onclick="showTab(2,this)">Salary Per Team</button>
        <button onclick="showTab(3,this)">Highest-Paid</button>
        <button class="active" onclick="showTab(-1,this)">All</button>
      </div>
      <div id="loading" class="loading-state"><div class="loading-spinner"></div><p>Loading injury data...</p></div>
      <div id="preview" class="preview" style="display:none;"></div>
      <div id="error" class="error-msg" style="display:none;"></div>
    </div>
  `;
  initReport();
}

// ==========================================
// ADMIN MODE
// ==========================================
let activeFilter = null;

async function initAdmin() {
  try {
    // Load saved modifications from localStorage
    try {
      const saved = localStorage.getItem('injuries_modifications');
      if (saved) { modifications = JSON.parse(saved); }
    } catch(e) {}
    await loadData();
    document.getElementById('lastUpdate').textContent = `${Object.keys(roster).length} players loaded`;
    renderRoster();
    updateBadge();
  } catch(e) {
    document.getElementById('rosterArea').innerHTML = `<div class="error-msg">Error: ${e.message}</div>`;
  }
}

function renderRoster() {
  const area = document.getElementById('rosterArea');
  let html = '';

  for (const team of NBA_TEAMS) {
    const players = Object.entries(roster)
      .filter(([_,v]) => v.team === team)
      .sort((a,b) => lastName(a[0]).localeCompare(lastName(b[0])));
    if (!players.length) continue;

    const injuredCount = players.filter(([name]) => {
      const mod = modifications[name];
      const cur = mod || latestStatus[name];
      return cur && cur.status !== 'Available';
    }).length;

    html += `<div class="team-section" data-team="${team}" id="team-${team.replace(/\s/g,'')}">`;
    html += `<div class="team-header" onclick="toggleTeam(this)">`;
    html += `<img src="${teamLogo(team)}" alt="${team}">`;
    html += `<span class="team-name">${team}</span>`;
    html += `<span class="team-count">${players.length} players</span>`;
    html += `<span class="team-injured ${injuredCount?'':'none'}">${injuredCount} injured</span>`;
    html += `<span class="chevron">‚ñº</span>`;
    html += `</div>`;
    html += `<div class="team-players">`;

    for (const [name, info] of players) {
      const cur = modifications[name] || latestStatus[name] || { status:'Available', injury:'', date:'' };
      const isModified = !!modifications[name];
      const isAvail = cur.status === 'Available';

      html += `<div class="player-row ${isModified?'modified':''}" data-player="${name}" data-team="${team}">`;
      html += `<span class="player-name" title="${name}">${name}</span>`;
      html += `<span class="player-salary">${fmtSal(info.salary)}</span>`;

      // Status select
      html += `<select class="${statusClass(cur.status)}" onchange="onStatusChange('${name.replace(/'/g,"\\'")}',this)">`;
      for (const s of STATUSES) {
        html += `<option value="${s}" ${s===cur.status?'selected':''}>${s}</option>`;
      }
      html += `</select>`;

      // Injury input
      html += `<input type="text" value="${cur.injury||''}" class="${isAvail?'inactive':''}" placeholder="${isAvail?'‚Äî':'Injury reason'}" onchange="onInjuryChange('${name.replace(/'/g,"\\'")}',this)" onfocus="this.classList.remove('inactive')">`;

      // Date input
      html += `<input type="date" value="${cur.date||''}" class="${isAvail?'inactive':''}" onchange="onDateChange('${name.replace(/'/g,"\\'")}',this)">`;

      html += `</div>`;
    }

    html += `</div></div>`;
  }

  area.innerHTML = html;
}

function toggleTeam(el) {
  el.closest('.team-section').classList.toggle('collapsed');
}

function getEffectiveStatus(name) {
  return modifications[name] || latestStatus[name] || { status:'Available', injury:'', date:'' };
}

function onStatusChange(name, sel) {
  const row = sel.closest('.player-row');
  const injInput = row.querySelector('input[type="text"]');
  const dateInput = row.querySelector('input[type="date"]');
  const newStatus = sel.value;

  // Determine the original status from JSON
  const original = latestStatus[name] || { status:'Available', injury:'', date:'' };

  // Update select color class
  sel.className = statusClass(newStatus);

  if (newStatus === original.status && !injInput.value && !dateInput.value) {
    // Reverted to original ‚Äî remove modification
    delete modifications[name];
    row.classList.remove('modified');
    injInput.className = newStatus==='Available' ? 'inactive' : '';
    dateInput.className = newStatus==='Available' ? 'inactive' : '';
  } else {
    // Always set date to today on status change
    dateInput.value = todayISO();
    // Carry forward injury from JSON if available and field empty
    if (!injInput.value && original.injury && newStatus !== 'Available') {
      injInput.value = original.injury;
    }

    modifications[name] = {
      status: newStatus,
      injury: injInput.value,
      date: dateInput.value
    };
    row.classList.add('modified');
    injInput.classList.remove('inactive');
    dateInput.classList.remove('inactive');
  }

  updateBadge();
  updateTeamInjuredCounts();
}

function onInjuryChange(name, inp) {
  const row = inp.closest('.player-row');
  const sel = row.querySelector('select');
  const dateInput = row.querySelector('input[type="date"]');
  const original = latestStatus[name] || { status:'Available', injury:'', date:'' };

  if (sel.value === original.status && !inp.value && !dateInput.value) {
    delete modifications[name];
    row.classList.remove('modified');
  } else {
    if (!dateInput.value) dateInput.value = todayISO();
    modifications[name] = { status: sel.value, injury: inp.value, date: dateInput.value };
    row.classList.add('modified');
  }
  updateBadge();
}

function onDateChange(name, inp) {
  const row = inp.closest('.player-row');
  const sel = row.querySelector('select');
  const injInput = row.querySelector('input[type="text"]');
  const original = latestStatus[name] || { status:'Available', injury:'', date:'' };

  if (sel.value === original.status && !injInput.value && !inp.value) {
    delete modifications[name];
    row.classList.remove('modified');
  } else {
    modifications[name] = { status: sel.value, injury: injInput.value, date: inp.value };
    row.classList.add('modified');
  }
  updateBadge();
}

function updateBadge() {
  const count = Object.keys(modifications).length;
  const badge = document.getElementById('changesBadge');
  badge.textContent = `${count} change${count!==1?'s':''}`;
  badge.className = count ? 'badge has-changes' : 'badge';
  // Auto-save to localStorage
  try { localStorage.setItem('injuries_modifications', JSON.stringify(modifications)); } catch(e) {}
}

function updateTeamInjuredCounts() {
  document.querySelectorAll('.team-section').forEach(sec => {
    const team = sec.dataset.team;
    const rows = sec.querySelectorAll('.player-row');
    let injured = 0;
    rows.forEach(r => {
      const sel = r.querySelector('select');
      if (sel && sel.value !== 'Available') injured++;
    });
    const badge = sec.querySelector('.team-injured');
    if (badge) {
      badge.textContent = `${injured} injured`;
      badge.classList.toggle('none', injured === 0);
    }
  });
}

function filterPlayers() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  document.querySelectorAll('.team-section').forEach(sec => {
    let anyVisible = false;
    sec.querySelectorAll('.player-row').forEach(row => {
      const name = row.dataset.player.toLowerCase();
      const team = row.dataset.team.toLowerCase();
      let show = !q || name.includes(q) || team.includes(q);

      // Apply active filter
      if (show && activeFilter === 'modified') show = row.classList.contains('modified');
      if (show && activeFilter === 'injured') {
        const sel = row.querySelector('select');
        show = sel && sel.value !== 'Available';
      }
      if (show && activeFilter === 'available') {
        const sel = row.querySelector('select');
        show = sel && sel.value === 'Available';
      }

      row.style.display = show ? '' : 'none';
      if (show) anyVisible = true;
    });
    sec.style.display = anyVisible ? '' : 'none';
    if (anyVisible) sec.classList.remove('collapsed');
  });
}

function toggleFilter(type, btn) {
  if (activeFilter === type) {
    activeFilter = null;
    btn.classList.remove('active');
  } else {
    activeFilter = type;
    document.querySelectorAll('.filter-bar .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  filterPlayers();
}

function resetAll() {
  if (Object.keys(modifications).length && !confirm('Reset all changes?')) return;
  modifications = {};
  prePurgeSnapshot = null;
  document.getElementById('undoBtn').style.display = 'none';
  try { localStorage.removeItem('injuries_modifications'); } catch(e) {}
  renderRoster();
  updateBadge();
}

let prePurgeSnapshot = null;

function purgeAvailable(btn) {
  // Save snapshot for undo
  prePurgeSnapshot = JSON.parse(JSON.stringify(modifications));

  // For every player in JSON whose latest effective status is "Available",
  // add a modification clearing their injury and date
  for (const [player, entry] of Object.entries(latestStatus)) {
    const effective = modifications[player] || entry;
    if (effective.status === 'Available' && (entry.injury || entry.date)) {
      modifications[player] = { status: 'Available', injury: '', date: '' };
    }
  }

  renderRoster();
  updateBadge();
  updateTeamInjuredCounts();

  document.getElementById('undoBtn').style.display = '';
  const orig = btn.textContent;
  btn.textContent = '‚úì Purged!'; btn.classList.add('active');
  setTimeout(() => { btn.textContent = orig; btn.classList.remove('active'); }, 2000);
}

function undoPurge(btn) {
  if (prePurgeSnapshot !== null) {
    modifications = prePurgeSnapshot;
    prePurgeSnapshot = null;
    renderRoster();
    updateBadge();
    updateTeamInjuredCounts();
  }
  btn.style.display = 'none';
}

// ===== JSON GENERATION =====
function buildMergedJSON() {
  // Start with original entries
  const merged = [...jsonEntries];

  // Append modifications as new entries
  for (const [player, mod] of Object.entries(modifications)) {
    merged.push({
      player,
      status: mod.status,
      injury: mod.injury || '',
      date: mod.date || todayISO()
    });
  }

  return merged;
}

function copyJSON(btn) {
  const merged = buildMergedJSON();
  const json = JSON.stringify(merged, null, 2);
  navigator.clipboard.writeText(json).then(() => {
    const orig = btn.textContent;
    btn.textContent = '‚úì Copied!'; btn.classList.add('success');
    setTimeout(() => { btn.textContent = orig; btn.classList.remove('success'); }, 2000);
  });
}

// ===== PRESTO HTML GENERATION (same 4 tables) =====
function buildPrestoHTML() {
  const merged = buildMergedJSON();
  const lat = {}, prv = {};
  for (const e of merged) {
    if (lat[e.player]) prv[e.player] = lat[e.player];
    lat[e.player] = e;
  }
  return buildPrestoTables(merged, lat, prv, false);
}

function buildPrestoTables(entries, lat, prv, usePurge) {
  const today = todayISO();

  // Shared styles: text-align on tbody inherits to all cells, avoiding per-cell repetition
  const TBL = 'style="border-collapse:collapse;font-family:Arial,sans-serif;font-size:14px;width:100%"';
  const TB = 'style="text-align:center"'; // on tbody ‚Äî inherited by all td/th
  const B = 'style="border:1px solid #eee;padding:4px"'; // per cell (minimum needed)
  const BH = 'style="border:1px solid #ccc;padding:4px"'; // header cells
  const H2 = 'style="font-size:22px;font-weight:700;margin-bottom:10px"';
  function logo(team) { const id=TEAM_IDS[team]; return id ? `<img src="https://cdn.nba.com/logos/nba/${id}/primary/L/logo.svg" width="28" height="28" style="vertical-align:middle">` : ''; }
  function r(i) { return i%2 ? ' style="background:#f9f9f9"' : ''; }

  // Table 1: Today's Updates
  const todayEntries = Object.entries(lat)
    .filter(([name,e]) => e.date === today && roster[name])
    .filter(([_,e]) => !usePurge || e.status !== 'Available')
    .map(([name,e]) => {
      const p = prv[name], rv = roster[name] || {};
      return { player:name, status:e.status, injury:e.injury, prevStatus:p?p.status:'Available', team:rv.team||'', salary:rv.salary||0 };
    }).sort((a,z) => a.team !== z.team ? a.team.localeCompare(z.team) : lastName(a.player).localeCompare(lastName(z.player)));

  let h1 = `<h2 ${H2}>Today's injury updates</h2><table ${TBL}><thead ${TB}><tr style="background:#f2f2f2"><th ${BH}></th><th ${BH}>PLAYER</th><th ${BH}>STATUS</th><th ${BH}>INJURY</th><th ${BH}>PREVIOUS STATUS</th><th ${BH}>SALARY</th></tr></thead><tbody ${TB}>`;
  let lt = '';
  if (!todayEntries.length) h1 += `<tr><td ${B} colspan="6">No updates today</td></tr>`;
  todayEntries.forEach((e, i) => {
    const lg = e.team !== lt ? logo(e.team) : ''; lt = e.team;
    h1 += `<tr${r(i)}><td ${B}>${lg}</td><td ${B}><b>${e.player}</b></td><td ${B}>${sSpan(e.status)}</td><td ${B}>${e.injury}</td><td ${B}>${e.prevStatus?sSpan(e.prevStatus):''}</td><td ${B}>${fmtSal(e.salary)}</td></tr>`;
  });
  h1 += '</tbody></table>';

  // Table 2: Full Report
  const allInjured = Object.entries(lat)
    .filter(([name,e]) => e.status !== 'Available' && roster[name])
    .map(([name,e]) => ({ player:name, ...e, team:(roster[name]||{}).team||'', salary:(roster[name]||{}).salary||0, days:daysMap[name]||0 }))
    .sort((a,z) => a.team !== z.team ? a.team.localeCompare(z.team) : lastName(a.player).localeCompare(lastName(z.player)));

  let h2 = `<h2 ${H2}>Full injury report</h2><table ${TBL}><thead ${TB}><tr style="background:#f2f2f2"><th ${BH}></th><th ${BH}>PLAYER</th><th ${BH}>SALARY</th><th ${BH}>STATUS</th><th ${BH}>INJURY</th><th ${BH}>DATE</th></tr></thead><tbody ${TB}>`;
  lt = '';
  allInjured.forEach((e, i) => {
    const lg = e.team !== lt ? logo(e.team) : ''; lt = e.team;
    h2 += `<tr${r(i)}><td ${B}>${lg}</td><td ${B}><b>${e.player}</b></td><td ${B}>${fmtSal(e.salary)}</td><td ${B}>${sSpan(e.status)}</td><td ${B}>${e.injury||''}</td><td ${B}>${e.date?fmtDate(e.date):''}</td></tr>`;
  });
  h2 += '</tbody></table>';

  // Table 3: Salary Per Team
  const teamInjSal = {};
  for (const e of allInjured) {
    if (e.status === 'Out' || e.status === 'Left Game' || e.status === 'Doubtful') {
      teamInjSal[e.team] = (teamInjSal[e.team]||0) + e.salary;
    }
  }
  let totalNBASal = 0, totalNBAInj = 0;
  for (const t of NBA_TEAMS) { totalNBASal += teamSalaries[t]||0; totalNBAInj += teamInjSal[t]||0; }

  const teamRows = NBA_TEAMS.map(t => ({
    team:t, injured:teamInjSal[t]||0, total:teamSalaries[t]||0,
    pct: teamSalaries[t] ? ((teamInjSal[t]||0)/teamSalaries[t]*100) : 0
  })).sort((a,z) => z.injured - a.injured);

  let h3 = `<h2 ${H2}>Injured salary per team</h2><table ${TBL}><thead ${TB}><tr style="background:#f2f2f2"><th ${BH}></th><th ${BH}>TEAM</th><th ${BH}>INJURED SALARY</th><th ${BH}>% SALARY</th></tr></thead><tbody ${TB}>`;
  teamRows.forEach((rv, i) => {
    h3 += `<tr${r(i)}><td ${B}>${logo(rv.team)}</td><td ${B}><b>${rv.team}</b></td><td ${B}>${fmtSalFull(rv.injured)}</td><td ${B}>${rv.pct.toFixed(2)}%</td></tr>`;
  });
  h3 += `<tr style="background:#222;color:#fff;font-weight:700"><td ${B}><img src="https://cdn.nba.com/logos/leagues/logo-nba.svg" width="28" height="28" style="vertical-align:middle"></td><td ${B}>NBA</td><td ${B}>${fmtSalFull(totalNBAInj)}</td><td ${B}>${totalNBASal?(totalNBAInj/totalNBASal*100).toFixed(2):'0.00'}%</td></tr>`;
  h3 += '</tbody></table>';

  // Table 4: Highest-Paid Injured
  const topPaid = [...allInjured].sort((a,z) => z.salary - a.salary).slice(0,25);
  let h4 = `<h2 ${H2}>Highest-paid injured players</h2><table ${TBL}><thead ${TB}><tr style="background:#f2f2f2"><th ${BH}></th><th ${BH}>PLAYER</th><th ${BH}>SALARY</th><th ${BH}>DAYS SINCE LAST GAME</th></tr></thead><tbody ${TB}>`;
  topPaid.forEach((e, i) => {
    h4 += `<tr${r(i)}><td ${B}>${logo(e.team)}</td><td ${B}><b>${e.player}</b></td><td ${B}>${fmtSalFull(e.salary)}</td><td ${B}>${e.days||''}</td></tr>`;
  });
  h4 += '</tbody></table>';

  return [h1, h2, h3, h4];
}

function copyPrestoHTML(btn) {
  const sections = buildPrestoHTML();
  const html = `<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">\n${sections.join('\n<br>\n')}\n</div>`;
  navigator.clipboard.writeText(html).then(() => {
    const orig = btn.textContent;
    btn.textContent = '‚úì Copied!'; btn.classList.add('success');
    setTimeout(() => { btn.textContent = orig; btn.classList.remove('success'); }, 2000);
  });
}

// ==========================================
// REPORT MODE (non-admin)
// ==========================================
let sectionsHTML = [];
let purgeActive = false;

async function initReport() {
  try {
    const { prev } = await loadData();
    buildReportSections(prev);
    document.getElementById('loading').style.display = 'none';
    document.getElementById('preview').style.display = 'block';
    showTab(-1, document.querySelector('.tab-bar button.active'));
  } catch(e) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('error').textContent = 'Error: ' + e.message;
  }
}

function buildReportSections(prev) {
  const lat = {};
  for (const e of jsonEntries) { lat[e.player] = e; }
  sectionsHTML = buildPrestoTables(jsonEntries, lat, prev, purgeActive);
}

function showTab(idx, btn) {
  document.querySelectorAll('.tab-bar button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('preview').innerHTML = idx === -1 ? sectionsHTML.join('<br>') : (sectionsHTML[idx] || '');
}

function copyToClipboard(html, btn) {
  const orig = btn.textContent;
  const w = `<div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">\n${html}\n</div>`;
  navigator.clipboard.writeText(w).then(() => {
    btn.textContent = '‚úì Copied!'; btn.classList.add('success');
    setTimeout(() => { btn.textContent = orig; btn.classList.remove('success'); }, 2000);
  });
}
function copyAll(btn) { copyToClipboard(sectionsHTML.join('\n<br>\n'), btn); }
function copySection(idx, btn) { if (sectionsHTML[idx]) copyToClipboard(sectionsHTML[idx], btn); }

async function refreshReport(btn) {
  const o = btn.textContent; btn.textContent = '‚è≥ Refreshing...'; btn.disabled = true;
  try {
    const { prev } = await loadData();
    buildReportSections(prev);
    showTab(-1, document.querySelector('.tab-bar button.active'));
  } catch(e) {}
  btn.textContent = '‚úì Updated!'; btn.classList.add('success');
  setTimeout(() => { btn.textContent = o; btn.classList.remove('success'); btn.disabled = false; }, 2000);
}

function togglePurge(btn) {
  purgeActive = !purgeActive;
  btn.classList.toggle('active', purgeActive);
  btn.style.background = purgeActive ? 'rgba(239,68,68,0.2)' : '';
  const prv = {};
  const lat = {};
  for (const e of jsonEntries) {
    if (lat[e.player]) prv[e.player] = lat[e.player];
    lat[e.player] = e;
  }
  buildReportSections(prv);
  showTab(-1, document.querySelector('.tab-bar button.active'));
}
</script>
</body>
</html>
