<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#3b82f6">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://hoopsmatic.com" crossorigin>
<link rel="dns-prefetch" href="https://hoopsmatic.com">
<title>Roster Manager ‚Äì HoopsMatic</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f5f5f7;--surface:#ffffff;--card:#ffffff;--border:#d1d1d6;
  --text:#1d1d1f;--muted:#6e6e73;--accent:#3b82f6;--accent2:#2563eb;
  --green:#34c759;--red:#ff453a;--orange:#b45309;--yellow:#f59e0b;--cyan:#0ea5e9;
  --team1:#3b82f6;--team2:#2563eb;--team1-dim:rgba(59,130,246,.1);--team2-dim:rgba(37,99,235,.1);
  --green-dim:rgba(52,199,89,.15);--red-dim:rgba(255,69,58,.15);--accent-dim:rgba(59,130,246,.15);
}
body{font-family:'DM Sans',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;max-width:100vw;line-height:1.5}
a{color:var(--accent);text-decoration:none}

/* Header */
.header{background:linear-gradient(135deg,var(--team1),var(--team2));padding:1rem 1.5rem;display:flex;align-items:center;gap:1rem;position:sticky;top:0;z-index:100;transition:background .4s}

/* === MOBILE: FORCE LANDSCAPE + AUTO-FIT === */
@media(max-width:1024px) and (orientation:portrait){
  html{transform:rotate(90deg);transform-origin:top left;width:100vh;height:100vw;position:absolute;top:0;left:100vw;overflow:hidden}
}
@media(max-width:1024px) and (orientation:landscape){
  .header{position:relative;padding:.5rem 1rem;gap:.5rem}
  .header h1{font-size:.9rem}
  .header .subtitle{font-size:.6rem}
  .main{padding:.5rem;gap:.5rem;max-width:100vw}
  .roster-panel{min-width:0;overflow-x:hidden}
  .depth-chart{grid-template-columns:repeat(5,1fr)!important;gap:.3rem;padding:.5rem;min-width:0}
  .dc-card{padding:.3rem;min-width:0;overflow:hidden}
  .dc-card .dc-top{flex-wrap:wrap;gap:.2rem}
  .dc-card .dc-hs,.dc-card .dc-ini{width:26px;height:20px;font-size:.4rem;border-radius:3px}
  .dc-card .dc-name{font-size:.55rem;flex:0 0 100%;order:3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:.1rem}
  .dc-card .dc-sal{font-size:.5rem;margin-left:auto}
  .pos-col{min-width:0}
  .cap-panel{min-width:0}
}
.header h1{font-size:1.2rem;font-weight:700;letter-spacing:-.02em;color:#fff}
.header .subtitle{font-size:.75rem;opacity:.85;color:#fff}
.header .season-badge{background:rgba(255,255,255,.2);padding:.3rem .8rem;border-radius:20px;font-size:.8rem;font-weight:600;color:#fff}
.header .hdr-team{display:flex;align-items:center;gap:.6rem}
.header .hdr-team img{width:36px;height:36px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
.header .hdr-team-name{font-size:.85rem;font-weight:600;line-height:1.2;color:#fff}
.header .hdr-team-sub{font-size:.6rem;opacity:.8;color:#fff}
.cap-mini{display:flex;flex-direction:column;gap:.15rem;min-width:140px}
.cap-mini-label{font-size:.55rem;text-transform:uppercase;letter-spacing:.5px;opacity:.8;display:flex;justify-content:space-between;color:#fff}
.cap-mini-bar{height:6px;background:rgba(255,255,255,.2);border-radius:3px;overflow:hidden}
.cap-mini-fill{height:100%;border-radius:3px;transition:width .5s ease,background .3s}
.cap-mini-vals{font-size:.55rem;opacity:.8;display:flex;justify-content:space-between;color:#fff}

/* Team Dropdown */
.team-dropdown{font-family:inherit;font-size:.8rem;padding:.4rem .8rem;background:rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.3);border-radius:8px;color:#fff;cursor:pointer;outline:none;min-width:160px;appearance:auto}
.team-dropdown:focus{border-color:rgba(255,255,255,.5)}
.team-dropdown option{background:var(--surface);color:var(--text)}

/* Team Banner */
.team-banner{display:flex;align-items:center;gap:1rem;padding:1rem 2rem;max-width:1600px;margin:0 auto}
.team-banner img{width:56px;height:56px;object-fit:contain}
.team-banner .tb-name{font-size:1.3rem;font-weight:700;letter-spacing:.5px}
.team-banner .tb-sub{font-size:.7rem;color:var(--muted)}

/* Main Layout */
.main{display:grid;grid-template-columns:1fr 320px;gap:1rem;padding:1rem;max-width:1600px;margin:0 auto}
@media(max-width:900px){.main{grid-template-columns:1fr}}
@media(max-width:768px){
  .header{flex-wrap:wrap;gap:.5rem;padding:.75rem 1rem;position:relative}
  .header h1{font-size:1rem}
  .cap-mini{min-width:100px}
  .team-dropdown{min-width:120px;font-size:.7rem}
  .toast-container{right:.5rem;left:.5rem;max-width:none}
  .toast{font-size:.7rem}
  .trade-confirm{width:95%}
}

/* Roster Panel */
.roster-panel{display:flex;flex-direction:column;gap:.75rem}
.section{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.section-hdr{padding:.6rem 1rem;display:flex;align-items:center;gap:.5rem;cursor:pointer;user-select:none;border-bottom:1px solid var(--border);background:var(--bg)}
.section-hdr .dot{width:10px;height:10px;border-radius:50%}
.section-hdr h3{font-size:.8rem;font-weight:600;flex:1}
.section-hdr .badge{font-size:.65rem;padding:.15rem .5rem;border-radius:10px;font-weight:600}
.section-body{padding:.5rem}

/* Player Row */
.player-row{display:flex;align-items:center;gap:.6rem;padding:.4rem .5rem;border-radius:8px;transition:background .1s}
.player-row:hover{background:var(--bg)}
.player-row .hs{width:36px;height:28px;border-radius:4px;object-fit:cover;background:var(--bg)}
.player-row .hs-ini{width:36px;height:28px;border-radius:4px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:.55rem;color:var(--muted)}
.player-row .info{flex:1;min-width:0}
.player-row .pname{font-size:.78rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.player-row .pdet{font-size:.6rem;color:var(--muted)}
.player-row .sal{font-size:.78rem;font-weight:600;text-align:right;min-width:70px}
.player-row .sal.g{color:var(--green)}.player-row .sal.ng{color:var(--red)}.player-row .sal.to{color:var(--orange)}.player-row .sal.po{color:var(--cyan)}.player-row .sal.pg{color:var(--yellow)}
.player-row .ch{font-size:.6rem;color:var(--muted);text-align:right}
.player-row .action-btn{
  font-size:.6rem;padding:.2rem .5rem;border-radius:6px;border:1px solid var(--border);
  background:var(--surface);color:var(--muted);cursor:pointer;white-space:nowrap;transition:all .15s;font-family:inherit
}
.player-row .action-btn:hover{border-color:var(--accent);color:var(--accent)}
.player-row .action-btn.pickup{border-color:var(--green);color:var(--green);background:var(--green-dim)}
.player-row .action-btn.pickup:hover{background:var(--green);color:#fff}
.player-row .action-btn.decline{border-color:var(--red);color:var(--red);background:var(--red-dim)}
.player-row .action-btn.decline:hover{background:var(--red);color:#fff}
.player-row .action-btn.renounce{border-color:var(--orange);color:var(--orange)}
.player-row .action-btn.renounce:hover{background:rgba(180,83,9,.15)}
.player-row .action-btn.waive{border-color:var(--red);color:var(--red)}
.player-row .action-btn.waive:hover{background:var(--red-dim)}
.player-row .action-btn.done{opacity:.5;pointer-events:none}
.player-row.acted{opacity:.45}

/* Cap Panel */
.cap-panel{position:sticky;top:60px;display:flex;flex-direction:column;gap:.75rem;align-self:start}
.cap-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1rem;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.cap-card h3{font-size:.8rem;font-weight:700;margin-bottom:.75rem;color:var(--accent)}
.cap-row{display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid var(--border);font-size:.75rem}
.cap-row:last-child{border-bottom:none}
.cap-row .label{color:var(--muted)}
.cap-row .value{font-weight:600}
.cap-row .value.pos{color:var(--green)}.cap-row .value.neg{color:var(--red)}
.cap-bar{height:8px;border-radius:4px;background:var(--bg);margin:.5rem 0;overflow:hidden;position:relative}
.cap-bar-fill{height:100%;border-radius:4px;transition:width .3s}
.cap-bar-marker{position:absolute;top:-2px;height:12px;width:2px;border-radius:1px}

/* Exception chips */
.exc-list{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.5rem}
.exc-chip{font-size:.65rem;padding:.2rem .5rem;border-radius:6px;background:var(--bg);border:1px solid var(--border);font-family:inherit}
.exc-chip.available{border-color:var(--green);color:#15803d;background:var(--green-dim)}
.exc-chip.unavailable{border-color:var(--border);color:var(--muted);opacity:.5}

/* Move log */
.move-log{max-height:200px;overflow-y:auto}
.move-entry{font-size:.68rem;padding:.3rem 0;border-bottom:1px solid var(--border);color:var(--muted)}
.move-entry .action{color:var(--accent)}

/* Controls */
.controls{display:flex;gap:.5rem;margin-top:.5rem}
.ctrl-btn{font-size:.7rem;padding:.35rem .75rem;border-radius:8px;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;transition:all .15s;font-family:inherit}
.ctrl-btn:hover{border-color:var(--accent);color:var(--accent)}
.ctrl-btn.reset{border-color:var(--red);color:var(--red)}
.ctrl-btn.reset:hover{background:var(--red-dim)}

/* Depth Chart */
.depth-chart{display:grid;grid-template-columns:repeat(5,1fr);gap:.6rem;background:var(--bg);border-radius:12px;padding:1rem;margin-bottom:.75rem;border:1px solid var(--border)}
.pos-col{display:flex;flex-direction:column;gap:.4rem;min-height:120px}
.pos-hdr{text-align:center;font-weight:700;font-size:.85rem;color:var(--accent);padding:.35rem;border-bottom:2px solid var(--accent);margin-bottom:.2rem;letter-spacing:-.01em}
.dc-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.5rem;cursor:grab;transition:all .15s;position:relative;box-shadow:0 1px 3px rgba(0,0,0,.05)}
.dc-card:hover{border-color:var(--accent);background:var(--accent-dim)}
.dc-card.dragging{opacity:.4;cursor:grabbing}
.dc-card.touch-dragging{opacity:.6;transform:scale(1.08);box-shadow:0 8px 24px rgba(0,0,0,.2),0 0 0 2px var(--team1);z-index:50;transition:none}
.dc-card.touch-held{animation:touchPulse .4s ease;box-shadow:0 0 0 2px var(--team1),0 4px 12px rgba(0,0,0,.15)}
@keyframes touchPulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1.04)}}
.dc-card .dc-top{display:flex;align-items:center;gap:.4rem;margin-bottom:.3rem;flex-wrap:wrap}
.dc-card .dc-hs{width:40px;height:30px;border-radius:4px;object-fit:cover;background:var(--bg)}
.dc-card .dc-ini{width:40px;height:30px;border-radius:4px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:.5rem;color:var(--muted)}
.dc-card .dc-name{font-size:.7rem;font-weight:600;flex:0 0 100%;order:3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dc-card .dc-sal{font-size:.6rem;font-weight:600;color:var(--green);white-space:nowrap;margin-left:auto}
.dc-card .dc-actions{display:flex;gap:.2rem;flex-wrap:wrap}
.dc-card .dc-btn{font-size:.5rem;padding:.15rem .35rem;border-radius:4px;border:1px solid var(--border);background:var(--bg);color:var(--muted);cursor:pointer;white-space:nowrap;transition:all .1s;font-family:inherit}
.dc-card .dc-btn:hover{border-color:var(--accent);color:var(--accent)}
.dc-card .dc-btn.trade{border-color:var(--cyan);color:var(--cyan)}
.dc-card .dc-btn.waive{border-color:var(--red);color:var(--red)}
.dc-card .dc-btn.opt{border-color:var(--orange);color:var(--orange)}
.dc-card .dc-opt-badge{position:absolute;top:2px;right:4px;font-size:.45rem;padding:.1rem .25rem;border-radius:2px;font-weight:700}
.dc-card .dc-opt-badge.to{background:rgba(180,83,9,.15);color:var(--orange)}
.dc-card .dc-opt-badge.po{background:rgba(14,165,233,.15);color:var(--cyan)}
.dc-card .dc-opt-badge.ng{background:rgba(255,69,58,.15);color:var(--red)}
.dc-card .dc-opt-badge.pg{background:rgba(255,214,0,.15);color:var(--yellow)}
.dc-card .dc-opt-badge.signed{background:rgba(52,199,89,.15);color:var(--green)}
.dc-card .dc-opt-badge.traded{background:rgba(14,165,233,.15);color:var(--cyan)}
.pos-col.drag-over{background:rgba(59,130,246,.08);border-radius:8px}
.dc-drop-indicator{height:3px;background:var(--accent);border-radius:2px;margin:2px 0;pointer-events:none;box-shadow:0 0 6px rgba(59,130,246,.6)}
.dc-section-label{font-size:.85rem;font-weight:700;color:var(--text);margin:1rem 0 .5rem;padding-bottom:.3rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.5rem}
.dc-section-label .dc-badge{font-size:.6rem;padding:.15rem .5rem;border-radius:10px;font-weight:600}
@media(max-width:768px) and (orientation:portrait){.depth-chart{grid-template-columns:repeat(3,1fr)}}
@media(max-width:500px) and (orientation:portrait){.depth-chart{grid-template-columns:repeat(2,1fr)}}

/* Contract Table */
.contract-table{width:100%;font-size:.7rem;border-collapse:collapse}
.contract-table th{padding:.4rem .5rem;font-size:.6rem;color:var(--muted);font-weight:600;letter-spacing:.5px;text-transform:uppercase;border-bottom:1px solid var(--border);background:var(--bg)}
.contract-table th:first-child{text-align:left}.contract-table th:not(:first-child){text-align:right}
.contract-table td{padding:.35rem .5rem;border-bottom:1px solid var(--border)}
.contract-table td:not(:first-child){text-align:right}
.contract-table tr:hover td{background:var(--bg)}
.contract-table .sal-g{color:var(--green)}.contract-table .sal-to{color:var(--orange)}.contract-table .sal-po{color:var(--cyan)}.contract-table .sal-ng{color:var(--red)}.contract-table .sal-pg{color:var(--yellow)}
.contract-table .player-cell{display:flex;align-items:center;gap:.4rem}
.contract-table .ct-hs{width:28px;height:21px;border-radius:3px;object-fit:cover;background:var(--bg)}
.contract-table .ct-ini{width:28px;height:21px;border-radius:3px;background:var(--bg);display:flex;align-items:center;justify-content:center;font-size:.45rem;color:var(--muted)}
.contract-wrap{border-radius:12px;border:1px solid var(--border);background:var(--surface);overflow-x:auto;box-shadow:0 1px 3px rgba(0,0,0,.06)}

/* Loading */
.loading{text-align:center;padding:3rem;color:var(--muted)}
.loading .spin{display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Empty state */
.empty{text-align:center;padding:2rem;color:var(--muted);font-size:.8rem}

/* Phase Stepper */
.phase-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:.6rem 1rem;display:flex;align-items:center;gap:.4rem;justify-content:center;flex-wrap:wrap;box-shadow:0 1px 2px rgba(0,0,0,.04)}

/* Content transitions */
.roster-panel,.cap-panel{animation:fadeSlideIn .3s ease}
@keyframes fadeSlideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* Player hover card */
.player-hover-card{position:fixed;z-index:200;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:.75rem;box-shadow:0 4px 20px rgba(0,0,0,.15);pointer-events:none;opacity:0;transition:opacity .15s;min-width:220px;max-width:280px}
.player-hover-card.show{opacity:1}
.phc-header{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem}
.phc-header img{width:40px;height:40px;border-radius:50%;background:var(--surface)}
.phc-name{font-size:.85rem;font-weight:700}
.phc-pos{font-size:.65rem;color:var(--muted)}
.phc-stats{display:grid;grid-template-columns:1fr 1fr;gap:.25rem .5rem}
.phc-stat{font-size:.65rem}
.phc-stat .label{color:var(--muted)}
.phc-stat .val{font-weight:600;float:right}
.phase-step{display:flex;align-items:center;gap:.3rem;font-size:.65rem;font-weight:600;padding:.3rem .6rem;border-radius:20px;color:var(--muted);background:transparent;border:1px solid transparent;cursor:pointer;transition:all .15s;white-space:nowrap}
.phase-step.active{background:var(--accent-dim);color:var(--accent);border-color:var(--accent)}
.phase-step.completed{color:var(--green);opacity:.8}
.phase-step.locked{opacity:.4;cursor:not-allowed}
.phase-arrow{color:var(--muted);font-size:.6rem;opacity:.5}
.phase-advance{font-size:.65rem;padding:.3rem .7rem;border-radius:8px;border:1px solid var(--green);background:var(--green-dim);color:#15803d;cursor:pointer;font-weight:600;margin-left:.5rem;transition:all .15s;font-family:inherit}
.phase-advance:hover{background:var(--green);color:#fff}

/* Waive modal */
.waive-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.waive-modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:380px;max-width:90vw;padding:1.2rem;box-shadow:0 4px 20px rgba(0,0,0,.15)}
.waive-modal h3{font-size:.9rem;font-weight:700;margin-bottom:.8rem;color:var(--text)}
.waive-modal .player-info{font-size:.75rem;color:var(--muted);margin-bottom:1rem;padding:.5rem;background:var(--surface);border-radius:6px}
.waive-modal .player-info .name{color:var(--text);font-weight:600;font-size:.85rem}
.waive-option{display:flex;flex-direction:column;gap:.3rem;padding:.7rem;border:1px solid var(--border);border-radius:8px;cursor:pointer;margin-bottom:.5rem;transition:all .15s}
.waive-option:hover{border-color:var(--accent);background:var(--accent-dim)}
.waive-option .opt-title{font-size:.75rem;font-weight:600;color:var(--text)}
.waive-option .opt-desc{font-size:.65rem;color:var(--muted)}
.waive-option .opt-amount{font-size:.8rem;font-weight:700;color:var(--red)}
.waive-cancel{font-size:.7rem;padding:.35rem .75rem;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;margin-top:.3rem;width:100%;text-align:center}

/* Coming soon badge */
.coming-soon{font-size:.55rem;padding:.1rem .3rem;border-radius:3px;background:var(--surface);color:var(--muted);border:1px solid var(--border);margin-left:.3rem}
.action-btn.trade{background:rgba(14,165,233,.1);color:var(--cyan);border-color:rgba(14,165,233,.3)}
.action-btn.extend{background:var(--accent-dim);color:var(--accent);border-color:rgba(59,130,246,.3)}
.ext-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:1000;display:flex;align-items:center;justify-content:center;padding:.5rem}
.ext-modal{background:var(--surface);border-radius:12px;max-width:480px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,.15)}
.ext-modal-hdr{display:flex;align-items:center;gap:.5rem;padding:.75rem 1rem;border-bottom:1px solid var(--border)}
.ext-modal-hdr h3{flex:1;font-size:.85rem;margin:0}
.ext-modal-body{padding:1rem}
.ext-player-info{display:flex;align-items:center;gap:.75rem;padding:.6rem;background:var(--surface);border-radius:8px;margin-bottom:.75rem}
.ext-player-info img{width:48px;height:36px;object-fit:cover;border-radius:4px}
.ext-player-info .name{font-weight:600;font-size:.8rem}
.ext-player-info .meta{font-size:.65rem;color:var(--muted)}
.ext-type-badge{display:inline-block;padding:.15rem .45rem;border-radius:4px;font-size:.6rem;font-weight:600;margin-left:.4rem}
.ext-type-badge.rse{background:var(--accent-dim);color:var(--accent)}
.ext-type-badge.vet{background:rgba(245,158,11,.15);color:#f59e0b}
.ext-config{margin:.75rem 0}
.ext-config label{display:block;font-size:.7rem;color:var(--muted);margin-bottom:.25rem}
.ext-config .row{display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem}
.ext-config input[type="range"]{flex:1;accent-color:var(--accent)}
.ext-config input[type="number"]{width:120px;padding:.35rem .5rem;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text);font-family:inherit;font-size:.75rem}
.ext-config select{padding:.35rem .5rem;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text);font-family:inherit;font-size:.75rem}
.ext-config .sal-display{font-size:.8rem;font-weight:600;color:var(--accent);min-width:80px;text-align:right}
.ext-breakdown{margin:.75rem 0}
.ext-breakdown h4{font-size:.7rem;color:var(--muted);margin:0 0 .35rem}
.ext-year-row{display:flex;justify-content:space-between;padding:.3rem .5rem;font-size:.7rem;border-radius:4px}
.ext-year-row:nth-child(even){background:var(--bg)}
.ext-year-row .yr{color:var(--muted);min-width:60px}
.ext-year-row .sal{font-weight:600}
.ext-total-row{display:flex;justify-content:space-between;padding:.4rem .5rem;font-size:.75rem;font-weight:700;border-top:1px solid var(--border);margin-top:.25rem}
.ext-note{font-size:.6rem;color:var(--muted);padding:.4rem;background:var(--bg);border-radius:4px;margin:.5rem 0}
.ext-confirm-btn{width:100%;padding:.6rem;background:var(--accent);color:white;border:none;border-radius:8px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;margin-top:.5rem}
.ext-confirm-btn:hover{opacity:.9}
.ext-confirm-btn:disabled{opacity:.4;cursor:not-allowed}
.extended-badge{font-size:.55rem;padding:.1rem .35rem;border-radius:3px;background:var(--accent-dim);color:var(--accent);font-weight:600;white-space:nowrap}

/* Draft Picker Modal */
.draft-picker-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.draft-picker{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:400px;max-width:90vw;max-height:80vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.15)}
.draft-picker-hdr{padding:.8rem 1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem}
.draft-picker-hdr h3{flex:1;font-size:.85rem;font-weight:700;color:var(--orange)}
.draft-picker-hdr .close-btn{background:none;border:none;color:var(--muted);font-size:1.1rem;cursor:pointer;padding:.2rem}
.draft-picker-hdr .close-btn:hover{color:var(--text)}
.draft-picker-search{padding:.5rem 1rem;border-bottom:1px solid var(--border)}
.draft-picker-search input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:.4rem .6rem;color:var(--text);font-size:.75rem;outline:none}
.draft-picker-search input:focus{border-color:var(--accent)}
.draft-picker-list{overflow-y:auto;flex:1;padding:.3rem}
.draft-pick-option{display:flex;align-items:center;gap:.6rem;padding:.45rem .8rem;border-radius:6px;cursor:pointer;font-size:.75rem;transition:background .1s}
.draft-pick-option:hover{background:var(--bg)}
.draft-pick-option.current{background:rgba(180,83,9,.12);border:1px solid rgba(180,83,9,.3)}
.draft-pick-option.taken{opacity:.35;cursor:not-allowed}
.draft-pick-option .rank{color:var(--muted);font-size:.65rem;min-width:30px}
.draft-pick-option .name{flex:1;font-weight:500}
.draft-pick-option .assigned{font-size:.6rem;color:var(--muted);padding:.1rem .4rem;background:var(--surface);border-radius:3px}
.action-btn.draft-swap{background:rgba(180,83,9,.15);color:var(--orange);border-color:rgba(180,83,9,.3)}
.action-btn.draft-swap:hover{background:rgba(180,83,9,.25)}

/* Your Pick pulse */
@keyframes pickPulse{0%{box-shadow:0 0 0 0 rgba(59,130,246,.5)}70%{box-shadow:0 0 0 12px rgba(59,130,246,0)}100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}}
.your-pick-box{animation:pickPulse 1.5s ease-out 2}

/* Trade Machine iframe overlay */
.tm-overlay{position:fixed;top:0;left:0;right:0;bottom:0;z-index:250;background:rgba(0,0,0,.5);display:flex;flex-direction:column;backdrop-filter:blur(4px)}
.tm-bar{display:flex;align-items:center;gap:.75rem;padding:.5rem 1rem;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0}
.tm-bar h3{flex:1;font-size:.8rem;font-weight:600;color:var(--cyan)}
.tm-bar .tm-close{background:none;border:1px solid var(--border);color:var(--text);font-size:.75rem;padding:.3rem .8rem;border-radius:6px;cursor:pointer;transition:all .15s}
.tm-bar .tm-close:hover{border-color:var(--red);color:var(--red)}
.tm-bar .tm-external{background:none;border:1px solid var(--border);color:var(--muted);font-size:.65rem;padding:.3rem .6rem;border-radius:6px;cursor:pointer;text-decoration:none;transition:all .15s}
.tm-bar .tm-external:hover{border-color:var(--accent);color:var(--accent)}
.tm-iframe{flex:1;border:none;width:100%;background:var(--bg)}

/* Trade Confirm Dialog */
.trade-confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:300;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.trade-confirm{background:var(--surface);border:1px solid var(--border);border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 4px 20px rgba(0,0,0,.15);animation:tcSlideIn .3s ease}
@keyframes tcSlideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.trade-confirm-hdr{padding:1rem 1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.5rem}
.trade-confirm-hdr h3{font-size:.95rem;flex:1}
.tc-body{padding:1rem 1.25rem}
.tc-section{margin-bottom:.75rem}
.tc-section-title{font-size:.7rem;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:.4rem;font-weight:600}
.tc-player{display:flex;align-items:center;gap:.5rem;padding:.35rem 0;border-bottom:1px solid var(--border)}
.tc-player:last-child{border-bottom:none}
.tc-player img{width:32px;height:32px;border-radius:50%;background:var(--surface)}
.tc-player-info{flex:1}
.tc-player-name{font-size:.8rem;font-weight:600}
.tc-player-sal{font-size:.65rem;color:var(--muted)}
.tc-actions{display:flex;gap:.5rem;padding:1rem 1.25rem;border-top:1px solid var(--border)}
.tc-actions button{flex:1;padding:.6rem;border-radius:8px;border:none;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s}
.tc-btn-confirm{background:var(--green);color:white}
.tc-btn-confirm:hover{filter:brightness(1.1)}
.tc-btn-reject{background:var(--red-dim);color:var(--red);border:1px solid rgba(255,69,58,.25)!important}
.tc-btn-reject:hover{background:var(--red);color:#fff}

/* Trade modal (legacy ‚Äî keep for manual record) */
.trade-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.trade-modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:520px;max-width:95vw;max-height:85vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.15)}
.trade-modal-hdr{padding:.8rem 1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem}
.trade-modal-hdr h3{flex:1;font-size:.85rem;font-weight:700;color:var(--cyan)}
.trade-modal-hdr .close-btn{background:none;border:none;color:var(--muted);font-size:1.1rem;cursor:pointer;padding:.2rem}
.trade-modal-body{padding:1rem;overflow-y:auto;flex:1}
.trade-link-row{display:flex;gap:.5rem;margin-bottom:1rem}
.trade-link-btn{font-size:.7rem;padding:.4rem .8rem;border-radius:6px;border:1px solid var(--cyan);background:rgba(14,165,233,.1);color:var(--cyan);cursor:pointer;font-weight:600;transition:all .15s;flex:1;text-align:center}
.trade-link-btn:hover{background:rgba(14,165,233,.2)}
.trade-record-section{margin-top:.5rem}
.trade-record-section h4{font-size:.75rem;color:var(--muted);margin-bottom:.5rem;font-weight:600}
.trade-input-row{display:flex;gap:.5rem;margin-bottom:.4rem;align-items:center}
.trade-input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:.4rem .6rem;color:var(--text);font-size:.75rem;outline:none}
.trade-input:focus{border-color:var(--accent)}
.trade-input::placeholder{color:var(--muted)}
.trade-add-btn{font-size:.65rem;padding:.3rem .6rem;border-radius:4px;border:1px solid var(--green);color:var(--green);background:transparent;cursor:pointer}
.trade-add-btn:hover{background:rgba(52,199,89,.15)}
.trade-player-tag{display:inline-flex;align-items:center;gap:.3rem;font-size:.65rem;padding:.2rem .5rem;border-radius:4px;background:var(--surface);border:1px solid var(--border);margin:.15rem .15rem}
.trade-player-tag .remove{cursor:pointer;color:var(--red);font-weight:700}
.trade-confirm-btn{width:100%;padding:.5rem;border-radius:6px;border:1px solid var(--green);background:rgba(52,199,89,.15);color:var(--green);cursor:pointer;font-weight:600;font-size:.75rem;margin-top:.75rem;transition:all .15s}
.trade-confirm-btn:hover{background:rgba(52,199,89,.3)}
.trade-confirm-btn:disabled{opacity:.4;cursor:not-allowed}

/* Signing modal */
.sign-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.sign-modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:420px;max-width:95vw;max-height:85vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.15)}
.sign-modal-hdr{padding:.8rem 1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem}
.sign-modal-hdr h3{flex:1;font-size:.85rem;font-weight:700;color:var(--green)}
.sign-modal-body{padding:1rem;overflow-y:auto;flex:1}
.sign-exc-option{display:flex;flex-direction:column;gap:.2rem;padding:.6rem;border:1px solid var(--border);border-radius:8px;cursor:pointer;margin-bottom:.4rem;transition:all .15s}
.sign-exc-option:hover{border-color:var(--accent);background:var(--accent-dim)}
.sign-exc-option.unavailable{opacity:.35;cursor:not-allowed}
.sign-exc-option .exc-name{font-size:.75rem;font-weight:600}
.sign-exc-option .exc-detail{font-size:.65rem;color:var(--muted)}
.sign-salary-input{display:flex;gap:.5rem;align-items:center;margin:.75rem 0}
.sign-salary-input label{font-size:.7rem;color:var(--muted);min-width:60px}
.sign-yr-table{width:100%;border-collapse:collapse;font-size:.65rem;margin:.5rem 0}
.sign-yr-table th{text-align:left;padding:.35rem .3rem;color:var(--muted);font-weight:600;border-bottom:2px solid var(--border);font-size:.6rem;text-transform:uppercase}
.sign-yr-table td{padding:.3rem;border-bottom:1px solid var(--border)}
.sign-yr-table tr:last-child td{border-bottom:none}
.sign-yr-table .yr-sal{font-weight:600;font-family:'DM Sans',system-ui;font-variant-numeric:tabular-nums}
.sign-yr-table select{font-size:.6rem;padding:.15rem .2rem;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text);cursor:pointer}
.sign-yr-table .yr-total{font-weight:700;color:var(--accent);border-top:2px solid var(--border)}
.sign-yr-sal-input{width:100%;border:1px solid var(--border);border-radius:4px;padding:.25rem .4rem;font-size:.65rem;font-family:'DM Sans',system-ui;background:var(--bg);color:var(--text);text-align:right;font-variant-numeric:tabular-nums}
.sign-yr-sal-input:focus{outline:none;border-color:var(--accent)}
.sign-config-row{display:flex;gap:.5rem;align-items:center;margin:.5rem 0}
.sign-config-row label{font-size:.65rem;color:var(--muted);min-width:55px}
.sign-config-row select,.sign-config-row input{font-size:.7rem;padding:.3rem .4rem;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);flex:1}
.sign-sat-note{font-size:.6rem;color:var(--orange);padding:.4rem .5rem;background:rgba(249,160,27,.08);border-radius:6px;margin:.5rem 0;line-height:1.3}

/* === LOTTERY DRAW ROOM === */
.lot-mode-btn{padding:.6rem 1.2rem;border:2px solid var(--border);border-radius:10px;background:var(--surface);cursor:pointer;text-align:center;transition:all .2s;flex:1;min-width:140px}
.lot-mode-btn:hover{border-color:var(--accent);background:var(--accent-dim)}
.lot-mode-btn .icon{font-size:1.5rem;display:block;margin-bottom:.25rem}
.lot-mode-btn .title{font-size:.75rem;font-weight:700;color:var(--text)}
.lot-mode-btn .desc{font-size:.55rem;color:var(--muted);margin-top:.15rem}
.lot-balls{display:flex;gap:.4rem;justify-content:center;flex-wrap:wrap;margin:.75rem 0}
.lot-ball{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:800;background:var(--surface);border:2px solid var(--border);color:var(--muted);transition:all .4s;font-family:'DM Sans',system-ui}
.lot-ball.drawn{background:var(--orange);border-color:var(--orange);color:white;transform:scale(1.15);box-shadow:0 0 12px rgba(180,83,9,.4)}
.lot-ball.drawing{animation:ballPulse .6s ease infinite;border-color:var(--orange)}
@keyframes ballPulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.2);opacity:.7}}
.lot-pick-header{text-align:center;font-size:.85rem;font-weight:700;color:var(--orange);margin:.75rem 0 .5rem;padding:.4rem;background:rgba(180,83,9,.06);border-radius:8px}
.lot-team-row{display:flex;align-items:center;gap:.5rem;padding:.3rem .5rem;border-radius:6px;margin-bottom:.2rem;font-size:.7rem;transition:all .3s;flex-wrap:wrap}
.lot-team-row.eliminated{opacity:.25}
.lot-team-row.winner{background:rgba(52,199,89,.12);border:1px solid rgba(52,199,89,.3)}
.lot-team-row .team-name{flex:1;font-weight:600;display:flex;align-items:center;gap:.3rem}
.lot-team-row .team-name img{width:18px;height:18px}
.lot-team-row .combos{font-size:.6rem;color:var(--muted);min-width:55px;text-align:right}
.lot-team-row .bar-wrap{width:80px;height:6px;background:var(--surface);border-radius:3px;overflow:hidden;border:1px solid var(--border)}
.lot-team-row .bar-fill{height:100%;background:var(--orange);border-radius:3px;transition:width .4s}
.lot-drawn-balls{display:flex;gap:.3rem;justify-content:center;margin:.5rem 0}
.lot-drawn-balls .mini-ball{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:800;background:var(--orange);color:white;font-family:'DM Sans',system-ui}
.lot-drawn-balls .mini-ball.pending{background:var(--surface);border:2px dashed var(--border);color:var(--muted)}
.lot-envelope{display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border-radius:8px;margin-bottom:.3rem;font-size:.75rem;border:1px solid var(--border);transition:all .4s}
.lot-envelope.revealed{background:var(--surface)}
.lot-envelope.hidden-env{background:repeating-linear-gradient(45deg,var(--surface),var(--surface) 4px,var(--bg) 4px,var(--bg) 8px);opacity:.4}
.lot-envelope.revealing{animation:envelopeFlash .5s ease;background:rgba(180,83,9,.08);border-color:var(--orange)}
.lot-envelope.top4{border-color:var(--orange);background:rgba(180,83,9,.06)}
@keyframes envelopeFlash{0%{transform:scale(1)}50%{transform:scale(1.03);background:rgba(180,83,9,.15)}100%{transform:scale(1)}}
.lot-envelope .pick-num{font-weight:800;min-width:35px;color:var(--orange)}
.lot-envelope .team-info{flex:1;display:flex;align-items:center;gap:.3rem;font-weight:600}
.lot-envelope .team-info img{width:20px;height:20px}
.lot-envelope .movement{font-size:.65rem;font-weight:700}

/* Training camp warning */
.camp-warning{background:rgba(255,69,58,.1);border:1px solid rgba(255,69,58,.3);border-radius:8px;padding:.75rem 1rem;margin-bottom:.75rem}
.camp-warning h4{font-size:.8rem;color:var(--red);margin-bottom:.3rem}
.camp-warning p{font-size:.7rem;color:var(--muted)}
.camp-ok{background:rgba(52,199,89,.1);border:1px solid rgba(52,199,89,.3);border-radius:8px;padding:.75rem 1rem;margin-bottom:.75rem}
.camp-ok h4{font-size:.8rem;color:var(--green);margin-bottom:.3rem}
.camp-ok p{font-size:.7rem;color:var(--muted)}

/* === TOAST NOTIFICATIONS === */
.toast-container{position:fixed;top:70px;right:1rem;z-index:500;display:flex;flex-direction:column;gap:.4rem;pointer-events:none}
.toast{padding:.6rem 1rem;border-radius:8px;font-size:.75rem;font-weight:500;color:white;pointer-events:auto;animation:toastIn .3s ease,toastOut .3s ease 2.7s forwards;box-shadow:0 4px 12px rgba(0,0,0,.15);max-width:320px;font-family:inherit}
.toast.success{background:linear-gradient(135deg,#4caf50,#388e3c)}
.toast.info{background:linear-gradient(135deg,var(--team1),var(--team2))}
.toast.warning{background:linear-gradient(135deg,#ff9800,#f57c00)}
.toast.error{background:linear-gradient(135deg,#ef5350,#d32f2f)}
@keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{from{opacity:1}to{opacity:0;transform:translateX(40px)}}

/* === TEAM ACCENT BORDERS === */
.dc-section-label{border-left:3px solid var(--team1);padding-left:.6rem}
.section-hdr .dot{background:var(--team1)!important}
.phase-step.active{border-color:var(--team1);color:var(--team1);background:var(--team1-dim)}

/* === PHASE TRANSITIONS === */
#rosterPanel,#capPanel{animation:fadeSlideIn .3s ease}
@keyframes fadeSlideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* === ENHANCED PLAYER HOVER CARD === */
.player-hover-card{min-width:260px;max-width:320px}
.phc-header{display:flex;align-items:center;gap:.6rem;padding-bottom:.5rem;border-bottom:1px solid var(--border);margin-bottom:.5rem}
.phc-header img{width:48px;height:48px;border-radius:50%;background:var(--surface);object-fit:cover}
.phc-header .phc-ini{width:48px;height:48px;border-radius:50%;background:var(--team1-dim);display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:700;color:var(--team1)}
.phc-name{font-size:.85rem;font-weight:700}
.phc-sub{font-size:.65rem;color:var(--muted)}
.phc-stats{display:grid;grid-template-columns:1fr 1fr;gap:.3rem}
.phc-stat{display:flex;justify-content:space-between;font-size:.65rem;padding:.2rem .4rem;background:var(--surface);border-radius:4px}
.phc-stat-label{color:var(--muted)}
.phc-stat-val{font-weight:600}

/* === TRADE HISTORY === */
.trade-history{margin-top:.75rem}
.trade-history-title{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:.4rem;display:flex;align-items:center;gap:.4rem}
.trade-item{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.5rem .6rem;margin-bottom:.4rem;font-size:.65rem;position:relative}
.trade-item .trade-dir{display:flex;gap:.3rem;align-items:center;flex-wrap:wrap;margin:.2rem 0}
.trade-item .trade-dir .out{color:var(--red)}
.trade-item .trade-dir .in{color:var(--green)}
.trade-item .trade-undo{position:absolute;top:.4rem;right:.4rem;font-size:.6rem;color:var(--muted);cursor:pointer;padding:.1rem .3rem;border-radius:4px;border:1px solid var(--border);background:none}
.trade-item .trade-undo:hover{color:var(--red);border-color:var(--red)}

/* === MOVE LOG === */
.move-log{margin-top:.75rem}
.move-item{display:flex;align-items:center;gap:.4rem;padding:.25rem 0;border-bottom:1px solid var(--border);font-size:.6rem}
.move-item:last-child{border-bottom:none}
.move-icon{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.55rem;flex-shrink:0}
.move-icon.trade{background:rgba(14,165,233,.15);color:var(--cyan)}
.move-icon.waive{background:rgba(255,69,58,.15);color:var(--red)}
.move-icon.sign{background:rgba(52,199,89,.15);color:var(--green)}
.move-icon.draft{background:rgba(59,130,246,.15);color:var(--accent)}
.move-icon.option{background:rgba(180,83,9,.15);color:var(--orange)}
.move-icon.phase{background:rgba(110,110,115,.15);color:var(--muted)}

/* Traded badge */
.traded-badge{font-size:.55rem;padding:.1rem .35rem;border-radius:3px;background:rgba(14,165,233,.15);color:var(--cyan);border:1px solid rgba(14,165,233,.3);margin-left:.3rem;font-weight:600}
.signed-badge{font-size:.55rem;padding:.1rem .35rem;border-radius:3px;background:rgba(52,199,89,.15);color:var(--green);border:1px solid rgba(52,199,89,.3);margin-left:.3rem;font-weight:600}

/* Landing Page */
.landing{position:fixed;top:0;left:0;right:0;bottom:0;z-index:300;background:var(--bg);display:flex;flex-direction:column;overflow-y:auto}
.landing-hdr{text-align:center;padding:2.5rem 1rem 1rem;background:linear-gradient(180deg,rgba(59,130,246,.06) 0%,transparent 100%)}
.landing-hdr h1{font-size:2rem;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.02em}
.landing-hdr .landing-sub{font-size:.85rem;color:var(--muted);margin-top:.4rem}
.landing-hdr .landing-badge{display:inline-block;margin-top:.75rem;font-size:.65rem;padding:.3rem .8rem;border-radius:20px;background:var(--accent-dim);color:var(--accent);border:1px solid rgba(59,130,246,.2);font-weight:600;letter-spacing:.5px}
.landing-body{max-width:900px;margin:0 auto;padding:1rem 1.5rem 3rem;width:100%}
.conf-label{font-size:.7rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin:1.5rem 0 .75rem;padding-bottom:.4rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.5rem}
.conf-label::before{content:'';display:inline-block;width:3px;height:14px;border-radius:2px}
.conf-label.east::before{background:var(--accent)}
.conf-label.west::before{background:var(--orange)}
.team-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:.6rem}
@media(max-width:700px){.team-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:420px){.team-grid{grid-template-columns:repeat(2,1fr)}}
.team-card{display:flex;flex-direction:column;align-items:center;gap:.4rem;padding:.8rem .5rem;background:var(--surface);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .15s;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.team-card:hover{border-color:var(--accent);background:var(--accent-dim);transform:translateY(-2px)}
.team-card:active{transform:translateY(0)}
.team-card img{width:48px;height:48px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.1))}
.team-card .tc-abbr{font-size:.75rem;font-weight:700;color:var(--text)}
.team-card .tc-name{font-size:.6rem;color:var(--muted);line-height:1.2}
</style>
</head>
<body>

<!-- Toast Notifications -->
<div class="toast-container" id="toastContainer"></div>

<!-- Landing Page -->
<div id="landingPage" class="landing">
  <div class="landing-hdr">
    <h1>üèÄ ROSTER MANAGER</h1>
    <div class="landing-sub">HoopsMatic GM Simulator ¬∑ 2026-27 Offseason</div>
    <div class="landing-badge">v1.7.2 ¬∑ SELECT YOUR TEAM TO BEGIN</div>
  </div>
  <div class="landing-body" id="landingBody">
    <div style="text-align:center;padding:2rem 0"><div class="spin" style="display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite"></div><p style="margin-top:.5rem;font-size:.8rem;color:var(--muted)">Loading teams...</p></div>
  </div>
</div>

<div class="header">
  <div>
    <h1>üèÄ ROSTER MANAGER <span style="font-size:.65rem;opacity:.6">v1.7.2</span></h1>
    <div class="subtitle" id="hdrBreadcrumb">HoopsMatic GM Simulator</div>
  </div>
  <div id="hdrTeamInfo" class="hdr-team" style="display:none"></div>
  <div id="hdrCapMini" class="cap-mini" style="display:none"></div>
  <div style="display:flex;align-items:center;gap:.75rem;margin-left:auto">
    <select id="teamSelect" class="team-dropdown" onchange="if(this.value)selectTeam(this.value)">
      <option value="">Select team...</option>
    </select>
    <div class="season-badge">2026-27</div>
  </div>
</div>

<div id="appContent" style="display:none">
  <div id="teamBanner" class="team-banner"></div>
  <div class="phase-bar" id="phaseBar"></div>
  <div class="main">
    <div class="roster-panel" id="rosterPanel"></div>
    <div class="cap-panel" id="capPanel"></div>
  </div>
</div>

<div id="loadingState" class="loading" style="display:none">
  <div class="spin"></div>
  <p style="margin-top:.5rem;font-size:.8rem">Loading roster data...</p>
</div>

<!-- Waive Decision Modal -->
<div id="waiveOverlay" class="waive-overlay" style="display:none" onclick="if(event.target===this)closeWaiveModal()">
  <div class="waive-modal" id="waiveModal"></div>
</div>

<!-- Draft Picker Modal -->
<div id="draftPickerOverlay" class="draft-picker-overlay" style="display:none" onclick="if(event.target===this)closeDraftPicker()">
  <div class="draft-picker">
    <div class="draft-picker-hdr">
      <span style="font-size:1.1rem">üèÄ</span>
      <h3 id="draftPickerTitle">Select Prospect</h3>
      <button class="close-btn" onclick="closeDraftPicker()">‚úï</button>
    </div>
    <div class="draft-picker-search">
      <input type="text" placeholder="Search prospects..." oninput="renderDraftPickerList(this.value)">
    </div>
    <div class="draft-picker-list" id="draftPickerList"></div>
  </div>
</div>

<!-- Trade Machine Iframe Overlay -->
<div id="tmOverlay" class="tm-overlay" style="display:none">
  <div class="tm-bar">
    <span style="font-size:1rem">üîÑ</span>
    <h3>Trade Machine</h3>
    <a id="tmExternalLink" class="tm-external" href="#" target="_blank" onclick="closeTradeMachine()">Open in new tab ‚Üó</a>
    <button class="tm-close" onclick="closeTradeMachine()">‚úï Close</button>
  </div>
  <div id="tmLoading" style="flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:.5rem">
    <div class="spin" style="display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--cyan);border-radius:50%;animation:spin .8s linear infinite"></div>
    <p style="font-size:.75rem;color:var(--muted)">Loading Trade Machine...</p>
    <button onclick="tmFallbackNewTab()" style="margin-top:.5rem;font-size:.7rem;padding:.3rem .8rem;border:1px solid var(--border);background:none;color:var(--muted);border-radius:6px;cursor:pointer">Not loading? Open in new tab instead</button>
  </div>
  <iframe id="tmIframe" class="tm-iframe" style="display:none" referrerpolicy="no-referrer-when-downgrade"></iframe>
</div>

<!-- Trade Confirm Dialog -->
<div id="tradeConfirmOverlay" class="trade-confirm-overlay" style="display:none" onclick="if(event.target===this)rejectPendingTrade()">
  <div class="trade-confirm">
    <div class="trade-confirm-hdr">
      <span style="font-size:1.1rem">üîÑ</span>
      <h3>Confirm Trade</h3>
    </div>
    <div class="tc-body" id="tradeConfirmBody"></div>
    <div class="tc-actions">
      <button class="tc-btn-confirm" onclick="confirmPendingTrade()">‚úÖ Accept Trade</button>
      <button class="tc-btn-reject" onclick="rejectPendingTrade()">‚ùå Reject</button>
    </div>
  </div>
</div>

<!-- Extension Modal -->
<div id="extOverlay" class="ext-overlay" style="display:none" onclick="if(event.target===this)closeExtModal()">
  <div class="ext-modal">
    <div class="ext-modal-hdr">
      <span style="font-size:1.1rem">üìù</span>
      <h3 id="extModalTitle">Extend Player</h3>
      <button class="close-btn" onclick="closeExtModal()">‚úï</button>
    </div>
    <div class="ext-modal-body" id="extModalBody"></div>
  </div>
</div>

<!-- Signing Modal -->
<div id="signOverlay" class="sign-overlay" style="display:none" onclick="if(event.target===this)closeSignModal()">
  <div class="sign-modal">
    <div class="sign-modal-hdr">
      <span style="font-size:1.1rem">‚úçÔ∏è</span>
      <h3 id="signModalTitle">Sign Free Agent</h3>
      <button class="close-btn" onclick="closeSignModal()">‚úï</button>
    </div>
    <div class="sign-modal-body" id="signModalBody"></div>
  </div>
</div>

<!-- Player Hover Card -->
<div id="playerHoverCard" class="player-hover-card"></div>

<script>
// ======================== CONSTANTS ========================
// Force landscape on mobile via Screen Orientation API
try { screen.orientation.lock('landscape').catch(()=>{}); } catch(e) {}
const SEASON = '2026-27';
const THRESHOLDS = {
  '2025-2026': {cap:154647000,tax:187895000,apron1:195945000,apron2:207824000,bae:5134000,ntmle:14104000,tmle:5685000,rmle:8781000},
  '2026-2027': {cap:166000000,tax:201690000,apron1:210690000,apron2:223690000,bae:5511000,ntmle:15139000,tmle:6102000,rmle:9425000},
  '2027-2028': {cap:174300000,tax:211775000,apron1:220812000,apron2:234200000,bae:5787000,ntmle:15896000,tmle:6407000,rmle:9897000},
};
const T = THRESHOLDS['2026-2027'];
const MIN_SALARY_0YOS = 1272870; // approximate 2026-27 minimum for 0 YOS
const MIN_SALARY_CAP_HOLD = Math.round(MIN_SALARY_0YOS * 1.5); // ~$1.9M
const EST_AVG_SALARY = 13200000; // approximate

// YOS-based salary bounds (NBA CBA)
// Min salary escalates by ~$100K per YOS; max % of cap by tiers
const MIN_SALARY_BY_YOS = [1272870,1611094,1810898,1880000,2020000,2160000,2300000,2440000,2580000,2720000,2860000,3000000,3150000,3300000];
function getPlayerYOS(p) {
  // Estimate years of service from age; NBA entry ~19
  const ageNum = parseInt(p?.age) || 0;
  if (!ageNum) return 0;
  return Math.max(0, ageNum - 19);
}
function getPlayerMinSalary(p) {
  const yos = getPlayerYOS(p);
  return MIN_SALARY_BY_YOS[Math.min(yos, MIN_SALARY_BY_YOS.length - 1)] || MIN_SALARY_0YOS;
}
function getPlayerMaxSalary(p) {
  const yos = getPlayerYOS(p);
  if (yos >= 10) return Math.round(T.cap * 0.35);
  if (yos >= 7) return Math.round(T.cap * 0.30);
  return Math.round(T.cap * 0.25);
}
function isRookieScale(p) {
  // Rookie scale if exception contains "Rookie" or player is on a rookie deal (young + low salary)
  const exc = (p?.exception || '').toLowerCase();
  return exc.includes('rookie') || exc.includes('2nd rnd') || exc.includes('second round');
}
function getPlayerRaiseRate(p, excName) {
  // S&T always uses Bird rights (8%) ‚Äî original team signs with their Bird rights
  if (excName === 'Sign-and-Trade') return 0.08;
  // Minimum/Two-Way/E10: flat (no raises per NBA rules ‚Äî salary set per YOS each year)
  if (excName === 'Minimum' || excName === 'Two-Way' || excName === 'Exhibit 10') return 0;

  // NBA CBA raise rules:
  // - Re-signing with Bird/Early Bird rights: 8% raises
  // - Signing via cap space, MLE, BAE, Room MLE: 5% raises
  // If excName is empty, infer from player's exception (for default display before exception is chosen)
  if (!excName) {
    // Default: infer from player's prior exception
    const exc = (p?.exception || '').toLowerCase();
    if (exc.includes('bird') && !exc.includes('early') && !exc.includes('non')) return 0.08;
    if (exc.includes('early bird') || exc.includes('early-bird')) return 0.08;
    if (exc.includes('rookie') || exc.includes('2nd rnd') || exc.includes('second round')) return 0.08;
    return 0.05;
  }
  // Cap space, MLE, BAE, Room MLE: always 5%
  if (['Cap Space', 'Non-Tax MLE', 'Tax MLE', 'Room MLE', 'BAE'].includes(excName)) return 0.05;
  // If it's a re-sign (using team's Bird rights), use player's exception
  const exc = (p?.exception || '').toLowerCase();
  if (exc.includes('bird') && !exc.includes('early') && !exc.includes('non')) return 0.08;
  if (exc.includes('early bird') || exc.includes('early-bird')) return 0.08;
  if (exc.includes('rookie') || exc.includes('2nd rnd') || exc.includes('second round')) return 0.08;
  return 0.05;
}

// 2026-27 Rookie Scale at 120% (Year 1 cap holds), picks 1-30
const ROOKIE_SCALE = [
  13825920,12370320,11108880,10015680,9069840,8237640,7520040,6889200,6332520,6016080,
  5715120,5429520,5157960,4900320,4655040,4422360,4201080,3991320,3811560,3658800,
  3512520,3372240,3237480,3108120,2983320,2884560,2801280,2783880,2763960,2743800
];

const SSID = '11llk0icQqoi0JwJXat5KO8y2RQeBMN5rS9FhAY56Idc';
const TEAMS = {
  'Atlanta':'ATL','Boston':'BOS','Brooklyn':'BKN','Charlotte':'CHA','Chicago':'CHI',
  'Cleveland':'CLE','Dallas':'DAL','Denver':'DEN','Detroit':'DET','Golden State':'GSW',
  'Houston':'HOU','Indiana':'IND','LA Clippers':'LAC','LA Lakers':'LAL','Memphis':'MEM',
  'Miami':'MIA','Milwaukee':'MIL','Minnesota':'MIN','New Orleans':'NOP','New York':'NYK',
  'Oklahoma City':'OKC','Orlando':'ORL','Philadelphia':'PHI','Phoenix':'PHX','Portland':'POR',
  'Sacramento':'SAC','San Antonio':'SAS','Toronto':'TOR','Utah':'UTA','Washington':'WAS'
};

const TEAM_COLORS = {
  ATL:['#E03A3E','#C1D32F'],BOS:['#007A33','#BA9653'],BKN:['#000000','#FFFFFF'],
  CHA:['#1D1160','#00788C'],CHI:['#CE1141','#000000'],CLE:['#860038','#FDBB30'],
  DAL:['#00538C','#002B5E'],DEN:['#0E2240','#FEC524'],DET:['#C8102E','#1D42BA'],
  GSW:['#1D428A','#FFC72C'],HOU:['#CE1141','#000000'],IND:['#002D62','#FDBB30'],
  LAC:['#C8102E','#1D428A'],LAL:['#552583','#FDB927'],MEM:['#5D76A9','#12173F'],
  MIA:['#98002E','#F9A01B'],MIL:['#00471B','#EEE1C6'],MIN:['#0C2340','#236192'],
  NOP:['#0C2340','#C8102E'],NYK:['#006BB6','#F58426'],OKC:['#007AC1','#EF6100'],
  ORL:['#0077C0','#C4CED4'],PHI:['#006BB6','#ED174C'],PHX:['#1D1160','#E56020'],
  POR:['#E03A3E','#000000'],SAC:['#5A2D81','#63727A'],SAS:['#C4CED4','#000000'],
  TOR:['#CE1141','#000000'],UTA:['#002B5C','#F9A01B'],WAS:['#002B5C','#E31837']
};

// ======================== STATE ========================
let allPlayers = []; // raw parsed data
let teamLogos = {}; // team -> logo URL
let teamDraftPicks = {}; // abbrev -> [{prospect, draftRnk, capHold}]
let allProspects = []; // all prospect names from Draft Predictor
let allPickSlots = {}; // pickSlot# -> {team (abbrev), defaultProspect}
let contractsMap = {}; // playerName -> { yrs: [{sal, ch, st},...], totG }
let tradeValueMap = {}; // playerName (lowercase) -> trade value ($)
let preLotteryOrder = []; // team abbrevs in standings order (worst to best)
let STATE = null; // current GM state

// Reverse team map: abbreviation -> full name
const TEAMS_REV = {};
for (const [full, abbr] of Object.entries(TEAMS)) TEAMS_REV[abbr] = full;

const PHASES = [
  { id: 'pre_lottery', label: 'Pre-Lottery', icon: 'üìã' },
  { id: 'lottery', label: 'Draft Lottery', icon: 'üé±' },
  { id: 'pre_draft', label: 'Pre-Draft', icon: 'üèÄ' },
  { id: 'draft', label: 'Draft Night', icon: 'üéØ' },
  { id: 'pre_fa', label: 'Pre-Free Agency', icon: 'üìù' },
  { id: 'free_agency', label: 'Free Agency', icon: '‚úçÔ∏è' },
  { id: 'training_camp', label: 'Training Camp', icon: '‚õ∫' }
];

// Trade Machine base URL
const TRADE_MACHINE_URL = 'https://hoopsmatic.com';

const MIN_SALARY_2ND_RD = 1157379; // 2nd round minimum cap hold

function defaultState(team) {
  return { team, phase: 'pre_lottery', moves: [], optionDecisions: {}, renounced: new Set(), waived: new Set(), stretched: new Set(), draftSelections: {}, trades: [], signings: [], extensions: [], depthOrder: {}, lotteryResults: null, draftResults: [], draftCurrentPick: 0 };
}

function saveState() {
  if (!STATE) return;
  const s = {
    ...STATE,
    renounced: [...STATE.renounced],
    waived: [...STATE.waived],
    stretched: [...STATE.stretched]
  };
  localStorage.setItem('rm_state_' + STATE.team, JSON.stringify(s));
}

function loadState(team) {
  const raw = localStorage.getItem('rm_state_' + team);
  if (raw) {
    try {
      const s = JSON.parse(raw);
      s.renounced = new Set(s.renounced || []);
      s.waived = new Set(s.waived || []);
      s.stretched = new Set(s.stretched || []);
      s.draftSelections = s.draftSelections || {};
      s.trades = s.trades || [];
      s.signings = s.signings || [];
      s.extensions = s.extensions || [];
      s.depthOrder = s.depthOrder || {};
      s.lotteryResults = s.lotteryResults || null;
      s.draftResults = s.draftResults || [];
      s.draftCurrentPick = s.draftCurrentPick || 0;
      s.phase = s.phase || 'pre_lottery';
      return s;
    } catch(e) {}
  }
  return defaultState(team);
}

// ======================== DATA LOADING ========================
function parseMoney(s) {
  if (!s) return 0;
  const neg = s.includes('-');
  const num = parseInt(s.replace(/[$,\s()-]/g, '')) || 0;
  return neg ? -num : num;
}

function fmtMoney(n) {
  if (n === 0) return '$0';
  const abs = Math.abs(n);
  const s = abs >= 1e6 ? '$' + (abs / 1e6).toFixed(1) + 'M' : abs >= 1e3 ? '$' + (abs / 1e3).toFixed(0) + 'K' : '$' + abs;
  return n < 0 ? '-' + s : s;
}

function fmtMoneyFull(n) {
  if (n === 0) return '$0';
  const abs = Math.abs(n);
  const s = '$' + abs.toLocaleString('en-US');
  return n < 0 ? '-' + s : s;
}

async function fetchData() {
  const gid = '0';
  const urls = [
    `https://docs.google.com/spreadsheets/d/${SSID}/gviz/tq?tqx=out:csv&gid=${gid}`,
    `https://docs.google.com/spreadsheets/d/${SSID}/export?format=csv&gid=${gid}`
  ];
  for (const url of urls) {
    try {
      const r = await fetch(url);
      if (!r.ok) continue;
      const txt = await r.text();
      if (txt.includes('<!DOCTYPE') || txt.includes('<html')) continue;
      return txt;
    } catch(e) { continue; }
  }
  return null;
}

async function fetchDraftPicks() {
  const gid = '965849547';
  const urls = [
    `https://docs.google.com/spreadsheets/d/${SSID}/gviz/tq?tqx=out:csv&gid=${gid}`,
    `https://docs.google.com/spreadsheets/d/${SSID}/export?format=csv&gid=${gid}`
  ];
  for (const url of urls) {
    try {
      const r = await fetch(url);
      if (!r.ok) continue;
      const txt = await r.text();
      if (txt.includes('<!DOCTYPE') || txt.includes('<html')) continue;
      const rows = parseCSV(txt);

      // Columns: 0=Prospect name, 15=POS (pre-lottery standings rank), 16=TEAM (3-letter abbrev)
      const prospects = [];
      const pickSlots = {};
      const picks = {};

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const prospect = (row[0] || '').trim();
        const pickPos = parseInt((row[15] || '').trim()) || 0;
        const rawTeam = (row[16] || '').trim().toUpperCase();

        if (!prospect) continue;
        prospects.push(prospect);

        // First-round picks (1-30) get rookie scale cap holds
        // Second-round picks (31-60) get minimum salary cap hold
        if (pickPos < 1 || pickPos > 60 || !rawTeam) continue;
        const abbrev = rawTeam.length <= 3 ? rawTeam : (TEAMS[rawTeam] || rawTeam);
        const capHold = pickPos <= 30 ? (ROOKIE_SCALE[pickPos - 1] || 0) : MIN_SALARY_2ND_RD;

        pickSlots[pickPos] = { team: abbrev, defaultProspect: prospect };

        if (!picks[abbrev]) picks[abbrev] = [];
        picks[abbrev].push({ prospect, draftRnk: pickPos, capHold });
      }

      for (const t of Object.keys(picks)) picks[t].sort((a, b) => a.draftRnk - b.draftRnk);
      allProspects = prospects;
      allPickSlots = pickSlots;
      teamDraftPicks = picks;

      // Build pre-lottery order from picks 1-14 (column P = standings rank, 1 = worst record)
      preLotteryOrder = [];
      for (let i = 1; i <= 14; i++) {
        if (pickSlots[i]) preLotteryOrder.push(pickSlots[i].team);
      }
      console.log(`[DP] Pre-lottery order: ${preLotteryOrder.join(', ')}`);

      const totalPicks = Object.values(picks).reduce((s, arr) => s + arr.length, 0);
      console.log(`[DP] Loaded ${prospects.length} prospects, ${totalPicks} first-round picks for ${Object.keys(picks).length} teams`);
      return;
    } catch(e) { console.warn('[DP] Failed:', e); continue; }
  }
  console.warn('[DP] Could not load draft predictor data');
}

const CONTRACTS_GID = '1649473047';
const CONTRACT_YEARS = [
  { label: "'25-26", sc: 7, cc: 8, tc: 9, preFaOnly: true },
  { label: "'26-27", sc: 10, cc: 11, tc: 12 },
  { label: "'27-28", sc: 13, cc: 14, tc: 15 },
  { label: "'28-29", sc: 16, cc: 17, tc: 18 },
  { label: "'29-30", sc: 19, cc: 20, tc: 21 },
  { label: "'30-31", sc: 22, cc: 23, tc: 24 },
];

function normContractSt(s) {
  if (!s) return '';
  s = s.trim().toUpperCase();
  if (s.startsWith('GUAR')) return 'GUARANTEED';
  if (s === 'NOT G') return 'NOT G';
  if (s === 'PARTIAL G') return 'PARTIAL G';
  if (s === 'TEAM OPT') return 'TEAM OPT';
  if (s === 'PLAYER OPT') return 'PLAYER OPT';
  if (s === 'TWO-WAY') return 'TWO-WAY';
  return s;
}

async function fetchContracts() {
  contractsMap = {};
  const urls = [
    `https://docs.google.com/spreadsheets/d/${SSID}/gviz/tq?tqx=out:csv&gid=${CONTRACTS_GID}`,
    `https://docs.google.com/spreadsheets/d/${SSID}/export?format=csv&gid=${CONTRACTS_GID}`
  ];
  for (const url of urls) {
    try {
      const r = await fetch(url);
      if (!r.ok) continue;
      const txt = await r.text();
      if (txt.includes('<!DOCTYPE') || txt.includes('<html')) continue;
      const rows = parseCSV(txt);
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const name = (row[0] || '').trim();
        if (!name) continue;
        const yrs = CONTRACT_YEARS.map(yr => ({
          sal: parseMoney(row[yr.sc]),
          ch: parseMoney(row[yr.cc]),
          st: normContractSt(row[yr.tc])
        }));
        // Only store if player has at least one future year salary
        if (yrs.some(y => y.sal)) {
          contractsMap[name] = { yrs, totG: parseMoney(row[28]) };
        }
      }
      console.log(`[Contracts] Loaded ${Object.keys(contractsMap).length} players`);
      return;
    } catch(e) { console.warn('[Contracts] Failed:', e); continue; }
  }
}

const TV_GID = '1310971167';
async function fetchTradeValues() {
  tradeValueMap = {};
  const urls = [
    `https://docs.google.com/spreadsheets/d/${SSID}/gviz/tq?tqx=out:csv&gid=${TV_GID}`,
    `https://docs.google.com/spreadsheets/d/${SSID}/export?format=csv&gid=${TV_GID}`
  ];
  for (const url of urls) {
    try {
      const r = await fetch(url);
      if (!r.ok) continue;
      const txt = await r.text();
      if (txt.includes('<!DOCTYPE') || txt.includes('<html')) continue;
      const rows = parseCSV(txt);
      const roster = [], historical = []; let todayStr = null;
      for (const row of rows.slice(1)) {
        while (row.length < 22) row.push('');
        if (row[18] && !todayStr) todayStr = row[18];
        if (row[0] && row[1]) roster.push({ player: row[1].trim(), rat365: parseFloat(row[2])||0, salary: parseInt(row[3].replace(/[$,]/g,''))||0, birthday: row[4]||'', draftPick: parseInt(row[20])||null });
        if (row[6] && row[7]) { const g = parseInt(row[9])||0; if (g > 0) historical.push({ year: row[6], player: row[7].trim(), totalRat: parseFloat(row[8].replace(/,/g,''))||0, games: g }); }
      }
      const playerHist = {}; for (const h of historical) { const k = h.player.toLowerCase(); if (!playerHist[k]) playerHist[k] = []; playerHist[k].push(h); }
      const WEIGHTS = {'2025-26':1.0,'2024-25':0.6,'2023-24':0.36,'2022-23':0.216,'2021-22':0.1296};
      const EXPECTED = {'2021-22':82,'2022-23':82,'2023-24':82,'2024-25':82,'2025-26':48};
      const EXP=1.8, BETA=0.8, MAX_MULT=1.4, MIN_PCT=0.40, WM_W=0.85, RAT_W=0.15, AGE_BONUS=1.0, OLD_TH=35, OLD_PEN=0.03;
      for (const p of roster) {
        const hist = playerHist[p.player.toLowerCase()]||[]; let num=0, den=0;
        for (const h of hist) { const w = WEIGHTS[h.year]||0; if (w<=0||h.games<=0) continue; let pg = h.totalRat/h.games; const exp = EXPECTED[h.year]||82; if (h.games/exp >= MIN_PCT) pg *= Math.min(MAX_MULT, Math.pow(exp/h.games, BETA)); num += pg*w*h.games; den += w*h.games; }
        p.watermark = den > 0 ? num/den : 0;
        const cur = hist.filter(h => h.year==='2025-26'); const cg = cur.reduce((s,h) => s+h.games, 0);
        p.rat365adj = (cg > 0 && cg/48 >= MIN_PCT) ? p.rat365 * Math.min(MAX_MULT, Math.pow(48/cg, BETA)) : p.rat365;
      }
      const pd = s => { if (!s) return null; const p = s.split('/'); return p.length===3 ? new Date(+p[2],+p[0]-1,+p[1]) : null; };
      const today = pd(todayStr)||new Date(); const ages = [];
      for (const p of roster) { const bd = pd(p.birthday); p.age = bd ? (today-bd)/(365.25*864e5) : null; if (p.age) ages.push(p.age); }
      const avgAge = ages.length > 0 ? ages.reduce((a,b)=>a+b,0)/ages.length : 26;
      const maxDev = Math.max(1, avgAge - Math.min(...ages));
      for (const p of roster) {
        if (p.age!==null && p.age < avgAge) p.ageMult = 1.0 + AGE_BONUS*(avgAge-p.age)/maxDev;
        else if (p.age!==null && p.age >= OLD_TH) p.ageMult = Math.max(0.5, 1.0-OLD_PEN*(p.age-OLD_TH));
        else p.ageMult = 1.0;
      }
      const tSP = roster.reduce((s,p)=>s+p.salary,0);
      const tWM = roster.reduce((s,p)=>s+Math.pow(Math.max(p.watermark,0),EXP),0);
      const tRAT = roster.reduce((s,p)=>s+Math.pow(Math.max(p.rat365adj,0),EXP),0);
      for (const p of roster) {
        const tvWM = tWM>0 ? (Math.pow(Math.max(p.watermark,0),EXP)/tWM)*tSP : 0;
        const tvRAT = tRAT>0 ? (Math.pow(Math.max(p.rat365adj,0),EXP)/tRAT)*tSP : 0;
        p.tvWithAge = (WM_W*tvWM + RAT_W*tvRAT) * p.ageMult;
      }
      const tWA = roster.reduce((s,p)=>s+p.tvWithAge,0);
      for (const p of roster) {
        const baseTV = tWA>0 ? Math.round((p.tvWithAge/tWA)*tSP) : 0; let bonus = 0;
        if (p.age!==null && p.age<25 && p.draftPick && p.draftPick>=1 && p.draftPick<=60) { bonus = Math.round(7e6 * Math.exp(-0.05*(p.draftPick-1)) * Math.exp(-0.5*Math.max(0,p.age-18.82))); }
        tradeValueMap[p.player.toLowerCase()] = baseTV+bonus;
      }
      console.log(`[TV] Loaded ${Object.keys(tradeValueMap).length} trade values`);
      return;
    } catch(e) { console.warn('[TV] Failed:', e); continue; }
  }
}

function parseCSV(text) {
  const rows = []; let row = []; let cell = ''; let inQ = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (inQ) {
      if (c === '"' && text[i+1] === '"') { cell += '"'; i++; }
      else if (c === '"') inQ = false;
      else cell += c;
    } else {
      if (c === '"') inQ = true;
      else if (c === ',') { row.push(cell); cell = ''; }
      else if (c === '\n' || c === '\r') {
        if (c === '\r' && text[i+1] === '\n') i++;
        row.push(cell); cell = '';
        if (row.some(c => c.trim())) rows.push(row);
        row = [];
      } else cell += c;
    }
  }
  if (cell || row.length) { row.push(cell); if (row.some(c => c.trim())) rows.push(row); }
  return rows;
}

function parseAllPlayers(csv) {
  const rows = parseCSV(csv);
  const players = [];
  // Header-based lookup for EXT_ELIGIBLE column
  const headers = rows[0] || [];
  const extColIdx = headers.findIndex(h => (h || '').trim().toUpperCase() === 'EXT_ELIGIBLE');
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const name = (r[0] || '').trim();
    const team = (r[2] || '').trim();
    if (!name || !team || !TEAMS[team]) continue;

    const sal26 = parseMoney(r[3]);
    const ch26 = parseMoney(r[4]);
    const st26 = (r[5] || '').trim();
    const sal27 = parseMoney(r[6]);
    const ch27 = parseMoney(r[7]);
    const st27 = (r[8] || '').trim();
    const contractType = (r[1] || '').trim();
    const exception = (r[20] || '').trim();

    // Skip 10-day contract players ‚Äî they won't be on the offseason roster
    const is10Day = /10.?day/i.test(contractType) || /10.?day/i.test(exception) || /10.?day/i.test(st26);
    if (is10Day) continue;
    const logo = (r[24] || '').trim();
    const headshot = (r[25] || '').trim();
    const pos = (r[26] || '').trim();
    const age = (r[27] || '').trim();
    const end = parseInt((r[29] || '').trim()) || 0;
    const totalGuar = parseMoney(r[30]);
    const tradeKicker = parseFloat((r[31] || '').trim()) || 0;
    const rat365 = parseFloat((r[11] || '').trim()) || 0;
    const extEligible = extColIdx >= 0 ? (r[extColIdx] || '').trim() : '';

    if (logo && team) teamLogos[team] = logo;

    // Determine player category for 2026-27 offseason
    // Two-way players are treated as regular roster players
    let category, capHold = 0;
    if (!sal27 && !st27) {
      // No 2026-27 salary = expiring (or two-way expiring), becomes free agent
      category = 'free_agent';
      capHold = calcCapHold(sal26, exception);
    } else if (st27 === 'TEAM OPT') {
      category = 'team_option';
    } else if (st27 === 'PLAYER OPT') {
      category = 'player_option';
    } else if (st27 === 'NOT G') {
      category = 'non_guaranteed';
    } else if (st27 === 'PARTIAL G') {
      category = 'partial_guaranteed';
    } else {
      category = 'under_contract'; // GUARANTEED or TWO-WAY with sal27
    }
    
    // Track if originally a two-way for badge display
    const isTwoWay = (st26 === 'TWO-WAY' || st27 === 'TWO-WAY');

    players.push({
      name, team, sal26, ch26, st26, sal27, ch27, st27,
      exception, logo, headshot, pos, age, end, totalGuar, tradeKicker,
      category, capHold, extEligible, rat365, isTwoWay,
      tv: tradeValueMap[name.toLowerCase()] || 0
    });
  }
  return players;
}

function calcCapHold(priorSalary, exception) {
  const maxSalary = Math.round(T.cap * 0.35); // absolute max for any player
  if (!priorSalary) return MIN_SALARY_CAP_HOLD;
  let hold;
  const exc = exception.toLowerCase();
  if (exc.includes('bird') && !exc.includes('early') && !exc.includes('non')) {
    hold = Math.round(priorSalary * (priorSalary > EST_AVG_SALARY ? 2.50 : 1.90));
  } else if (exc.includes('early bird')) {
    hold = Math.max(Math.round(priorSalary * 1.90), Math.round(EST_AVG_SALARY * 1.30));
  } else if (exc.includes('non-bird') || exc.includes('non bird')) {
    hold = Math.max(Math.round(priorSalary * 1.50), MIN_SALARY_CAP_HOLD);
  } else if (exc.includes('minimum')) {
    hold = MIN_SALARY_CAP_HOLD;
  } else if (exc.includes('mid-level') || exc.includes('taxpayer') || exc.includes('room')) {
    hold = Math.max(Math.round(priorSalary * 1.50), MIN_SALARY_CAP_HOLD);
  } else if (exc.includes('rookie')) {
    hold = Math.round(priorSalary * 1.90);
  } else {
    hold = Math.max(Math.round(priorSalary * 1.50), MIN_SALARY_CAP_HOLD);
  }
  return Math.min(hold, maxSalary);
}

// ======================== CAP ENGINE ========================
function calcCapSheet(team) {
  const players = allPlayers.filter(p => p.team === team);
  let activeSalaries = 0, capHolds = 0, deadMoney = 0;
  let rosterCount = 0;

  // Build set of traded-out player names
  const tradedOut = new Set();
  const tradedIn = []; // {name, salary, pos, fromTeam}
  for (const trade of (STATE.trades || [])) {
    for (const p of (trade.out || [])) tradedOut.add(p.name);
    for (const p of (trade.in || [])) tradedIn.push(p);
  }

  const roster = { under_contract: [], free_agent: [], non_guaranteed: [], partial_guaranteed: [], waived: [], draft_picks: [], signed: [] };

  for (const p of players) {
    // Skip traded-out players
    if (tradedOut.has(p.name)) continue;

    const waived = STATE.waived.has(p.name);
    const renounced = STATE.renounced.has(p.name);
    const optDecision = STATE.optionDecisions[p.name]; // 'pickup','exercise','decline'

    // === WAIVED ===
    if (waived) {
      let dead = 0;
      const isStretched = STATE.stretched.has(p.name);
      const wasPickedUp = STATE.optionDecisions[p.name] === 'pickup' || STATE.optionDecisions[p.name] === 'exercise';
      if (p.category === 'under_contract' || p.st27 === 'GUARANTEED' || wasPickedUp) {
        dead = p.sal27; // full guaranteed salary
      } else if (p.category === 'partial_guaranteed') {
        dead = p.ch27; // guaranteed portion
      }
      // Stretch provision: divide over (2*remaining_years + 1)
      if (isStretched && dead > 0) {
        const remainingYrs = Math.max(1, (p.end || 2027) - 2026);
        const stretchPeriod = 2 * remainingYrs + 1;
        dead = Math.round(dead / stretchPeriod);
      }
      if (dead) deadMoney += dead;
      roster.waived.push({ ...p, status: 'waived', deadAmount: dead, isStretched });
      continue;
    }

    // === TEAM OPTION ===
    if (p.category === 'team_option') {
      if (optDecision === 'pickup') {
        activeSalaries += p.sal27;
        rosterCount++;
        roster.under_contract.push({ ...p, status: 'picked_up', fromOption: 'TO' });
      } else if (optDecision === 'decline') {
        const hold = calcCapHold(p.sal26, p.exception);
        if (renounced) {
          roster.free_agent.push({ ...p, status: 'renounced', capHold: hold, fromOption: 'TO' });
        } else {
          capHolds += hold;
          roster.free_agent.push({ ...p, status: 'held', capHold: hold, fromOption: 'TO' });
        }
      } else {
        // Pending ‚Äî count salary provisionally
        activeSalaries += p.sal27;
        rosterCount++;
        roster.under_contract.push({ ...p, status: 'pending_to' });
      }
      continue;
    }

    // === PLAYER OPTION ===
    if (p.category === 'player_option') {
      if (optDecision === 'exercise') {
        activeSalaries += p.sal27;
        rosterCount++;
        roster.under_contract.push({ ...p, status: 'exercised', fromOption: 'PO' });
      } else if (optDecision === 'decline') {
        const hold = calcCapHold(p.sal26, p.exception);
        if (renounced) {
          roster.free_agent.push({ ...p, status: 'renounced', capHold: hold, fromOption: 'PO' });
        } else {
          capHolds += hold;
          roster.free_agent.push({ ...p, status: 'held', capHold: hold, fromOption: 'PO' });
        }
      } else {
        activeSalaries += p.sal27;
        rosterCount++;
        roster.under_contract.push({ ...p, status: 'pending_po' });
      }
      continue;
    }

    // === FREE AGENT ===
    if (p.category === 'free_agent') {
      if (renounced) {
        roster.free_agent.push({ ...p, status: 'renounced' });
      } else {
        capHolds += p.capHold;
        roster.free_agent.push({ ...p, status: 'held' });
      }
      continue;
    }

    // === NON-GUARANTEED ===
    if (p.category === 'non_guaranteed') {
      activeSalaries += p.sal27;
      rosterCount++;
      roster.non_guaranteed.push({ ...p, status: 'active' });
      continue;
    }

    // === PARTIAL GUARANTEED ===
    if (p.category === 'partial_guaranteed') {
      activeSalaries += p.sal27;
      rosterCount++;
      roster.partial_guaranteed.push({ ...p, status: 'active' });
      continue;
    }

    // === UNDER CONTRACT (GUARANTEED) ===
    activeSalaries += p.sal27;
    rosterCount++;
    roster.under_contract.push({ ...p, status: 'active' });
  }

  // Incomplete roster charge: if < 12 standard contracts, add minimum cap hold per empty slot
  const incompleteCharge = rosterCount < 12 ? (12 - rosterCount) * MIN_SALARY_CAP_HOLD : 0;

  // === DRAFT PICKS ===
  const teamAbbrev = TEAMS[team];
  const picks = teamDraftPicks[teamAbbrev] || [];
  let draftCapHolds = 0;
  for (const pick of picks) {
    if (STATE.renounced.has('PICK_' + pick.draftRnk)) continue;
    draftCapHolds += pick.capHold;
    const selectedProspect = (STATE.draftSelections && STATE.draftSelections[pick.draftRnk]) || pick.prospect;
    roster.draft_picks.push({ ...pick, selectedProspect });
  }
  capHolds += draftCapHolds;

  // === TRADED-IN PLAYERS ===
  for (const tp of tradedIn) {
    activeSalaries += tp.salary;
    rosterCount++;
    roster.under_contract.push({
      name: tp.name, sal27: tp.salary, pos: tp.pos || '', headshot: tp.headshot || '',
      exception: tp.exception || '', st27: 'GUARANTEED', status: 'traded_in', fromTeam: tp.fromTeam,
      end: tp.end || 0, tradeKicker: 0, tv: tradeValueMap[tp.name.toLowerCase()] || 0,
      isSAT: tp.isSAT, years: tp.years, contractType: tp.contractType
    });
  }

  // === SIGNINGS (Free Agency) ===
  for (const sig of (STATE.signings || [])) {
    if (STATE.waived.has(sig.name)) {
      // Waived after signing ‚Äî dead cap depends on contract type
      let dead = 0;
      if (sig.contractType === 'two-way' || sig.contractType === 'exhibit-10' || sig.contractType === 'non-guaranteed') {
        dead = 0; // No dead cap for two-way, Exhibit 10, or non-guaranteed
      } else if (sig.contractType === 'partial-guaranteed') {
        dead = Math.round(sig.salary * (sig.guaranteedPct || 0) / 100);
      } else {
        dead = sig.salary; // Guaranteed = full dead cap
      }
      if (dead > 0) deadMoney += dead;
      roster.waived.push({
        name: sig.name, sal27: sig.salary, sal26: sig.salary, pos: sig.pos || '', headshot: sig.headshot || '',
        exception: sig.exception, st27: sig.contractType === 'non-guaranteed' ? 'NOT G' : sig.contractType === 'two-way' ? 'TWO-WAY' : 'GUARANTEED',
        status: 'waived', deadAmount: dead, isStretched: false, tv: tradeValueMap[sig.name.toLowerCase()] || 0,
        contractType: sig.contractType
      });
      continue;
    }
    // Two-way players don't count against cap or roster limit (separate 3-slot roster)
    if (sig.contractType === 'two-way') {
      roster.signed.push({
        name: sig.name, sal27: sig.salary, pos: sig.pos || '', headshot: sig.headshot || '',
        exception: sig.exception, st27: 'TWO-WAY', status: 'signed', isTwoWay: true,
        end: sig.end || 2027, tradeKicker: 0, tv: tradeValueMap[sig.name.toLowerCase()] || 0,
        contractType: sig.contractType, _signed: true
      });
      continue;
    }
    activeSalaries += sig.salary;
    rosterCount++;
    const st27Label = sig.contractType === 'non-guaranteed' ? 'NOT G'
      : sig.contractType === 'partial-guaranteed' ? 'PARTIAL G'
      : sig.contractType === 'exhibit-10' ? 'NOT G'
      : 'GUARANTEED';
    roster.signed.push({
      name: sig.name, sal27: sig.salary, pos: sig.pos || '', headshot: sig.headshot || '',
      exception: sig.exception, st27: st27Label, status: 'signed',
      end: sig.end || 2027, tradeKicker: 0, tv: tradeValueMap[sig.name.toLowerCase()] || 0,
      contractType: sig.contractType, isSignAndTrade: sig.isSignAndTrade, _signed: true
    });
  }

  const teamSalary = activeSalaries + capHolds + deadMoney + incompleteCharge;
  const capSpace = T.cap - teamSalary;
  const taxRoom = T.tax - teamSalary;
  const apron1Room = T.apron1 - teamSalary;
  const apron2Room = T.apron2 - teamSalary;

  const hasCapSpace = capSpace > 0;
  const belowTax = taxRoom > 0;
  const belowApron1 = apron1Room > 0;
  const belowApron2 = apron2Room > 0;

  // Track exception usage from signings
  const excUsage = {};
  for (const sig of (STATE.signings || [])) {
    const exc = sig.exception || 'Unknown';
    excUsage[exc] = (excUsage[exc] || 0) + sig.salary;
  }

  // Determine if team is hard-capped (used Non-Tax MLE ‚Üí capped at 1st apron)
  const usedNTMLE = (excUsage['Non-Tax MLE'] || 0) > 0;
  const isHardCapped = usedNTMLE;

  const exceptions = [];
  if (hasCapSpace) {
    exceptions.push({ name: 'Cap Space', amount: capSpace, available: true });
    exceptions.push({ name: 'Room MLE', amount: T.rmle, available: true });
  } else {
    exceptions.push({ name: 'Cap Space', amount: 0, available: false });
  }
  // MLE logic per 2023 CBA:
  // Below 1st apron: Non-Tax MLE available (using it hard-caps at 1st apron)
  // Between 1st and 2nd apron: Tax MLE available (no hard cap)
  // Above 2nd apron: No MLE at all
  if (!hasCapSpace) {
    if (belowApron1) {
      // Check if hard-capped and signing would breach apron
      exceptions.push({ name: 'Non-Tax MLE', amount: T.ntmle, available: true, hardCapNote: '‚ö†Ô∏è Hard-caps team at 1st apron' });
    } else if (belowApron2) {
      exceptions.push({ name: 'Non-Tax MLE', amount: T.ntmle, available: false });
      exceptions.push({ name: 'Tax MLE', amount: T.tmle, available: true });
    } else {
      // Above 2nd apron: no MLE
      exceptions.push({ name: 'Non-Tax MLE', amount: T.ntmle, available: false });
      exceptions.push({ name: 'Tax MLE', amount: T.tmle, available: false });
    }
  }
  // BAE: available when over cap and below 2nd apron
  if (!hasCapSpace) {
    if (belowApron2) {
      exceptions.push({ name: 'BAE', amount: T.bae, available: true });
    } else {
      exceptions.push({ name: 'BAE', amount: T.bae, available: false });
    }
  }
  exceptions.push({ name: 'Minimum', amount: MIN_SALARY_0YOS, available: true });
  // Two-Way: up to 3 two-way contracts per team (don't count against cap)
  const twoWayCount = (STATE.signings || []).filter(s => s.contractType === 'two-way').length
    + players.filter(p => p.isTwoWay && !STATE.waived.has(p.name) && !tradedOut.has(p.name)).length;
  exceptions.push({ name: 'Two-Way', amount: MIN_SALARY_0YOS, available: twoWayCount < 3, note: `${twoWayCount}/3 used` });
  // Exhibit 10 (training camp only)
  if (STATE.phase === 'training_camp') {
    exceptions.push({ name: 'Exhibit 10', amount: MIN_SALARY_0YOS, available: true, note: '$100K bonus' });
  }
  // Sign-and-Trade: always available for other teams' FAs (original team signs with Bird rights)
  const MAX_SAT_SALARY = Math.round(T.cap * 0.35);
  exceptions.push({ name: 'Sign-and-Trade', amount: MAX_SAT_SALARY, available: true, note: 'Max 4yr ¬∑ Hard-caps at 1st apron', isSAT: true });

  for (const exc of exceptions) {
    const used = excUsage[exc.name] || 0;
    if (used > 0) {
      exc.used = used;
      exc.remaining = Math.max(0, exc.amount - used);
    }
  }

  // If hard-capped, check how much room left under apron1
  const hardCapRoom = isHardCapped ? (T.apron1 - teamSalary) : Infinity;

  return {
    roster, activeSalaries, capHolds, deadMoney, incompleteCharge, draftCapHolds,
    teamSalary, capSpace, taxRoom, apron1Room, apron2Room,
    rosterCount, exceptions, hasCapSpace, belowTax, belowApron1, belowApron2,
    isHardCapped, hardCapRoom
  };
}

// ======================== RENDERING ========================
function renderTeamDropdown() {
  const sel = document.getElementById('teamSelect');
  const sorted = Object.entries(TEAMS).sort((a,b) => a[0].localeCompare(b[0]));
  sel.innerHTML = '<option value="">Select team...</option>';
  for (const [full, abbr] of sorted) {
    const opt = document.createElement('option');
    opt.value = full;
    opt.textContent = `${abbr} ‚Äî ${full}`;
    if (STATE && STATE.team === full) opt.selected = true;
    sel.appendChild(opt);
  }
}

function applyTeamTheme(team) {
  const abbr = TEAMS[team] || '';
  const colors = TEAM_COLORS[abbr] || ['#3b82f6','#2563eb'];
  const root = document.documentElement.style;
  root.setProperty('--team1', colors[0]);
  root.setProperty('--team2', colors[1]);
  root.setProperty('--team1-dim', colors[0] + '18');
  root.setProperty('--team2-dim', colors[1] + '18');
  root.setProperty('--team1-glow', colors[0] + '30');
  root.setProperty('--team2-glow', colors[1] + '30');
  // Meta theme-color for mobile
  const meta = document.querySelector('meta[name="theme-color"]');
  if (meta) meta.content = colors[0];
}

function selectTeam(team) {
  if (_draftAnimTimer) { clearInterval(_draftAnimTimer); _draftAnimTimer = null; }
  STATE = loadState(team);
  applyTeamTheme(team);
  document.getElementById('teamSelect').value = team;
  document.getElementById('appContent').style.display = 'block';
  // Re-apply lottery results if they exist
  if (STATE.lotteryResults) applyLotteryResults(STATE.lotteryResults);
  // Team banner (simplified - main info is in header now)
  const abbr = TEAMS[team] || '';
  const logo = teamLogos[team] || '';
  const banner = document.getElementById('teamBanner');
  banner.innerHTML = '';
  // Update header team info
  const hdrTeam = document.getElementById('hdrTeamInfo');
  hdrTeam.innerHTML = `${logo ? `<img src="${logo}" alt="${abbr}">` : ''}<div><div class="hdr-team-name">${team}</div><div class="hdr-team-sub">${abbr} ¬∑ 2026-27</div></div>`;
  hdrTeam.style.display = 'flex';
  // Update breadcrumb
  updateBreadcrumb();
  render();
}

function updateBreadcrumb() {
  const el = document.getElementById('hdrBreadcrumb');
  if (!el || !STATE) return;
  const abbr = TEAMS[STATE.team] || '';
  const phaseLabel = PHASES.find(p => p.id === STATE.phase)?.label || '';
  el.innerHTML = `${STATE.team} <span style="opacity:.5">‚Ä∫</span> ${phaseLabel}`;
}

function render() {
  if (!STATE) return;
  updateBreadcrumb();
  renderPhaseBar();
  if (STATE.phase === 'lottery') {
    renderLottery();
    const cap = calcCapSheet(STATE.team);
    renderCapPanel(cap);
    updateHeaderCapBar(cap);
  } else if (STATE.phase === 'draft') {
    renderDraftBoard();
    const cap = calcCapSheet(STATE.team);
    renderCapPanel(cap);
    updateHeaderCapBar(cap);
  } else {
    const cap = calcCapSheet(STATE.team);
    renderRoster(cap);
    renderCapPanel(cap);
    updateHeaderCapBar(cap);
  }
}

function updateHeaderCapBar(cap) {
  const el = document.getElementById('hdrCapMini');
  if (!el || !cap) return;
  const pct = Math.min(100, (cap.teamSalary / T.apron2) * 100);
  const color = cap.teamSalary > T.apron2 ? 'var(--red)' : cap.teamSalary > T.apron1 ? 'var(--orange)' : cap.teamSalary > T.tax ? 'var(--yellow)' : '#4caf50';
  el.innerHTML = `
    <div class="cap-mini-label"><span>Cap Usage</span><span>${fmtMoney(cap.teamSalary)}</span></div>
    <div class="cap-mini-bar"><div class="cap-mini-fill" style="width:${pct}%;background:${color}"></div></div>
    <div class="cap-mini-vals"><span>Cap: ${fmtMoney(T.cap)}</span><span>Tax: ${fmtMoney(T.tax)}</span></div>`;
  el.style.display = 'flex';
}

function renderPhaseBar() {
  const bar = document.getElementById('phaseBar');
  const currentIdx = PHASES.findIndex(p => p.id === STATE.phase);
  let h = '';
  PHASES.forEach((phase, i) => {
    if (i > 0) h += `<span class="phase-arrow">‚ñ∂</span>`;
    const cls = i === currentIdx ? 'active' : i < currentIdx ? 'completed' : 'locked';
    h += `<div class="phase-step ${cls}" onclick="${i <= currentIdx ? `setPhase('${phase.id}')` : ''}">${phase.icon} ${phase.label}</div>`;
  });
  if (currentIdx < PHASES.length - 1) {
    const next = PHASES[currentIdx + 1];
    h += `<button class="phase-advance" onclick="advancePhase()">Proceed to ${next.label} ‚Üí</button>`;
  }
  bar.innerHTML = h;
}

// =============== DEPTH CHART HELPERS ===============
function getDepthPlayers(cap) {
  const players = [];
  for (const p of cap.roster.under_contract) players.push(p);
  for (const p of cap.roster.non_guaranteed) players.push(p);
  for (const p of cap.roster.partial_guaranteed) players.push(p);
  for (const p of cap.roster.signed) players.push({...p, _signed: true});
  return players;
}

function posOf(p) {
  const raw = (p.pos || 'SF').split('-')[0].split('/')[0].trim().toUpperCase();
  return ['PG','SG','SF','PF','C'].includes(raw) ? raw : 'SF';
}

function buildDepthPositions(players) {
  const POS = ['PG','SG','SF','PF','C'];
  const ALGO_VERSION = 3; // bump this to invalidate saved orders
  const saved = STATE.depthOrder || {};

  // Only use saved order if it was made with current algorithm
  if (saved._v === ALGO_VERSION && Object.keys(saved).length > 1) {
    const byPos = {}; POS.forEach(p => byPos[p] = []);
    const pm = {}; players.forEach(p => pm[p.name] = p);
    const placed = new Set();
    POS.forEach(pos => {
      if (saved[pos]) saved[pos].forEach(n => {
        if (pm[n] && !placed.has(n)) { byPos[pos].push(pm[n]); placed.add(n); }
      });
    });
    players.forEach(p => { if (!placed.has(p.name)) byPos[posOf(p)].push(p); });
    return byPos;
  }

  // === ROW-BY-ROW PLACEMENT ===
  // Fill starters (row 1) across all 5 positions first, then 2nd unit, then 3rd.
  // For each open slot, pick the highest-TV remaining player who can play that position.
  // This guarantees higher-TV players always land in higher rows.
  const ADJ = { PG:['SG'], SG:['PG','SF'], SF:['SG','PF'], PF:['SF','C'], C:['PF'] };
  const remaining = [...players].sort((a,b) => (b.tv||0) - (a.tv||0));
  const byPos = {}; POS.forEach(p => byPos[p] = []);
  const maxRows = Math.ceil(players.length / 5);

  for (let row = 0; row < maxRows; row++) {
    // For each position in this row, find best available player
    const rowPicks = [];
    for (const pos of POS) {
      // Find highest-TV remaining player whose natural or adjacent includes this position
      let bestIdx = -1, bestTV = -1;
      for (let i = 0; i < remaining.length; i++) {
        const p = remaining[i];
        const nat = posOf(p);
        const valid = [nat, ...ADJ[nat]];
        if (valid.includes(pos) && (p.tv||0) > bestTV) {
          bestTV = p.tv||0;
          bestIdx = i;
        }
      }
      if (bestIdx >= 0) {
        rowPicks.push({ pos, idx: bestIdx, tv: bestTV });
      }
    }
    // Assign picks ‚Äî but each player can only go to one position.
    // Sort picks by TV ascending so we process lowest first;
    // if a player is best for multiple positions, they go to the one
    // where they're most needed (handled by processing order).
    // Actually: process positions that have fewer candidates first to avoid conflicts.
    const used = new Set();
    // Sort: positions with fewer valid remaining candidates first (most constrained)
    rowPicks.sort((a,b) => {
      const countA = remaining.filter(p => !used.has(p) && [posOf(p), ...ADJ[posOf(p)]].includes(a.pos)).length;
      const countB = remaining.filter(p => !used.has(p) && [posOf(p), ...ADJ[posOf(p)]].includes(b.pos)).length;
      return countA - countB;
    });
    for (const pick of rowPicks) {
      // Re-find best for this position among unused
      let bestP = null, bestTV = -1, bestRI = -1;
      for (let i = 0; i < remaining.length; i++) {
        const p = remaining[i];
        if (used.has(p)) continue;
        const nat = posOf(p);
        const valid = [nat, ...ADJ[nat]];
        if (valid.includes(pick.pos) && (p.tv||0) > bestTV) {
          bestTV = p.tv||0;
          bestP = p;
          bestRI = i;
        }
      }
      if (bestP) {
        byPos[pick.pos].push(bestP);
        used.add(bestP);
        remaining.splice(bestRI, 1);
      }
    }
  }
  // Any leftover (shouldn't happen but safety)
  for (const p of remaining) byPos[posOf(p)].push(p);

  // Clear stale order
  STATE.depthOrder = {};
  saveState();

  return byPos;
}

function saveDepthOrder() {
  const cols = document.querySelectorAll('.pos-col');
  const order = { _v: 3 };
  cols.forEach(col => {
    const pos = col.dataset.position;
    order[pos] = [];
    col.querySelectorAll('.dc-card').forEach(card => {
      order[pos].push(card.dataset.player);
    });
  });
  STATE.depthOrder = order;
  saveState();
}

function dcBadge(p) {
  if (p.status === 'pending_to') return '<span class="dc-opt-badge to">TO</span>';
  if (p.status === 'pending_po') return '<span class="dc-opt-badge po">PO</span>';
  if (p.status === 'picked_up') return '<span class="dc-opt-badge" style="background:rgba(52,199,89,.15);color:var(--green)">‚úìTO</span>';
  if (p.status === 'exercised') return '<span class="dc-opt-badge" style="background:rgba(52,199,89,.15);color:var(--green)">‚úìPO</span>';
  if (p._signed && p.isSignAndTrade) return '<span class="dc-opt-badge" style="background:rgba(0,199,190,.15);color:var(--cyan)">S&T</span>';
  if (p.status === 'traded_in' && p.isSAT) return '<span class="dc-opt-badge" style="background:rgba(0,199,190,.15);color:var(--cyan)">S&T</span>';
  if (p._signed && p.contractType === 'exhibit-10') return '<span class="dc-opt-badge" style="background:rgba(110,110,115,.15);color:var(--muted)">E10</span>';
  if (p._signed) return '<span class="dc-opt-badge signed">FA</span>';
  if (p.status === 'traded_in') return '<span class="dc-opt-badge traded">TRD</span>';
  if (p.isTwoWay || p.contractType === 'two-way') return '<span class="dc-opt-badge" style="background:rgba(110,110,115,.15);color:var(--muted)">2W</span>';
  if (p.category === 'non_guaranteed' || p.contractType === 'non-guaranteed') return '<span class="dc-opt-badge ng">NG</span>';
  if (p.category === 'partial_guaranteed' || p.contractType === 'partial-guaranteed') return '<span class="dc-opt-badge pg">PG</span>';
  return '';
}

function dcActions(p) {
  const phase = STATE.phase;
  let h = '';
  // Option decisions
  if (p.status === 'pending_to' && (phase === 'pre_lottery' || phase === 'pre_draft' || phase === 'pre_fa')) {
    h += `<button class="dc-btn opt" onclick="event.stopPropagation();doOption('${esc(p.name)}','pickup')">Pick Up</button>`;
    h += `<button class="dc-btn waive" onclick="event.stopPropagation();doOption('${esc(p.name)}','decline')">Decline</button>`;
    return h;
  }
  if (p.status === 'pending_po' && (phase === 'pre_lottery' || phase === 'pre_draft' || phase === 'pre_fa')) {
    h += `<button class="dc-btn opt" onclick="event.stopPropagation();doOption('${esc(p.name)}','exercise')">Exercise</button>`;
    h += `<button class="dc-btn waive" onclick="event.stopPropagation();doOption('${esc(p.name)}','decline')">Decline</button>`;
    return h;
  }
  // Waive (not during draft)
  if (phase !== 'draft' && (p.status === 'active' || p.status === 'picked_up' || p.status === 'exercised' || p.status === 'traded_in' || p.status === 'signed')) {
    h += `<button class="dc-btn waive" onclick="event.stopPropagation();openWaiveModal('${esc(p.name)}')">Waive</button>`;
  }
  // Trade
  if (phase !== 'draft' && (p.status === 'active' || p.status === 'picked_up' || p.status === 'exercised' || p.status === 'traded_in' || p.status === 'signed')) {
    h += `<button class="dc-btn trade" onclick="event.stopPropagation();openTradeModal('${esc(p.name)}')">Trade</button>`;
  }
  // Extend
  if ((phase === 'pre_lottery' || phase === 'pre_draft' || phase === 'pre_fa') && (p.status === 'active' || p.status === 'picked_up' || p.status === 'exercised') && p.extEligible) {
    if (!(STATE.extensions || []).some(e => e.name === p.name)) {
      h += `<button class="dc-btn opt" onclick="event.stopPropagation();openExtModal('${esc(p.name)}')">Ext</button>`;
    }
  }
  // Extension badge
  const ext = (STATE.extensions || []).find(e => e.name === p.name);
  if (ext) h += `<span style="font-size:.45rem;color:var(--accent);font-weight:700">EXT thru ${ext.endYear}</span>`;
  return h;
}

function dcCard(p) {
  const ini = p.name.split(' ').map(w => w[0]).join('');
  const esc = p.name.replace(/'/g, "\\'");
  const hs = p.headshot
    ? `<img class="dc-hs" src="${p.headshot}" onerror="this.outerHTML='<div class=dc-ini>${ini}</div>'">`
    : `<div class="dc-ini">${ini}</div>`;
  return `<div class="dc-card" draggable="true" data-player="${p.name}" onmouseenter="showPlayerCard(event,'${esc}')" onmouseleave="hidePlayerCard()">
    ${dcBadge(p)}
    <div class="dc-top">${hs}<div class="dc-name">${p.name}</div><div class="dc-sal">${fmtMoney(p.sal27 || 0)}</div></div>
    <div class="dc-actions">${dcActions(p)}</div></div>`;
}

// =============== CONTRACT TABLE ===============
function contractSalCell(yr) {
  if (!yr || (!yr.sal && !yr.st)) return '<td><span style="color:var(--muted)">‚Äî</span></td>';
  const cls = {'GUARANTEED':'sal-g','PARTIAL G':'sal-pg','NOT G':'sal-ng','TEAM OPT':'sal-to','PLAYER OPT':'sal-po','TWO-WAY':'sal-g','TO':'sal-to','PO':'sal-po','ETO':'sal-po'}[yr.st] || 'sal-g';
  let inner = `<span class="${cls}">${fmtMoney(yr.sal)}</span>`;
  if (yr.st === 'PARTIAL G' && yr.ch && yr.ch !== yr.sal) inner += `<div style="font-size:.55rem;color:var(--yellow)">G: ${fmtMoney(yr.ch)}</div>`;
  else if (yr.st === 'NOT G') inner += `<div style="font-size:.55rem;color:var(--red)">G: ${yr.ch ? fmtMoney(yr.ch) : '$0'}</div>`;
  else if (yr.st === 'PLAYER OPT' || yr.st === 'PO') inner += `<div style="font-size:.55rem;color:var(--cyan)">PO</div>`;
  else if (yr.st === 'TEAM OPT' || yr.st === 'TO') inner += `<div style="font-size:.55rem;color:var(--orange)">TO</div>`;
  else if (yr.st === 'ETO') inner += `<div style="font-size:.55rem;color:var(--cyan)">ETO</div>`;
  return `<td>${inner}</td>`;
}

// =============== LOTTERY ===============
const LOTTERY_ODDS = [140, 140, 140, 125, 105, 90, 75, 60, 45, 30, 20, 15, 10, 5]; // per 1000

function getLotteryTeams() {
  if (preLotteryOrder.length >= 14) {
    return preLotteryOrder.slice(0, 14).map((team, i) => ({ team, originalSlot: i + 1 }));
  }
  const teams = [];
  for (let i = 1; i <= 14; i++) {
    const slot = allPickSlots[i];
    if (slot) teams.push({ team: slot.team, originalSlot: i });
  }
  return teams;
}

// Generate all C(14,4) = 1001 combinations
function generateAllCombinations() {
  const combos = [];
  for (let a = 1; a <= 11; a++)
    for (let b = a+1; b <= 12; b++)
      for (let c = b+1; c <= 13; c++)
        for (let d = c+1; d <= 14; d++)
          combos.push([a, b, c, d]);
  return combos; // 1001 combos
}

// Assign 1000 combinations to 14 teams (one combo unassigned)
function assignCombinations(teams) {
  const allCombos = generateAllCombinations();
  // Shuffle combinations randomly
  for (let i = allCombos.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [allCombos[i], allCombos[j]] = [allCombos[j], allCombos[i]];
  }
  const assignments = new Map(); // combo key ‚Üí team index
  const teamCombos = teams.map(() => []);
  let idx = 0;
  for (let t = 0; t < teams.length; t++) {
    const count = LOTTERY_ODDS[t];
    for (let c = 0; c < count && idx < allCombos.length; c++, idx++) {
      const key = allCombos[idx].join('-');
      assignments.set(key, t);
      teamCombos[t].push(allCombos[idx]);
    }
  }
  // The 1001st combo (idx=1000) is unassigned
  return { assignments, teamCombos, allCombos };
}

// Filter combinations still possible given drawn balls
function filterCombos(combos, drawnBalls) {
  if (!drawnBalls.length) return combos;
  return combos.filter(c => drawnBalls.every(b => c.includes(b)));
}

// ===== LOTTERY SIMULATION (weighted random, used by both modes) =====
function runLotterySimulation() {
  const lotteryTeams = getLotteryTeams();
  if (lotteryTeams.length < 14) return null;
  const remaining = lotteryTeams.map((t, i) => ({ ...t, weight: LOTTERY_ODDS[i] }));
  const results = [];
  for (let pick = 1; pick <= 4; pick++) {
    const totalW = remaining.reduce((s, t) => s + t.weight, 0);
    let rand = Math.random() * totalW;
    let winner;
    for (const t of remaining) { rand -= t.weight; if (rand <= 0) { winner = t; break; } }
    if (!winner) winner = remaining[remaining.length - 1];
    results.push({ pick, team: winner.team, originalSlot: winner.originalSlot });
    remaining.splice(remaining.indexOf(winner), 1);
  }
  remaining.sort((a, b) => a.originalSlot - b.originalSlot);
  for (let i = 0; i < remaining.length; i++) {
    results.push({ pick: 5 + i, team: remaining[i].team, originalSlot: remaining[i].originalSlot });
  }
  return results;
}

function applyLotteryResults(results) {
  if (!results) return;
  for (const r of results) {
    if (allPickSlots[r.pick]) {
      allPickSlots[r.pick] = { ...allPickSlots[r.pick], team: r.team };
    }
  }
  const picks = {};
  for (const [slot, info] of Object.entries(allPickSlots)) {
    const s = parseInt(slot);
    if (s < 1 || s > 60) continue;
    if (!picks[info.team]) picks[info.team] = [];
    const capHold = s <= 30 ? (ROOKIE_SCALE[s - 1] || 0) : MIN_SALARY_2ND_RD;
    picks[info.team].push({ prospect: info.defaultProspect, draftRnk: s, capHold });
  }
  for (const t of Object.keys(picks)) picks[t].sort((a, b) => a.draftRnk - b.draftRnk);
  teamDraftPicks = picks;
}

function doRunLottery() {
  const results = runLotterySimulation();
  STATE.lotteryResults = results;
  applyLotteryResults(results);
  saveState();
  render();
}

// ===== LOTTERY ROOM STATE =====
let _lotRoom = null; // { teams, assignments, teamCombos, drawnBalls, currentPick, picksResolved, results, timer, phase }

function startLotteryRoom() {
  const teams = getLotteryTeams();
  if (teams.length < 14) return;
  const { assignments, teamCombos, allCombos } = assignCombinations(teams);
  _lotRoom = {
    teams, assignments, teamCombos, allCombos,
    drawnBalls: [], currentPick: 1, picksResolved: [],
    results: [], timer: null, phase: 'ready', // ready, mixing, drawn, winner
    wonTeamIdxs: new Set()
  };
  renderLotteryRoom();
}

function drawNextBallInRoom() {
  if (!_lotRoom || _lotRoom.phase === 'mixing') return;
  const drawn = _lotRoom.drawnBalls;
  // Available balls: 1-14, not yet drawn in this pick's round
  const available = [];
  for (let i = 1; i <= 14; i++) { if (!drawn.includes(i)) available.push(i); }
  if (drawn.length >= 4 || !available.length) return;

  _lotRoom.phase = 'mixing';
  renderLotteryRoom();

  const mixTime = drawn.length === 0 ? 2000 : 1000; // 20s‚Üí2s, 10s‚Üí1s (scaled for UX)
  _lotRoom.timer = setTimeout(() => {
    // Draw random ball
    const ball = available[Math.floor(Math.random() * available.length)];
    drawn.push(ball);
    _lotRoom.phase = 'drawn';

    if (drawn.length === 4) {
      // Check which team this combination belongs to
      const sorted = [...drawn].sort((a,b) => a - b);
      const key = sorted.join('-');
      const teamIdx = _lotRoom.assignments.get(key);

      if (teamIdx === undefined || _lotRoom.wonTeamIdxs.has(teamIdx)) {
        // Unassigned combo or team already won ‚Äî discard, redraw
        _lotRoom.phase = 'redraw';
        renderLotteryRoom();
        setTimeout(() => {
          _lotRoom.drawnBalls = [];
          _lotRoom.phase = 'ready';
          renderLotteryRoom();
        }, 1500);
        return;
      }

      // Winner found
      const winner = _lotRoom.teams[teamIdx];
      _lotRoom.wonTeamIdxs.add(teamIdx);
      _lotRoom.picksResolved.push({ pick: _lotRoom.currentPick, team: winner.team, originalSlot: winner.originalSlot, combo: sorted });
      _lotRoom.phase = 'winner';
      renderLotteryRoom();
    } else {
      renderLotteryRoom();
    }
  }, mixTime);
}

function lotRoomNextPick() {
  if (!_lotRoom) return;
  if (_lotRoom.currentPick >= 4) {
    // Top 4 done ‚Äî fill remaining
    finalizeLotteryFromRoom();
    return;
  }
  _lotRoom.currentPick++;
  _lotRoom.drawnBalls = [];
  _lotRoom.phase = 'ready';
  renderLotteryRoom();
}

function finalizeLotteryFromRoom() {
  if (!_lotRoom) return;
  const results = [..._lotRoom.picksResolved];
  // Fill picks 5-14 with remaining teams in original order
  const wonTeams = new Set(results.map(r => r.team));
  const remaining = _lotRoom.teams.filter(t => !wonTeams.has(t.team)).sort((a, b) => a.originalSlot - b.originalSlot);
  for (let i = 0; i < remaining.length; i++) {
    results.push({ pick: 5 + i, team: remaining[i].team, originalSlot: remaining[i].originalSlot });
  }
  STATE.lotteryResults = results;
  applyLotteryResults(results);
  saveState();
  _lotRoom = null;
  render();
}

function renderLotteryRoom() {
  const panel = document.getElementById('rosterPanel');
  const lot = _lotRoom;
  const teamAbbrev = TEAMS[STATE.team];
  let h = '';

  h += `<div class="dc-section-label">üé± Lottery Room ‚Äî Drawing for Pick #${lot.currentPick}</div>`;

  // Previous picks resolved
  if (lot.picksResolved.length) {
    h += `<div style="margin-bottom:.75rem">`;
    for (const p of lot.picksResolved) {
      const logo = teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === p.team)] || '';
      const isUser = p.team === teamAbbrev;
      h += `<div style="display:flex;align-items:center;gap:.5rem;padding:.25rem .5rem;font-size:.7rem;color:var(--green)">`;
      h += `<span style="font-weight:800;color:var(--orange)">#${p.pick}</span>`;
      h += logo ? `<img src="${logo}" style="width:16px;height:16px">` : '';
      h += `<span style="font-weight:${isUser?'800':'600'};color:${isUser?'var(--accent)':'var(--text)'}"> ${p.team}</span>`;
      h += `<span style="color:var(--muted);font-size:.6rem">[${p.combo.join('-')}]</span>`;
      h += `</div>`;
    }
    h += `</div>`;
  }

  // Ping-pong balls
  h += `<div class="lot-balls">`;
  for (let i = 1; i <= 14; i++) {
    const isDrawn = lot.drawnBalls.includes(i);
    const cls = isDrawn ? 'drawn' : (lot.phase === 'mixing' ? '' : '');
    h += `<div class="lot-ball ${cls}">${i}</div>`;
  }
  h += `</div>`;

  // Drawn balls for this pick
  h += `<div class="lot-drawn-balls">`;
  for (let i = 0; i < 4; i++) {
    if (i < lot.drawnBalls.length) {
      h += `<div class="mini-ball">${lot.drawnBalls[i]}</div>`;
    } else if (i === lot.drawnBalls.length && lot.phase === 'mixing') {
      h += `<div class="mini-ball pending" style="animation:ballPulse .6s ease infinite">?</div>`;
    } else {
      h += `<div class="mini-ball pending">?</div>`;
    }
  }
  h += `</div>`;

  // Status
  if (lot.phase === 'mixing') {
    h += `<div class="lot-pick-header" style="color:var(--muted)">üîÑ Mixing balls...</div>`;
  } else if (lot.phase === 'redraw') {
    h += `<div class="lot-pick-header" style="color:var(--red)">‚ùå Invalid combination ‚Äî redrawing...</div>`;
  } else if (lot.phase === 'winner') {
    const w = lot.picksResolved[lot.picksResolved.length - 1];
    const logo = teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === w.team)] || '';
    h += `<div class="lot-pick-header" style="color:var(--green)">üéâ Pick #${w.pick}: ${logo ? `<img src="${logo}" style="width:22px;height:22px;vertical-align:middle">` : ''} ${w.team}!</div>`;
  } else if (lot.drawnBalls.length > 0 && lot.drawnBalls.length < 4) {
    h += `<div class="lot-pick-header">${lot.drawnBalls.length}/4 balls drawn</div>`;
  } else {
    h += `<div class="lot-pick-header">Ready to draw</div>`;
  }

  // Action button (above team list so no scrolling needed)
  h += `<div style="text-align:center;margin:.5rem 0">`;
  if (lot.phase === 'winner') {
    if (lot.currentPick < 4) {
      h += `<button class="phase-advance" onclick="lotRoomNextPick()" style="font-size:.85rem;padding:.5rem 1.5rem">Next Pick (#${lot.currentPick + 1}) ‚Üí</button>`;
    } else {
      h += `<button class="phase-advance" onclick="finalizeLotteryFromRoom()" style="font-size:.85rem;padding:.5rem 1.5rem">Finalize Lottery ‚Üí</button>`;
    }
  } else if (lot.phase !== 'mixing' && lot.phase !== 'redraw') {
    h += `<button class="phase-advance" onclick="drawNextBallInRoom()" style="font-size:.9rem;padding:.6rem 2rem">üé± Draw Ball</button>`;
  }
  h += `</div>`;

  // Team combinations remaining
  const showCombos = lot.drawnBalls.length >= 2 && lot.phase !== 'mixing';

  // Pre-compute team data and sort: alive teams first, eliminated below
  const teamData = lot.teams.map((team, t) => {
    const alreadyWon = lot.wonTeamIdxs.has(t);
    const remainingCombos = alreadyWon ? [] : filterCombos(lot.teamCombos[t], lot.drawnBalls);
    const isWinner = lot.phase === 'winner' && lot.picksResolved[lot.picksResolved.length - 1]?.team === team.team;
    return { team, t, alreadyWon, remainingCombos, remaining: remainingCombos.length, originalCount: lot.teamCombos[t].length, isWinner };
  });
  // Winner on top, then alive (remaining > 0) sorted by remaining desc, then eliminated
  teamData.sort((a, b) => {
    if (a.isWinner !== b.isWinner) return a.isWinner ? -1 : 1;
    const aAlive = !a.alreadyWon && a.remaining > 0;
    const bAlive = !b.alreadyWon && b.remaining > 0;
    if (aAlive !== bAlive) return aAlive ? -1 : 1;
    if (aAlive && bAlive) return b.remaining - a.remaining;
    return a.t - b.t;
  });

  h += `<div style="margin-top:.5rem">`;
  for (const td of teamData) {
    const { team, t, alreadyWon, remainingCombos, remaining, originalCount, isWinner } = td;
    const isUser = team.team === teamAbbrev;
    const logo = teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === team.team)] || '';
    const cls = alreadyWon ? 'lot-team-row eliminated' : isWinner ? 'lot-team-row winner' : remaining === 0 ? 'lot-team-row eliminated' : 'lot-team-row';
    h += `<div class="${cls}" ${isUser ? 'style="background:rgba(59,130,246,.06)"' : ''}>`;
    h += `<div class="team-name">${logo ? `<img src="${logo}">` : ''}<span style="${isUser?'font-weight:800;color:var(--accent)':''}">${team.team}</span></div>`;
    h += `<div class="bar-wrap"><div class="bar-fill" style="width:${originalCount > 0 ? Math.min(100, remaining / originalCount * 100) : 0}%"></div></div>`;
    h += `<div class="combos">${alreadyWon ? '‚úì Won' : isWinner ? 'üéâ Winner' : remaining + '/' + originalCount}</div>`;
    // Show actual remaining combos when 2+ balls drawn
    if (showCombos && remaining > 0 && remaining <= 40) {
      h += `<div style="width:100%;margin-top:.15rem;display:flex;flex-wrap:wrap;gap:.2rem;padding-left:1.5rem">`;
      for (const c of remainingCombos) {
        const isWinningCombo = isWinner && lot.drawnBalls.length === 4 && c.every(b => lot.drawnBalls.includes(b));
        const label = c.map(b => {
          const isDrawn = lot.drawnBalls.includes(b);
          return isDrawn ? `<span style="color:var(--orange);font-weight:800">${b}</span>` : `<span style="font-weight:700">${b}</span>`;
        }).join('-');
        h += `<span style="font-size:.5rem;padding:.1rem .3rem;background:${isWinningCombo?'rgba(52,199,89,.15)':isUser?'rgba(59,130,246,.1)':'var(--surface)'};border:1px solid ${isWinningCombo?'var(--green)':'var(--border)'};border-radius:3px;font-family:'DM Sans',system-ui">${label}</span>`;
      }
      h += `</div>`;
    }
    h += `</div>`;
  }
  h += `</div>`;

  panel.innerHTML = h;
}

// ===== ENVELOPE MODE =====
let _envState = null; // { results, currentReveal, timer }

function startLotteryEnvelope() {
  const results = runLotterySimulation();
  if (!results) return;
  _envState = { results, currentReveal: 14, timer: null, paused: false }; // start from pick 14
  renderLotteryEnvelope();
  // Auto-reveal with 700ms intervals, pause before top 4
  _envState.timer = setInterval(() => {
    if (!_envState || _envState.paused) return;
    _envState.currentReveal--;
    renderLotteryEnvelope();
    // Pause after revealing pick #5 (before top 4)
    if (_envState.currentReveal === 5) {
      _envState.paused = true;
      clearInterval(_envState.timer);
      _envState.timer = null;
      renderLotteryEnvelope();
      return;
    }
    if (_envState.currentReveal <= 0) {
      clearInterval(_envState.timer);
      _envState.timer = null;
    }
  }, 700);
}

function resumeEnvelopeTop4() {
  if (!_envState) return;
  _envState.paused = false;
  // Reveal top 4 with slightly longer intervals for drama
  _envState.timer = setInterval(() => {
    if (!_envState) return;
    _envState.currentReveal--;
    renderLotteryEnvelope();
    if (_envState.currentReveal <= 0) {
      clearInterval(_envState.timer);
      _envState.timer = null;
    }
  }, 1200);
}

function finalizeLotteryEnvelope() {
  if (!_envState) return;
  if (_envState.timer) clearInterval(_envState.timer);
  STATE.lotteryResults = _envState.results;
  applyLotteryResults(_envState.results);
  saveState();
  _envState = null;
  render();
}

function renderLotteryEnvelope() {
  const panel = document.getElementById('rosterPanel');
  const env = _envState;
  const teamAbbrev = TEAMS[STATE.team];
  let h = '';

  h += `<div class="dc-section-label">üì∫ 2026 NBA Draft Lottery ‚Äî Live Broadcast</div>`;
  h += `<div style="font-size:.7rem;color:var(--muted);margin-bottom:.75rem;text-align:center">Deputy Commissioner reveals picks in reverse order...</div>`;

  // Envelopes: 14 down to 1
  // Determine which teams are still in play for top 4
  const revealedTeams = new Set();
  for (let p = 14; p >= 5; p--) {
    if (p >= env.currentReveal) {
      const r = env.results.find(r => r.pick === p);
      if (r) revealedTeams.add(r.team);
    }
  }

  for (let pick = 14; pick >= 1; pick--) {
    const r = env.results.find(r => r.pick === pick);
    const isRevealed = pick >= env.currentReveal;
    const isCurrentReveal = pick === env.currentReveal;
    const isTop4 = pick <= 4;
    const isUser = r && r.team === teamAbbrev;
    const logo = r ? (teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === r.team)] || '') : '';

    // Insert commercial break before top 4
    if (pick === 4 && env.paused) {
      h += `<div style="text-align:center;padding:1rem;margin:.75rem 0;background:linear-gradient(135deg,rgba(180,83,9,.08),rgba(180,83,9,.02));border:2px dashed var(--orange);border-radius:10px">`;
      h += `<div style="font-size:1.2rem;margin-bottom:.3rem">üì∫</div>`;
      h += `<div style="font-size:.8rem;font-weight:700;color:var(--orange);margin-bottom:.15rem">Commercial Break</div>`;
      h += `<div style="font-size:.65rem;color:var(--muted);margin-bottom:.6rem">The top 4 picks are about to be revealed...</div>`;
      // Show remaining teams
      h += `<div style="display:flex;gap:.4rem;justify-content:center;flex-wrap:wrap;margin-bottom:.6rem">`;
      const lotteryTeams = getLotteryTeams();
      for (const lt of lotteryTeams) {
        if (revealedTeams.has(lt.team)) continue;
        const ltLogo = teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === lt.team)] || '';
        const ltIsUser = lt.team === teamAbbrev;
        h += `<div style="display:flex;align-items:center;gap:.25rem;padding:.25rem .5rem;background:var(--surface);border:1px solid ${ltIsUser?'var(--accent)':'var(--border)'};border-radius:6px;font-size:.65rem;font-weight:${ltIsUser?'800':'600'}">`;
        h += ltLogo ? `<img src="${ltLogo}" style="width:16px;height:16px">` : '';
        h += `<span style="${ltIsUser?'color:var(--accent)':''}">${lt.team}</span>`;
        h += `<span style="color:var(--muted);font-size:.55rem">#${lt.originalSlot}</span>`;
        h += `</div>`;
      }
      h += `</div>`;
      h += `<button class="phase-advance" onclick="resumeEnvelopeTop4()" style="font-size:.85rem;padding:.5rem 1.5rem">üèÜ Reveal Top 4</button>`;
      h += `</div>`;
      break; // Don't render picks 4-1 yet
    }

    if (isRevealed) {
      const diff = r.originalSlot - r.pick;
      const moveHtml = diff > 0 ? `<span class="movement" style="color:var(--green)">‚ñ≤${diff}</span>` : diff < 0 ? `<span class="movement" style="color:var(--red)">‚ñº${Math.abs(diff)}</span>` : `<span class="movement" style="color:var(--muted)">‚Äî</span>`;
      h += `<div class="lot-envelope ${isCurrentReveal ? 'revealing' : 'revealed'} ${isTop4 ? 'top4' : ''}" ${isUser ? 'style="background:rgba(59,130,246,.08);border-color:var(--accent)"' : ''}>`;
      h += `<span class="pick-num">${isTop4 ? 'üèÜ' : ''} #${pick}</span>`;
      h += `<span class="team-info">${logo ? `<img src="${logo}">` : ''}<span style="${isUser ? 'color:var(--accent)' : ''}">${r.team}</span></span>`;
      h += `<span style="font-size:.6rem;color:var(--muted)">was #${r.originalSlot}</span>`;
      h += moveHtml;
      h += `</div>`;
    } else {
      h += `<div class="lot-envelope hidden-env">`;
      h += `<span class="pick-num">#${pick}</span>`;
      h += `<span class="team-info" style="color:var(--muted)">???</span>`;
      h += `</div>`;
    }
  }

  // Finalize button (when all revealed)
  if (env.currentReveal <= 0) {
    h += `<div style="text-align:center;margin-top:1rem">`;
    h += `<button class="phase-advance" onclick="finalizeLotteryEnvelope()" style="font-size:.9rem;padding:.6rem 2rem">‚úÖ Confirm Lottery Results</button>`;
    h += `</div>`;
  }

  panel.innerHTML = h;
}

function renderLottery() {
  const panel = document.getElementById('rosterPanel');
  const teamAbbrev = TEAMS[STATE.team];
  const results = STATE.lotteryResults;
  let h = '';

  h += `<div class="dc-section-label">üé± 2026 NBA Draft Lottery</div>`;

  if (!results) {
    // Show odds table + mode selection
    const lotteryTeams = getLotteryTeams();
    h += `<div style="font-size:.75rem;color:var(--muted);margin-bottom:1rem">14 lottery teams compete for the top 4 picks. Choose how to experience the lottery.</div>`;

    // Mode selection buttons
    h += `<div style="display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap;margin-bottom:1.25rem">`;
    h += `<div class="lot-mode-btn" onclick="startLotteryRoom()">`;
    h += `<span class="icon">üé±</span><span class="title">Lottery Room</span>`;
    h += `<div class="desc">Watch ping-pong balls drawn live.<br>See combinations narrow in real-time.</div>`;
    h += `</div>`;
    h += `<div class="lot-mode-btn" onclick="startLotteryEnvelope()">`;
    h += `<span class="icon">üì∫</span><span class="title">TV Broadcast</span>`;
    h += `<div class="desc">Envelopes revealed in reverse order,<br>just like the live telecast.</div>`;
    h += `</div>`;
    h += `<div class="lot-mode-btn" onclick="doRunLottery()">`;
    h += `<span class="icon">‚ö°</span><span class="title">Instant</span>`;
    h += `<div class="desc">Skip the drama.<br>See results immediately.</div>`;
    h += `</div>`;
    h += `</div>`;

    // Odds table
    h += `<div class="contract-wrap"><table class="contract-table"><thead><tr>`;
    h += `<th>Slot</th><th>Team</th><th>Odds (#1)</th><th>Combos</th><th>Top 4</th>`;
    h += `</tr></thead><tbody>`;
    const top4Approx = [52.1,52.1,52.1,48.1,42.1,37.2,31.9,26.3,20.8,14.5,10.1,7.6,5.2,2.4];
    for (let i = 0; i < lotteryTeams.length; i++) {
      const lt = lotteryTeams[i];
      const logo = teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === lt.team)] || '';
      const isUser = lt.team === teamAbbrev;
      const rowStyle = isUser ? ' style="background:rgba(59,130,246,.1)"' : '';
      h += `<tr${rowStyle}><td style="font-weight:700;color:var(--orange)">#${i+1}</td>`;
      h += `<td><div style="display:flex;align-items:center;gap:.4rem">${logo ? `<img src="${logo}" style="width:20px;height:20px">` : ''}`;
      h += `<span style="font-weight:${isUser?'700':'400'};color:${isUser?'var(--accent)':'var(--text)'}">${lt.team}</span></div></td>`;
      h += `<td style="font-weight:600">${(LOTTERY_ODDS[i]/10).toFixed(1)}%</td>`;
      h += `<td style="font-size:.65rem;color:var(--muted)">${LOTTERY_ODDS[i]}/1000</td>`;
      h += `<td>${top4Approx[i].toFixed(1)}%</td>`;
      h += `</tr>`;
    }
    h += `</tbody></table></div>`;
  } else {
    // Show results
    if (STATE.lotteryResults) applyLotteryResults(STATE.lotteryResults);
    h += `<div style="font-size:.75rem;color:var(--muted);margin-bottom:1rem">Lottery complete! Top 4 picks have been drawn.</div>`;
    h += `<div class="contract-wrap"><table class="contract-table"><thead><tr>`;
    h += `<th>Pick</th><th>Team</th><th>Original</th><th>Movement</th>`;
    h += `</tr></thead><tbody>`;
    for (const r of results) {
      const logo = teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === r.team)] || '';
      const isUser = r.team === teamAbbrev;
      const diff = r.originalSlot - r.pick;
      const move = diff > 0 ? `<span style="color:var(--green);font-weight:700">‚ñ≤ ${diff}</span>` : diff < 0 ? `<span style="color:var(--red);font-weight:700">‚ñº ${Math.abs(diff)}</span>` : `<span style="color:var(--muted)">‚Äî</span>`;
      const rowStyle = isUser ? ' style="background:rgba(59,130,246,.1)"' : '';
      const isTop4 = r.pick <= 4;
      h += `<tr${rowStyle}><td style="font-weight:700;color:${isTop4?'var(--orange)':'var(--text)'}">`;
      h += `${isTop4?'üèÜ ':''}#${r.pick}</td>`;
      h += `<td><div style="display:flex;align-items:center;gap:.4rem">${logo ? `<img src="${logo}" style="width:20px;height:20px">` : ''}`;
      h += `<span style="font-weight:${isUser?'700':'400'};color:${isUser?'var(--accent)':'var(--text)'}">${r.team}</span></div></td>`;
      h += `<td style="color:var(--muted)">#${r.originalSlot}</td>`;
      h += `<td>${move}</td></tr>`;
    }
    h += `</tbody></table></div>`;
    h += `<div style="text-align:center;margin-top:1rem">`;
    h += `<button class="waive-cancel" onclick="doRunLottery()" style="font-size:.8rem;padding:.5rem 1.5rem;border:1px solid var(--orange);color:var(--orange)">üîÑ Reshuffle Lottery</button>`;
    h += `</div>`;
  }

  panel.innerHTML = h;
}

// =============== DRAFT SIMULATION ===============
function getDraftedProspects() {
  return new Set((STATE.draftResults || []).map(r => r.prospect));
}

function getPickTeam(pick) {
  // Use lottery results if available for picks 1-14
  if (STATE.lotteryResults && pick <= 14) {
    const lr = STATE.lotteryResults.find(r => r.pick === pick);
    if (lr) return lr.team;
  }
  const slot = allPickSlots[pick];
  return slot ? slot.team : null;
}

function autoDraftPick(pick) {
  const drafted = getDraftedProspects();
  // Pick highest-ranked remaining prospect (allProspects is consensus order)
  for (const name of allProspects) {
    if (!drafted.has(name)) return name;
  }
  return null;
}

let _draftAnimTimer = null;

function runDraftUntilUser() {
  // Animated: one pick per second, pauses at user's pick
  if (_draftAnimTimer) { clearInterval(_draftAnimTimer); _draftAnimTimer = null; }
  const teamAbbrev = TEAMS[STATE.team];

  function draftNextPick() {
    let current = STATE.draftCurrentPick || 1;
    if (current > 60) {
      clearInterval(_draftAnimTimer); _draftAnimTimer = null;
      saveState(); render();
      return;
    }
    const pickTeam = getPickTeam(current);
    if (!pickTeam) { STATE.draftCurrentPick = current + 1; render(); return; }

    if (pickTeam === teamAbbrev) {
      // User's turn ‚Äî pause animation
      clearInterval(_draftAnimTimer); _draftAnimTimer = null;
      saveState(); render();
      return;
    }

    // AI pick
    const prospect = autoDraftPick(current);
    if (prospect) {
      STATE.draftResults.push({ pick: current, team: pickTeam, prospect });
    }
    STATE.draftCurrentPick = current + 1;
    saveState();
    render();
  }

  _draftAnimTimer = setInterval(draftNextPick, 500);
}

function startDraft() {
  STATE.draftCurrentPick = 1;
  saveState();
  render();
  runDraftUntilUser();
}

function skipDraft() {
  // Auto-draft all 60 picks using default prospect order
  const teamAbbrev = TEAMS[STATE.team];
  const drafted = getDraftedProspects();
  for (let pick = 1; pick <= 60; pick++) {
    const pickTeam = getPickTeam(pick);
    if (!pickTeam) continue;
    // Skip already-drafted picks
    if (STATE.draftResults.some(r => r.pick === pick)) continue;
    
    // Find best available prospect
    let prospect = null;
    for (const name of allProspects) {
      if (!drafted.has(name)) { prospect = name; break; }
    }
    if (!prospect) continue;
    
    STATE.draftResults.push({ pick, team: pickTeam, prospect });
    drafted.add(prospect);
    
    // Record user's picks as moves for undo
    if (pickTeam === teamAbbrev) {
      STATE.draftSelections[pick] = prospect;
      STATE.moves.push({
        action: 'Draft',
        detail: `Pick #${pick}: ${prospect} (auto)`,
        undo: { type: 'draft_sim', pick }
      });
    }
  }
  STATE.draftCurrentPick = 61;
  saveState();
  showToast('Draft complete! All picks auto-selected.', 'success');
  render();
}

function getDraftGrade(pick, prospect) {
  // Grade based on how close the pick is to the prospect's projected rank
  const projIdx = allProspects.indexOf(prospect);
  if (projIdx < 0) return {grade:'B', emoji:'üìã'};
  const projPick = projIdx + 1;
  const diff = projPick - pick; // positive = reach, negative = steal
  if (diff <= -15) return {grade:'A+', emoji:'üî•'};
  if (diff <= -8) return {grade:'A', emoji:'‚≠ê'};
  if (diff <= -3) return {grade:'A-', emoji:'üëç'};
  if (diff <= 3) return {grade:'B+', emoji:'üëå'};
  if (diff <= 8) return {grade:'B', emoji:'üìã'};
  if (diff <= 15) return {grade:'C+', emoji:'ü§î'};
  return {grade:'C', emoji:'üò¨'};
}

function userDraftPick(prospect) {
  const pick = STATE.draftCurrentPick;
  const teamAbbrev = TEAMS[STATE.team];
  STATE.draftResults.push({ pick, team: teamAbbrev, prospect });
  STATE.draftSelections[pick] = prospect;
  STATE.moves.push({
    action: 'Draft',
    detail: `Pick #${pick}: ${prospect}`,
    undo: { type: 'draft_sim', pick }
  });
  STATE.draftCurrentPick = pick + 1;
  saveState();

  const grade = getDraftGrade(pick, prospect);
  showToast(`${grade.emoji} Drafted ${prospect} at #${pick} ‚Äî Grade: ${grade.grade}`, grade.grade.startsWith('A') ? 'success' : 'info');

  // Continue animated drafting
  render();
  runDraftUntilUser();
}

function renderDraftBoard() {
  const panel = document.getElementById('rosterPanel');
  const teamAbbrev = TEAMS[STATE.team];
  let h = '';

  const current = STATE.draftCurrentPick || 0;
  const draftNotStarted = current < 1;
  const isDraftComplete = current > 60;
  const drafted = getDraftedProspects();

  if (draftNotStarted) {
    h += `<div class="dc-section-label">üéØ 2026 NBA Draft</div>`;
    h += `<div style="font-size:.75rem;color:var(--muted);margin-bottom:1rem">60 picks across 2 rounds. The draft will simulate automatically, pausing when it's your turn to pick.</div>`;

    // Show user's picks
    const userPicks = (teamDraftPicks[teamAbbrev] || []).slice().sort((a,b) => a.draftRnk - b.draftRnk);
    if (userPicks.length) {
      h += `<div style="margin-bottom:1.25rem">`;
      h += `<div style="font-size:.7rem;font-weight:700;color:var(--accent);margin-bottom:.5rem">YOUR PICKS</div>`;
      for (const p of userPicks) {
        const rd = p.draftRnk <= 30 ? '1st' : '2nd';
        h += `<div style="display:flex;align-items:center;gap:.5rem;padding:.3rem .5rem;background:rgba(59,130,246,.06);border-radius:4px;margin-bottom:.2rem;font-size:.75rem">`;
        h += `<span style="font-weight:700;color:var(--orange)">#${p.draftRnk}</span>`;
        h += `<span>${rd} Round</span>`;
        h += `<span style="color:var(--muted)">¬∑ proj. ${p.prospect}</span>`;
        h += `</div>`;
      }
      h += `</div>`;
    }

    h += `<div style="text-align:center;margin-top:1rem;display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap">`;
    h += `<button class="phase-advance" onclick="startDraft()" style="font-size:1rem;padding:.75rem 2rem">üèÄ Start Draft</button>`;
    h += `<button class="phase-advance" onclick="skipDraft()" style="font-size:.85rem;padding:.65rem 1.5rem;background:var(--surface);color:var(--muted);border:1px solid var(--border)">‚è© Skip Draft</button>`;
    h += `</div>`;

    // Show full draft board preview (empty)
    h += `<div class="contract-wrap" style="margin-top:1.5rem"><table class="contract-table"><thead><tr>`;
    h += `<th>Pick</th><th>Team</th><th>Prospect</th>`;
    h += `</tr></thead><tbody>`;
    for (let pick = 1; pick <= 60; pick++) {
      if (pick === 1) h += `<tr><td colspan="3" style="font-weight:700;font-size:.7rem;color:var(--orange);padding:.6rem .5rem;background:rgba(180,83,9,.06);border-bottom:2px solid var(--orange)">ROUND 1</td></tr>`;
      if (pick === 31) h += `<tr><td colspan="3" style="font-weight:700;font-size:.7rem;color:var(--accent);padding:.6rem .5rem;background:rgba(59,130,246,.06);border-bottom:2px solid var(--accent)">ROUND 2</td></tr>`;
      const pickTeam = getPickTeam(pick);
      if (!pickTeam) continue;
      const isUser = pickTeam === teamAbbrev;
      const logo = teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === pickTeam)] || '';
      const rowStyle = isUser ? ' style="background:rgba(59,130,246,.1)"' : '';
      h += `<tr${rowStyle}>`;
      h += `<td style="font-weight:700;color:var(--muted)">#${pick}</td>`;
      h += `<td><div style="display:flex;align-items:center;gap:.3rem">${logo?`<img src="${logo}" style="width:18px;height:18px">`:''}<span style="font-weight:${isUser?'700':'400'};color:${isUser?'var(--accent)':'var(--text)'}">${pickTeam}</span></div></td>`;
      h += `<td style="color:var(--muted)">‚Äî</td>`;
      h += `</tr>`;
    }
    h += `</tbody></table></div>`;
    panel.innerHTML = h;
    return;
  }

  h += `<div class="dc-section-label">üèÄ 2026 NBA Draft ${isDraftComplete ? '‚Äî Complete' : `‚Äî ${current <= 30 ? 'Round 1' : 'Round 2'}, Pick #${current}`}</div>`;

  // User's pick selection (if it's their turn)
  if (!isDraftComplete && getPickTeam(current) === teamAbbrev) {
    h += `<div id="yourPickBox" class="your-pick-box" style="background:rgba(59,130,246,.1);border:2px solid var(--accent);border-radius:10px;padding:1rem;margin-bottom:1rem">`;
    h += `<h3 style="color:var(--accent);margin-bottom:.5rem;font-size:.9rem">üéØ Your Pick ‚Äî #${current}</h3>`;
    h += `<input id="draftSearchInput" class="trade-input" style="width:100%;margin-bottom:.5rem" placeholder="Filter prospects..." oninput="filterDraftProspects(this.value)">`;
    h += `<div id="draftProspectList" style="max-height:250px;overflow-y:auto">`;
    h += buildDraftProspectList('');
    h += `</div></div>`;
  }

  // Draft board
  h += `<div class="contract-wrap"><table class="contract-table"><thead><tr>`;
  h += `<th>Pick</th><th>Team</th><th>Prospect</th>`;
  h += `</tr></thead><tbody>`;

  for (let pick = 1; pick <= 60; pick++) {
    // Round dividers
    if (pick === 1) h += `<tr><td colspan="3" style="font-weight:700;font-size:.7rem;color:var(--orange);padding:.6rem .5rem;background:rgba(180,83,9,.06);border-bottom:2px solid var(--orange)">ROUND 1</td></tr>`;
    if (pick === 31) h += `<tr><td colspan="3" style="font-weight:700;font-size:.7rem;color:var(--accent);padding:.6rem .5rem;background:rgba(59,130,246,.06);border-bottom:2px solid var(--accent)">ROUND 2</td></tr>`;
    const pickTeam = getPickTeam(pick);
    if (!pickTeam) continue;
    const result = STATE.draftResults.find(r => r.pick === pick);
    const isUser = pickTeam === teamAbbrev;
    const isCurrent = pick === current && !isDraftComplete;
    const isPicked = !!result;

    let rowStyle = '';
    if (isUser) rowStyle = ' style="background:rgba(59,130,246,.1)"';
    else if (isCurrent) rowStyle = ' style="background:rgba(180,83,9,.08)"';

    const logo = teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === pickTeam)] || '';

    h += `<tr${rowStyle}${isCurrent?' data-current="1"':''}>`;
    h += `<td style="font-weight:700;color:${isCurrent?'var(--orange)':isPicked?'var(--green)':'var(--muted)'}">${isCurrent?'‚û°Ô∏è ':''}#${pick}</td>`;
    h += `<td><div style="display:flex;align-items:center;gap:.3rem">${logo?`<img src="${logo}" style="width:18px;height:18px">`:''}<span style="font-weight:${isUser?'700':'400'};color:${isUser?'var(--accent)':'var(--text)'}">${pickTeam}</span></div></td>`;
    if (isPicked) {
      h += `<td style="font-weight:600">${result.prospect}</td>`;
    } else if (isCurrent) {
      h += `<td style="color:var(--orange);font-style:italic">On the clock...</td>`;
    } else {
      h += `<td style="color:var(--muted)">‚Äî</td>`;
    }
    h += `</tr>`;
  }
  h += `</tbody></table></div>`;

  // Undrafted prospects (after draft complete)
  if (isDraftComplete) {
    // Post-draft summary for user's picks
    const userPicks = STATE.draftResults.filter(r => r.team === teamAbbrev);
    if (userPicks.length) {
      h += `<div class="dc-section-label" style="margin-top:1rem">üèÜ Your Draft Recap</div>`;
      h += `<div style="display:flex;flex-direction:column;gap:.3rem;margin-bottom:1rem">`;
      for (const r of userPicks) {
        const grade = getDraftGrade(r.pick, r.prospect);
        const gradeColor = grade.grade.startsWith('A') ? 'var(--green)' : grade.grade.startsWith('B') ? 'var(--accent)' : 'var(--orange)';
        h += `<div style="display:flex;align-items:center;gap:.5rem;padding:.4rem .6rem;background:var(--surface);border-radius:6px;border:1px solid var(--border)">`;
        h += `<span style="font-weight:700;color:var(--orange);min-width:35px">#${r.pick}</span>`;
        h += `<span style="flex:1;font-size:.75rem;font-weight:600">${r.prospect}</span>`;
        h += `<span style="font-size:.7rem;font-weight:700;color:${gradeColor};padding:.15rem .4rem;background:${gradeColor}15;border-radius:4px">${grade.emoji} ${grade.grade}</span>`;
        h += `</div>`;
      }
      h += `</div>`;
    }

    const undrafted = allProspects.filter(n => !drafted.has(n));
    if (undrafted.length) {
      h += `<div class="dc-section-label" style="margin-top:1rem">üìã Undrafted Prospects <span class="dc-badge" style="background:rgba(110,110,115,.12);color:var(--muted)">${undrafted.length}</span></div>`;
      h += `<div style="font-size:.7rem;color:var(--muted);margin-bottom:.5rem">These players will be available as undrafted free agents.</div>`;
      h += `<div style="display:flex;flex-wrap:wrap;gap:.3rem">`;
      for (const n of undrafted.slice(0, 30)) {
        h += `<span style="font-size:.65rem;padding:.2rem .5rem;background:var(--surface);border-radius:4px;border:1px solid var(--border)">${n}</span>`;
      }
      if (undrafted.length > 30) h += `<span style="font-size:.65rem;padding:.2rem .5rem;color:var(--muted)">+${undrafted.length-30} more</span>`;
      h += `</div>`;
    }
  }

  panel.innerHTML = h;

  // Auto-scroll: prioritize Your Pick box when it's user's turn
  if (!isDraftComplete) {
    const yourBox = panel.querySelector('#yourPickBox');
    if (yourBox) {
      setTimeout(() => yourBox.scrollIntoView({ behavior: 'smooth', block: 'start' }), 80);
      // Focus the search input for immediate typing
      setTimeout(() => { const inp = panel.querySelector('#draftSearchInput'); if (inp) inp.focus(); }, 150);
    } else {
      const row = panel.querySelector('tr[data-current]');
      if (row) setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 50);
    }
  }
}

function buildDraftProspectList(filter) {
  const drafted = getDraftedProspects();
  const q = filter.toLowerCase();
  let h = '';
  let rank = 0;
  for (const name of allProspects) {
    rank++;
    if (drafted.has(name)) continue;
    if (q && !name.toLowerCase().includes(q)) continue;
    // Show projected pick info
    let proj = '';
    for (const [s, info] of Object.entries(allPickSlots)) {
      if (info.defaultProspect === name) { proj = `proj #${s}`; break; }
    }
    h += `<div class="draft-pick-option" onclick="userDraftPick('${esc(name)}')">`;
    h += `<span class="rank">${rank}</span>`;
    h += `<span class="name">${name}</span>`;
    if (proj) h += `<span class="assigned">${proj}</span>`;
    h += `</div>`;
  }
  if (!h) h = '<div style="padding:.5rem;text-align:center;color:var(--muted);font-size:.7rem">No prospects available</div>';
  return h;
}

function filterDraftProspects(query) {
  const list = document.getElementById('draftProspectList');
  if (list) list.innerHTML = buildDraftProspectList(query);
}

// =============== MAIN RENDER ===============
function renderRoster(cap) {
  const panel = document.getElementById('rosterPanel');
  const phase = STATE.phase;
  let h = '';

  // Action bar
  h += `<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.75rem;align-items:center">`;
  if (phase !== 'draft') {
    const tradeBadge = STATE.trades?.length ? ` <span style="font-size:.55rem;background:var(--cyan);color:white;padding:.1rem .35rem;border-radius:8px;margin-left:.25rem">${STATE.trades.length}</span>` : '';
    h += `<button class="action-btn trade" style="font-size:.7rem;padding:.35rem .75rem" onclick="openTradeModal()">üîÑ Trade Machine${tradeBadge}</button>`;
  }
  if (phase === 'free_agency' || phase === 'training_camp') {
    h += `<button class="action-btn pickup" style="font-size:.7rem;padding:.35rem .75rem" onclick="openSignModal()">‚úçÔ∏è Sign Free Agent</button>`;
  }
  // Roster count pill
  const rCount = cap.rosterCount;
  h += `<span style="margin-left:auto;font-size:.6rem;padding:.2rem .6rem;border-radius:12px;background:var(--surface);border:1px solid var(--border);color:var(--muted)">${rCount} players</span>`;
  h += `</div>`;

  // Training camp compliance
  if (phase === 'training_camp') {
    const total = cap.rosterCount;
    if (total > 15) h += `<div class="camp-warning"><h4>‚ö†Ô∏è Roster Over Limit</h4><p>You have ${total} contracts ‚Äî must cut ${total - 15} player(s) to reach the 15-player limit.</p></div>`;
    else if (total < 14) h += `<div class="camp-warning"><h4>‚ö†Ô∏è Roster Under Minimum</h4><p>You have ${total} contracts ‚Äî need at least 14 for opening night.</p></div>`;
    else h += `<div class="camp-ok"><h4>‚úÖ Roster Compliant</h4><p>${total} contracts (limit: 15)</p></div>`;
  }

  // ======== DEPTH CHART ========
  const depthPlayers = getDepthPlayers(cap);
  const byPos = buildDepthPositions(depthPlayers);
  const POS = ['PG','SG','SF','PF','C'];
  const rosterTotal = depthPlayers.reduce((s,p) => s + (p.sal27||0), 0);
  h += `<div class="dc-section-label">üèÄ Depth Chart <span class="dc-badge" style="background:rgba(59,130,246,.15);color:var(--accent)">${depthPlayers.length} players</span><span class="dc-badge" style="background:rgba(52,199,89,.12);color:var(--green)">${fmtMoney(rosterTotal)}</span></div>`;
  h += `<div style="font-size:.6rem;color:var(--muted);margin-bottom:.5rem">üí° Drag players to rearrange positions</div>`;
  h += `<div class="depth-chart" id="depthChartGrid">`;
  POS.forEach(pos => {
    h += `<div class="pos-col" data-position="${pos}"><div class="pos-hdr">${pos}</div>`;
    byPos[pos].forEach(p => { h += dcCard(p); });
    h += `</div>`;
  });
  h += `</div>`;

  // ======== CONTRACT TABLE ========
  // Build synthetic contract data for signings and extensions
  const synthContracts = {};
  for (const sig of (STATE.signings || [])) {
    if (STATE.waived.has(sig.name)) continue;
    const yrs = Array(6).fill(null);
    
    if (sig.yearStructure && sig.yearStructure.length) {
      // Use detailed year structure
      for (const yr of sig.yearStructure) {
        const idx = yr.season - 2026; // 2027=1 ('26-27), 2028=2 ('27-28), etc.
        if (idx < 0 || idx >= 6) continue;
        let stLabel = 'GUARANTEED';
        let guarAmt = yr.salary;
        if (yr.status === 'non-guaranteed') { stLabel = 'NOT G'; guarAmt = 0; }
        else if (yr.status === 'partial') { stLabel = 'PARTIAL G'; guarAmt = Math.round(yr.salary * 0.5); }
        else if (yr.status === 'team_option') { stLabel = 'TO'; guarAmt = 0; }
        else if (yr.status === 'player_option') { stLabel = 'PO'; guarAmt = 0; }
        else if (yr.status === 'eto') { stLabel = 'ETO'; guarAmt = yr.salary; }
        else if (sig.contractType === 'two-way') { stLabel = 'TWO-WAY'; }
        yrs[idx] = { sal: yr.salary, ch: guarAmt, st: stLabel };
      }
    } else {
      // Legacy: flat raise calculation
      const stLabel = sig.contractType === 'two-way' ? 'TWO-WAY' : sig.contractType === 'non-guaranteed' ? 'NOT G' : sig.contractType === 'partial-guaranteed' ? 'PARTIAL G' : sig.contractType === 'exhibit-10' ? 'NOT G' : 'GUARANTEED';
      for (let y = 0; y < sig.years; y++) {
        const raise = Math.round(sig.salary * (sig.raiseRate || 0.05));
        const sal = sig.salary + (raise * y);
        const guarAmt = sig.contractType === 'partial-guaranteed' ? Math.round(sal * (sig.guaranteedPct || 50) / 100) : (sig.contractType === 'non-guaranteed' || sig.contractType === 'exhibit-10' ? 0 : sal);
        yrs[1 + y] = { sal, ch: guarAmt, st: stLabel };
      }
    }
    const totG = yrs.reduce((s, yr) => s + (yr && (yr.st === 'GUARANTEED' || yr.st === 'TWO-WAY' || yr.st === 'ETO') ? yr.sal : (yr?.ch || 0)), 0);
    synthContracts[sig.name] = { yrs, totG };
  }
  // Also generate synthetic contracts for S&T traded-in players
  for (const trade of (STATE.trades || [])) {
    for (const tp of (trade.in || [])) {
      if (!tp.isSAT || !tp.salary || !tp.years) continue;
      if (STATE.waived.has(tp.name)) continue;
      if (synthContracts[tp.name]) continue; // Don't overwrite existing
      const stLabel = 'GUARANTEED';
      const yrs2 = Array(6).fill(null);
      for (let y = 0; y < tp.years; y++) {
        const raise = Math.round(tp.salary * 0.05);
        const sal = tp.salary + (raise * y);
        yrs2[1 + y] = { sal, ch: sal, st: stLabel };
      }
      const totG2 = yrs2.reduce((s, yr) => s + (yr?.ch || 0), 0);
      synthContracts[tp.name] = { yrs: yrs2, totG: totG2 };
    }
  }
  for (const ext of (STATE.extensions || [])) {
    const existing = contractsMap[ext.name] || synthContracts[ext.name];
    if (!existing) continue;
    const yrs = existing.yrs ? [...existing.yrs] : Array(6).fill(null);
    // Fill extension years starting from extStartYear
    for (const bd of ext.breakdown) {
      const idx = (ext.extStartYear + bd.year - 1) - 2025; // index in CONTRACT_YEARS
      if (idx >= 0 && idx < 6) {
        yrs[idx] = { sal: bd.salary, ch: bd.salary, st: 'GUARANTEED' };
      }
    }
    const totG = yrs.reduce((s, yr) => s + (yr?.ch || 0), 0);
    if (contractsMap[ext.name]) {
      contractsMap[ext.name] = { ...contractsMap[ext.name], yrs, totG };
    } else {
      synthContracts[ext.name] = { yrs, totG };
    }
  }

  const contractPlayers = [...cap.roster.under_contract, ...cap.roster.non_guaranteed, ...cap.roster.partial_guaranteed, ...cap.roster.signed].sort((a,b) => (b.sal27||0) - (a.sal27||0));
  const showPreFa = phase === 'pre_lottery' || phase === 'pre_draft' || phase === 'lottery' || phase === 'draft' || phase === 'pre_fa';
  const visibleYears = CONTRACT_YEARS.filter(yr => !yr.preFaOnly || showPreFa);
  if (contractPlayers.length) {
    h += `<div class="dc-section-label">üìã Contracts <span class="dc-badge" style="background:rgba(52,199,89,.12);color:var(--green)">${contractPlayers.length} players</span></div>`;
    h += `<div class="contract-wrap"><table class="contract-table"><thead><tr>`;
    h += `<th style="min-width:150px">Player</th>`;
    visibleYears.forEach(yr => { h += `<th>${yr.label}</th>`; });
    h += `<th>Tot Guar</th></tr></thead><tbody>`;
    for (const p of contractPlayers) {
      const ini = p.name.split(' ').map(w => w[0]).join('');
      const hs = p.headshot
        ? `<img class="ct-hs" src="${p.headshot}" onerror="this.outerHTML='<div class=ct-ini>${ini}</div>'">`
        : `<div class="ct-ini">${ini}</div>`;
      h += `<tr><td><div class="player-cell">${hs}<div><div style="font-weight:600;font-size:.7rem">${p.name}</div><div style="font-size:.55rem;color:var(--muted)">${p.pos || ''} ${p.age ? '¬∑ ' + p.age : ''}</div></div></div></td>`;
      const cd = synthContracts[p.name] || contractsMap[p.name];
      if (cd) {
        CONTRACT_YEARS.forEach((yr, i) => {
          if (yr.preFaOnly && !showPreFa) return;
          h += contractSalCell(cd.yrs[i]);
        });
        h += `<td style="font-weight:600;font-size:.65rem">${cd.totG ? fmtMoney(cd.totG) : '‚Äî'}</td>`;
      } else {
        // Fallback: show from roster data
        if (showPreFa) {
          const st26 = p.st26 || 'GUARANTEED';
          h += contractSalCell({sal: p.sal26, ch: p.ch26, st: st26});
        }
        const st27 = p._signed ? 'GUARANTEED' : (p.st27 || 'GUARANTEED');
        h += contractSalCell({sal: p.sal27, ch: p.ch27, st: st27});
        const remaining = visibleYears.length - (showPreFa ? 2 : 1);
        for (let i = 0; i < remaining; i++) h += `<td><span style="color:var(--muted)">‚Äî</span></td>`;
        h += `<td style="font-weight:600;font-size:.65rem">${p.totalGuar ? fmtMoney(p.totalGuar) : '‚Äî'}</td>`;
      }
      h += `</tr>`;
    }
    h += `</tbody></table></div>`;
  }

  // ======== FREE AGENTS ========
  const fas = cap.roster.free_agent;
  if (fas.length) {
    const activeFas = fas.filter(p => p.status !== 'renounced');
    const renouncedFas = fas.filter(p => p.status === 'renounced');
    const totalHolds = activeFas.reduce((s,p) => s + (p.capHold||0), 0);
    h += `<div class="dc-section-label">üîì Free Agents <span class="dc-badge" style="background:rgba(59,130,246,.12);color:var(--accent)">${activeFas.length} held</span><span class="dc-badge" style="background:rgba(59,130,246,.12);color:var(--accent)">${fmtMoney(totalHolds)} cap holds</span></div>`;
    h += `<div class="section"><div class="section-body">`;
    for (const p of [...activeFas, ...renouncedFas].sort((a,b) => {
      if (a.status === 'renounced' && b.status !== 'renounced') return 1;
      if (b.status === 'renounced' && a.status !== 'renounced') return -1;
      return (b.capHold||0) - (a.capHold||0);
    })) {
      const acted = p.status === 'renounced';
      h += `<div class="player-row${acted ? ' acted' : ''}">`;
      h += p.headshot ? `<img class="hs" src="${p.headshot}" onerror="this.outerHTML='<div class=hs-ini>${p.name.split(' ').map(w=>w[0]).join('')}</div>'">` : `<div class="hs-ini">${p.name.split(' ').map(w=>w[0]).join('')}</div>`;
      h += `<div class="info"><div class="pname">${p.name}${p.fromOption ? ` <span style="font-size:.55rem;color:var(--muted)">(${p.fromOption} declined)</span>` : ''}${p.isTwoWay ? ' <span style="font-size:.5rem;padding:.1rem .3rem;border-radius:3px;background:rgba(110,110,115,.15);color:var(--muted)">2W</span>' : ''}</div>`;
      h += `<div class="pdet">${p.exception ? shortExc(p.exception) : ''}</div></div>`;
      if (acted) {
        h += `<div><div class="sal" style="color:var(--muted);text-decoration:line-through">${fmtMoney(p.capHold)}</div><div class="ch">renounced</div></div>`;
      } else {
        h += `<div><div class="sal" style="color:var(--accent)">${fmtMoney(p.capHold)}</div><div class="ch">cap hold</div></div>`;
      }
      h += `<div style="display:flex;gap:.3rem">`;
      if (!acted) {
        h += `<button class="action-btn renounce" onclick="doRenounce('${esc(p.name)}')">Renounce</button>`;
        if (phase === 'free_agency' || phase === 'training_camp') h += `<button class="action-btn pickup" onclick="openSignModal('${esc(p.name)}', true)">Re-sign</button>`;
      }
      h += `</div></div>`;
    }
    h += `</div></div>`;
  }

  // ======== DRAFT PICKS ========
  const picks = cap.roster.draft_picks;
  if (picks.length) {
    const draftTotal = picks.reduce((s,p) => s + (p.capHold||0), 0);
    h += `<div class="dc-section-label">üèÄ Draft Picks <span class="dc-badge" style="background:rgba(180,83,9,.12);color:var(--orange)">${picks.length} picks</span><span class="dc-badge" style="background:rgba(180,83,9,.12);color:var(--orange)">${fmtMoney(draftTotal)} cap holds</span></div>`;
    h += `<div class="section"><div class="section-body">`;
    for (const p of picks) {
      const isSwapped = p.selectedProspect !== p.prospect;
      h += `<div class="player-row">`;
      h += `<div class="hs-ini" style="background:var(--orange);color:#000;font-weight:700;font-size:.7rem">#${p.draftRnk}</div>`;
      h += `<div class="info"><div class="pname">${p.selectedProspect || 'TBD'}${isSwapped ? ` <span style="font-size:.55rem;color:var(--muted)">(was: ${p.prospect})</span>` : ''}</div>`;
      const rdLabel = p.draftRnk <= 30 ? `1st Rd Pick #${p.draftRnk} ¬∑ Rookie Scale` : `2nd Rd Pick #${p.draftRnk} ¬∑ Min Salary`;
      h += `<div class="pdet">${rdLabel}</div></div>`;
      h += `<div><div class="sal" style="color:var(--orange)">${fmtMoney(p.capHold)}</div><div class="ch">cap hold</div></div>`;
      h += `<div style="display:flex;gap:.3rem">`;
      if (phase === 'draft') {
        h += `<button class="action-btn draft-swap" onclick="openDraftPicker(${p.draftRnk})">üîÑ Swap</button>`;
        if (isSwapped) h += `<button class="action-btn decline" onclick="resetDraftPick(${p.draftRnk})">‚Ü©</button>`;
      } else if (phase === 'pre_lottery' || phase === 'pre_draft' || phase === 'lottery') {
        h += `<span style="font-size:.6rem;color:var(--muted)">available in Draft Night</span>`;
      }
      h += `</div></div>`;
    }
    h += `</div></div>`;
  }

  // ======== WAIVED ========
  if (cap.roster.waived.length) {
    const totalDead = cap.roster.waived.reduce((s,p) => s + (p.deadAmount||0), 0);
    h += `<div class="dc-section-label">üóëÔ∏è Waived <span class="dc-badge" style="background:rgba(255,69,58,.12);color:var(--red)">${cap.roster.waived.length}</span><span class="dc-badge" style="background:rgba(255,69,58,.12);color:var(--red)">${fmtMoney(totalDead)} dead</span></div>`;
    h += `<div class="section"><div class="section-body">`;
    for (const p of cap.roster.waived) {
      h += `<div class="player-row acted">`;
      h += p.headshot ? `<img class="hs" src="${p.headshot}" onerror="this.outerHTML='<div class=hs-ini>${p.name.split(' ').map(w=>w[0]).join('')}</div>'">` : `<div class="hs-ini">${p.name.split(' ').map(w=>w[0]).join('')}</div>`;
      h += `<div class="info"><div class="pname">${p.name}</div><div class="pdet">${fmtMoney(p.sal27||p.sal26)} salary</div></div>`;
      h += `<div><div class="sal" style="color:var(--muted);text-decoration:line-through">${fmtMoney(p.sal27||p.sal26)}</div>`;
      h += `<div class="ch">${p.deadAmount ? fmtMoney(p.deadAmount) + ' dead' + (p.isStretched ? ' (str)' : '') : 'no dead cap'}</div></div>`;
      h += `</div>`;
    }
    h += `</div></div>`;
  }

  panel.innerHTML = h;
  setupDragDrop();
}

// =============== DRAG & DROP ===============
let _draggedCard = null;
let _touchDragState = null; // { card, startX, startY, clone, holdTimer, isDragging }

function setupDragDrop() {
  const grid = document.getElementById('depthChartGrid');
  if (!grid) return;

  grid.querySelectorAll('.dc-card').forEach(card => {
    // === MOUSE DRAG (desktop) ===
    card.addEventListener('dragstart', e => {
      _draggedCard = card;
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', card.dataset.player);
    });
    card.addEventListener('dragend', () => {
      card.classList.remove('dragging');
      _draggedCard = null;
      grid.querySelectorAll('.dc-drop-indicator').forEach(el => el.remove());
      grid.querySelectorAll('.pos-col.drag-over').forEach(el => el.classList.remove('drag-over'));
    });

    // === TOUCH DRAG (mobile) ===
    card.addEventListener('touchstart', e => {
      if (e.touches.length !== 1) return;
      const touch = e.touches[0];
      _touchDragState = {
        card,
        startX: touch.clientX,
        startY: touch.clientY,
        clone: null,
        holdTimer: null,
        isDragging: false
      };
      // Long-press to activate drag (250ms)
      _touchDragState.holdTimer = setTimeout(() => {
        if (!_touchDragState) return;
        _touchDragState.isDragging = true;
        card.classList.add('touch-held');
        // Haptic feedback
        if (navigator.vibrate) navigator.vibrate(30);
        // Create floating clone
        const rect = card.getBoundingClientRect();
        const clone = card.cloneNode(true);
        clone.className = 'dc-card touch-dragging';
        clone.style.position = 'fixed';
        clone.style.width = rect.width + 'px';
        clone.style.left = rect.left + 'px';
        clone.style.top = rect.top + 'px';
        clone.style.pointerEvents = 'none';
        document.body.appendChild(clone);
        _touchDragState.clone = clone;
        card.style.opacity = '0.3';
      }, 250);
    }, { passive: false });

    card.addEventListener('touchmove', e => {
      if (!_touchDragState) return;
      const touch = e.touches[0];
      const dx = Math.abs(touch.clientX - _touchDragState.startX);
      const dy = Math.abs(touch.clientY - _touchDragState.startY);
      // Cancel hold if finger moves too much before hold triggers
      if (!_touchDragState.isDragging && (dx > 10 || dy > 10)) {
        clearTimeout(_touchDragState.holdTimer);
        _touchDragState = null;
        return;
      }
      if (!_touchDragState.isDragging) return;
      e.preventDefault();
      // Move clone with finger
      const clone = _touchDragState.clone;
      if (clone) {
        clone.style.left = (touch.clientX - clone.offsetWidth / 2) + 'px';
        clone.style.top = (touch.clientY - clone.offsetHeight / 2) + 'px';
      }
      // Highlight target column
      grid.querySelectorAll('.pos-col.drag-over').forEach(el => el.classList.remove('drag-over'));
      grid.querySelectorAll('.dc-drop-indicator').forEach(el => el.remove());
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      const col = target?.closest('.pos-col');
      if (col) {
        col.classList.add('drag-over');
        const cards = [...col.querySelectorAll('.dc-card')].filter(c => c !== _touchDragState.card);
        const afterCard = cards.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = touch.clientY - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) return { offset, el: child };
          return closest;
        }, { offset: -Infinity, el: null }).el;
        const indicator = document.createElement('div');
        indicator.className = 'dc-drop-indicator';
        if (afterCard) col.insertBefore(indicator, afterCard);
        else col.appendChild(indicator);
      }
    }, { passive: false });

    card.addEventListener('touchend', e => {
      if (!_touchDragState) return;
      clearTimeout(_touchDragState.holdTimer);
      const state = _touchDragState;
      _touchDragState = null;
      if (!state.isDragging) {
        state.card.classList.remove('touch-held');
        return;
      }
      // Find drop target
      const touch = e.changedTouches[0];
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      const col = target?.closest('.pos-col');
      if (col) {
        const cards = [...col.querySelectorAll('.dc-card')].filter(c => c !== state.card);
        const afterCard = cards.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = touch.clientY - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) return { offset, el: child };
          return closest;
        }, { offset: -Infinity, el: null }).el;
        if (afterCard) col.insertBefore(state.card, afterCard);
        else col.appendChild(state.card);
        saveDepthOrder();
        if (navigator.vibrate) navigator.vibrate(15);
      }
      // Cleanup
      state.card.style.opacity = '';
      state.card.classList.remove('touch-held', 'touch-dragging');
      if (state.clone) state.clone.remove();
      grid.querySelectorAll('.dc-drop-indicator').forEach(el => el.remove());
      grid.querySelectorAll('.pos-col.drag-over').forEach(el => el.classList.remove('drag-over'));
    });

    card.addEventListener('touchcancel', () => {
      if (!_touchDragState) return;
      clearTimeout(_touchDragState.holdTimer);
      _touchDragState.card.style.opacity = '';
      _touchDragState.card.classList.remove('touch-held', 'touch-dragging');
      if (_touchDragState.clone) _touchDragState.clone.remove();
      _touchDragState = null;
      grid.querySelectorAll('.dc-drop-indicator').forEach(el => el.remove());
      grid.querySelectorAll('.pos-col.drag-over').forEach(el => el.classList.remove('drag-over'));
    });
  });

  // === Desktop column drop handlers (unchanged) ===
  grid.querySelectorAll('.pos-col').forEach(col => {
    col.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      col.classList.add('drag-over');
      // Remove existing indicators
      grid.querySelectorAll('.dc-drop-indicator').forEach(el => el.remove());
      // Find closest card
      const cards = [...col.querySelectorAll('.dc-card:not(.dragging)')];
      const afterCard = cards.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = e.clientY - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) return { offset, el: child };
        return closest;
      }, { offset: -Infinity, el: null }).el;

      const indicator = document.createElement('div');
      indicator.className = 'dc-drop-indicator';
      if (afterCard) col.insertBefore(indicator, afterCard);
      else col.appendChild(indicator);
    });

    col.addEventListener('dragleave', e => {
      if (!col.contains(e.relatedTarget)) {
        col.classList.remove('drag-over');
        col.querySelectorAll('.dc-drop-indicator').forEach(el => el.remove());
      }
    });

    col.addEventListener('drop', e => {
      e.preventDefault();
      col.classList.remove('drag-over');
      grid.querySelectorAll('.dc-drop-indicator').forEach(el => el.remove());
      if (!_draggedCard) return;

      // Find insertion point
      const cards = [...col.querySelectorAll('.dc-card:not(.dragging)')];
      const afterCard = cards.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = e.clientY - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) return { offset, el: child };
        return closest;
      }, { offset: -Infinity, el: null }).el;

      if (afterCard) col.insertBefore(_draggedCard, afterCard);
      else col.appendChild(_draggedCard);

      saveDepthOrder();
    });
  });
}

function renderCapPanel(cap) {
  const panel = document.getElementById('capPanel');
  let h = '';

  // Team Salary breakdown
  h += `<div class="cap-card">`;
  h += `<h3>üí∞ Team Salary</h3>`;
  h += capRow('Active Salaries', cap.activeSalaries);
  h += capRow('Cap Holds (FAs)', cap.capHolds - (cap.draftCapHolds || 0));
  if (cap.draftCapHolds) h += capRow('Cap Holds (Draft)', cap.draftCapHolds);
  h += capRow('Dead Money', cap.deadMoney);
  if (cap.incompleteCharge) h += capRow('Incomplete Roster', cap.incompleteCharge, 'neg');
  h += `<div class="cap-row" style="border-top:1px solid var(--border);margin-top:.3rem;padding-top:.5rem">`;
  h += `<span class="label" style="font-weight:700;color:var(--text)">TEAM SALARY</span>`;
  h += `<span class="value" style="font-size:.85rem">${fmtMoneyFull(cap.teamSalary)}</span>`;
  h += `</div></div>`;

  // Cap Space & Thresholds
  h += `<div class="cap-card">`;
  h += `<h3>üìä Cap Space & Thresholds</h3>`;
  h += capRow('Salary Cap', T.cap);
  h += capRowDelta('Cap Space', cap.capSpace);
  h += `<div class="cap-bar" style="position:relative;height:10px;margin:.5rem 0">`;
  // Markers for Cap, Tax, Apron1, Apron2
  const maxRef = T.apron2 * 1.15;
  const markers = [{val:T.cap,label:'Cap',color:'var(--green)'},{val:T.tax,label:'Tax',color:'var(--yellow)'},{val:T.apron1,label:'A1',color:'var(--orange)'},{val:T.apron2,label:'A2',color:'var(--red)'}];
  markers.forEach(m => {
    const pct = Math.min(100, m.val / maxRef * 100);
    h += `<div style="position:absolute;left:${pct}%;top:-12px;transform:translateX(-50%);font-size:.45rem;color:${m.color};font-weight:600;white-space:nowrap">${m.label}</div>`;
    h += `<div style="position:absolute;left:${pct}%;top:0;width:1px;height:10px;background:${m.color};opacity:.6"></div>`;
  });
  const fillPct = Math.min(100, cap.teamSalary / maxRef * 100);
  const fillColor = cap.teamSalary > T.apron2 ? 'var(--red)' : cap.teamSalary > T.apron1 ? 'var(--orange)' : cap.teamSalary > T.tax ? 'var(--yellow)' : 'var(--green)';
  h += `<div class="cap-bar-fill" style="width:${fillPct}%;background:${fillColor};height:100%;border-radius:3px;transition:width .5s ease"></div>`;
  h += `</div>`;
  h += capRow('Luxury Tax', T.tax);
  h += capRowDelta('Tax Room', cap.taxRoom);
  h += capRow('1st Apron', T.apron1);
  h += capRowDelta('1st Apron Room', cap.apron1Room);
  if (cap.isHardCapped) h += `<div style="font-size:.6rem;color:var(--orange);margin:.2rem 0;font-weight:600">‚ö†Ô∏è HARD-CAPPED at 1st Apron (used Non-Tax MLE)</div>`;
  h += capRow('2nd Apron', T.apron2);
  h += capRowDelta('2nd Apron Room', cap.apron2Room);
  h += `</div>`;

  // Roster count
  h += `<div class="cap-card">`;
  h += `<h3>üë• Roster</h3>`;
  h += capRow('Standard Contracts', cap.rosterCount + '/15');
  if (cap.rosterCount < 14) {
    h += `<div style="font-size:.65rem;color:var(--red);margin-top:.3rem">‚ö†Ô∏è Need at least 14 standard contracts by opening night</div>`;
  }
  h += `</div>`;

  // Exceptions
  h += `<div class="cap-card">`;
  h += `<h3>üé´ Available Exceptions</h3>`;
  h += `<div class="exc-list">`;
  for (const exc of cap.exceptions) {
    const usedLabel = exc.used ? ` (used: ${fmtMoney(exc.used)})` : '';
    const noteLabel = exc.note ? ` ¬∑ ${exc.note}` : '';
    h += `<div class="exc-chip ${exc.available ? 'available' : 'unavailable'}">${exc.name}: ${fmtMoney(exc.remaining !== undefined ? exc.remaining : exc.amount)}${usedLabel}${noteLabel}</div>`;
  }
  h += `</div></div>`;

  // Trade History
  if (STATE.trades && STATE.trades.length) {
    h += `<div class="cap-card">`;
    h += `<h3>üîÑ Trade History</h3>`;
    h += `<div class="trade-history">`;
    for (const trade of [...STATE.trades].reverse()) {
      const date = new Date(trade.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      h += `<div class="trade-entry" style="padding:.5rem 0;border-bottom:1px solid var(--border)">`;
      h += `<div style="font-size:.6rem;color:var(--muted);margin-bottom:.25rem">${date}</div>`;
      if (trade.out.length) {
        h += `<div style="font-size:.7rem;color:var(--red);margin-bottom:.15rem">üì§ ${trade.out.map(p => p.name).join(', ')}</div>`;
      }
      if (trade.in.length) {
        h += `<div style="font-size:.7rem;color:var(--green)">üì• ${trade.in.map(p => `${p.name}${p.fromTeam ? ' ('+p.fromTeam+')' : ''}`).join(', ')}</div>`;
      }
      h += `</div>`;
    }
    h += `</div></div>`;
  }

  // Move log (enhanced)
  h += `<div class="cap-card">`;
  h += `<h3>üìù Move Log</h3>`;
  if (STATE.moves.length) {
    h += renderMoveLog();
  } else {
    h += `<div style="font-size:.7rem;color:var(--muted)">No moves yet. Use the roster panel to make decisions.</div>`;
  }
  h += `<div class="controls">`;
  h += `<button class="ctrl-btn" onclick="undoLast()">‚Ü© Undo</button>`;
  h += `<button class="ctrl-btn reset" onclick="resetTeam()">üóë Reset All</button>`;
  h += `</div></div>`;

  panel.innerHTML = h;
}

function capRow(label, value, cls) {
  const display = typeof value === 'number' ? fmtMoneyFull(value) : value;
  return `<div class="cap-row"><span class="label">${label}</span><span class="value ${cls || ''}">${display}</span></div>`;
}

function capRowDelta(label, value) {
  const cls = value >= 0 ? 'pos' : 'neg';
  return `<div class="cap-row"><span class="label">${label}</span><span class="value ${cls}">${fmtMoneyFull(value)}</span></div>`;
}

function shortExc(e) {
  return { 'Bird Exception': 'Bird', 'Early Bird Exception': 'Early Bird', 'Non-Bird Exception': 'Non-Bird',
    'Mid-Level Exception': 'MLE', 'Taxpayer Mid-Level Exception': 'Tax MLE', 'Room Mid-Level Exception': 'Room MLE',
    'Biannual Exception': 'BAE', 'Minimum Salary Exception': 'Min', 'Rookie Exception': 'Rookie',
    'Second Round Exception': '2nd Rnd' }[e] || e || '';
}

function esc(s) { return s.replace(/'/g, "\\'"); }

// ======================== ACTIONS ========================
function doOption(name, decision) {
  STATE.optionDecisions[name] = decision;
  const label = decision === 'pickup' ? 'Picked up' : decision === 'exercise' ? 'Exercised' : 'Declined';
  const p = allPlayers.find(p => p.name === name && p.team === STATE.team);
  STATE.moves.push({ action: label, detail: `${name}'s option (${fmtMoney(p?.sal27 || 0)})`, undo: { type: 'option', name } });
  saveState();
  showToast(`${label} ${name}'s option`, decision === 'decline' ? 'warning' : 'success');
  render();
}

function doRenounce(name) {
  STATE.renounced.add(name);
  const p = allPlayers.find(p => p.name === name && p.team === STATE.team);
  STATE.moves.push({ action: 'Renounced', detail: `${name} (freed ${fmtMoney(p?.capHold || 0)} cap hold)`, undo: { type: 'renounce', name } });
  saveState();
  showToast(`Renounced ${name} ‚Äî freed ${fmtMoney(p?.capHold || 0)}`, 'warning');
  render();
}

function doWaive(name, stretch = false) {
  STATE.waived.add(name);
  if (stretch) STATE.stretched.add(name);
  const p = allPlayers.find(p => p.name === name && p.team === STATE.team);
  const sig = (STATE.signings || []).find(s => s.name === name);
  let dead = 0;
  if (sig) {
    // Signed player ‚Äî dead cap depends on contract type
    if (sig.contractType === 'two-way' || sig.contractType === 'exhibit-10' || sig.contractType === 'non-guaranteed') {
      dead = 0;
    } else if (sig.contractType === 'partial-guaranteed') {
      dead = Math.round(sig.salary * (sig.guaranteedPct || 0) / 100);
    } else {
      dead = sig.salary;
    }
  } else if (p) {
    // Original roster player
    if (p.isTwoWay || p.st27 === 'TWO-WAY') {
      dead = 0;
    } else if (p.category === 'under_contract' || p.st27 === 'GUARANTEED') {
      dead = p.sal27;
    } else if (p.category === 'partial_guaranteed') {
      dead = p.ch27;
    }
    // non_guaranteed = 0 dead cap (already default)
  }
  if (stretch && dead > 0) {
    const endYr = sig ? (sig.end || 2027) : (p?.end || 2027);
    const rem = Math.max(1, endYr - 2026);
    const period = 2 * rem + 1;
    dead = Math.round(dead / period);
  }
  const sal = sig ? sig.salary : (p?.sal27 || 0);
  const detail = `${name} (${fmtMoney(sal)}${dead ? ', ' + fmtMoney(dead) + ' dead cap' + (stretch ? ' stretched' : '') : ', no dead cap'})`;
  STATE.moves.push({ action: stretch ? 'Waived & Stretched' : 'Waived', detail, undo: { type: 'waive', name } });
  saveState();
  showToast(`${stretch ? 'Waived & stretched' : 'Waived'} ${name}`, 'error');
  render();
}

function openWaiveModal(name) {
  const p = allPlayers.find(p => p.name === name && p.team === STATE.team);
  const sig = (STATE.signings || []).find(s => s.name === name);
  if (!p && !sig) return;
  const modal = document.getElementById('waiveModal');

  // Calculate dead cap amounts
  let fullDead = 0;
  let playerSal = 0;
  let playerSt = 'GUARANTEED';
  let playerEnd = 2027;
  let isNoDeadCap = false;

  if (sig) {
    playerSal = sig.salary;
    playerEnd = sig.end || 2027;
    if (sig.contractType === 'two-way' || sig.contractType === 'exhibit-10' || sig.contractType === 'non-guaranteed') {
      fullDead = 0;
      isNoDeadCap = true;
      playerSt = sig.contractType === 'two-way' ? 'TWO-WAY' : sig.contractType === 'exhibit-10' ? 'EXHIBIT 10' : 'NOT G';
    } else if (sig.contractType === 'partial-guaranteed') {
      fullDead = Math.round(sig.salary * (sig.guaranteedPct || 0) / 100);
      playerSt = 'PARTIAL G';
    } else {
      fullDead = sig.salary;
    }
  } else if (p) {
    playerSal = p.sal27;
    playerEnd = p.end || 2027;
    playerSt = p.st27 || 'GUARANTEED';
    const wasPickedUp = STATE.optionDecisions[p.name] === 'pickup' || STATE.optionDecisions[p.name] === 'exercise';
    if (p.isTwoWay || p.st27 === 'TWO-WAY') {
      fullDead = 0;
      isNoDeadCap = true;
    } else if (p.category === 'under_contract' || p.st27 === 'GUARANTEED' || wasPickedUp) {
      fullDead = p.sal27;
    } else if (p.category === 'partial_guaranteed') {
      fullDead = p.ch27;
    } else if (p.category === 'non_guaranteed') {
      fullDead = 0;
      isNoDeadCap = true;
    }
  }

  const remainingYrs = Math.max(1, playerEnd - 2026);
  const stretchPeriod = 2 * remainingYrs + 1;
  const stretchedDead = fullDead > 0 ? Math.round(fullDead / stretchPeriod) : 0;
  const canStretch = fullDead > 0 && stretchPeriod > 1;

  let h = `<h3>Waive ${name}?</h3>`;
  h += `<div class="player-info"><div class="name">${name}</div>`;
  h += `${(p?.pos || sig?.pos || '')} ¬∑ ${fmtMoney(playerSal)} salary ¬∑ ${playerSt}`;
  if (playerEnd > 2027) h += ` ¬∑ contract thru ${playerEnd}`;
  h += `</div>`;

  if (isNoDeadCap) {
    h += `<div class="waive-option" onclick="closeWaiveModal();doWaive('${esc(name)}')">`;
    h += `<div class="opt-title">Waive ‚Äî No dead cap</div>`;
    h += `<div class="opt-desc">${playerSt === 'TWO-WAY' ? 'Two-way contract' : playerSt === 'EXHIBIT 10' ? 'Exhibit 10 deal' : 'Non-guaranteed contract'}, team owes nothing</div>`;
    h += `<div class="opt-amount" style="color:var(--green)">$0 dead cap</div>`;
    h += `</div>`;
  } else {
    h += `<div class="waive-option" onclick="closeWaiveModal();doWaive('${esc(name)}')">`;
    h += `<div class="opt-title">Waive</div>`;
    h += `<div class="opt-desc">${fullDead < playerSal ? 'Guaranteed portion' : 'Full guaranteed amount'} hits cap immediately</div>`;
    h += `<div class="opt-amount">${fmtMoney(fullDead)} dead cap in 2026-27</div>`;
    h += `</div>`;
    if (canStretch) {
      h += `<div class="waive-option" onclick="closeWaiveModal();doWaive('${esc(name)}', true)">`;
      h += `<div class="opt-title">Waive & Stretch</div>`;
      h += `<div class="opt-desc">Spread dead cap over ${stretchPeriod} years (${remainingYrs} remaining √ó 2 + 1)</div>`;
      h += `<div class="opt-amount">${fmtMoney(stretchedDead)}/yr for ${stretchPeriod} years</div>`;
      h += `</div>`;
    }
  }
  h += `<button class="waive-cancel" onclick="closeWaiveModal()">Cancel</button>`;
  modal.innerHTML = h;
  document.getElementById('waiveOverlay').style.display = 'flex';
}

function closeWaiveModal() {
  document.getElementById('waiveOverlay').style.display = 'none';
}

// ======================== PHASE NAVIGATION ========================
function setPhase(id) {
  const currentIdx = PHASES.findIndex(p => p.id === STATE.phase);
  const targetIdx = PHASES.findIndex(p => p.id === id);
  if (targetIdx <= currentIdx) {
    STATE.phase = id;
    saveState();
    render();
  }
}

function advancePhase() {
  const currentIdx = PHASES.findIndex(p => p.id === STATE.phase);
  if (currentIdx < PHASES.length - 1) {
    // Can't leave lottery without running it
    if (STATE.phase === 'lottery' && !STATE.lotteryResults) {
      alert('Run the lottery first!');
      return;
    }
    STATE.phase = PHASES[currentIdx + 1].id;
    STATE.moves.push({ action: 'Phase', detail: `Advanced to ${PHASES[currentIdx + 1].label}`, undo: { type: 'phase', prev: PHASES[currentIdx].id } });
    saveState();
    render();
  }
}

function undoLast() {
  if (!STATE.moves.length) return;
  const last = STATE.moves.pop();
  const undoneAction = last.action;
  if (last.undo) {
    if (last.undo.type === 'option') delete STATE.optionDecisions[last.undo.name];
    if (last.undo.type === 'renounce') STATE.renounced.delete(last.undo.name);
    if (last.undo.type === 'waive') {
      STATE.waived.delete(last.undo.name);
      STATE.stretched.delete(last.undo.name);
    }
    if (last.undo.type === 'draft') {
      if (last.undo.prev) STATE.draftSelections[last.undo.slot] = last.undo.prev;
      else delete STATE.draftSelections[last.undo.slot];
    }
    if (last.undo.type === 'draft_sim') {
      // Remove last draft result and back up pick counter
      const pick = last.undo.pick;
      STATE.draftResults = (STATE.draftResults || []).filter(r => r.pick !== pick);
      delete STATE.draftSelections[pick];
      // Also remove AI picks after user's pick
      STATE.draftResults = STATE.draftResults.filter(r => r.pick < pick);
      STATE.draftCurrentPick = pick;
    }
    if (last.undo.type === 'phase') {
      STATE.phase = last.undo.prev;
    }
    if (last.undo.type === 'trade') {
      STATE.trades.pop();
      // Restore any S&T signings that were removed when the trade was confirmed
      if (last.undo.removedSATSignings) {
        for (const sig of last.undo.removedSATSignings) {
          STATE.signings.push(sig);
        }
      }
    }
    if (last.undo.type === 'signing') {
      STATE.signings.pop();
    }
    if (last.undo.type === 'extension') {
      STATE.extensions.pop();
    }
  }
  saveState();
  showToast(`Undid: ${undoneAction}`, 'info');
  render();
}

function resetTeam() {
  if (!confirm(`Reset all moves for ${STATE.team}?`)) return;
  localStorage.removeItem('rm_state_' + STATE.team);
  STATE = defaultState(STATE.team);
  showToast('All moves reset', 'warning');
  render();
}

// ======================== TOAST NOTIFICATIONS ========================
function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ======================== PLAYER HOVER CARD ========================
let _hoverTimeout = null;

function showPlayerCard(event, playerName) {
  clearTimeout(_hoverTimeout);
  _hoverTimeout = setTimeout(() => {
    const card = document.getElementById('playerHoverCard');
    const p = allPlayers.find(pl => pl.name === playerName && pl.team === STATE.team);
    if (!p) return;
    const ini = playerName.split(' ').map(w => w[0]).join('');
    const tv = tradeValueMap[playerName.toLowerCase()] || 0;
    const cd = contractsMap[playerName];
    let h = `<div class="phc-header">`;
    h += p.headshot ? `<img src="${p.headshot}" onerror="this.outerHTML='<div class=phc-ini>${ini}</div>'">` : `<div class="phc-ini">${ini}</div>`;
    h += `<div><div class="phc-name">${playerName}</div><div class="phc-sub">${p.pos || ''} ¬∑ ${p.age ? p.age + ' yrs' : ''} ¬∑ ${TEAMS[STATE.team]}</div></div></div>`;
    h += `<div class="phc-stats">`;
    h += `<div class="phc-stat"><span class="phc-stat-label">Salary</span><span class="phc-stat-val">${fmtMoney(p.sal27 || 0)}</span></div>`;
    h += `<div class="phc-stat"><span class="phc-stat-label">Trade Value</span><span class="phc-stat-val">${tv ? fmtMoney(tv) : '‚Äî'}</span></div>`;
    if (cd) {
      const yrsLeft = cd.yrs.filter(y => y && y.sal > 0).length;
      h += `<div class="phc-stat"><span class="phc-stat-label">Yrs Left</span><span class="phc-stat-val">${yrsLeft}</span></div>`;
      if (cd.totG) h += `<div class="phc-stat"><span class="phc-stat-label">Tot Guar</span><span class="phc-stat-val">${fmtMoney(cd.totG)}</span></div>`;
    }
    if (p.tradeKicker) h += `<div class="phc-stat"><span class="phc-stat-label">Trade Kicker</span><span class="phc-stat-val">${p.tradeKicker}%</span></div>`;
    h += `</div>`;
    card.innerHTML = h;
    // Position near cursor
    const rect = event.target.getBoundingClientRect();
    let top = rect.bottom + 8;
    let left = rect.left;
    if (top + 200 > window.innerHeight) top = rect.top - 200;
    if (left + 280 > window.innerWidth) left = window.innerWidth - 290;
    card.style.top = top + 'px';
    card.style.left = Math.max(8, left) + 'px';
    card.classList.add('show');
  }, 300);
}

function hidePlayerCard() {
  clearTimeout(_hoverTimeout);
  const card = document.getElementById('playerHoverCard');
  card.classList.remove('show');
}

// ======================== TRADE HISTORY RENDERING ========================
function renderTradeHistory() {
  if (!STATE.trades || !STATE.trades.length) return '';
  let h = `<div class="trade-history"><div class="trade-history-title">üîÑ Trade History <span style="font-size:.6rem;opacity:.6">(${STATE.trades.length})</span></div>`;
  STATE.trades.forEach((trade, i) => {
    const outNames = trade.out.map(p => p.name).join(', ') || 'none';
    const inNames = trade.in.map(p => p.name).join(', ') || 'none';
    h += `<div class="trade-item">`;
    h += `<div class="trade-dir"><span class="out">üì§ ${outNames}</span></div>`;
    h += `<div class="trade-dir"><span class="in">üì• ${inNames}</span></div>`;
    h += `</div>`;
  });
  h += `</div>`;
  return h;
}

// ======================== MOVE LOG RENDERING ========================
function renderMoveLog() {
  if (!STATE.moves || !STATE.moves.length) return '';
  const iconMap = {Trade:'trade',Waive:'waive',Sign:'sign','Free Agent':'sign',Draft:'draft',Option:'option',Phase:'phase',Renounce:'waive',Extend:'sign',Stretch:'waive'};
  let h = `<div class="move-log">`;
  // Show last 15 moves, newest first
  const recent = [...STATE.moves].reverse().slice(0, 15);
  for (const m of recent) {
    const iconType = Object.entries(iconMap).find(([k]) => m.action.includes(k))?.[1] || 'phase';
    const emoji = {trade:'üîÑ',waive:'‚úÇÔ∏è',sign:'‚úçÔ∏è',draft:'üèÄ',option:'‚öôÔ∏è',phase:'üìã'}[iconType] || 'üìã';
    h += `<div class="move-item"><div class="move-icon ${iconType}">${emoji}</div><span style="flex:1;color:var(--text)">${m.action}</span><span style="color:var(--muted);font-size:.55rem">${m.detail ? m.detail.substring(0,50) + (m.detail.length > 50 ? '...' : '') : ''}</span></div>`;
  }
  h += `</div>`;
  return h;
}

// ======================== TRADE MACHINE INTEGRATION ========================
let _tradeContext = null; // { playerName } or null for team-level

let _tmUrl = '';
let _tmBaseUrl = '';
let _tmPreloaded = false;

function preloadTradeMachine() {
  if (_tmPreloaded || !STATE) return;
  const abbrev = TEAMS[STATE.team];
  if (!abbrev) return;
  _tmBaseUrl = `${TRADE_MACHINE_URL}/?rm=${abbrev}&t=${abbrev},${getRandomTradePartner(abbrev)}`;
  const iframe = document.getElementById('tmIframe');
  if (iframe) {
    iframe.src = _tmBaseUrl;
    _tmPreloaded = true;
    iframe.onload = function() {
      iframe.dataset.ready = '1';
    };
    console.log('[TM] Preloading Trade Machine');
  }
}

function getRandomTradePartner(excludeAbbrev) {
  const allAbbrevs = Object.values(TEAMS).filter(a => a !== excludeAbbrev);
  return allAbbrevs[Math.floor(Math.random() * allAbbrevs.length)];
}

function openTradeModal(playerName) {
  // Clear any stale S&T pending flag
  window._pendingSATSigning = null;
  const abbrev = TEAMS[STATE.team];
  const partner = getRandomTradePartner(abbrev);
  
  // Build Trade Machine URL with RM mode flag + both teams
  _tmUrl = `${TRADE_MACHINE_URL}/?rm=${abbrev}&t=${abbrev},${partner}`;
  
  if (playerName) {
    const p = allPlayers.find(p => p.name === playerName && p.team === STATE.team);
    const playerId = p?.headshot ? (p.headshot.match(/\/(\d+)\.png/)?.[1] || '') : '';
    const pParam = playerId || playerName.replace(/[^a-zA-Z0-9]+/g, '-').replace(/^-|-$/g, '');
    _tmUrl += `&p=${encodeURIComponent(pParam)}&pd=0-`;
  }
  
  const overlay = document.getElementById('tmOverlay');
  const iframe = document.getElementById('tmIframe');
  const loading = document.getElementById('tmLoading');
  const extLink = document.getElementById('tmExternalLink');
  
  extLink.href = _tmUrl;
  
  const iframeReady = iframe.dataset.ready === '1';
  
  if (iframeReady && !playerName) {
    // Team-level open with preloaded iframe ‚Äî show instantly
    loading.style.display = 'none';
    iframe.style.display = 'block';
  } else if (iframeReady && playerName) {
    // Player-specific but iframe already loaded ‚Äî navigate and show immediately
    iframe.style.display = 'block';
    loading.style.display = 'none';
    iframe.src = _tmUrl;
  } else {
    // Not yet loaded ‚Äî show iframe (it may be mid-load from preload) + spinner
    iframe.style.display = 'block';
    loading.style.display = 'flex';
    iframe.onload = function() {
      loading.style.display = 'none';
      iframe.dataset.ready = '1';
    };
    if (iframe.src === 'about:blank' || !iframe.src) {
      iframe.src = _tmUrl;
    }
  }
  
  overlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function tmFallbackNewTab() {
  closeTradeMachine();
  window.open(_tmUrl, '_blank');
}

function closeTradeMachine() {
  const overlay = document.getElementById('tmOverlay');
  overlay.style.display = 'none';
  document.body.style.overflow = '';
  // If there's a pending S&T signing and no trade is being processed, roll it back
  // (_pendingTrade is set when TM sends a trade, so don't roll back in that case)
  if (window._pendingSATSigning && !_pendingTrade) {
    rollbackPendingSAT();
  }
}

function rollbackPendingSAT() {
  const pendingName = window._pendingSATSigning;
  if (!pendingName) return;
  window._pendingSATSigning = null;
  
  // Remove the S&T signing
  const sigIdx = (STATE.signings || []).findIndex(s => s.isSAT && s.name === pendingName);
  if (sigIdx !== -1) {
    STATE.signings.splice(sigIdx, 1);
  }
  // Remove the corresponding move (search from end)
  for (let i = STATE.moves.length - 1; i >= 0; i--) {
    if (STATE.moves[i].action === 'Signed' && STATE.moves[i].detail.includes(pendingName) && STATE.moves[i].detail.includes('S&T')) {
      STATE.moves.splice(i, 1);
      break;
    }
  }
  saveState();
  showToast(`S&T cancelled ‚Äî ${pendingName} signing rolled back`, 'info');
  render();
}

// Escape key closes Trade Machine overlay
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('tmOverlay').style.display !== 'none') {
    closeTradeMachine();
  }
});

function closeTradeModal() {
  closeTradeMachine();
}

// Listen for trade data from Trade Machine iframe
let _pendingTrade = null;

window.addEventListener('message', function(event) {
  if (!event.data) return;
  
  // Close message from Trade Machine
  if (event.data.type === 'ROSTER_MANAGER_CLOSE') {
    closeTradeMachine();
    return;
  }
  
  if (event.data.type !== 'ROSTER_MANAGER_TRADE') return;
  if (!STATE) return;
  
  const data = event.data;
  const teamAbbrev = TEAMS[STATE.team];
  
  // Verify this trade is for the current team
  if (data.team !== teamAbbrev) {
    console.warn('[RM] Trade team mismatch:', data.team, 'vs', teamAbbrev);
    return;
  }
  
  // Build the trade object
  _pendingTrade = {
    out: (data.out || []).map(p => ({ name: p.name, salary: p.salary, pos: p.pos || '', headshot: p.headshot || '' })),
    in: (data.in || []).map(p => ({ name: p.name, salary: p.salary, pos: p.pos || '', headshot: p.headshot || '', fromTeam: p.fromTeam || '' })),
    timestamp: data.timestamp || Date.now()
  };
  
  // Close TM and show confirm dialog
  closeTradeMachine();
  showTradeConfirm(_pendingTrade);
});

function showTradeConfirm(trade) {
  const body = document.getElementById('tradeConfirmBody');
  let h = '';
  
  // Outgoing players
  h += `<div class="tc-section"><div class="tc-section-title" style="color:var(--red)">üì§ Sending Out</div>`;
  if (trade.out.length) {
    for (const p of trade.out) {
      h += `<div class="tc-player">`;
      if (p.headshot) h += `<img src="${p.headshot}" onerror="this.style.display='none'">`;
      h += `<div class="tc-player-info"><div class="tc-player-name">${p.name}</div><div class="tc-player-sal">${p.pos ? p.pos + ' ¬∑ ' : ''}${fmtMoney(p.salary)}</div></div></div>`;
    }
  } else {
    h += `<div style="font-size:.75rem;color:var(--muted);padding:.3rem 0">No players</div>`;
  }
  h += `</div>`;
  
  // Incoming players
  h += `<div class="tc-section"><div class="tc-section-title" style="color:var(--green)">üì• Receiving</div>`;
  if (trade.in.length) {
    for (const p of trade.in) {
      h += `<div class="tc-player">`;
      if (p.headshot) h += `<img src="${p.headshot}" onerror="this.style.display='none'">`;
      h += `<div class="tc-player-info"><div class="tc-player-name">${p.name}</div><div class="tc-player-sal">${p.pos ? p.pos + ' ¬∑ ' : ''}${fmtMoney(p.salary)}${p.fromTeam ? ' ¬∑ from ' + p.fromTeam : ''}</div></div></div>`;
    }
  } else {
    h += `<div style="font-size:.75rem;color:var(--muted);padding:.3rem 0">No players</div>`;
  }
  h += `</div>`;
  
  // Salary delta + cap impact
  const salOut = trade.out.reduce((s,p) => s + (p.salary || 0), 0);
  const salIn = trade.in.reduce((s,p) => s + (p.salary || 0), 0);
  const delta = salIn - salOut;
  h += `<div style="padding:.6rem;background:var(--surface);border-radius:8px;margin-top:.5rem">`;
  h += `<div style="display:flex;justify-content:space-between;font-size:.7rem;margin-bottom:.3rem"><span>Salary out</span><span style="color:var(--green)">${fmtMoney(salOut)}</span></div>`;
  h += `<div style="display:flex;justify-content:space-between;font-size:.7rem;margin-bottom:.3rem"><span>Salary in</span><span style="color:var(--red)">${fmtMoney(salIn)}</span></div>`;
  h += `<div style="display:flex;justify-content:space-between;font-size:.75rem;font-weight:700;padding-top:.3rem;border-top:1px solid var(--border)"><span>Net impact</span><span style="color:${delta > 0 ? 'var(--red)' : 'var(--green)'}">${delta > 0 ? '+' : ''}${fmtMoney(delta)}</span></div>`;
  // Show projected new cap space
  if (STATE) {
    const cap = calcCapSheet(STATE.team);
    const newCapSpace = cap.capSpace - delta;
    h += `<div style="display:flex;justify-content:space-between;font-size:.65rem;margin-top:.3rem;opacity:.7"><span>Projected cap space</span><span style="color:${newCapSpace >= 0 ? 'var(--green)' : 'var(--red)'}">~ ${fmtMoney(newCapSpace)}</span></div>`;
  }
  h += `</div>`;
  
  body.innerHTML = h;
  document.getElementById('tradeConfirmOverlay').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function confirmPendingTrade() {
  if (!_pendingTrade) return;
  
  // S&T trade completed ‚Äî clear pending flag
  window._pendingSATSigning = null;
  
  // For S&T trades: match incoming players with S&T signings, transfer metadata, remove signing
  const removedSATSignings = [];
  for (const incoming of (_pendingTrade.in || [])) {
    const satIdx = (STATE.signings || []).findIndex(s => s.isSAT && s.name === incoming.name);
    if (satIdx !== -1) {
      const satSig = STATE.signings[satIdx];
      // Transfer S&T signing metadata to the trade record
      incoming.isSAT = true;
      incoming.salary = satSig.salary; // Use the S&T salary from the signing
      incoming.years = satSig.years;
      incoming.end = satSig.end;
      incoming.contractType = satSig.contractType || 'guaranteed';
      incoming.guaranteedPct = satSig.guaranteedPct;
      incoming.exception = satSig.exception;
      // Save and remove the S&T signing to avoid duplication
      removedSATSignings.push(satSig);
      STATE.signings.splice(satIdx, 1);
    }
  }
  
  STATE.trades.push(_pendingTrade);
  
  const outNames = _pendingTrade.out.map(p => p.name).join(', ') || 'none';
  const inNames = _pendingTrade.in.map(p => `${p.name}${p.fromTeam ? ' (' + p.fromTeam + ')' : ''}`).join(', ') || 'none';
  STATE.moves.push({
    action: 'Trade',
    detail: `Sent: ${outNames} ‚Üí Received: ${inNames}`,
    undo: { type: 'trade', removedSATSignings }
  });
  
  saveState();
  _pendingTrade = null;
  document.getElementById('tradeConfirmOverlay').style.display = 'none';
  document.body.style.overflow = '';
  showToast(`Trade completed! Acquired ${inNames}`, 'success');
  render();
  console.log('[RM] Trade confirmed');
}

function rejectPendingTrade() {
  _pendingTrade = null;
  document.getElementById('tradeConfirmOverlay').style.display = 'none';
  document.body.style.overflow = '';
  // Roll back S&T signing if this was an S&T trade that was rejected
  rollbackPendingSAT();
  console.log('[RM] Trade rejected');
}

// ======================== EXTENSION ENGINE ========================
const EXT_CAP = 166000000; // 2026-27 projected salary cap
const EXT_RAISE_PCT = 0.08; // 8% annual raises for extensions

function parseExtCode(code) {
  // Format: RSE:25:5 or VET:30:4
  if (!code) return null;
  const parts = code.split(':');
  if (parts.length < 3) return null;
  const type = parts[0].toUpperCase(); // RSE or VET
  const maxPct = parseInt(parts[1]) || 25;
  const maxYears = parseInt(parts[2]) || 4;
  if (type !== 'RSE' && type !== 'VET') return null;
  return { type, maxPct, maxYears };
}

function calcExtension(maxPct, years, customStartSalary) {
  // Starting salary = cap √ó maxPct (or custom if user adjusts)
  const maxStarting = Math.round(EXT_CAP * (maxPct / 100));
  const startSalary = customStartSalary || maxStarting;
  const breakdown = [];
  let total = 0;
  for (let y = 0; y < years; y++) {
    // 8% raise each year from starting salary (not compounding from prior year in NBA extensions)
    // Actually NBA extensions use 8% of year-1 salary as the raise amount each year
    const raise = Math.round(startSalary * EXT_RAISE_PCT);
    const sal = startSalary + (raise * y);
    breakdown.push({ year: y + 1, salary: sal });
    total += sal;
  }
  return { startSalary, maxStarting, breakdown, total };
}

function openExtModal(playerName) {
  const p = allPlayers.find(p => p.name === playerName && p.team === STATE.team);
  if (!p || !p.extEligible) return;

  const ext = parseExtCode(p.extEligible);
  if (!ext) { alert('Invalid extension code: ' + p.extEligible); return; }

  document.getElementById('extModalTitle').textContent = `Extend ${playerName}`;
  const modal = document.getElementById('extModalBody');

  const maxStarting = Math.round(EXT_CAP * (ext.maxPct / 100));
  const initCalc = calcExtension(ext.maxPct, ext.maxYears);

  // Determine extension start year
  const extStartYear = p.end > 0 ? p.end + 1 : 2027;

  let h = '';

  // Player info
  h += `<div class="ext-player-info">`;
  if (p.headshot) h += `<img src="${p.headshot}" alt="">`;
  h += `<div>`;
  h += `<div class="name">${p.name}`;
  h += `<span class="ext-type-badge ${ext.type.toLowerCase()}">${ext.type === 'RSE' ? 'Rookie Scale' : 'Veteran'}</span>`;
  h += `</div>`;
  h += `<div class="meta">${p.pos || ''} ¬∑ ${p.age || ''} ¬∑ Current: ${fmtMoney(p.sal27 || p.sal26)}/yr ¬∑ Under contract thru ${p.end || '‚Äî'}</div>`;
  h += `</div></div>`;

  // Extension config
  h += `<div class="ext-config">`;

  // Max % info
  h += `<div class="ext-note">üìä Max starting salary: <strong>${ext.maxPct}% of cap</strong> = <strong>${fmtMoneyFull(maxStarting)}</strong> ¬∑ 8% annual raises ¬∑ Up to ${ext.maxYears} years</div>`;

  // Starting salary
  h += `<label>Starting Salary (Year 1)</label>`;
  h += `<div class="row">`;
  h += `<input type="range" id="extSalRange" min="${Math.round(maxStarting * 0.3)}" max="${maxStarting}" step="100000" value="${maxStarting}" oninput="updateExtPreview()">`;
  h += `<span class="sal-display" id="extSalDisplay">${fmtMoneyFull(maxStarting)}</span>`;
  h += `</div>`;
  h += `<div class="row">`;
  h += `<input type="number" id="extSalInput" value="${maxStarting}" min="1000000" max="${maxStarting}" step="100000" style="flex:1" oninput="syncExtSlider()">`;
  h += `</div>`;

  // Years
  h += `<label style="margin-top:.5rem">Extension Length</label>`;
  h += `<div class="row">`;
  h += `<select id="extYears" onchange="updateExtPreview()">`;
  for (let y = 1; y <= ext.maxYears; y++) {
    h += `<option value="${y}" ${y === ext.maxYears ? 'selected' : ''}>${y} year${y > 1 ? 's' : ''} (thru ${extStartYear + y - 1})</option>`;
  }
  h += `</select>`;
  h += `</div>`;
  h += `</div>`;

  // Breakdown placeholder
  h += `<div class="ext-breakdown" id="extBreakdown"></div>`;

  // Note about cap impact
  if (extStartYear > 2027) {
    h += `<div class="ext-note">‚ÑπÔ∏è Extension starts in ${extStartYear}-${String(extStartYear + 1).slice(2)}, after current contract. No impact on 2026-27 cap.</div>`;
  } else {
    h += `<div class="ext-note">‚ö° Extension starts in 2026-27. First-year salary will apply to the cap sheet.</div>`;
  }

  // Confirm
  h += `<button class="ext-confirm-btn" id="extConfirmBtn" onclick="confirmExtension()">‚úÖ Confirm Extension</button>`;
  h += `<button class="waive-cancel" onclick="closeExtModal()">Cancel</button>`;

  modal.innerHTML = h;

  // Store context
  window._extContext = { playerName, ext, extStartYear, maxStarting };

  document.getElementById('extOverlay').style.display = 'flex';

  // Initial breakdown
  updateExtPreview();
}

function closeExtModal() {
  document.getElementById('extOverlay').style.display = 'none';
  window._extContext = null;
}

function syncExtSlider() {
  const val = parseInt(document.getElementById('extSalInput').value) || 0;
  const ctx = window._extContext;
  if (!ctx) return;
  const clamped = Math.max(Math.round(ctx.maxStarting * 0.3), Math.min(val, ctx.maxStarting));
  document.getElementById('extSalRange').value = clamped;
  updateExtPreview();
}

function updateExtPreview() {
  const ctx = window._extContext;
  if (!ctx) return;

  const startSalary = parseInt(document.getElementById('extSalRange').value) || ctx.maxStarting;
  const years = parseInt(document.getElementById('extYears').value) || ctx.ext.maxYears;

  // Sync input field
  document.getElementById('extSalInput').value = startSalary;
  document.getElementById('extSalDisplay').textContent = fmtMoneyFull(startSalary);

  const calc = calcExtension(ctx.ext.maxPct, years, startSalary);

  let h = `<h4>üìã Year-by-Year Breakdown</h4>`;
  for (const yr of calc.breakdown) {
    const season = (ctx.extStartYear + yr.year - 1);
    const seasonLabel = `${season}-${String(season + 1).slice(2)}`;
    h += `<div class="ext-year-row">`;
    h += `<span class="yr">${seasonLabel}</span>`;
    h += `<span class="sal">${fmtMoneyFull(yr.salary)}</span>`;
    h += `</div>`;
  }
  h += `<div class="ext-total-row">`;
  h += `<span>Total Value</span>`;
  h += `<span>${fmtMoneyFull(calc.total)} / ${years}yr</span>`;
  h += `</div>`;

  document.getElementById('extBreakdown').innerHTML = h;
}

function confirmExtension() {
  const ctx = window._extContext;
  if (!ctx) return;

  const startSalary = parseInt(document.getElementById('extSalRange').value) || ctx.maxStarting;
  const years = parseInt(document.getElementById('extYears').value) || ctx.ext.maxYears;
  const calc = calcExtension(ctx.ext.maxPct, years, startSalary);
  const endYear = ctx.extStartYear + years - 1;

  const extension = {
    name: ctx.playerName,
    type: ctx.ext.type,
    maxPct: ctx.ext.maxPct,
    startSalary,
    years,
    endYear,
    extStartYear: ctx.extStartYear,
    breakdown: calc.breakdown,
    total: calc.total,
    timestamp: Date.now()
  };

  STATE.extensions.push(extension);

  STATE.moves.push({
    action: 'Extended',
    detail: `${ctx.playerName} ‚Äî ${years}yr / ${fmtMoney(calc.total)} (${fmtMoney(startSalary)}/yr starting, thru ${endYear})`,
    undo: { type: 'extension' }
  });

  saveState();
  closeExtModal();
  showToast(`Extended ${ctx.playerName} ‚Äî ${years}yr / ${fmtMoney(calc.total)}`, 'success');
  render();
}

// ======================== FREE AGENCY SIGNING ========================
function openSignModal(faName, isResign) {
  const modal = document.getElementById('signModalBody');
  document.getElementById('signModalTitle').textContent = isResign ? `Re-sign ${faName}` : 'Sign Free Agent';
  window._signIsResign = !!isResign;

  const cap = calcCapSheet(STATE.team);
  let h = '';

  if (!faName) {
    // Build full FA list
    const alreadySigned = new Set((STATE.signings || []).map(s => s.name));
    const allFAs = allPlayers.filter(p =>
      isProjectedFA(p) && p.team !== STATE.team && !alreadySigned.has(p.name)
    ).sort((a,b) => (b.tv||0) - (a.tv||0));

    h += `<div style="margin-bottom:.5rem">`;
    h += `<input id="signSearchInput" class="trade-input" style="width:100%" placeholder="Filter players..." oninput="filterSignList(this.value)">`;
    h += `</div>`;
    h += `<div id="signSearchResults" style="max-height:300px;overflow-y:auto;margin-bottom:.75rem">`;
    const undrafted = getUndraftedProspects();
    h += buildFAListHTML(allFAs, undrafted);
    h += `</div>`;
    h += `<div id="signExcSection" style="display:none">`;
  } else {
    const p = allPlayers.find(p => p.name === faName);
    const tv = tradeValueMap[faName.toLowerCase()] || 0;
    const playerMax = p ? getPlayerMaxSalary(p) : Math.round(T.cap * 0.25);
    const playerMin = p ? getPlayerMinSalary(p) : MIN_SALARY_0YOS;
    const yos = p ? getPlayerYOS(p) : 0;
    const maxPctLabel = yos >= 10 ? '35%' : yos >= 7 ? '30%' : '25%';
    h += `<div style="padding:.5rem;background:var(--surface);border-radius:6px;margin-bottom:.75rem;font-size:.7rem;line-height:1.5">`;
    h += `<div style="font-weight:700;font-size:.8rem">${faName}</div>`;
    if (p) h += `<div>${p.pos || ''} ¬∑ was ${fmtMoneyFull(p.sal26)} in 25-26 ¬∑ ~${yos} YOS</div>`;
    h += `<div style="display:flex;gap:.75rem;flex-wrap:wrap">`;
    if (tv) h += `<span>TV: <strong>${fmtMoneyFull(tv)}</strong></span>`;
    h += `<span>Min: <strong style="color:var(--green)">${fmtMoneyFull(playerMin)}</strong></span>`;
    h += `<span>Max (${maxPctLabel}): <strong style="color:var(--orange)">${fmtMoneyFull(playerMax)}</strong></span>`;
    h += `</div>`;
    if (p?.exception) h += `<div style="font-size:.6rem;color:var(--muted)">Rights: ${p.exception} ¬∑ Raises: ${Math.round(getPlayerRaiseRate(p, '') * 100)}%</div>`;
    h += `</div>`;
    h += `<input type="hidden" id="signPlayerName" value="${faName}">`;
    h += `<div id="signExcSection">`;
    // Set player context for re-sign
    const projSal = tv > playerMin ? Math.min(tv, playerMax) : (p?.sal26 || playerMin);
    const defaultRaiseRate = p ? getPlayerRaiseRate(p, '') : 0.05;
    window._signPlayerContext = { name: faName, team: p?.team || STATE.team, tv, projSalary: projSal, isTwoWayLevel: false, needsSAT: false, playerMax, playerMin, defaultRaiseRate, rookieScale: p ? isRookieScale(p) : false, yos, exception: p?.exception || '' };
  }

  // Exception options
  h += `<h4 style="font-size:.75rem;color:var(--muted);margin-bottom:.5rem">Choose Exception</h4>`;
  for (const exc of cap.exceptions) {
    // Hide S&T for re-signing own FAs
    if (exc.isSAT && window._signIsResign) continue;
    const cls = exc.available ? '' : 'unavailable';
    h += `<div class="sign-exc-option ${cls}" ${exc.available ? `onclick="selectSignException('${esc(exc.name)}', ${exc.remaining !== undefined ? exc.remaining : exc.amount})"` : ''}>`;
    h += `<div class="exc-name">${exc.name}${exc.hardCapNote ? ` <span style="font-size:.55rem;color:var(--orange)">${exc.hardCapNote}</span>` : ''}${exc.note ? ` <span style="font-size:.55rem;color:var(--muted)">(${exc.note})</span>` : ''}</div>`;
    h += `<div class="exc-detail">${exc.available ? (exc.remaining !== undefined ? 'Remaining: ' + fmtMoneyFull(exc.remaining) : 'Up to ' + fmtMoneyFull(exc.amount)) : 'Not available'}${exc.used ? ` (used ${fmtMoneyFull(exc.used)})` : ''}</div>`;
    h += `</div>`;
  }

  if (!faName) h += `</div>`; // close signExcSection
  h += `<div id="signSalarySection" style="display:none">`;
  // Year 1 salary
  h += `<div class="sign-config-row">`;
  h += `<label>Year 1:</label>`;
  h += `<input id="signSalaryInput" class="sign-yr-sal-input" type="text" placeholder="$0" style="flex:1" oninput="onSignSalaryInput(this)" onblur="formatSignSalaryField(this)">`;
  h += `</div>`;
  // Quick-sign buttons (populated by selectSignException)
  h += `<div id="signQuickButtons" style="display:none"></div>`;
  // Years selector
  h += `<div class="sign-config-row">`;
  h += `<label>Years:</label>`;
  h += `<select id="signYearsInput" onchange="updateSignPreview()">`;
  for (let i = 1; i <= 5; i++) h += `<option value="${i}">${i}</option>`;
  h += `</select>`;
  h += `</div>`;
  // Raise type
  h += `<div class="sign-config-row">`;
  h += `<label>Raises:</label>`;
  h += `<select id="signRaiseType" onchange="updateSignPreview()">`;
  h += `<option value="5">5% (Non-Bird)</option>`;
  h += `<option value="8">8% (Bird Rights)</option>`;
  h += `<option value="0">Flat (no raises)</option>`;
  h += `</select>`;
  h += `</div>`;
  // S&T note
  h += `<div id="satNote" class="sign-sat-note" style="display:none">‚ö†Ô∏è Sign-and-Trade: min 3yr / max 4yr ¬∑ Receiving team hard-capped at 1st apron ¬∑ Trade Machine will open after signing</div>`;
  // Year-by-year breakdown
  h += `<div id="signYearBreakdown"></div>`;
  h += `<button class="trade-confirm-btn" onclick="confirmSigning()" style="margin-top:.5rem">‚úÖ Sign Player</button>`;
  h += `</div>`;
  h += `<button class="waive-cancel" onclick="closeSignModal()">Cancel</button>`;

  modal.innerHTML = h;
  document.getElementById('signOverlay').style.display = 'flex';
  window._signContext = { exception: null, maxAmount: 0 };
}

function buildFAListHTML(fas, undrafted) {
  if (!fas.length && !(undrafted && undrafted.length)) return `<div style="font-size:.7rem;color:var(--muted);padding:.5rem;text-align:center">No free agents available</div>`;
  let h = '';
  for (const p of fas) {
    let reason = 'expiring';
    if (p.category === 'team_option') reason = 'TO decline proj.';
    else if (p.category === 'player_option') reason = 'PO decline proj.';
    const ini = p.name.split(' ').map(w => w[0]).join('');
    const hs = p.headshot
      ? `<img src="${p.headshot}" style="width:28px;height:21px;border-radius:3px;object-fit:cover;background:var(--surface)" onerror="this.outerHTML='<span style=\\'display:inline-block;width:28px;text-align:center;font-size:.5rem;color:var(--muted)\\'>${ini}</span>'">`
      : `<span style="display:inline-block;width:28px;text-align:center;font-size:.5rem;color:var(--muted)">${ini}</span>`;
    h += `<div class="draft-pick-option" onclick="selectSignPlayer('${esc(p.name)}')" style="display:flex;align-items:center;gap:.4rem">`;
    h += hs;
    h += `<span class="name" style="flex:1">${p.name}</span>`;
    h += `<span class="assigned" style="font-size:.6rem">${TEAMS[p.team] || p.team} ¬∑ ${p.pos || ''} ¬∑ ${fmtMoneyFull(p.sal26)} ¬∑ ${reason}</span>`;
    h += `</div>`;
  }
  // Undrafted prospects
  if (undrafted && undrafted.length) {
    h += `<div style="padding:.4rem .5rem;font-size:.6rem;font-weight:700;color:var(--orange);border-bottom:1px solid var(--border);margin-top:.3rem">UNDRAFTED FREE AGENTS</div>`;
    for (const name of undrafted) {
      const ini = name.split(' ').map(w => w[0]).join('');
      h += `<div class="draft-pick-option" onclick="selectSignPlayer('${esc(name)}')" style="display:flex;align-items:center;gap:.4rem">`;
      h += `<span style="display:inline-block;width:28px;text-align:center;font-size:.5rem;color:var(--muted)">${ini}</span>`;
      h += `<span class="name" style="flex:1">${name}</span>`;
      h += `<span class="assigned" style="font-size:.6rem">UDFA ¬∑ min salary</span>`;
      h += `</div>`;
    }
  }
  return h;
}

function getUndraftedProspects() {
  if (!STATE.draftResults || !STATE.draftResults.length || STATE.draftCurrentPick <= 60) return [];
  const drafted = getDraftedProspects();
  const alreadySigned = new Set((STATE.signings || []).map(s => s.name));
  return allProspects.filter(n => !drafted.has(n) && !alreadySigned.has(n));
}

function filterSignList(query) {
  const results = document.getElementById('signSearchResults');
  const alreadySigned = new Set((STATE.signings || []).map(s => s.name));
  const q = (query || '').toLowerCase();
  const fas = allPlayers.filter(p =>
    isProjectedFA(p) && p.team !== STATE.team && !alreadySigned.has(p.name) &&
    (!q || p.name.toLowerCase().includes(q) || (TEAMS[p.team]||'').toLowerCase().includes(q) || (p.pos||'').toLowerCase().includes(q))
  ).sort((a,b) => (b.tv||0) - (a.tv||0));
  const undrafted = getUndraftedProspects().filter(n => !q || n.toLowerCase().includes(q));
  results.innerHTML = buildFAListHTML(fas, undrafted);
}

function closeSignModal() {
  document.getElementById('signOverlay').style.display = 'none';
}

function isProjectedFA(p) {
  // Already a free agent (expiring contract)
  if (p.category === 'free_agent' || !p.sal27) return true;
  // Team option: team declines if player's trade value < their salary
  if (p.category === 'team_option' && (p.tv || 0) < (p.sal27 || 0)) return true;
  // Player option: player declines if trade value > salary (they'd get more on open market)
  if (p.category === 'player_option' && (p.tv || 0) > (p.sal27 || 0)) return true;
  return false;
}

function selectSignPlayer(name) {
  const p = allPlayers.find(pl => pl.name === name);
  const tv = tradeValueMap[name.toLowerCase()] || 0;
  
  // Compute player salary bounds
  const playerMax = p ? getPlayerMaxSalary(p) : Math.round(T.cap * 0.25);
  const playerMin = p ? getPlayerMinSalary(p) : MIN_SALARY_0YOS;
  
  // Projected salary = trade value, bounded by player min and max
  let projSalary = tv || playerMin;
  if (projSalary < playerMin) projSalary = playerMin;
  if (projSalary > playerMax) projSalary = playerMax;
  // If two-way level player (TV < min * 1.5), default to min
  const isTwoWayLevel = tv > 0 && tv < MIN_SALARY_0YOS * 1.5;
  if (isTwoWayLevel) projSalary = playerMin;

  // Check which exceptions can cover this salary
  const cap = calcCapSheet(STATE.team);
  const maxExcAmount = Math.max(...cap.exceptions.filter(e => e.available && e.name !== 'Two-Way' && e.name !== 'Exhibit 10' && e.name !== 'Sign-and-Trade').map(e => e.remaining !== undefined ? e.remaining : e.amount), 0);
  const needsSAT = projSalary > maxExcAmount && !isTwoWayLevel;

  // Determine raise rate from player's exception
  const defaultRaiseRate = p ? getPlayerRaiseRate(p, '') : 0.05;
  const rookieScale = p ? isRookieScale(p) : false;
  const yos = p ? getPlayerYOS(p) : 0;
  const maxPctLabel = yos >= 10 ? '35%' : yos >= 7 ? '30%' : '25%';

  // Show selected player info with salary range
  let infoHtml = `<div style="padding:.5rem;background:var(--surface);border-radius:6px;font-size:.7rem;line-height:1.5">`;
  infoHtml += `<div style="font-weight:700;font-size:.8rem;margin-bottom:.15rem">${name}</div>`;
  if (p) infoHtml += `<div>${p.pos || ''} ¬∑ ${TEAMS[p.team] || p.team} ¬∑ Age ${p.age || '?'} ¬∑ ~${yos} YOS</div>`;
  infoHtml += `<div style="display:flex;gap:.75rem;flex-wrap:wrap;margin-top:.2rem">`;
  infoHtml += `<span>TV: <strong>${fmtMoneyFull(tv)}</strong></span>`;
  infoHtml += `<span>Min: <strong style="color:var(--green)">${fmtMoneyFull(playerMin)}</strong></span>`;
  infoHtml += `<span>Max (${maxPctLabel}): <strong style="color:var(--orange)">${fmtMoneyFull(playerMax)}</strong></span>`;
  infoHtml += `</div>`;
  if (p?.exception) infoHtml += `<div style="font-size:.6rem;color:var(--muted);margin-top:.15rem">Rights: ${p.exception}${rookieScale ? ' ¬∑ Rookie Scale' : ''} ¬∑ Default raises: ${Math.round(defaultRaiseRate * 100)}%</div>`;
  if (needsSAT) infoHtml += `<div style="color:var(--orange);font-weight:600;margin-top:.2rem">‚ö†Ô∏è Projected salary exceeds available exceptions ‚Äî S&T likely needed</div>`;
  infoHtml += `</div>`;
  document.getElementById('signSearchResults').innerHTML = infoHtml;

  // Create hidden input
  let inp = document.getElementById('signPlayerName');
  if (!inp) {
    inp = document.createElement('input');
    inp.type = 'hidden';
    inp.id = 'signPlayerName';
    document.getElementById('signModalBody').appendChild(inp);
  }
  inp.value = name;
  // Store player context
  window._signPlayerContext = { name, team: p?.team || '', tv, projSalary, isTwoWayLevel, needsSAT, playerMax, playerMin, defaultRaiseRate, rookieScale, yos, exception: p?.exception || '' };
  document.getElementById('signExcSection').style.display = '';
}

function selectSignException(excName, maxAmount) {
  const ctx = window._signPlayerContext || {};
  const playerMax = ctx.playerMax || Math.round(T.cap * 0.25);
  const playerMin = ctx.playerMin || MIN_SALARY_0YOS;
  
  // Effective max: can't exceed player max OR exception amount (whichever is lower)
  // S&T bypasses exception limits (original team uses Bird rights), but still capped by player max
  const effectiveMax = excName === 'Sign-and-Trade' ? playerMax : Math.min(playerMax, maxAmount);
  
  window._signContext = { exception: excName, maxAmount, effectiveMax };
  document.getElementById('signSalarySection').style.display = '';

  const salInput = document.getElementById('signSalaryInput');
  const yrsInput = document.getElementById('signYearsInput');
  const raiseInput = document.getElementById('signRaiseType');
  const satNote = document.getElementById('satNote');

  // Determine raise rate from player's exception type
  const p = allPlayers.find(pl => pl.name === ctx.name);
  const raiseRate = p ? getPlayerRaiseRate(p, excName) : (excName === 'Sign-and-Trade' ? 0.08 : 0.05);

  // Configure years options
  let minYrs = 1, maxYrs = 5;
  if (excName === 'Sign-and-Trade') { minYrs = 3; maxYrs = 4; }
  else if (excName === 'Two-Way' || excName === 'Exhibit 10') { minYrs = 1; maxYrs = 2; }
  else if (excName === 'Minimum') { maxYrs = 3; }

  // Rebuild years dropdown
  let yrsHtml = '';
  for (let i = minYrs; i <= maxYrs; i++) yrsHtml += `<option value="${i}">${i}</option>`;
  yrsInput.innerHTML = yrsHtml;
  yrsInput.value = excName === 'Sign-and-Trade' ? 3 : minYrs;

  // Set raise type from player's rights
  if (excName === 'Minimum' || excName === 'Two-Way' || excName === 'Exhibit 10') {
    raiseInput.value = '0';
    raiseInput.disabled = true;
  } else {
    raiseInput.value = String(Math.round(raiseRate * 100));
    raiseInput.disabled = false;
  }

  // Set default salary = trade value, bounded by effective max
  let defaultSal;
  if (excName === 'Minimum' || excName === 'Two-Way' || excName === 'Exhibit 10') {
    defaultSal = playerMin;
  } else {
    const proj = ctx.projSalary || playerMin;
    defaultSal = Math.max(playerMin, Math.min(proj, effectiveMax));
  }
  salInput.value = fmtMoneyFull(defaultSal);
  salInput.dataset.raw = defaultSal;

  // S&T note
  if (satNote) satNote.style.display = excName === 'Sign-and-Trade' ? '' : 'none';

  // Quick-sign buttons (Min / TV / Max)
  const quickDiv = document.getElementById('signQuickButtons');
  if (quickDiv) {
    const isMinType = excName === 'Minimum' || excName === 'Two-Way' || excName === 'Exhibit 10';
    if (isMinType) {
      quickDiv.innerHTML = '';
      quickDiv.style.display = 'none';
    } else {
      let qh = `<div style="display:flex;gap:.35rem;flex-wrap:wrap;margin:.35rem 0">`;
      qh += `<button type="button" onclick="setSignSalary(${playerMin})" style="font-size:.6rem;padding:.2rem .5rem;border:1px solid var(--border);border-radius:4px;background:var(--surface);color:var(--green);cursor:pointer">Min ${fmtMoney(playerMin)}</button>`;
      if (ctx.tv && ctx.tv > playerMin && ctx.tv <= effectiveMax) {
        qh += `<button type="button" onclick="setSignSalary(${ctx.tv})" style="font-size:.6rem;padding:.2rem .5rem;border:1px solid var(--border);border-radius:4px;background:var(--surface);color:var(--accent);cursor:pointer">TV ${fmtMoney(ctx.tv)}</button>`;
      }
      qh += `<button type="button" onclick="setSignSalary(${effectiveMax})" style="font-size:.6rem;padding:.2rem .5rem;border:1px solid var(--border);border-radius:4px;background:var(--surface);color:var(--orange);cursor:pointer">Max ${fmtMoney(effectiveMax)}</button>`;
      qh += `</div>`;
      quickDiv.innerHTML = qh;
      quickDiv.style.display = '';
    }
  }

  // Highlight selected exception
  document.querySelectorAll('.sign-exc-option').forEach(el => el.style.borderColor = '');
  if (event && event.target) {
    const opt = event.target.closest('.sign-exc-option');
    if (opt) opt.style.borderColor = 'var(--accent)';
  }

  updateSignPreview();
}

function setSignSalary(amount) {
  const salInput = document.getElementById('signSalaryInput');
  if (salInput) {
    salInput.value = fmtMoneyFull(amount);
    salInput.dataset.raw = amount;
    updateSignPreview();
  }
}

// === Currency input helpers ===
function parseRawSalary(str) {
  if (!str) return 0;
  return parseInt(str.toString().replace(/[$,\s]/g, '')) || 0;
}

function onSignSalaryInput(el) {
  // Strip non-numeric, store raw
  const raw = el.value.replace(/[^0-9]/g, '');
  el.dataset.raw = raw;
  // Don't reformat while typing ‚Äî just let them type digits
}

function formatSignSalaryField(el) {
  const raw = parseRawSalary(el.dataset.raw || el.value);
  if (raw > 0) {
    el.value = fmtMoneyFull(raw);
    el.dataset.raw = raw;
  }
  updateSignPreview();
}

// === Year-by-year preview ===
function getSignYearStructure() {
  const salInput = document.getElementById('signSalaryInput');
  const baseSal = parseRawSalary(salInput?.dataset?.raw || salInput?.value);
  const years = parseInt(document.getElementById('signYearsInput')?.value) || 1;
  const raiseRate = parseFloat(document.getElementById('signRaiseType')?.value) / 100 || 0;
  const excName = window._signContext?.exception || '';
  const isMin = excName === 'Minimum' || excName === 'Two-Way' || excName === 'Exhibit 10';

  const structure = [];
  for (let y = 0; y < years; y++) {
    const season = 2027 + y; // End-year: 2027 = '26-27 season
    const seasonLabel = `'${String(season - 1).slice(2)}-${String(season).slice(2)}`;
    let sal;
    if (isMin) {
      // Minimum contracts: use player's YOS-based minimum (increases each year as YOS grows)
      const ctx = window._signPlayerContext || {};
      const baseYos = ctx.yos || 0;
      sal = MIN_SALARY_BY_YOS[Math.min(baseYos + y, MIN_SALARY_BY_YOS.length - 1)] || MIN_SALARY_0YOS;
    } else {
      // Raises based on year 1 salary (NBA style: fixed raise amount each year)
      const raiseAmt = Math.round(baseSal * raiseRate);
      sal = baseSal + (raiseAmt * y);
    }
    // Default status: Year 1 always guaranteed, rest guaranteed too
    structure.push({ year: y, season, seasonLabel, salary: sal, status: 'guaranteed' });
  }
  return structure;
}

function updateSignPreview() {
  const container = document.getElementById('signYearBreakdown');
  if (!container) return;

  const structure = getSignYearStructure();
  if (!structure.length) { container.innerHTML = ''; return; }

  const excName = window._signContext?.exception || '';
  const isSimple = excName === 'Two-Way' || excName === 'Exhibit 10';

  let h = `<table class="sign-yr-table"><thead><tr>`;
  h += `<th>Season</th><th style="text-align:right">Salary</th>`;
  if (!isSimple) h += `<th>Status</th>`;
  h += `</tr></thead><tbody>`;

  let totalValue = 0;
  let totalGuaranteed = 0;
  const isMultiYear = structure.length > 1;

  for (const yr of structure) {
    totalValue += yr.salary;
    const isLastYear = yr.year === structure.length - 1;
    h += `<tr>`;
    h += `<td style="font-weight:600">${yr.seasonLabel}</td>`;
    h += `<td class="yr-sal" style="text-align:right">${fmtMoneyFull(yr.salary)}</td>`;
    if (!isSimple) {
      h += `<td><select class="sign-yr-status" data-yr="${yr.year}" onchange="onYearStatusChange()">`;
      h += `<option value="guaranteed"${yr.year === 0 ? ' selected' : ''}>Guaranteed</option>`;
      h += `<option value="non-guaranteed">Non-Guaranteed</option>`;
      h += `<option value="partial">Partially Guar.</option>`;
      if (isMultiYear && isLastYear) {
        h += `<option value="team_option">Team Option</option>`;
        h += `<option value="player_option">Player Option</option>`;
        h += `<option value="eto">Early Term. (ETO)</option>`;
      }
      h += `</select></td>`;
    }
    h += `</tr>`;
  }

  // Total row
  h += `<tr><td class="yr-total">Total</td>`;
  h += `<td class="yr-total" style="text-align:right">${fmtMoneyFull(totalValue)}</td>`;
  if (!isSimple) h += `<td class="yr-total" id="signGuarTotal"></td>`;
  h += `</tr>`;

  h += `</tbody></table>`;
  container.innerHTML = h;

  onYearStatusChange(); // Calculate guaranteed total
}

function onYearStatusChange() {
  const structure = getSignYearStructure();
  const selects = document.querySelectorAll('.sign-yr-status');
  let totalGuar = 0;

  selects.forEach(sel => {
    const yr = parseInt(sel.dataset.yr);
    const yrData = structure[yr];
    if (!yrData) return;
    const status = sel.value;
    if (status === 'guaranteed') totalGuar += yrData.salary;
    else if (status === 'partial') totalGuar += Math.round(yrData.salary * 0.5);
    // TO, PO, ETO, NG = 0 guaranteed
  });

  const totalEl = document.getElementById('signGuarTotal');
  if (totalEl) {
    totalEl.innerHTML = `<span style="font-size:.55rem;color:var(--green)">${fmtMoneyFull(totalGuar)} guar.</span>`;
  }
}

function confirmSigning() {
  const nameEl = document.getElementById('signPlayerName');
  if (!nameEl || !nameEl.value) { alert('Select a player first'); return; }
  const name = nameEl.value;
  const salInput = document.getElementById('signSalaryInput');
  const salary = parseRawSalary(salInput?.dataset?.raw || salInput?.value);
  const years = parseInt(document.getElementById('signYearsInput').value) || 1;
  const raiseRate = parseFloat(document.getElementById('signRaiseType')?.value) / 100 || 0;
  const isSignAndTrade = (window._signContext.exception === 'Sign-and-Trade');
  const excName = window._signContext.exception || '';

  if (!salary) { alert('Enter a salary amount'); return; }

  // Enforce player max salary
  const ctx = window._signPlayerContext || {};
  const effectiveMax = window._signContext?.effectiveMax || ctx.playerMax || Math.round(T.cap * 0.35);
  if (salary > effectiveMax) {
    alert(`Salary of ${fmtMoneyFull(salary)} exceeds this player's maximum of ${fmtMoneyFull(effectiveMax)}.`);
    return;
  }

  // S&T validation: min 3 years, max 4 years
  if (isSignAndTrade && years < 3) {
    alert('Sign-and-trade deals require a minimum of 3 years under current CBA rules.');
    return;
  }
  if (isSignAndTrade && years > 4) {
    alert('Sign-and-trade deals are limited to 4 years under current CBA rules.');
    return;
  }

  // Exception amount check for non-S&T (already bounded by effectiveMax above)

  // Hard-cap check for Non-Tax MLE
  if (excName === 'Non-Tax MLE') {
    const cap = calcCapSheet(STATE.team);
    const newTotal = cap.teamSalary + salary;
    if (newTotal > T.apron1) {
      alert(`Using the Non-Tax MLE hard-caps your team at the 1st apron (${fmtMoneyFull(T.apron1)}). This signing would put you at ${fmtMoneyFull(newTotal)}.`);
      return;
    }
  }

  // Build year structure from the preview table
  const yearStructure = [];
  const isMin = excName === 'Minimum' || excName === 'Two-Way' || excName === 'Exhibit 10';
  const statusSelects = document.querySelectorAll('.sign-yr-status');

  for (let y = 0; y < years; y++) {
    const season = 2027 + y;
    let yrSal;
    if (isMin) {
      yrSal = MIN_SALARY_0YOS;
    } else {
      const raiseAmt = Math.round(salary * raiseRate);
      yrSal = salary + (raiseAmt * y);
    }
    let status = 'guaranteed';
    if (statusSelects[y]) status = statusSelects[y].value;
    yearStructure.push({ season, salary: yrSal, status });
  }

  // Determine overall contract type from year structure
  const hasNG = yearStructure.some(y => y.status === 'non-guaranteed');
  const hasPartial = yearStructure.some(y => y.status === 'partial');
  const hasTO = yearStructure.some(y => y.status === 'team_option');
  const hasPO = yearStructure.some(y => y.status === 'player_option');
  const hasETO = yearStructure.some(y => y.status === 'eto');
  let contractType = 'guaranteed';
  if (excName === 'Two-Way') contractType = 'two-way';
  else if (excName === 'Exhibit 10') contractType = 'exhibit-10';
  else if (hasNG && !hasPartial && !hasTO && !hasPO) contractType = 'non-guaranteed';
  else if (hasPartial) contractType = 'partial-guaranteed';

  const p = allPlayers.find(p => p.name === name);
  const signing = {
    name,
    salary,
    years,
    raiseRate,
    exception: excName || 'FA',
    pos: p?.pos || '',
    headshot: p?.headshot || '',
    end: 2027 + years - 1,
    contractType,
    guaranteedPct: 100,
    isSignAndTrade,
    yearStructure
  };
  if (isSignAndTrade) {
    signing.fromTeam = window._signPlayerContext?.team || '';
    signing.isSAT = true;
  }

  STATE.signings.push(signing);

  // Build detail string
  const totalValue = yearStructure.reduce((s, y) => s + y.salary, 0);
  const totalGuar = yearStructure.reduce((s, y) => {
    if (y.status === 'guaranteed') return s + y.salary;
    if (y.status === 'partial') return s + Math.round(y.salary * 0.5);
    return s;
  }, 0);
  const typeFlags = [];
  if (hasTO) typeFlags.push('TO');
  if (hasPO) typeFlags.push('PO');
  if (hasETO) typeFlags.push('ETO');
  if (hasNG) typeFlags.push('NG');
  if (hasPartial) typeFlags.push('PG');
  const flagStr = typeFlags.length ? ` [${typeFlags.join(',')}]` : '';
  const satLabel = isSignAndTrade ? ` [S&T from ${TEAMS[signing.fromTeam] || signing.fromTeam}]` : '';

  STATE.moves.push({
    action: 'Signed',
    detail: `${name} ¬∑ ${fmtMoney(totalValue)}/${years}yr (${fmtMoney(salary)} yr1) via ${excName}${flagStr}${satLabel}`,
    undo: { type: 'signing' }
  });
  saveState();
  closeSignModal();
  showToast(`Signed ${name} ¬∑ ${fmtMoney(totalValue)}/${years}yr via ${excName}`, 'success');

  if (isSignAndTrade) {
    render();
    const fromAbbrev = TEAMS[signing.fromTeam] || signing.fromTeam || '';
    const myAbbrev = TEAMS[STATE.team] || '';
    // Track this as pending ‚Äî will be rolled back if TM closes without trade
    window._pendingSATSigning = signing.name;
    if (fromAbbrev) {
      setTimeout(() => {
        const satName = encodeURIComponent(name.replace(/\s+/g, '-').toLowerCase());
        _tmUrl = `${TRADE_MACHINE_URL}/?rm=${myAbbrev}&t=${fromAbbrev},${myAbbrev}&sat=${satName}&sat_sal=${salary}&sat_from=${fromAbbrev}`;
        const overlay = document.getElementById('tmOverlay');
        const iframe = document.getElementById('tmIframe');
        const loading = document.getElementById('tmLoading');
        const extLink = document.getElementById('tmExternalLink');
        extLink.href = _tmUrl;
        iframe.style.display = 'block';
        loading.style.display = 'flex';
        iframe.onload = function() { loading.style.display = 'none'; iframe.dataset.ready = '1'; };
        iframe.src = _tmUrl;
        overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }, 300);
    }
  } else {
    render();
  }
}

// ======================== DRAFT PICKER ========================
let _draftPickerSlot = null;

function openDraftPicker(slot) {
  _draftPickerSlot = slot;
  const overlay = document.getElementById('draftPickerOverlay');
  overlay.style.display = 'flex';
  document.getElementById('draftPickerTitle').textContent = `Select Prospect ‚Äî Pick #${slot}`;
  const input = overlay.querySelector('.draft-picker-search input');
  input.value = '';
  input.focus();
  renderDraftPickerList('');
}

function closeDraftPicker() {
  document.getElementById('draftPickerOverlay').style.display = 'none';
  _draftPickerSlot = null;
}

function renderDraftPickerList(filter) {
  const list = document.getElementById('draftPickerList');
  const slot = _draftPickerSlot;
  const teamAbbrev = TEAMS[STATE.team];
  const currentPick = (STATE.draftSelections && STATE.draftSelections[slot]) ||
    (allPickSlots[slot] ? allPickSlots[slot].defaultProspect : '');
  const filterLower = filter.toLowerCase();

  // Build set of prospects already selected by THIS team (other picks)
  const teamPicks = teamDraftPicks[teamAbbrev] || [];
  const takenByTeam = new Set();
  for (const tp of teamPicks) {
    if (tp.draftRnk === slot) continue;
    const sel = (STATE.draftSelections && STATE.draftSelections[tp.draftRnk]) || tp.prospect;
    takenByTeam.add(sel);
  }

  let h = '';
  const filtered = allProspects.filter(name =>
    name.toLowerCase().includes(filterLower)
  );

  for (let i = 0; i < filtered.length; i++) {
    const name = filtered[i];
    const isCurrent = name === currentPick;
    const isTaken = takenByTeam.has(name);
    // Find which team has this prospect as default
    let assignedTo = '';
    for (const [s, info] of Object.entries(allPickSlots)) {
      if (info.defaultProspect === name && info.team !== teamAbbrev) {
        assignedTo = `#${s} ${info.team}`;
        break;
      }
    }

    h += `<div class="draft-pick-option${isCurrent ? ' current' : ''}${isTaken ? ' taken' : ''}" `;
    if (!isTaken) h += `onclick="selectDraftProspect('${esc(name)}')"`;
    h += `>`;
    h += `<span class="rank">${i + 1}</span>`;
    h += `<span class="name">${name}</span>`;
    if (isCurrent) h += `<span class="assigned" style="color:var(--orange)">current</span>`;
    else if (assignedTo) h += `<span class="assigned">proj ${assignedTo}</span>`;
    h += `</div>`;
  }

  if (!filtered.length) h = '<div style="padding:1rem;text-align:center;color:var(--muted);font-size:.75rem">No prospects found</div>';
  list.innerHTML = h;
}

function selectDraftProspect(name) {
  const slot = _draftPickerSlot;
  if (!slot) return;
  const prev = STATE.draftSelections[slot] || null;
  STATE.draftSelections[slot] = name;
  const defaultName = allPickSlots[slot] ? allPickSlots[slot].defaultProspect : 'TBD';
  STATE.moves.push({
    action: 'Draft',
    detail: `Pick #${slot}: ${name}${name !== defaultName ? ' (was ' + defaultName + ')' : ''}`,
    undo: { type: 'draft', slot, prev }
  });
  saveState();
  closeDraftPicker();
  render();
}

function resetDraftPick(slot) {
  const prev = STATE.draftSelections[slot] || null;
  delete STATE.draftSelections[slot];
  const defaultName = allPickSlots[slot] ? allPickSlots[slot].defaultProspect : 'TBD';
  STATE.moves.push({
    action: 'Draft Reset',
    detail: `Pick #${slot}: back to ${defaultName}`,
    undo: { type: 'draft', slot, prev }
  });
  saveState();
  render();
}

// ======================== INIT ========================
async function init() {
  document.getElementById('loadingState').style.display = 'block';
  renderTeamDropdown();

  const [csv] = await Promise.all([fetchData(), fetchDraftPicks(), fetchContracts(), fetchTradeValues()]);
  if (!csv) {
    document.getElementById('loadingState').innerHTML = '<p style="color:var(--red)">Failed to load data. Try refreshing.</p>';
    const lb = document.getElementById('landingBody');
    if (lb) lb.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--red)">Failed to load data. Try refreshing.</div>';
    return;
  }

  allPlayers = parseAllPlayers(csv);
  document.getElementById('loadingState').style.display = 'none';
  renderTeamDropdown();
  renderLandingPage();

  // Hard refresh = clean slate: clear all saved state
  for (const key of Object.keys(localStorage)) {
    if (key.startsWith('rm_state_') || key === 'rm_last_team') localStorage.removeItem(key);
  }
}

function renderLandingPage() {
  const body = document.getElementById('landingBody');
  if (!body) return;

  const EAST = ['Atlanta','Boston','Brooklyn','Charlotte','Chicago','Cleveland','Detroit','Indiana','Miami','Milwaukee','New York','Orlando','Philadelphia','Toronto','Washington'];
  const WEST = ['Dallas','Denver','Golden State','Houston','LA Clippers','LA Lakers','Memphis','Minnesota','New Orleans','Oklahoma City','Phoenix','Portland','Sacramento','San Antonio','Utah'];

  function buildGrid(teams) {
    let h = '<div class="team-grid">';
    for (const full of teams) {
      const abbr = TEAMS[full] || full;
      const logo = teamLogos[full] || '';
      const colors = TEAM_COLORS[abbr] || ['#3b82f6','#2563eb'];
      h += `<div class="team-card" onclick="pickTeamFromLanding('${full.replace(/'/g,"\\'")}')\" onmouseenter="this.style.borderColor='${colors[0]}';this.style.background='${colors[0]}12'" onmouseleave="this.style.borderColor='';this.style.background=''">`;
      if (logo) {
        h += `<img src="${logo}" alt="${abbr}">`;
      } else {
        h += `<div style="width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:${colors[0]}18;border-radius:50%;font-size:1rem;font-weight:700;color:${colors[0]}">${abbr}</div>`;
      }
      h += `<div class="tc-abbr">${abbr}</div>`;
      h += `<div class="tc-name">${full}</div>`;
      h += `</div>`;
    }
    h += '</div>';
    return h;
  }

  let h = '';
  h += `<div class="conf-label east">Eastern Conference</div>`;
  h += buildGrid(EAST);
  h += `<div class="conf-label west">Western Conference</div>`;
  h += buildGrid(WEST);
  body.innerHTML = h;
}

function pickTeamFromLanding(team) {
  const landing = document.getElementById('landingPage');
  if (landing) {
    landing.style.transition = 'opacity .3s ease';
    landing.style.opacity = '0';
    setTimeout(() => { landing.style.display = 'none'; }, 300);
  }
  selectTeam(team);
}

// Override selectTeam to also save last team and hide landing
const _selectTeam = selectTeam;
selectTeam = function(team) {
  localStorage.setItem('rm_last_team', team);
  const landing = document.getElementById('landingPage');
  if (landing && landing.style.display !== 'none') {
    landing.style.transition = 'opacity .3s ease';
    landing.style.opacity = '0';
    setTimeout(() => { landing.style.display = 'none'; }, 300);
  }
  _selectTeam(team);
  // Preload Trade Machine in background after a short delay
  _tmPreloaded = false; // Reset for new team
  setTimeout(preloadTradeMachine, 500);
};

init();
</script>
</body>
</html>
