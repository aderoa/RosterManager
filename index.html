<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NBA Depth Charts by Trade Value</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: white; }
    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    header { text-align: center; margin-bottom: 2rem; }
    h1 { font-size: 2.5rem; margin-bottom: 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .subtitle { color: #8892b0; font-size: 1.1rem; }
    .back-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; text-decoration: none; font-weight: 500; margin-bottom: 1.5rem; transition: all 0.2s; }
    .back-btn:hover { background: rgba(255,255,255,0.2); }

    /* Admin banner */
    .admin-banner { display: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #1a1a2e; text-align: center; padding: 0.5rem 1rem; font-weight: 700; font-size: 0.9rem; position: sticky; top: 0; z-index: 100; }
    .admin-banner.active { display: flex; align-items: center; justify-content: center; gap: 1rem; flex-wrap: wrap; }
    .admin-save-status { display: inline-block; font-weight: 500; opacity: 0; transition: opacity 0.3s; }
    .admin-save-status.visible { opacity: 1; }
    .export-btn { padding: 0.4rem 1rem; background: #1a1a2e; color: #f59e0b; border: 1px solid #1a1a2e; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
    .export-btn:hover { background: #2a2a4e; }

    /* Team grid */
    .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; }
    .team-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 1.25rem; text-align: center; cursor: pointer; transition: all 0.2s; text-decoration: none; color: white; }
    .team-card:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); transform: translateY(-2px); }
    .team-logo { width: 56px; height: 56px; margin: 0 auto 0.75rem; object-fit: contain; }
    .team-name { font-weight: 600; font-size: 0.95rem; }
    .team-abbrev { color: #8892b0; font-size: 0.8rem; margin-top: 0.25rem; }

    /* Single team view */
    .depth-chart-container { display: none; }
    .depth-chart-container.active { display: block; }
    .team-header { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
    .team-header-logo { width: 72px; height: 72px; object-fit: contain; }
    .team-header-name { font-size: 1.75rem; font-weight: 700; }
    .drag-hint { text-align: center; color: #8892b0; font-size: 0.85rem; margin-bottom: 1rem; }

    .depth-chart { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; background: rgba(255,255,255,0.95); border-radius: 16px; padding: 1.25rem; color: #1a1a2e; }
    .position-column { display: flex; flex-direction: column; gap: 0.5rem; min-height: 200px; }
    .position-header { text-align: center; font-weight: 700; font-size: 1.1rem; color: #1a1a2e; padding: 0.5rem; border-bottom: 3px solid #667eea; margin-bottom: 0.25rem; }
    .player-card { background: white; border-radius: 12px; padding: 0.75rem; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s; border: 2px solid transparent; cursor: grab; user-select: none; }
    .player-card.spacer { background: transparent; box-shadow: none; border: 2px solid transparent; opacity: 1; cursor: default; pointer-events: none; }
    .player-card:hover { transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,0.12); border-color: #667eea; }
    .player-card.starter { background: linear-gradient(135deg, #fff 0%, #f0f4ff 100%); border: 2px solid #667eea; }
    .player-card.dragging { opacity: 0.5; cursor: grabbing; }
    .player-card.drag-over { border: 2px dashed #667eea; background: #f0f4ff; }
    .position-column.drag-over { background: rgba(102,126,234,0.1); border-radius: 8px; }
    /* Drop indicator line */
    .drop-indicator { height: 3px; background: #667eea; border-radius: 2px; margin: 2px 0; pointer-events: none; box-shadow: 0 0 6px rgba(102,126,234,0.6); transition: none; }
    .player-image { width: 80px; height: 60px; margin: 0 auto 0.5rem; border-radius: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; overflow: hidden; pointer-events: none; }
    .player-image img { width: 100%; height: 100%; object-fit: cover; }
    .player-image .initials { color: white; font-weight: 700; font-size: 1.2rem; }
    .player-name { font-weight: 600; font-size: 0.8rem; color: #1a1a2e; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
    .trade-value { font-size: 0.8rem; font-weight: 600; pointer-events: none; }
    .trade-value.high { color: #16a34a; }
    .trade-value.medium { color: #ca8a04; }
    .trade-value.low { color: #6b7280; }

    .loading { text-align: center; padding: 4rem 2rem; }
    .loading-spinner { width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.2); border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error { text-align: center; padding: 2rem; color: #f87171; }
    footer { text-align: center; margin-top: 2rem; padding: 1rem; color: #8892b0; font-size: 0.9rem; }
    footer a { color: #667eea; text-decoration: none; }

    /* Admin all-teams */
    .admin-all-teams { display: none; }
    .admin-all-teams.active { display: block; }
    .admin-team-row { margin-bottom: 1.5rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; overflow: hidden; }
    .admin-team-row-header { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.08); }
    .admin-team-row-logo { width: 36px; height: 36px; object-fit: contain; }
    .admin-team-row-name { font-weight: 700; font-size: 1rem; }
    .admin-team-row-abbrev { color: #8892b0; font-size: 0.8rem; margin-left: 0.25rem; }
    .admin-depth-chart { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; padding: 0.75rem; background: rgba(255,255,255,0.92); color: #1a1a2e; }
    .admin-position-column { display: flex; flex-direction: column; gap: 0.35rem; min-height: 80px; }
    .admin-position-header { text-align: center; font-weight: 700; font-size: 0.85rem; color: #1a1a2e; padding: 0.3rem; border-bottom: 2px solid #667eea; margin-bottom: 0.2rem; }
    .admin-player-card { background: white; border-radius: 8px; padding: 0.4rem 0.5rem; text-align: center; box-shadow: 0 1px 4px rgba(0,0,0,0.06); transition: transform 0.1s, box-shadow 0.1s, opacity 0.1s; border: 2px solid transparent; cursor: grab; user-select: none; font-size: 0.75rem; }
    .admin-player-card:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-color: #667eea; }
    .admin-player-card.starter { background: linear-gradient(135deg, #fff 0%, #f0f4ff 100%); border: 2px solid #667eea; }
    .admin-player-card.dragging { opacity: 0.5; cursor: grabbing; }
    .admin-player-card.drag-over { border: 2px dashed #667eea; background: #f0f4ff; }
    .admin-player-card.spacer.drag-over { opacity: 1; border: 2px solid #667eea; background: #3a3a6e; }
    .admin-position-column.drag-over { background: rgba(102,126,234,0.1); border-radius: 6px; }
    .admin-drop-indicator { height: 3px; background: #667eea; border-radius: 2px; margin: 1px 0; pointer-events: none; box-shadow: 0 0 6px rgba(102,126,234,0.6); transition: none; }
    .admin-player-name { font-weight: 600; font-size: 0.75rem; color: #1a1a2e; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
    .admin-player-card.two-way { background: #e1bee7; }
    .admin-player-card.ten-day { background: #fff9c4; }
    .admin-player-card.spacer { background: #2a2a4e; border: 1px dashed #444; display: flex; align-items: center; justify-content: center; opacity: 0.6; cursor: grab; position: relative; padding: 0.4rem 0.5rem; }
    .admin-player-card.spacer > * { pointer-events: none; }
    .admin-player-card.spacer .spacer-label { color: #666; font-size: 0.65rem; }
    .admin-player-card.spacer .spacer-delete { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #f44; cursor: pointer; font-size: 0.7rem; padding: 2px 4px; line-height: 1; }
    .admin-player-card.spacer .spacer-delete:hover { color: #ff6666; }
    .add-spacer-btn { width: 100%; padding: 3px; margin-top: 4px; background: transparent; border: 1px dashed #444; border-radius: 4px; color: #666; font-size: 0.65rem; cursor: pointer; transition: all 0.2s; }
    .add-spacer-btn:hover { border-color: #888; color: #aaa; background: rgba(255,255,255,0.03); }
    .admin-player-card.injured { background: #ef5350; color: white; }
    .admin-player-card.injured .admin-player-name { color: white; }
    .admin-player-card.injured .admin-trade-value { color: #ffcdd2 !important; }
    .admin-player-card.questionable { background: #ef9a9a; }
    .admin-separator { height: 2px; background: #ef5350; margin: 4px 0; border-radius: 1px; opacity: 0.6; pointer-events: none; }
    .admin-trade-value { font-size: 0.65rem; font-weight: 600; pointer-events: none; margin-top: 1px; }
    .admin-trade-value.high { color: #16a34a; }
    .admin-trade-value.medium { color: #ca8a04; }
    .admin-trade-value.low { color: #6b7280; }

    @media (max-width: 900px) { .depth-chart, .admin-depth-chart { grid-template-columns: repeat(3, 1fr); } .team-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); } }
    @media (max-width: 600px) { .depth-chart, .admin-depth-chart { grid-template-columns: repeat(2, 1fr); } h1 { font-size: 1.75rem; } .player-image { width: 60px; height: 45px; } }

    /* Export modal */
    .export-modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); z-index:200; align-items:center; justify-content:center; padding:2rem; }
    .export-modal.active { display:flex; }
    .export-modal-inner { background:#1e2a3a; border-radius:16px; width:100%; max-width:900px; max-height:90vh; display:flex; flex-direction:column; overflow:hidden; }
    .export-modal-header { display:flex; align-items:center; justify-content:space-between; padding:1rem 1.5rem; border-bottom:1px solid rgba(255,255,255,0.1); }
    .export-modal-header h3 { font-size:1.1rem; }
    .export-modal-actions { display:flex; gap:0.5rem; }
    .export-modal-actions button { padding:0.5rem 1rem; border-radius:8px; border:none; font-family:'DM Sans',sans-serif; font-weight:600; font-size:0.85rem; cursor:pointer; transition:all 0.2s; }
    .copy-btn { background:#667eea; color:white; }
    .copy-btn:hover { background:#5a6fd6; }
    .copy-btn.copied { background:#16a34a; }
    .close-btn { background:rgba(255,255,255,0.1); color:white; }
    .close-btn:hover { background:rgba(255,255,255,0.2); }
    .export-modal textarea { flex:1; background:#0d1117; color:#c9d1d9; border:none; padding:1rem 1.5rem; font-family:'Courier New',monospace; font-size:0.8rem; resize:none; outline:none; line-height:1.5; }
  </style>
</head>
<body>
  <div id="adminBanner" class="admin-banner">
    <span>üîß ADMIN MODE ‚Äî Drag to reorder, synced to GitHub</span>
    <span id="saveStatus" class="admin-save-status">‚úì Saved</span>
    <div style="display:flex;gap:0.5rem;align-items:center;">
      <button class="export-btn" onclick="copyExportDirect(true,0,15)">üì∑ Copy ATL-MEM</button>
      <button class="export-btn" onclick="copyExportDirect(true,15,30)">üì∑ Copy MIA-WAS</button>
      <button class="export-btn" onclick="manualRefresh(this)">üîÑ Refresh Data</button>
      <span id="refreshStatus" style="color:#1a1a2e;font-size:0.7rem;margin-left:8px;opacity:0.7;">Auto-refresh: 60s</span>
    </div>
  </div>
  <div class="container">
    <header><h1>üèÄ NBA Depth Charts</h1><p class="subtitle">Ranked by Trade Value</p></header>
    <div id="loading" class="loading"><div class="loading-spinner"></div><p>Loading NBA data...</p></div>
    <div id="teamGrid" class="team-grid" style="display:none;"></div>
    <div id="depthChartContainer" class="depth-chart-container">
      <a href="?" class="back-btn">‚Üê All Teams</a>
      <div class="team-header"><img id="teamLogo" class="team-header-logo" src="" alt=""><h2 id="teamName" class="team-header-name"></h2></div>
      <p class="drag-hint">üí° Drag players to rearrange or move between positions</p>
      <div id="depthChart" class="depth-chart"></div>
    </div>
    <div id="adminAllTeams" class="admin-all-teams">
      <p class="drag-hint">üí° Drag players to rearrange ‚Äî changes auto-sync to GitHub</p>
      <div id="adminTeamsList"></div>
    </div>

  <!-- Export Modal -->
  <div id="exportModal" class="export-modal" onclick="if(event.target===this)closeExportModal()">
    <div class="export-modal-inner">
      <div class="export-modal-header">
        <h3 id="exportModalTitle">üìã Export HTML</h3>
        <div class="export-modal-actions">
          <button class="copy-btn" onclick="copyExportCode()">üìã Copy to Clipboard</button>
          <button class="copy-btn" onclick="downloadExportCode()" style="margin-left:8px;">üíæ Download .txt</button>
          <button class="close-btn" onclick="closeExportModal()">‚úï Close</button>
        </div>
      </div>
      <textarea id="exportCode" readonly></textarea>
    </div>
  </div>
    <div id="error" class="error" style="display:none;"></div>
    <footer>Trade values computed using <a href="https://hoopsmatic.com" target="_blank">HoopsMatic</a> methodology</footer>
  </div>
<script>
// =====================================================
// HYBRID PERSISTENCE: localStorage (fast) + GitHub (durable)
// =====================================================
const STORAGE_KEY = 'depthcharts_orders';
const ADMIN_KEY = 'hoopsmatic2025';
const GH_TOKEN_KEY = 'depthcharts_gh_token';
const GH_REPO = 'aderoa/DepthCharts';
const GH_FILE = 'order.json';
const GH_API = `https://api.github.com/repos/${GH_REPO}/contents/${GH_FILE}`;
let isAdmin = false;
let ghSHA = null;         // current SHA of order.json on GitHub
let ghSaveTimer = null;   // debounce timer for GitHub pushes
let ghOrdersCache = null; // in-memory cache of the full orders object

function loadAllOrders() {
  if (ghOrdersCache) return ghOrdersCache;
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
  catch(e) { return {}; }
}
function saveAllOrders(orders) {
  ghOrdersCache = orders;
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(orders)); } catch(e) {}
  // Debounce GitHub push (admin only)
  if (isAdmin) {
    clearTimeout(ghSaveTimer);
    ghSaveTimer = setTimeout(() => pushToGitHub(orders), 2000);
  }
}
function saveTeamOrder(teamAbbrev, container) {
  const columns = container.querySelectorAll('[class*="position-column"]');
  const order = {};
  columns.forEach(col => {
    const pos = col.dataset.position;
    if (!pos) return;
    order[pos] = [];
    col.childNodes.forEach(node => {
      if (node.classList && node.classList.contains('admin-separator')) {
        order[pos].push('__SEPARATOR__');
      } else if (node.classList && (node.classList.contains('admin-player-card') || node.classList.contains('player-card'))) {
        if (node.dataset.player === '__SPACER__') order[pos].push('__SPACER__');
        else if (node.dataset.player) order[pos].push(node.dataset.player);
      }
    });
  });
  const all = loadAllOrders();
  all[teamAbbrev] = order;
  saveAllOrders(all);
  showSaveStatus('local');
}
function loadTeamOrder(t) { return (loadAllOrders())[t] || null; }

function showSaveStatus(mode) {
  const el = document.getElementById('saveStatus');
  if (mode === 'local') { el.textContent = 'üíæ Saving...'; el.style.color = '#1a1a2e'; }
  else if (mode === 'github') { el.textContent = '‚úì Synced to GitHub'; el.style.color = '#065f46'; }
  else if (mode === 'error') { el.textContent = '‚úó GitHub sync failed'; el.style.color = '#991b1b'; }
  else if (mode === 'loading') { el.textContent = '‚è≥ Loading from GitHub...'; el.style.color = '#1a1a2e'; }
  el.classList.add('visible');
  clearTimeout(el._t);
  if (mode === 'github' || mode === 'error') el._t = setTimeout(() => el.classList.remove('visible'), 4000);
}

// ---- GitHub Token Management ----
function getGHToken() {
  return localStorage.getItem(GH_TOKEN_KEY) || null;
}
function promptGHToken() {
  const token = prompt('Enter your GitHub Personal Access Token (needs repo scope).\nThis is stored locally and used to sync order.json to GitHub.');
  if (token && token.trim()) {
    localStorage.setItem(GH_TOKEN_KEY, token.trim());
    return token.trim();
  }
  return null;
}

// ---- Fetch order.json from GitHub (source of truth) ----
async function fetchFromGitHub() {
  try {
    const headers = { 'Accept': 'application/vnd.github.v3+json' };
    const token = getGHToken();
    if (token) headers['Authorization'] = `token ${token}`;
    const resp = await fetch(GH_API, { headers });
    if (!resp.ok) {
      if (resp.status === 404) { console.log('order.json not found on GitHub, will create on first save'); return null; }
      throw new Error(`GitHub API ${resp.status}`);
    }
    const data = await resp.json();
    ghSHA = data.sha;
    const content = atob(data.content.replace(/\n/g, ''));
    const orders = JSON.parse(content);
    // Update localStorage and cache
    ghOrdersCache = orders;
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(orders)); } catch(e) {}
    console.log('Loaded order.json from GitHub (SHA: ' + ghSHA.slice(0,7) + ')');
    return orders;
  } catch(e) {
    console.warn('Failed to fetch from GitHub:', e.message);
    return null;
  }
}

// ---- Push order.json to GitHub ----
async function pushToGitHub(orders) {
  let token = getGHToken();
  if (!token) {
    token = promptGHToken();
    if (!token) { showSaveStatus('error'); return; }
  }
  try {
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(orders, null, 2))));
    const body = {
      message: `Update depth chart orders ‚Äî ${new Date().toLocaleString()}`,
      content: content,
      branch: 'main'
    };
    if (ghSHA) body.sha = ghSHA;
    const resp = await fetch(GH_API, {
      method: 'PUT',
      headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (resp.status === 401 || resp.status === 403) {
      localStorage.removeItem(GH_TOKEN_KEY);
      showSaveStatus('error');
      alert('GitHub token expired or invalid. You will be prompted for a new one on next save.');
      return;
    }
    if (!resp.ok) throw new Error(`GitHub PUT ${resp.status}`);
    const data = await resp.json();
    ghSHA = data.content.sha;
    showSaveStatus('github');
    console.log('Pushed order.json to GitHub (SHA: ' + ghSHA.slice(0,7) + ')');
  } catch(e) {
    console.error('GitHub push failed:', e);
    showSaveStatus('error');
  }
}

// =====================================================
// TEAMS & ALIASES
// =====================================================
const NBA_TEAMS = [
  {abbrev:'ATL',name:'Atlanta Hawks',logo:'https://cdn.nba.com/logos/nba/1610612737/global/L/logo.svg'},
  {abbrev:'BOS',name:'Boston Celtics',logo:'https://cdn.nba.com/logos/nba/1610612738/global/L/logo.svg'},
  {abbrev:'BKN',name:'Brooklyn Nets',logo:'https://cdn.nba.com/logos/nba/1610612751/global/L/logo.svg'},
  {abbrev:'CHA',name:'Charlotte Hornets',logo:'https://cdn.nba.com/logos/nba/1610612766/global/L/logo.svg'},
  {abbrev:'CHI',name:'Chicago Bulls',logo:'https://cdn.nba.com/logos/nba/1610612741/global/L/logo.svg'},
  {abbrev:'CLE',name:'Cleveland Cavaliers',logo:'https://cdn.nba.com/logos/nba/1610612739/global/L/logo.svg'},
  {abbrev:'DAL',name:'Dallas Mavericks',logo:'https://cdn.nba.com/logos/nba/1610612742/global/L/logo.svg'},
  {abbrev:'DEN',name:'Denver Nuggets',logo:'https://cdn.nba.com/logos/nba/1610612743/global/L/logo.svg'},
  {abbrev:'DET',name:'Detroit Pistons',logo:'https://cdn.nba.com/logos/nba/1610612765/global/L/logo.svg'},
  {abbrev:'GSW',name:'Golden State Warriors',logo:'https://cdn.nba.com/logos/nba/1610612744/global/L/logo.svg'},
  {abbrev:'HOU',name:'Houston Rockets',logo:'https://cdn.nba.com/logos/nba/1610612745/global/L/logo.svg'},
  {abbrev:'IND',name:'Indiana Pacers',logo:'https://cdn.nba.com/logos/nba/1610612754/global/L/logo.svg'},
  {abbrev:'LAC',name:'LA Clippers',logo:'https://cdn.nba.com/logos/nba/1610612746/global/L/logo.svg'},
  {abbrev:'LAL',name:'Los Angeles Lakers',logo:'https://cdn.nba.com/logos/nba/1610612747/global/L/logo.svg'},
  {abbrev:'MEM',name:'Memphis Grizzlies',logo:'https://cdn.nba.com/logos/nba/1610612763/global/L/logo.svg'},
  {abbrev:'MIA',name:'Miami Heat',logo:'https://cdn.nba.com/logos/nba/1610612748/global/L/logo.svg'},
  {abbrev:'MIL',name:'Milwaukee Bucks',logo:'https://cdn.nba.com/logos/nba/1610612749/global/L/logo.svg'},
  {abbrev:'MIN',name:'Minnesota Timberwolves',logo:'https://cdn.nba.com/logos/nba/1610612750/global/L/logo.svg'},
  {abbrev:'NOP',name:'New Orleans Pelicans',logo:'https://cdn.nba.com/logos/nba/1610612740/global/L/logo.svg'},
  {abbrev:'NYK',name:'New York Knicks',logo:'https://cdn.nba.com/logos/nba/1610612752/global/L/logo.svg'},
  {abbrev:'OKC',name:'Oklahoma City Thunder',logo:'https://cdn.nba.com/logos/nba/1610612760/global/L/logo.svg'},
  {abbrev:'ORL',name:'Orlando Magic',logo:'https://cdn.nba.com/logos/nba/1610612753/global/L/logo.svg'},
  {abbrev:'PHI',name:'Philadelphia 76ers',logo:'https://cdn.nba.com/logos/nba/1610612755/global/L/logo.svg'},
  {abbrev:'PHX',name:'Phoenix Suns',logo:'https://cdn.nba.com/logos/nba/1610612756/global/L/logo.svg'},
  {abbrev:'POR',name:'Portland Trail Blazers',logo:'https://cdn.nba.com/logos/nba/1610612757/global/L/logo.svg'},
  {abbrev:'SAC',name:'Sacramento Kings',logo:'https://cdn.nba.com/logos/nba/1610612758/global/L/logo.svg'},
  {abbrev:'SAS',name:'San Antonio Spurs',logo:'https://cdn.nba.com/logos/nba/1610612759/global/L/logo.svg'},
  {abbrev:'TOR',name:'Toronto Raptors',logo:'https://cdn.nba.com/logos/nba/1610612761/global/L/logo.svg'},
  {abbrev:'UTA',name:'Utah Jazz',logo:'https://cdn.nba.com/logos/nba/1610612762/global/L/logo.svg'},
  {abbrev:'WAS',name:'Washington Wizards',logo:'https://cdn.nba.com/logos/nba/1610612764/global/L/logo.svg'}
];
const TEAM_ALIASES = {
  'Atlanta':'ATL','Hawks':'ATL','Boston':'BOS','Celtics':'BOS','Brooklyn':'BKN','Nets':'BKN',
  'Charlotte':'CHA','Hornets':'CHA','Chicago':'CHI','Bulls':'CHI','Cleveland':'CLE','Cavaliers':'CLE','Cavs':'CLE',
  'Dallas':'DAL','Mavericks':'DAL','Mavs':'DAL','Denver':'DEN','Nuggets':'DEN','Detroit':'DET','Pistons':'DET',
  'Golden State':'GSW','Warriors':'GSW','Houston':'HOU','Rockets':'HOU','Indiana':'IND','Pacers':'IND',
  'LA Clippers':'LAC','Clippers':'LAC','Los Angeles Lakers':'LAL','Lakers':'LAL','LA Lakers':'LAL',
  'Memphis':'MEM','Grizzlies':'MEM','Miami':'MIA','Heat':'MIA','Milwaukee':'MIL','Bucks':'MIL',
  'Minnesota':'MIN','Timberwolves':'MIN','Wolves':'MIN','New Orleans':'NOP','Pelicans':'NOP',
  'New York':'NYK','Knicks':'NYK','Oklahoma City':'OKC','Thunder':'OKC','Orlando':'ORL','Magic':'ORL',
  'Philadelphia':'PHI','76ers':'PHI','Sixers':'PHI','Phoenix':'PHX','Suns':'PHX',
  'Portland':'POR','Trail Blazers':'POR','Blazers':'POR','Sacramento':'SAC','Kings':'SAC',
  'San Antonio':'SAS','Spurs':'SAS','Toronto':'TOR','Raptors':'TOR','Utah':'UTA','Jazz':'UTA',
  'Washington':'WAS','Wizards':'WAS'
};

// =====================================================
// DATA URLs
// =====================================================
const TV_SHEET_ID = '2PACX-1vSg6im6IYB6HXMGzQbmmBnLw9SfQLzxCSo8OfChxlJLhsB6BBCO0wPF_TMch0YgAbtFqYkwDWrsxRe7';
const TV_GID = '1310971167';
const TV_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${TV_SHEET_ID}/pub?gid=${TV_GID}&single=true&output=csv`;
const ROSTER_GID = '0';
const ROSTER_CSV_URL = `https://docs.google.com/spreadsheets/d/e/${TV_SHEET_ID}/pub?gid=${ROSTER_GID}&single=true&output=csv`;
const INJURIES_JSON_URL = 'https://aderoa.github.io/Injuries/injuries.json';

let allPlayers = [], tradeValueMap = new Map(), draggedElement = null;

// =====================================================
// CSV PARSER
// =====================================================
function parseCSV(text) {
  const rows = []; let cur = '', inQ = false, row = [];
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (inQ) { if (c === '"' && text[i+1] === '"') { cur += '"'; i++; } else if (c === '"') inQ = false; else cur += c; }
    else { if (c === '"') inQ = true; else if (c === ',') { row.push(cur.trim()); cur = ''; }
    else if (c === '\n' || c === '\r') { if (c === '\r' && text[i+1] === '\n') i++; row.push(cur.trim()); if (row.length > 1 || row[0] !== '') rows.push(row); row = []; cur = ''; }
    else cur += c; }
  }
  if (cur || row.length > 0) { row.push(cur.trim()); if (row.length > 1 || row[0] !== '') rows.push(row); }
  return rows;
}

// =====================================================
// TRADE VALUE COMPUTATION
// =====================================================
function computeTradeValues(csvText) {
  const rows = parseCSV(csvText); const roster = [], historical = []; let todayStr = null;
  for (const row of rows.slice(1)) {
    while (row.length < 22) row.push('');
    if (row[18] && !todayStr) todayStr = row[18];
    if (row[0] && row[1]) roster.push({ player: row[1].trim(), rat365: parseFloat(row[2])||0, salary: parseInt(row[3].replace(/[$,]/g,''))||0, birthday: row[4]||'', draftPick: parseInt(row[20])||null });
    if (row[6] && row[7]) { const g = parseInt(row[9])||0; if (g > 0) historical.push({ year: row[6], player: row[7].trim(), totalRat: parseFloat(row[8].replace(/,/g,''))||0, games: g }); }
  }
  const playerHist = {}; for (const h of historical) { const k = h.player.toLowerCase(); if (!playerHist[k]) playerHist[k] = []; playerHist[k].push(h); }
  const WEIGHTS = {'2025-26':1.0,'2024-25':0.6,'2023-24':0.36,'2022-23':0.216,'2021-22':0.1296};
  const EXPECTED = {'2021-22':82,'2022-23':82,'2023-24':82,'2024-25':82,'2025-26':48};
  const EXP=1.8, BETA=0.8, MAX_MULT=1.4, MIN_PCT=0.40, WM_W=0.85, RAT_W=0.15, AGE_BONUS=1.0, OLD_TH=35, OLD_PEN=0.03;
  for (const p of roster) {
    const hist = playerHist[p.player.toLowerCase()]||[]; let num=0, den=0;
    for (const h of hist) { const w = WEIGHTS[h.year]||0; if (w<=0||h.games<=0) continue; let pg = h.totalRat/h.games; const exp = EXPECTED[h.year]||82; if (h.games/exp >= MIN_PCT) pg *= Math.min(MAX_MULT, Math.pow(exp/h.games, BETA)); num += pg*w*h.games; den += w*h.games; }
    p.watermark = den > 0 ? num/den : 0;
    const cur = hist.filter(h => h.year==='2025-26'); const cg = cur.reduce((s,h) => s+h.games, 0);
    p.rat365adj = (cg > 0 && cg/48 >= MIN_PCT) ? p.rat365 * Math.min(MAX_MULT, Math.pow(48/cg, BETA)) : p.rat365;
  }
  const pd = s => { if (!s) return null; const p = s.split('/'); return p.length===3 ? new Date(+p[2],+p[0]-1,+p[1]) : null; };
  const today = pd(todayStr)||new Date(); const ages = [];
  for (const p of roster) { const bd = pd(p.birthday); p.age = bd ? (today-bd)/(365.25*864e5) : null; if (p.age) ages.push(p.age); }
  const avgAge = ages.length > 0 ? ages.reduce((a,b)=>a+b,0)/ages.length : 26;
  const maxDev = avgAge - Math.min(...ages);
  for (const p of roster) {
    if (p.age!==null && p.age < avgAge) p.ageMult = 1.0 + AGE_BONUS*(avgAge-p.age)/maxDev;
    else if (p.age!==null && p.age >= OLD_TH) p.ageMult = Math.max(0.5, 1.0-OLD_PEN*(p.age-OLD_TH));
    else p.ageMult = 1.0;
  }
  const tSP = roster.reduce((s,p)=>s+p.salary,0);
  const tWM = roster.reduce((s,p)=>s+Math.pow(Math.max(p.watermark,0),EXP),0);
  const tRAT = roster.reduce((s,p)=>s+Math.pow(Math.max(p.rat365adj,0),EXP),0);
  for (const p of roster) {
    const tvWM = tWM>0 ? (Math.pow(Math.max(p.watermark,0),EXP)/tWM)*tSP : 0;
    const tvRAT = tRAT>0 ? (Math.pow(Math.max(p.rat365adj,0),EXP)/tRAT)*tSP : 0;
    p.tvWithAge = (WM_W*tvWM + RAT_W*tvRAT) * p.ageMult;
  }
  const tWA = roster.reduce((s,p)=>s+p.tvWithAge,0); const result = new Map();
  for (const p of roster) {
    const baseTV = tWA>0 ? Math.round((p.tvWithAge/tWA)*tSP) : 0; let bonus = 0;
    if (p.age!==null && p.age<25 && p.draftPick && p.draftPick>=1 && p.draftPick<=60) { bonus = Math.round(7e6 * Math.exp(-0.05*(p.draftPick-1)) * Math.exp(-0.5*Math.max(0,p.age-18.82))); }
    result.set(p.player.toLowerCase(), baseTV+bonus);
  }
  return result;
}

// =====================================================
// ROSTER PARSER (salary, headshot, status, injury)
// =====================================================
function parseRosterCSV(csvText) {
  const rows = parseCSV(csvText); if (rows.length < 2) return [];
  const hdr = rows[0]; const col = n => hdr.findIndex(h => h.toUpperCase() === n.toUpperCase());
  const PI=col('PLAYER'), TI=col('TEAM'), SI=col('2026'), STI=col('ST 25-26'), OI=col('OUT?'), RI=col('REASON'), LI=col('LOGO'), HI=col('HEADSHOT'), POI=col('POSITION');
  if (PI<0||TI<0) return [];
  const players = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i]; const name = r[PI]?.trim(); const team = r[TI]?.trim();
    if (!name||!team) continue;
    const abbrev = TEAM_ALIASES[team]||team;
    const pos = POI>=0 ? (r[POI]?.trim()||'SF') : 'SF';
    const headshot = HI>=0 ? (r[HI]?.trim()||'') : '';
    const tv = tradeValueMap.get(name.toLowerCase())||0;
    const salary = SI>=0 ? (parseInt((r[SI]||'0').replace(/[$,]/g,''))||0) : 0;
    const status = STI>=0 ? (r[STI]?.trim()||'GUARANTEED') : 'GUARANTEED';
    const injury = OI>=0 ? (r[OI]?.trim()||'') : '';
    const reason = RI>=0 ? (r[RI]?.trim()||'') : '';
    const logo = LI>=0 ? (r[LI]?.trim()||'') : '';
    let color = 'normal';
    if (status==='TWO-WAY'||status==='10-DAY') color = 'twoway';
    if (injury==='Out'||injury==='Doubtful') color = 'injured';
    else if (injury==='Questionable') color = 'questionable';
    players.push({name, team:abbrev, position:pos, tradeValue:tv, headshot, salary, contractStatus:status, injuryStatus:injury, injuryReason:reason, colorCode:color, teamLogo:logo});
  }
  return players;
}

// Overlay injury status from GitHub injuries.json onto allPlayers
function applyInjuriesJSON(injuries) {
  if (!injuries || !injuries.length) return;
  // Build latest status per player
  const latest = {};
  for (const e of injuries) latest[e.player] = e;
  // Reset ALL players to healthy first (JSON is authoritative over spreadsheet)
  for (const p of allPlayers) {
    const base = (p.contractStatus === 'TWO-WAY' || p.contractStatus === '10-DAY') ? 'twoway' : 'normal';
    p.injuryStatus = '';
    p.injuryReason = '';
    p.colorCode = base;
  }
  // Then overlay JSON entries
  for (const p of allPlayers) {
    const entry = latest[p.name];
    if (!entry) continue;
    if (entry.status === 'Available' || entry.status === 'Probable') continue;
    p.injuryStatus = entry.status;
    p.injuryReason = entry.injury;
    if (entry.status === 'Out' || entry.status === 'Doubtful') p.colorCode = 'injured';
    else if (entry.status === 'Questionable') p.colorCode = 'questionable';
  }
}

// =====================================================
// FORMATTING UTILS
// =====================================================
function fmtTV(tv) { if (tv>=1e6) return '$'+(tv/1e6).toFixed(1)+'M'; if (tv>=1e3) return '$'+Math.round(tv/1e3)+'K'; return '$'+tv.toLocaleString(); }
function fmtSal(s) { if (s>=1e6) return '$'+(s/1e6).toFixed(1)+'M'; if (s>=1e3) return '$'+Math.round(s/1e3)+'K'; return '$'+s.toLocaleString(); }
function fmtSalFull(s) { return '$'+s.toLocaleString('en-US'); }
function valClass(tv) { return tv>=2e7?'high':tv>=5e6?'medium':'low'; }
function initials(n) { return n.split(' ').map(w=>w[0]).join(''); }

// =====================================================
// RENDER TEAM GRID
// =====================================================
function renderTeamGrid() {
  const g = document.getElementById('teamGrid');
  g.innerHTML = NBA_TEAMS.map(t=>`<a href="?team=${t.abbrev}" class="team-card"><img class="team-logo" src="${t.logo}" alt="${t.name}" onerror="this.style.opacity='0.3'"><div class="team-name">${t.name}</div><div class="team-abbrev">${t.abbrev}</div></a>`).join('');
  g.style.display = 'grid';
}

// =====================================================
// BUILD POSITION MAP (shared by single-team & admin)
// =====================================================
function buildPositionMap(teamPlayers, savedOrder, minRows) {
  const positions = ['PG','SG','SF','PF','C'];
  const byPos = {}; positions.forEach(p => byPos[p] = []);
  if (savedOrder) {
    const pm = {}; teamPlayers.forEach(p => pm[p.name] = p);
    const placed = new Set();
    positions.forEach(pos => { if (savedOrder[pos]) savedOrder[pos].forEach(n => {
      if (n === '__SPACER__') { byPos[pos].push('__SPACER__'); }
      else if (pm[n]&&!placed.has(n)) { byPos[pos].push(pm[n]); placed.add(n); }
    }); });
    teamPlayers.forEach(p => { if (!placed.has(p.name)) byPos[positions.includes(p.position)?p.position:'SF'].push(p); });
  } else {
    teamPlayers.forEach(p => byPos[positions.includes(p.position)?p.position:'SF'].push(p));
    positions.forEach(pos => byPos[pos].sort((a,b) => b.tradeValue - a.tradeValue));
  }
  // Pad columns to minRows with spacers (for admin mode)
  if (minRows) {
    positions.forEach(pos => {
      while (byPos[pos].length < minRows) byPos[pos].push('__SPACER__');
    });
  }
  return byPos;
}

// =====================================================
// SINGLE TEAM VIEW
// =====================================================
function renderDepthChart(teamAbbrev) {
  const team = NBA_TEAMS.find(t=>t.abbrev===teamAbbrev);
  if (!team) { document.getElementById('error').textContent='Team not found'; document.getElementById('error').style.display='block'; return; }
  const tp = allPlayers.filter(p=>p.team===teamAbbrev);
  if (!tp.length) { document.getElementById('error').textContent=`No players for ${team.name}`; document.getElementById('error').style.display='block'; return; }
  document.getElementById('teamLogo').src = team.logo;
  document.getElementById('teamName').textContent = team.name;
  document.title = `${team.name} Depth Chart`;
  const positions = ['PG','SG','SF','PF','C'];
  const byPos = buildPositionMap(tp, loadTeamOrder(teamAbbrev));
  let html = '';
  positions.forEach(pos => {
    html += `<div class="position-column" data-position="${pos}"><div class="position-header">${pos}</div>`;
    let firstReal = true;
    byPos[pos].forEach((p,i) => {
      if (p === '__SPACER__') {
        html += `<div class="player-card spacer" data-player="__SPACER__">
          <div class="player-image"><span class="initials" style="visibility:hidden;">&nbsp;</span></div>
          <div class="player-name" style="visibility:hidden;">‚Äî</div>
          <div class="trade-value" style="visibility:hidden;">&nbsp;</div></div>`;
      } else {
        html += `<div class="player-card ${firstReal?'starter':''}" draggable="true" data-player="${p.name}" data-tv="${p.tradeValue}">
          <div class="player-image">${p.headshot?`<img src="${p.headshot}" alt="${p.name}" onerror="this.parentElement.innerHTML='<span class=\\'initials\\'>${initials(p.name)}</span>'">`:`<span class="initials">${initials(p.name)}</span>`}</div>
          <div class="player-name">${p.name}</div>
          <div class="trade-value ${valClass(p.tradeValue)}">${fmtSal(p.salary)}</div></div>`;
        firstReal = false;
      }
    });
    html += '</div>';
  });
  document.getElementById('depthChart').innerHTML = html;
  document.getElementById('depthChartContainer').classList.add('active');
  setupDragDrop(document.getElementById('depthChart'), teamAbbrev, false);
}

// =====================================================
// ADMIN ALL-TEAMS VIEW
// =====================================================
function renderAdminAllTeams() {
  document.getElementById('adminBanner').classList.add('active');
  document.title = 'NBA Depth Charts ‚Äî ADMIN';
  const container = document.getElementById('adminTeamsList');
  const positions = ['PG','SG','SF','PF','C'];
  const savedOrders = loadAllOrders();
  // Build player lookup
  const pMap = {};
  allPlayers.forEach(p => pMap[p.name] = p);

  let html = '';
  for (const team of NBA_TEAMS) {
    const tp = allPlayers.filter(p=>p.team===team.abbrev);
    if (!tp.length) continue;
    const saved = savedOrders[team.abbrev] || null;

    // For each position, build healthy and injured arrays
    const healthyByPos = {}, injuredByPos = {};
    const globalPlaced = new Set();
    positions.forEach(pos => {
      healthyByPos[pos] = [];
      injuredByPos[pos] = [];

      if (saved && saved[pos]) {
        const sepIdx = saved[pos].indexOf('__SEPARATOR__');
        const aboveNames = sepIdx >= 0 ? saved[pos].slice(0, sepIdx) : saved[pos];
        const belowNames = sepIdx >= 0 ? saved[pos].slice(sepIdx + 1) : [];

        // Above separator: place saved players, but force Out/Doubtful down
        aboveNames.forEach(n => {
          if (n === '__SPACER__' || globalPlaced.has(n)) return;
          const p = pMap[n];
          if (!p || p.team !== team.abbrev) return;
          if (p.colorCode === 'injured') { injuredByPos[pos].push(p); }
          else { healthyByPos[pos].push(p); }
          globalPlaced.add(n);
        });

        // Below separator: place saved players, but force non-injured/non-questionable up
        belowNames.forEach(n => {
          if (n === '__SPACER__' || globalPlaced.has(n)) return;
          const p = pMap[n];
          if (!p || p.team !== team.abbrev) return;
          if (p.colorCode === 'injured' || p.colorCode === 'questionable') { injuredByPos[pos].push(p); }
          else { healthyByPos[pos].push(p); }
          globalPlaced.add(n);
        });
      } else {
        // No saved order ‚Äî default sort by trade value
        const posTp = tp.filter(p => p.position === pos && !globalPlaced.has(p.name)).sort((a,b) => b.tradeValue - a.tradeValue);
        posTp.forEach(p => {
          if (p.colorCode === 'injured') injuredByPos[pos].push(p);
          else healthyByPos[pos].push(p);
          globalPlaced.add(p.name);
        });
      }
    });

    // Handle unplaced players (new additions or position mismatches)
    tp.filter(p => !globalPlaced.has(p.name)).forEach(p => {
      const pos = positions.includes(p.position) ? p.position : 'SF';
      if (p.colorCode === 'injured') injuredByPos[pos].push(p);
      else healthyByPos[pos].push(p);
    });

    // Count total healthy to determine row count
    const totalHealthy = positions.reduce((s, pos) => s + healthyByPos[pos].length, 0);
    const healthyRows = Math.max(1, Math.ceil(totalHealthy / 5));

    html += `<div class="admin-team-row" data-team="${team.abbrev}">
      <div class="admin-team-row-header"><img class="admin-team-row-logo" src="${team.logo}" alt="${team.name}" onerror="this.style.opacity='0.3'"><span class="admin-team-row-name">${team.name}</span><span class="admin-team-row-abbrev">${team.abbrev}</span></div>
      <div class="admin-depth-chart" data-team="${team.abbrev}">`;
    positions.forEach(pos => {
      html += `<div class="admin-position-column" data-position="${pos}"><div class="admin-position-header">${pos}</div>`;

      // Healthy players
      let firstReal = true;
      healthyByPos[pos].forEach(p => {
        const sc = p.contractStatus==='10-DAY'?'ten-day':p.colorCode==='twoway'?'two-way':p.colorCode==='questionable'?'questionable':'';
        html += `<div class="admin-player-card ${firstReal?'starter':''} ${sc}" draggable="true" data-player="${p.name}" data-tv="${p.tradeValue}"><div class="admin-player-name">${p.name}</div><div class="admin-trade-value ${valClass(p.tradeValue)}">${fmtSal(p.salary)}</div></div>`;
        firstReal = false;
      });

      // Pad healthy section with spacers
      for (let i = healthyByPos[pos].length; i < healthyRows; i++) {
        html += `<div class="admin-player-card spacer" draggable="true" data-player="__SPACER__"><div><div class="admin-player-name" style="color:#666;">‚Äî blank ‚Äî</div><div class="admin-trade-value" style="visibility:hidden;">&nbsp;</div></div></div>`;
      }

      // Separator
      html += `<div class="admin-separator"></div>`;

      // Injured players
      injuredByPos[pos].forEach(p => {
        const sc = p.colorCode==='injured'?'injured':'questionable';
        html += `<div class="admin-player-card ${sc}" draggable="true" data-player="${p.name}" data-tv="${p.tradeValue}"><div class="admin-player-name">${p.name}</div><div class="admin-trade-value ${valClass(p.tradeValue)}">${fmtSal(p.salary)}</div></div>`;
      });

      html += '</div>';
    });
    html += '</div></div>';
  }
  container.innerHTML = html;
  document.getElementById('adminAllTeams').classList.add('active');
  document.querySelectorAll('.admin-depth-chart').forEach(c => setupDragDrop(c, c.dataset.team, true));
}

// =====================================================
// UNIFIED DRAG AND DROP
// =====================================================
function setupDragDrop(container, teamAbbrev, isAdminView) {
  const cardSel = isAdminView ? '.admin-player-card' : '.player-card';
  const colSel = isAdminView ? '.admin-position-column' : '.position-column';

  container.querySelectorAll(cardSel).forEach(card => {
    makeDraggable(card, container, teamAbbrev, cardSel, colSel);
  });

  container.querySelectorAll(colSel).forEach(col => {
    col.addEventListener('dragover', function(e) { e.preventDefault(); });
    col.addEventListener('drop', function(e) {
      e.preventDefault();
      if (draggedElement && !e.target.closest(cardSel)) {
        // Dropped on empty area of column ‚Äî append (before spacer btn if exists)
        const addBtn = this.querySelector('.add-spacer-btn');
        if (addBtn) this.insertBefore(draggedElement, addBtn);
        else this.appendChild(draggedElement);
      }
    });
  });
}

function makeDraggable(card, container, teamAbbrev, cardSel, colSel) {
  card.addEventListener('dragstart', function(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', this.dataset.player);
  });

  card.addEventListener('dragend', function() {
    this.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    draggedElement = null;
    // Update starter highlights
    container.querySelectorAll(colSel).forEach(col => {
      let firstReal = true;
      col.querySelectorAll(cardSel).forEach(c => {
        if (c.classList.contains('spacer')) { c.classList.remove('starter'); return; }
        c.classList.toggle('starter', firstReal);
        firstReal = false;
      });
    });
    saveTeamOrder(teamAbbrev, container);
  });

  card.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    if (!draggedElement || this === draggedElement) return;

    const isSpacer = this.classList.contains('spacer');
    const draggedIsSpacer = draggedElement.classList.contains('spacer');

    // If one is spacer and other is player, just highlight ‚Äî swap happens on drop
    if (isSpacer !== draggedIsSpacer) {
      this.classList.add('drag-over');
      return;
    }

    // Normal reorder: live preview move
    const col = this.parentElement;
    const r = this.getBoundingClientRect();
    const midY = r.top + r.height / 2;
    if (e.clientY < midY) {
      if (draggedElement.nextElementSibling !== this || draggedElement.parentElement !== col) {
        col.insertBefore(draggedElement, this);
      }
    } else {
      if (this.nextElementSibling !== draggedElement || draggedElement.parentElement !== col) {
        col.insertBefore(draggedElement, this.nextSibling);
      }
    }
  });

  card.addEventListener('dragleave', function() {
    this.classList.remove('drag-over');
  });

  card.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.classList.remove('drag-over');
    if (!draggedElement || this === draggedElement) return;

    const isSpacer = this.classList.contains('spacer');
    const draggedIsSpacer = draggedElement.classList.contains('spacer');

    // Swap: player <-> spacer
    if (isSpacer !== draggedIsSpacer) {
      const placeholder = document.createElement('div');
      this.parentElement.insertBefore(placeholder, this);
      draggedElement.parentElement.insertBefore(this, draggedElement);
      placeholder.parentElement.insertBefore(draggedElement, placeholder);
      placeholder.remove();
    }
  });
}

// =====================================================
// SPACER MANAGEMENT
// =====================================================
function addSpacer(btn) {
  const col = btn.parentElement;
  const teamAbbrev = btn.dataset.team;
  const spacer = document.createElement('div');
  spacer.className = 'admin-player-card spacer';
  spacer.draggable = true;
  spacer.dataset.player = '__SPACER__';
  spacer.innerHTML = '<div><div class="admin-player-name" style="color:#666;">‚Äî blank ‚Äî</div><div class="admin-trade-value" style="visibility:hidden;">&nbsp;</div></div><button class="spacer-delete" onclick="removeSpacer(this)" title="Remove spacer">‚úï</button>';
  col.insertBefore(spacer, btn);
  // Attach drag events to new spacer
  const chart = col.closest('.admin-depth-chart');
  attachCardDrag(spacer, chart, teamAbbrev);
  saveTeamOrder(teamAbbrev, chart);
}

function removeSpacer(deleteBtn) {
  const spacer = deleteBtn.parentElement;
  const chart = spacer.closest('.admin-depth-chart');
  const teamAbbrev = chart.dataset.team;
  spacer.remove();
  saveTeamOrder(teamAbbrev, chart);
}

function attachCardDrag(card, container, teamAbbrev) {
  makeDraggable(card, container, teamAbbrev, '.admin-player-card', '.admin-position-column');
}

// =====================================================
// EXPORT HTML ‚Äî shared generator
// =====================================================
function generateExportHTML(teamOrders, withHeadshots, startIdx, endIdx) {
  const positions = ['PG','SG','SF','PF','C'];
  const playerMap = {}; allPlayers.forEach(p => playerMap[p.name] = p);
  const S = 'border:none;padding:4px;text-align:center;';
  const iS = 'display:block;width:80px;height:80px;object-fit:cover;margin:0 auto;';

  let out = '<div style="font-family:sans-serif;max-width:800px;margin:0 auto;overflow-x:auto;font-size:16px;text-align:center;">';

  const teamsSlice = NBA_TEAMS.slice(startIdx, endIdx);
  for (const team of teamsSlice) {
    const order = teamOrders[team.abbrev];
    if (!order) continue;
    const posCols = {}; let maxRows = 0;
    positions.forEach(pos => {
      const names = order[pos]||[];
      posCols[pos] = names.map(n => n === '__SPACER__' ? null : (playerMap[n]||null));
      if (posCols[pos].length > maxRows) maxRows = posCols[pos].length;
    });
    while (maxRows > 0) {
      const row = positions.map(pos => posCols[pos][maxRows-1] || null);
      if (row.some(p => p !== null)) break;
      maxRows--;
    }
    if (maxRows < 1) maxRows = 1;

    out += `<div style="text-align:center;font-size:1.2em;margin-bottom:.5em;"><strong>${team.name.toUpperCase()}</strong></div>`;
    out += `<table style="width:100%;text-align:center;border-collapse:collapse;font-size:12px;"><tbody>`;
    out += `<tr style="background-color:#f2f2f2;">`;
    positions.forEach(pos => { out += `<th style="${S}">${pos}</th>`; });
    out += `</tr>`;

    for (let r = 0; r < maxRows; r++) {
      const rp = positions.map(pos => posCols[pos][r] || null);
      if (!rp.some(p => p !== null)) continue;
      const cc = rp.map(p => {
        if (!p) return '';
        if (p.contractStatus === '10-DAY') return 'background-color:yellow;';
        if (p.colorCode === 'twoway') return 'background-color:#e1bee7;';
        if (p.colorCode === 'injured') return 'background-color:lightcoral;';
        if (p.colorCode === 'questionable') return 'background-color:#f5b7b1;';
        return '';
      });
      if (withHeadshots) {
        out += `<tr style="background-color:#fff;">`;
        rp.forEach((p,i) => {
          out += p && p.headshot ? `<td style="${S}"><img src="${p.headshot}" style="${iS}"/></td>` : `<td style="${S}"></td>`;
        });
        out += `</tr>`;
      }
      out += `<tr style="background-color:#f2f2f2;">`;
      rp.forEach((p,i) => { out += `<td style="${S}${cc[i]}">${p ? `<strong>${p.name}</strong>` : ''}</td>`; });
      out += `</tr>`;
      out += `<tr style="background-color:#f2f2f2;">`;
      rp.forEach((p,i) => { out += `<td style="${S}${cc[i]}">${p ? fmtSalFull(p.salary) : ''}</td>`; });
      out += `</tr>`;
    }
    out += `</tbody></table><br>`;
  }
  out += '</div>';
  return out;
}

function exportHTML(withHeadshots, startIdx, endIdx) {
  // Read order from DOM
  const teamOrders = {};
  document.querySelectorAll('.admin-depth-chart').forEach(chart => {
    const ta = chart.dataset.team; const order = {};
    chart.querySelectorAll('.admin-position-column').forEach(col => {
      const pos = col.dataset.position; if (!pos) return; order[pos] = [];
      col.querySelectorAll('.admin-player-card').forEach(card => {
        if (card.dataset.player === '__SPACER__') order[pos].push('__SPACER__');
        else if (card.dataset.player) order[pos].push(card.dataset.player);
      });
    });
    teamOrders[ta] = order;
  });

  const out = generateExportHTML(teamOrders, withHeadshots, startIdx, endIdx);
  const teamsSlice = NBA_TEAMS.slice(startIdx, endIdx);
  const firstTeam = teamsSlice[0]?.abbrev || '?';
  const lastTeam = teamsSlice[teamsSlice.length-1]?.abbrev || '?';
  const blockLabel = `${firstTeam}‚Äì${lastTeam}`;
  const modeLabel = withHeadshots ? 'üì∑ Headshots' : 'üìã Compact';
  const sizeKB = (new Blob([out]).size / 1024).toFixed(1);
  document.getElementById('exportCode').value = out;
  document.getElementById('exportModalTitle').textContent = `${modeLabel} ‚Äî ${blockLabel} (${teamsSlice.length} teams, ${sizeKB} KB)`;
  document.getElementById('exportModal').classList.add('active');
}

// =====================================================
// SAVE ORDER JSON (for GitHub Pages export)
// =====================================================
function downloadOrderJSON() {
  // Force immediate push to GitHub
  const orders = loadAllOrders();
  const btn = event.target;
  const orig = btn.textContent;
  btn.textContent = '‚è≥ Pushing...';
  btn.disabled = true;
  pushToGitHub(orders).then(() => {
    btn.textContent = '‚úì Pushed!';
    btn.style.background = '#16a34a'; btn.style.color = 'white';
    setTimeout(() => { btn.textContent = orig; btn.style.background = ''; btn.style.color = ''; btn.disabled = false; }, 2000);
  });
}

// =====================================================
// EXPORT RENDER MODE (for iframe embed in Presto)
// ?export=1 ‚Üí first half, ?export=2 ‚Üí second half
// ?headshots=0 ‚Üí compact (default: headshots on)
// =====================================================
async function renderExportView(exportParam, withHeadshots) {
  // Replace entire page with clean white canvas
  document.body.style.cssText = 'background:white;margin:0;padding:0;color:#1a1a2e;';
  document.querySelector('.container').style.display = 'none';
  document.getElementById('adminBanner').style.display = 'none';

  const statusEl = document.getElementById('loading');
  statusEl.style.display = 'block';
  statusEl.style.color = '#333';
  statusEl.querySelector('p').textContent = 'Loading depth charts...';
  statusEl.querySelector('.loading-spinner').style.borderTopColor = '#667eea';

  try {
    const orderURL = new URL('order.json', window.location.href.split('?')[0]).href;
    const [tvR, rR, oR] = await Promise.all([
      fetch(TV_CSV_URL), fetch(ROSTER_CSV_URL), fetch(orderURL)
    ]);
    if (!tvR.ok || !rR.ok) throw new Error('Failed to fetch player data');
    if (!oR.ok) throw new Error('order.json not found ‚Äî save your order from admin mode first');

    const [tvText, rText, orderData] = await Promise.all([tvR.text(), rR.text(), oR.json()]);
    tradeValueMap = computeTradeValues(tvText);
    allPlayers = parseRosterCSV(rText);
    try { const ijR = await fetch(INJURIES_JSON_URL + '?t=' + Date.now()); if (ijR.ok) applyInjuriesJSON(await ijR.json()); } catch(e) {}

    let startIdx, endIdx;
    if (exportParam === '2') { startIdx = 15; endIdx = 30; }
    else if (exportParam === 'all') { startIdx = 0; endIdx = 30; }
    else { startIdx = 0; endIdx = 15; }

    const html = generateExportHTML(orderData, withHeadshots, startIdx, endIdx);

    statusEl.style.display = 'none';
    const wrapper = document.createElement('div');
    wrapper.innerHTML = html;
    document.body.appendChild(wrapper);

    // Fix mobile scroll: prevent horizontal scroll capture from blocking vertical scroll
    const style = document.createElement('style');
    style.textContent = '* { touch-action: pan-y !important; } div { overflow-x: visible !important; }';
    document.head.appendChild(style);

    // Auto-resize iframe if embedded
    function notifyHeight() {
      const h = document.body.scrollHeight;
      window.parent.postMessage({type:'resize', height: h}, '*');
    }
    notifyHeight();
    // Re-check after images load
    window.addEventListener('load', notifyHeight);
    setTimeout(notifyHeight, 3000);
  } catch (err) {
    console.error('Export render error:', err);
    statusEl.style.display = 'none';
    const errDiv = document.createElement('div');
    errDiv.style.cssText = 'text-align:center;padding:2rem;color:#c00;font-family:sans-serif;';
    errDiv.textContent = 'Error: ' + err.message;
    document.body.appendChild(errDiv);
  }
}

function copyExportDirect(withHeadshots, startIdx, endIdx) {
  const teamOrders = {};
  document.querySelectorAll('.admin-depth-chart').forEach(chart => {
    const ta = chart.dataset.team; const order = {};
    chart.querySelectorAll('.admin-position-column').forEach(col => {
      const pos = col.dataset.position; if (!pos) return; order[pos] = [];
      col.querySelectorAll('.admin-player-card').forEach(card => {
        if (card.dataset.player === '__SPACER__') order[pos].push('__SPACER__');
        else if (card.dataset.player) order[pos].push(card.dataset.player);
      });
    });
    teamOrders[ta] = order;
  });
  const out = generateExportHTML(teamOrders, withHeadshots, startIdx, endIdx);
  const btn = event.target.closest('.export-btn');
  const orig = btn.textContent;
  const blob = new Blob([out], {type: 'text/plain'});
  navigator.clipboard.write([new ClipboardItem({'text/plain': blob})]).then(() => {
    btn.textContent = '‚úì Copied!';
    btn.style.background = '#16a34a'; btn.style.color = 'white';
    setTimeout(() => { btn.textContent = orig; btn.style.background = ''; btn.style.color = ''; }, 2000);
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = out; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = orig, 2000);
  });
}

function copyExportCode() {
  const text = document.getElementById('exportCode').value;
  // Force plain text only ‚Äî no HTML clipboard metadata
  const blob = new Blob([text], {type: 'text/plain'});
  navigator.clipboard.write([new ClipboardItem({'text/plain': blob})]).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = '‚úì Copied!'; btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'üìã Copy to Clipboard'; btn.classList.remove('copied'); }, 2000);
  }).catch(() => {
    // Fallback
    const ta = document.getElementById('exportCode');
    ta.select(); ta.setSelectionRange(0, ta.value.length);
    document.execCommand('copy');
  });
}

function downloadExportCode() {
  const text = document.getElementById('exportCode').value;
  const blob = new Blob([text], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'depth-charts-export.txt';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

function closeExportModal() { document.getElementById('exportModal').classList.remove('active'); }

// =====================================================
// AUTO-REFRESH DATA (updates cards in-place, preserves order)
// =====================================================
async function autoRefreshData() {
  try {
    const [tvR, rR] = await Promise.all([fetch(TV_CSV_URL), fetch(ROSTER_CSV_URL)]);
    if (!tvR.ok || !rR.ok) return;
    const [tvText, rText] = await Promise.all([tvR.text(), rR.text()]);
    tradeValueMap = computeTradeValues(tvText);
    allPlayers = parseRosterCSV(rText);
    try { const ijR = await fetch(INJURIES_JSON_URL + '?t=' + Date.now()); if (ijR.ok) applyInjuriesJSON(await ijR.json()); } catch(e) {}
    // Full re-render to move players between healthy/injured sections
    renderAdminAllTeams();
    const el = document.getElementById('refreshStatus');
    if (el) {
      const t = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      el.textContent = `Updated ${t}`;
      el.style.opacity = '1';
      setTimeout(() => el.style.opacity = '0.7', 2000);
    }
  } catch (e) {
    console.warn('Auto-refresh failed:', e);
  }
}

async function manualRefresh(btn) {
  const orig = btn.textContent;
  btn.textContent = '‚è≥ Refreshing...';
  btn.disabled = true;
  try {
    const [tvR, rR] = await Promise.all([fetch(TV_CSV_URL), fetch(ROSTER_CSV_URL)]);
    if (!tvR.ok || !rR.ok) throw new Error('Fetch failed');
    const [tvText, rText] = await Promise.all([tvR.text(), rR.text()]);
    tradeValueMap = computeTradeValues(tvText);
    allPlayers = parseRosterCSV(rText);
    try { const ijR = await fetch(INJURIES_JSON_URL + '?t=' + Date.now()); if (ijR.ok) applyInjuriesJSON(await ijR.json()); } catch(e) {}
    // Full re-render preserving saved orders
    renderAdminAllTeams();
    const el = document.getElementById('refreshStatus');
    const t = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    if (el) { el.textContent = `Updated ${t}`; el.style.opacity = '1'; setTimeout(() => el.style.opacity = '0.7', 2000); }
  } catch(e) { console.warn('Refresh failed:', e); }
  btn.textContent = '‚úì Updated!';
  btn.style.background = '#16a34a'; btn.style.color = 'white';
  setTimeout(() => { btn.textContent = orig; btn.style.background = ''; btn.style.color = ''; btn.disabled = false; }, 2000);
}

// =====================================================
// INIT
// =====================================================
async function init() {
  const params = new URLSearchParams(window.location.search);
  const exportParam = params.get('export');
  const teamParam = params.get('team')?.toUpperCase();
  const adminParam = params.get('admin');
  isAdmin = (adminParam === ADMIN_KEY);

  // Export render mode ‚Äî iframe-friendly, no UI
  if (exportParam) {
    const withHeadshots = params.get('headshots') !== '0';
    return renderExportView(exportParam, withHeadshots);
  }

  try {
    // Fetch player data + order.json from GitHub in parallel
    const fetches = [fetch(TV_CSV_URL), fetch(ROSTER_CSV_URL), fetchFromGitHub()];
    const [tvR, rR, ghOrders] = await Promise.all(fetches);
    if (!tvR.ok || !rR.ok) throw new Error('Failed to fetch data');
    const [tvText, rText] = await Promise.all([tvR.text(), rR.text()]);
    tradeValueMap = computeTradeValues(tvText);
    allPlayers = parseRosterCSV(rText);
    try { const ijR = await fetch(INJURIES_JSON_URL + '?t=' + Date.now()); if (ijR.ok) applyInjuriesJSON(await ijR.json()); } catch(e) { console.warn('Injuries JSON unavailable:', e); }
    document.getElementById('loading').style.display = 'none';
    if (isAdmin && !teamParam) {
      renderAdminAllTeams();
      setInterval(autoRefreshData, 60000);
    }
    else if (teamParam && NBA_TEAMS.some(t=>t.abbrev===teamParam)) renderDepthChart(teamParam);
    else renderTeamGrid();
  } catch (err) {
    console.error('Error:', err);
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').textContent = 'Error loading data. Please refresh.';
    document.getElementById('error').style.display = 'block';
  }
}
init();
</script>
</body>
</html>
