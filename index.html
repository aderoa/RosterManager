<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://hoopsmatic.com" crossorigin>
<link rel="dns-prefetch" href="https://hoopsmatic.com">
<title>Roster Manager ‚Äì HoopsMatic</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0e1a;--surface:#111827;--card:#1a2236;--border:#1e2d4a;
  --text:#e2e8f0;--muted:#64748b;--accent:#667eea;--accent2:#764ba2;
  --green:#4caf50;--red:#ef5350;--orange:#ff9800;--yellow:#ffd600;--cyan:#26c6da;
}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
a{color:var(--accent);text-decoration:none}

/* Header */
.header{background:linear-gradient(135deg,var(--accent),var(--accent2));padding:1rem 1.5rem;display:flex;align-items:center;gap:1rem;position:sticky;top:0;z-index:100}
.header h1{font-size:1.2rem;font-weight:700;letter-spacing:.5px}
.header .subtitle{font-size:.75rem;opacity:.8}
.header .season-badge{margin-left:auto;background:rgba(0,0,0,.25);padding:.3rem .8rem;border-radius:20px;font-size:.8rem;font-weight:600}

/* Team Dropdown */
.team-dropdown{font-family:inherit;font-size:.8rem;padding:.4rem .8rem;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.15);border-radius:6px;color:var(--text);cursor:pointer;outline:none;min-width:160px;appearance:auto}
.team-dropdown:focus{border-color:var(--accent)}
.team-dropdown option{background:var(--card);color:var(--text)}

/* Team Banner */
.team-banner{display:flex;align-items:center;gap:1rem;padding:1rem 2rem;max-width:1600px;margin:0 auto}
.team-banner img{width:56px;height:56px;object-fit:contain}
.team-banner .tb-name{font-size:1.3rem;font-weight:700;letter-spacing:.5px}
.team-banner .tb-sub{font-size:.7rem;color:var(--muted)}

/* Main Layout */
.main{display:grid;grid-template-columns:1fr 320px;gap:1rem;padding:1rem;max-width:1600px;margin:0 auto}
@media(max-width:900px){.main{grid-template-columns:1fr}}

/* Roster Panel */
.roster-panel{display:flex;flex-direction:column;gap:.75rem}
.section{background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.section-hdr{padding:.6rem 1rem;display:flex;align-items:center;gap:.5rem;cursor:pointer;user-select:none;border-bottom:1px solid var(--border)}
.section-hdr .dot{width:10px;height:10px;border-radius:50%}
.section-hdr h3{font-size:.8rem;font-weight:600;flex:1}
.section-hdr .badge{font-size:.65rem;padding:.15rem .5rem;border-radius:10px;font-weight:600}
.section-body{padding:.5rem}

/* Player Row */
.player-row{display:flex;align-items:center;gap:.6rem;padding:.4rem .5rem;border-radius:6px;transition:background .1s}
.player-row:hover{background:rgba(255,255,255,.03)}
.player-row .hs{width:36px;height:28px;border-radius:4px;object-fit:cover;background:var(--surface)}
.player-row .hs-ini{width:36px;height:28px;border-radius:4px;background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:.55rem;color:var(--muted)}
.player-row .info{flex:1;min-width:0}
.player-row .pname{font-size:.78rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.player-row .pdet{font-size:.6rem;color:var(--muted)}
.player-row .sal{font-size:.78rem;font-weight:600;text-align:right;min-width:70px}
.player-row .sal.g{color:var(--green)}.player-row .sal.ng{color:var(--red)}.player-row .sal.to{color:var(--orange)}.player-row .sal.po{color:var(--cyan)}.player-row .sal.pg{color:var(--yellow)}
.player-row .ch{font-size:.6rem;color:var(--muted);text-align:right}
.player-row .action-btn{
  font-size:.6rem;padding:.2rem .5rem;border-radius:4px;border:1px solid var(--border);
  background:transparent;color:var(--muted);cursor:pointer;white-space:nowrap;transition:all .15s
}
.player-row .action-btn:hover{border-color:var(--accent);color:var(--accent)}
.player-row .action-btn.pickup{border-color:var(--green);color:var(--green)}
.player-row .action-btn.pickup:hover{background:rgba(76,175,80,.15)}
.player-row .action-btn.decline{border-color:var(--red);color:var(--red)}
.player-row .action-btn.decline:hover{background:rgba(239,83,80,.15)}
.player-row .action-btn.renounce{border-color:var(--orange);color:var(--orange)}
.player-row .action-btn.renounce:hover{background:rgba(255,152,0,.15)}
.player-row .action-btn.waive{border-color:var(--red);color:var(--red)}
.player-row .action-btn.waive:hover{background:rgba(239,83,80,.15)}
.player-row .action-btn.done{opacity:.5;pointer-events:none}
.player-row.acted{opacity:.45}

/* Cap Panel */
.cap-panel{position:sticky;top:60px;display:flex;flex-direction:column;gap:.75rem;align-self:start}
.cap-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1rem}
.cap-card h3{font-size:.8rem;font-weight:700;margin-bottom:.75rem;color:var(--accent)}
.cap-row{display:flex;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:.75rem}
.cap-row:last-child{border-bottom:none}
.cap-row .label{color:var(--muted)}
.cap-row .value{font-weight:600}
.cap-row .value.pos{color:var(--green)}.cap-row .value.neg{color:var(--red)}
.cap-bar{height:8px;border-radius:4px;background:var(--surface);margin:.5rem 0;overflow:hidden;position:relative}
.cap-bar-fill{height:100%;border-radius:4px;transition:width .3s}
.cap-bar-marker{position:absolute;top:-2px;height:12px;width:2px;border-radius:1px}

/* Exception chips */
.exc-list{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.5rem}
.exc-chip{font-size:.65rem;padding:.2rem .5rem;border-radius:4px;background:var(--surface);border:1px solid var(--border)}
.exc-chip.available{border-color:var(--green);color:var(--green)}
.exc-chip.unavailable{border-color:var(--border);color:var(--muted);opacity:.5}

/* Move log */
.move-log{max-height:200px;overflow-y:auto}
.move-entry{font-size:.68rem;padding:.3rem 0;border-bottom:1px solid rgba(255,255,255,.04);color:var(--muted)}
.move-entry .action{color:var(--accent)}

/* Controls */
.controls{display:flex;gap:.5rem;margin-top:.5rem}
.ctrl-btn{font-size:.7rem;padding:.35rem .75rem;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;transition:all .15s}
.ctrl-btn:hover{border-color:var(--accent);color:var(--accent)}
.ctrl-btn.reset{border-color:var(--red);color:var(--red)}
.ctrl-btn.reset:hover{background:rgba(239,83,80,.15)}

/* Depth Chart */
.depth-chart{display:grid;grid-template-columns:repeat(5,1fr);gap:.6rem;background:rgba(255,255,255,.04);border-radius:12px;padding:1rem;margin-bottom:.75rem}
.pos-col{display:flex;flex-direction:column;gap:.4rem;min-height:120px}
.pos-hdr{text-align:center;font-weight:700;font-size:.85rem;color:var(--accent);padding:.35rem;border-bottom:2px solid var(--accent);margin-bottom:.2rem;letter-spacing:.5px}
.dc-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:.5rem;cursor:grab;transition:all .15s;position:relative}
.dc-card:hover{border-color:var(--accent);background:rgba(102,126,234,.06)}
.dc-card.dragging{opacity:.4;cursor:grabbing}
.dc-card .dc-top{display:flex;align-items:center;gap:.4rem;margin-bottom:.3rem}
.dc-card .dc-hs{width:40px;height:30px;border-radius:4px;object-fit:cover;background:var(--surface)}
.dc-card .dc-ini{width:40px;height:30px;border-radius:4px;background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:.5rem;color:var(--muted)}
.dc-card .dc-name{font-size:.7rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.dc-card .dc-sal{font-size:.6rem;font-weight:600;color:var(--green);white-space:nowrap}
.dc-card .dc-actions{display:flex;gap:.2rem;flex-wrap:wrap}
.dc-card .dc-btn{font-size:.5rem;padding:.15rem .35rem;border-radius:3px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;white-space:nowrap;transition:all .1s}
.dc-card .dc-btn:hover{border-color:var(--accent);color:var(--accent)}
.dc-card .dc-btn.trade{border-color:var(--cyan);color:var(--cyan)}
.dc-card .dc-btn.waive{border-color:var(--red);color:var(--red)}
.dc-card .dc-btn.opt{border-color:var(--orange);color:var(--orange)}
.dc-card .dc-opt-badge{position:absolute;top:2px;right:4px;font-size:.45rem;padding:.1rem .25rem;border-radius:2px;font-weight:700}
.dc-card .dc-opt-badge.to{background:rgba(255,152,0,.15);color:var(--orange)}
.dc-card .dc-opt-badge.po{background:rgba(38,198,218,.15);color:var(--cyan)}
.dc-card .dc-opt-badge.ng{background:rgba(239,83,80,.15);color:var(--red)}
.dc-card .dc-opt-badge.pg{background:rgba(255,214,0,.15);color:var(--yellow)}
.dc-card .dc-opt-badge.signed{background:rgba(76,175,80,.15);color:var(--green)}
.dc-card .dc-opt-badge.traded{background:rgba(38,198,218,.15);color:var(--cyan)}
.pos-col.drag-over{background:rgba(102,126,234,.08);border-radius:8px}
.dc-drop-indicator{height:3px;background:var(--accent);border-radius:2px;margin:2px 0;pointer-events:none;box-shadow:0 0 6px rgba(102,126,234,.6)}
.dc-section-label{font-size:.85rem;font-weight:700;color:var(--text);margin:1rem 0 .5rem;padding-bottom:.3rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.5rem}
.dc-section-label .dc-badge{font-size:.6rem;padding:.15rem .5rem;border-radius:10px;font-weight:600}
@media(max-width:768px){.depth-chart{grid-template-columns:repeat(3,1fr)}}
@media(max-width:500px){.depth-chart{grid-template-columns:repeat(2,1fr)}}

/* Contract Table */
.contract-table{width:100%;font-size:.7rem;border-collapse:collapse}
.contract-table th{padding:.4rem .5rem;font-size:.6rem;color:var(--muted);font-weight:600;letter-spacing:.5px;text-transform:uppercase;border-bottom:1px solid var(--border);background:var(--surface)}
.contract-table th:first-child{text-align:left}.contract-table th:not(:first-child){text-align:right}
.contract-table td{padding:.35rem .5rem;border-bottom:1px solid rgba(255,255,255,.03)}
.contract-table td:not(:first-child){text-align:right}
.contract-table tr:hover td{background:rgba(255,255,255,.02)}
.contract-table .sal-g{color:var(--green)}.contract-table .sal-to{color:var(--orange)}.contract-table .sal-po{color:var(--cyan)}.contract-table .sal-ng{color:var(--red)}.contract-table .sal-pg{color:var(--yellow)}
.contract-table .player-cell{display:flex;align-items:center;gap:.4rem}
.contract-table .ct-hs{width:28px;height:21px;border-radius:3px;object-fit:cover;background:var(--surface)}
.contract-table .ct-ini{width:28px;height:21px;border-radius:3px;background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:.45rem;color:var(--muted)}
.contract-wrap{border-radius:8px;border:1px solid var(--border);background:var(--card);overflow-x:auto}

/* Loading */
.loading{text-align:center;padding:3rem;color:var(--muted)}
.loading .spin{display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Empty state */
.empty{text-align:center;padding:2rem;color:var(--muted);font-size:.8rem}

/* Phase Stepper */
.phase-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:.6rem 1rem;display:flex;align-items:center;gap:.4rem;justify-content:center;flex-wrap:wrap}
.phase-step{display:flex;align-items:center;gap:.3rem;font-size:.65rem;font-weight:600;padding:.3rem .6rem;border-radius:20px;color:var(--muted);background:transparent;border:1px solid transparent;cursor:pointer;transition:all .15s;white-space:nowrap}
.phase-step.active{background:rgba(102,126,234,.15);color:var(--accent);border-color:var(--accent)}
.phase-step.completed{color:var(--green);opacity:.8}
.phase-step.locked{opacity:.4;cursor:not-allowed}
.phase-arrow{color:var(--muted);font-size:.6rem;opacity:.5}
.phase-advance{font-size:.65rem;padding:.3rem .7rem;border-radius:6px;border:1px solid var(--green);background:rgba(76,175,80,.1);color:var(--green);cursor:pointer;font-weight:600;margin-left:.5rem;transition:all .15s}
.phase-advance:hover{background:rgba(76,175,80,.25)}

/* Waive modal */
.waive-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.waive-modal{background:var(--card);border:1px solid var(--border);border-radius:12px;width:380px;max-width:90vw;padding:1.2rem}
.waive-modal h3{font-size:.9rem;font-weight:700;margin-bottom:.8rem;color:var(--text)}
.waive-modal .player-info{font-size:.75rem;color:var(--muted);margin-bottom:1rem;padding:.5rem;background:var(--surface);border-radius:6px}
.waive-modal .player-info .name{color:var(--text);font-weight:600;font-size:.85rem}
.waive-option{display:flex;flex-direction:column;gap:.3rem;padding:.7rem;border:1px solid var(--border);border-radius:8px;cursor:pointer;margin-bottom:.5rem;transition:all .15s}
.waive-option:hover{border-color:var(--accent);background:rgba(102,126,234,.06)}
.waive-option .opt-title{font-size:.75rem;font-weight:600;color:var(--text)}
.waive-option .opt-desc{font-size:.65rem;color:var(--muted)}
.waive-option .opt-amount{font-size:.8rem;font-weight:700;color:var(--red)}
.waive-cancel{font-size:.7rem;padding:.35rem .75rem;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;margin-top:.3rem;width:100%;text-align:center}

/* Coming soon badge */
.coming-soon{font-size:.55rem;padding:.1rem .3rem;border-radius:3px;background:var(--surface);color:var(--muted);border:1px solid var(--border);margin-left:.3rem}
.action-btn.trade{background:rgba(38,198,218,.12);color:var(--cyan);border-color:rgba(38,198,218,.3)}
.action-btn.extend{background:rgba(102,126,234,.12);color:var(--accent);border-color:rgba(102,126,234,.3)}
.ext-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:1000;display:flex;align-items:center;justify-content:center;padding:.5rem}
.ext-modal{background:var(--card);border-radius:12px;max-width:480px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,.4)}
.ext-modal-hdr{display:flex;align-items:center;gap:.5rem;padding:.75rem 1rem;border-bottom:1px solid var(--border)}
.ext-modal-hdr h3{flex:1;font-size:.85rem;margin:0}
.ext-modal-body{padding:1rem}
.ext-player-info{display:flex;align-items:center;gap:.75rem;padding:.6rem;background:var(--surface);border-radius:8px;margin-bottom:.75rem}
.ext-player-info img{width:48px;height:36px;object-fit:cover;border-radius:4px}
.ext-player-info .name{font-weight:600;font-size:.8rem}
.ext-player-info .meta{font-size:.65rem;color:var(--muted)}
.ext-type-badge{display:inline-block;padding:.15rem .45rem;border-radius:4px;font-size:.6rem;font-weight:600;margin-left:.4rem}
.ext-type-badge.rse{background:rgba(102,126,234,.15);color:#667eea}
.ext-type-badge.vet{background:rgba(245,158,11,.15);color:#f59e0b}
.ext-config{margin:.75rem 0}
.ext-config label{display:block;font-size:.7rem;color:var(--muted);margin-bottom:.25rem}
.ext-config .row{display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem}
.ext-config input[type="range"]{flex:1;accent-color:var(--accent)}
.ext-config input[type="number"]{width:120px;padding:.35rem .5rem;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text);font-family:inherit;font-size:.75rem}
.ext-config select{padding:.35rem .5rem;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text);font-family:inherit;font-size:.75rem}
.ext-config .sal-display{font-size:.8rem;font-weight:600;color:var(--accent);min-width:80px;text-align:right}
.ext-breakdown{margin:.75rem 0}
.ext-breakdown h4{font-size:.7rem;color:var(--muted);margin:0 0 .35rem}
.ext-year-row{display:flex;justify-content:space-between;padding:.3rem .5rem;font-size:.7rem;border-radius:4px}
.ext-year-row:nth-child(even){background:var(--surface)}
.ext-year-row .yr{color:var(--muted);min-width:60px}
.ext-year-row .sal{font-weight:600}
.ext-total-row{display:flex;justify-content:space-between;padding:.4rem .5rem;font-size:.75rem;font-weight:700;border-top:1px solid var(--border);margin-top:.25rem}
.ext-note{font-size:.6rem;color:var(--muted);padding:.4rem;background:var(--surface);border-radius:4px;margin:.5rem 0}
.ext-confirm-btn{width:100%;padding:.6rem;background:var(--accent);color:white;border:none;border-radius:8px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;margin-top:.5rem}
.ext-confirm-btn:hover{opacity:.9}
.ext-confirm-btn:disabled{opacity:.4;cursor:not-allowed}
.extended-badge{font-size:.55rem;padding:.1rem .35rem;border-radius:3px;background:rgba(102,126,234,.15);color:#667eea;font-weight:600;white-space:nowrap}

/* Draft Picker Modal */
.draft-picker-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.draft-picker{background:var(--card);border:1px solid var(--border);border-radius:12px;width:400px;max-width:90vw;max-height:80vh;display:flex;flex-direction:column;overflow:hidden}
.draft-picker-hdr{padding:.8rem 1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem}
.draft-picker-hdr h3{flex:1;font-size:.85rem;font-weight:700;color:var(--orange)}
.draft-picker-hdr .close-btn{background:none;border:none;color:var(--muted);font-size:1.1rem;cursor:pointer;padding:.2rem}
.draft-picker-hdr .close-btn:hover{color:var(--text)}
.draft-picker-search{padding:.5rem 1rem;border-bottom:1px solid var(--border)}
.draft-picker-search input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:.4rem .6rem;color:var(--text);font-size:.75rem;outline:none}
.draft-picker-search input:focus{border-color:var(--accent)}
.draft-picker-list{overflow-y:auto;flex:1;padding:.3rem}
.draft-pick-option{display:flex;align-items:center;gap:.6rem;padding:.45rem .8rem;border-radius:6px;cursor:pointer;font-size:.75rem;transition:background .1s}
.draft-pick-option:hover{background:rgba(255,255,255,.06)}
.draft-pick-option.current{background:rgba(255,152,0,.12);border:1px solid rgba(255,152,0,.3)}
.draft-pick-option.taken{opacity:.35;cursor:not-allowed}
.draft-pick-option .rank{color:var(--muted);font-size:.65rem;min-width:30px}
.draft-pick-option .name{flex:1;font-weight:500}
.draft-pick-option .assigned{font-size:.6rem;color:var(--muted);padding:.1rem .4rem;background:var(--surface);border-radius:3px}
.action-btn.draft-swap{background:rgba(255,152,0,.15);color:var(--orange);border-color:rgba(255,152,0,.3)}
.action-btn.draft-swap:hover{background:rgba(255,152,0,.25)}

/* Your Pick pulse */
@keyframes pickPulse{0%{box-shadow:0 0 0 0 rgba(102,126,234,.5)}70%{box-shadow:0 0 0 12px rgba(102,126,234,0)}100%{box-shadow:0 0 0 0 rgba(102,126,234,0)}}
.your-pick-box{animation:pickPulse 1.5s ease-out 2}

/* Trade Machine iframe overlay */
.tm-overlay{position:fixed;top:0;left:0;right:0;bottom:0;z-index:250;background:rgba(0,0,0,.85);display:flex;flex-direction:column;backdrop-filter:blur(4px)}
.tm-bar{display:flex;align-items:center;gap:.75rem;padding:.5rem 1rem;background:var(--card);border-bottom:1px solid var(--border);flex-shrink:0}
.tm-bar h3{flex:1;font-size:.8rem;font-weight:600;color:var(--cyan)}
.tm-bar .tm-close{background:none;border:1px solid var(--border);color:var(--text);font-size:.75rem;padding:.3rem .8rem;border-radius:6px;cursor:pointer;transition:all .15s}
.tm-bar .tm-close:hover{border-color:var(--red);color:var(--red)}
.tm-bar .tm-external{background:none;border:1px solid var(--border);color:var(--muted);font-size:.65rem;padding:.3rem .6rem;border-radius:6px;cursor:pointer;text-decoration:none;transition:all .15s}
.tm-bar .tm-external:hover{border-color:var(--accent);color:var(--accent)}
.tm-iframe{flex:1;border:none;width:100%;background:var(--bg)}

/* Trade modal (legacy ‚Äî keep for manual record) */
.trade-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.trade-modal{background:var(--card);border:1px solid var(--border);border-radius:12px;width:520px;max-width:95vw;max-height:85vh;display:flex;flex-direction:column;overflow:hidden}
.trade-modal-hdr{padding:.8rem 1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem}
.trade-modal-hdr h3{flex:1;font-size:.85rem;font-weight:700;color:var(--cyan)}
.trade-modal-hdr .close-btn{background:none;border:none;color:var(--muted);font-size:1.1rem;cursor:pointer;padding:.2rem}
.trade-modal-body{padding:1rem;overflow-y:auto;flex:1}
.trade-link-row{display:flex;gap:.5rem;margin-bottom:1rem}
.trade-link-btn{font-size:.7rem;padding:.4rem .8rem;border-radius:6px;border:1px solid var(--cyan);background:rgba(38,198,218,.1);color:var(--cyan);cursor:pointer;font-weight:600;transition:all .15s;flex:1;text-align:center}
.trade-link-btn:hover{background:rgba(38,198,218,.2)}
.trade-record-section{margin-top:.5rem}
.trade-record-section h4{font-size:.75rem;color:var(--muted);margin-bottom:.5rem;font-weight:600}
.trade-input-row{display:flex;gap:.5rem;margin-bottom:.4rem;align-items:center}
.trade-input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:.4rem .6rem;color:var(--text);font-size:.75rem;outline:none}
.trade-input:focus{border-color:var(--accent)}
.trade-input::placeholder{color:var(--muted)}
.trade-add-btn{font-size:.65rem;padding:.3rem .6rem;border-radius:4px;border:1px solid var(--green);color:var(--green);background:transparent;cursor:pointer}
.trade-add-btn:hover{background:rgba(76,175,80,.15)}
.trade-player-tag{display:inline-flex;align-items:center;gap:.3rem;font-size:.65rem;padding:.2rem .5rem;border-radius:4px;background:var(--surface);border:1px solid var(--border);margin:.15rem .15rem}
.trade-player-tag .remove{cursor:pointer;color:var(--red);font-weight:700}
.trade-confirm-btn{width:100%;padding:.5rem;border-radius:6px;border:1px solid var(--green);background:rgba(76,175,80,.15);color:var(--green);cursor:pointer;font-weight:600;font-size:.75rem;margin-top:.75rem;transition:all .15s}
.trade-confirm-btn:hover{background:rgba(76,175,80,.3)}
.trade-confirm-btn:disabled{opacity:.4;cursor:not-allowed}

/* Signing modal */
.sign-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.sign-modal{background:var(--card);border:1px solid var(--border);border-radius:12px;width:420px;max-width:95vw;max-height:85vh;display:flex;flex-direction:column;overflow:hidden}
.sign-modal-hdr{padding:.8rem 1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem}
.sign-modal-hdr h3{flex:1;font-size:.85rem;font-weight:700;color:var(--green)}
.sign-modal-body{padding:1rem;overflow-y:auto;flex:1}
.sign-exc-option{display:flex;flex-direction:column;gap:.2rem;padding:.6rem;border:1px solid var(--border);border-radius:8px;cursor:pointer;margin-bottom:.4rem;transition:all .15s}
.sign-exc-option:hover{border-color:var(--accent);background:rgba(102,126,234,.06)}
.sign-exc-option.unavailable{opacity:.35;cursor:not-allowed}
.sign-exc-option .exc-name{font-size:.75rem;font-weight:600}
.sign-exc-option .exc-detail{font-size:.65rem;color:var(--muted)}
.sign-salary-input{display:flex;gap:.5rem;align-items:center;margin:.75rem 0}
.sign-salary-input label{font-size:.7rem;color:var(--muted);min-width:60px}

/* Training camp warning */
.camp-warning{background:rgba(239,83,80,.1);border:1px solid rgba(239,83,80,.3);border-radius:8px;padding:.75rem 1rem;margin-bottom:.75rem}
.camp-warning h4{font-size:.8rem;color:var(--red);margin-bottom:.3rem}
.camp-warning p{font-size:.7rem;color:var(--muted)}
.camp-ok{background:rgba(76,175,80,.1);border:1px solid rgba(76,175,80,.3);border-radius:8px;padding:.75rem 1rem;margin-bottom:.75rem}
.camp-ok h4{font-size:.8rem;color:var(--green);margin-bottom:.3rem}
.camp-ok p{font-size:.7rem;color:var(--muted)}

/* Traded badge */
.traded-badge{font-size:.55rem;padding:.1rem .35rem;border-radius:3px;background:rgba(38,198,218,.15);color:var(--cyan);border:1px solid rgba(38,198,218,.3);margin-left:.3rem;font-weight:600}
.signed-badge{font-size:.55rem;padding:.1rem .35rem;border-radius:3px;background:rgba(76,175,80,.15);color:var(--green);border:1px solid rgba(76,175,80,.3);margin-left:.3rem;font-weight:600}

/* Landing Page */
.landing{position:fixed;top:0;left:0;right:0;bottom:0;z-index:300;background:var(--bg);display:flex;flex-direction:column;overflow-y:auto}
.landing-hdr{text-align:center;padding:2.5rem 1rem 1rem;background:linear-gradient(180deg,rgba(102,126,234,.12) 0%,transparent 100%)}
.landing-hdr h1{font-size:2rem;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:1px}
.landing-hdr .landing-sub{font-size:.85rem;color:var(--muted);margin-top:.4rem}
.landing-hdr .landing-badge{display:inline-block;margin-top:.75rem;font-size:.65rem;padding:.3rem .8rem;border-radius:20px;background:rgba(102,126,234,.12);color:var(--accent);border:1px solid rgba(102,126,234,.2);font-weight:600;letter-spacing:.5px}
.landing-body{max-width:900px;margin:0 auto;padding:1rem 1.5rem 3rem;width:100%}
.conf-label{font-size:.7rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin:1.5rem 0 .75rem;padding-bottom:.4rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.5rem}
.conf-label::before{content:'';display:inline-block;width:3px;height:14px;border-radius:2px}
.conf-label.east::before{background:var(--accent)}
.conf-label.west::before{background:var(--orange)}
.team-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:.6rem}
@media(max-width:700px){.team-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:420px){.team-grid{grid-template-columns:repeat(2,1fr)}}
.team-card{display:flex;flex-direction:column;align-items:center;gap:.4rem;padding:.8rem .5rem;background:var(--card);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all .15s;text-align:center}
.team-card:hover{border-color:var(--accent);background:rgba(102,126,234,.08);transform:translateY(-2px)}
.team-card:active{transform:translateY(0)}
.team-card img{width:48px;height:48px;object-fit:contain;filter:drop-shadow(0 2px 4px rgba(0,0,0,.3))}
.team-card .tc-abbr{font-size:.75rem;font-weight:700;color:var(--text)}
.team-card .tc-name{font-size:.6rem;color:var(--muted);line-height:1.2}
</style>
</head>
<body>

<!-- Landing Page -->
<div id="landingPage" class="landing">
  <div class="landing-hdr">
    <h1>üèÄ ROSTER MANAGER</h1>
    <div class="landing-sub">HoopsMatic GM Simulator ¬∑ 2026-27 Offseason</div>
    <div class="landing-badge">SELECT YOUR TEAM TO BEGIN</div>
  </div>
  <div class="landing-body" id="landingBody">
    <div style="text-align:center;padding:2rem 0"><div class="spin" style="display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite"></div><p style="margin-top:.5rem;font-size:.8rem;color:var(--muted)">Loading teams...</p></div>
  </div>
</div>

<div class="header">
  <div>
    <h1>üèÄ ROSTER MANAGER <span style="font-size:.65rem;opacity:.6">v0.9.5</span></h1>
    <div class="subtitle">HoopsMatic GM Simulator</div>
  </div>
  <div style="display:flex;align-items:center;gap:.75rem;margin-left:auto">
    <select id="teamSelect" class="team-dropdown" onchange="if(this.value)selectTeam(this.value)">
      <option value="">Select team...</option>
    </select>
    <div class="season-badge">2026-27 OFFSEASON</div>
  </div>
</div>

<div id="appContent" style="display:none">
  <div id="teamBanner" class="team-banner"></div>
  <div class="phase-bar" id="phaseBar"></div>
  <div class="main">
    <div class="roster-panel" id="rosterPanel"></div>
    <div class="cap-panel" id="capPanel"></div>
  </div>
</div>

<div id="loadingState" class="loading" style="display:none">
  <div class="spin"></div>
  <p style="margin-top:.5rem;font-size:.8rem">Loading roster data...</p>
</div>

<!-- Waive Decision Modal -->
<div id="waiveOverlay" class="waive-overlay" style="display:none" onclick="if(event.target===this)closeWaiveModal()">
  <div class="waive-modal" id="waiveModal"></div>
</div>

<!-- Draft Picker Modal -->
<div id="draftPickerOverlay" class="draft-picker-overlay" style="display:none" onclick="if(event.target===this)closeDraftPicker()">
  <div class="draft-picker">
    <div class="draft-picker-hdr">
      <span style="font-size:1.1rem">üèÄ</span>
      <h3 id="draftPickerTitle">Select Prospect</h3>
      <button class="close-btn" onclick="closeDraftPicker()">‚úï</button>
    </div>
    <div class="draft-picker-search">
      <input type="text" placeholder="Search prospects..." oninput="renderDraftPickerList(this.value)">
    </div>
    <div class="draft-picker-list" id="draftPickerList"></div>
  </div>
</div>

<!-- Trade Machine Iframe Overlay -->
<div id="tmOverlay" class="tm-overlay" style="display:none">
  <div class="tm-bar">
    <span style="font-size:1rem">üîÑ</span>
    <h3>Trade Machine</h3>
    <a id="tmExternalLink" class="tm-external" href="#" target="_blank" onclick="closeTradeMachine()">Open in new tab ‚Üó</a>
    <button class="tm-close" onclick="closeTradeMachine()">‚úï Close</button>
  </div>
  <div id="tmLoading" style="flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:.5rem">
    <div class="spin" style="display:inline-block;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--cyan);border-radius:50%;animation:spin .8s linear infinite"></div>
    <p style="font-size:.75rem;color:var(--muted)">Loading Trade Machine...</p>
    <button onclick="tmFallbackNewTab()" style="margin-top:.5rem;font-size:.7rem;padding:.3rem .8rem;border:1px solid var(--border);background:none;color:var(--muted);border-radius:6px;cursor:pointer">Not loading? Open in new tab instead</button>
  </div>
  <iframe id="tmIframe" class="tm-iframe" style="display:none" referrerpolicy="no-referrer-when-downgrade"></iframe>
</div>

<!-- Extension Modal -->
<div id="extOverlay" class="ext-overlay" style="display:none" onclick="if(event.target===this)closeExtModal()">
  <div class="ext-modal">
    <div class="ext-modal-hdr">
      <span style="font-size:1.1rem">üìù</span>
      <h3 id="extModalTitle">Extend Player</h3>
      <button class="close-btn" onclick="closeExtModal()">‚úï</button>
    </div>
    <div class="ext-modal-body" id="extModalBody"></div>
  </div>
</div>

<!-- Signing Modal -->
<div id="signOverlay" class="sign-overlay" style="display:none" onclick="if(event.target===this)closeSignModal()">
  <div class="sign-modal">
    <div class="sign-modal-hdr">
      <span style="font-size:1.1rem">‚úçÔ∏è</span>
      <h3 id="signModalTitle">Sign Free Agent</h3>
      <button class="close-btn" onclick="closeSignModal()">‚úï</button>
    </div>
    <div class="sign-modal-body" id="signModalBody"></div>
  </div>
</div>

<script>
// ======================== CONSTANTS ========================
const SEASON = '2026-27';
const THRESHOLDS = {
  '2025-2026': {cap:154647000,tax:187895000,apron1:195945000,apron2:207824000,bae:5134000,ntmle:14104000,tmle:5685000,rmle:8781000},
  '2026-2027': {cap:166000000,tax:201690000,apron1:210690000,apron2:223690000,bae:5511000,ntmle:15139000,tmle:6102000,rmle:9425000},
  '2027-2028': {cap:174300000,tax:211775000,apron1:220812000,apron2:234200000,bae:5787000,ntmle:15896000,tmle:6407000,rmle:9897000},
};
const T = THRESHOLDS['2026-2027'];
const MIN_SALARY_0YOS = 1272870; // approximate 2026-27 minimum for 0 YOS
const MIN_SALARY_CAP_HOLD = Math.round(MIN_SALARY_0YOS * 1.5); // ~$1.9M
const EST_AVG_SALARY = 13200000; // approximate

// 2026-27 Rookie Scale at 120% (Year 1 cap holds), picks 1-30
const ROOKIE_SCALE = [
  13825920,12370320,11108880,10015680,9069840,8237640,7520040,6889200,6332520,6016080,
  5715120,5429520,5157960,4900320,4655040,4422360,4201080,3991320,3811560,3658800,
  3512520,3372240,3237480,3108120,2983320,2884560,2801280,2783880,2763960,2743800
];

const SSID = '11llk0icQqoi0JwJXat5KO8y2RQeBMN5rS9FhAY56Idc';
const TEAMS = {
  'Atlanta':'ATL','Boston':'BOS','Brooklyn':'BKN','Charlotte':'CHA','Chicago':'CHI',
  'Cleveland':'CLE','Dallas':'DAL','Denver':'DEN','Detroit':'DET','Golden State':'GSW',
  'Houston':'HOU','Indiana':'IND','LA Clippers':'LAC','LA Lakers':'LAL','Memphis':'MEM',
  'Miami':'MIA','Milwaukee':'MIL','Minnesota':'MIN','New Orleans':'NOP','New York':'NYK',
  'Oklahoma City':'OKC','Orlando':'ORL','Philadelphia':'PHI','Phoenix':'PHX','Portland':'POR',
  'Sacramento':'SAC','San Antonio':'SAS','Toronto':'TOR','Utah':'UTA','Washington':'WAS'
};

// ======================== STATE ========================
let allPlayers = []; // raw parsed data
let teamLogos = {}; // team -> logo URL
let teamDraftPicks = {}; // abbrev -> [{prospect, draftRnk, capHold}]
let allProspects = []; // all prospect names from Draft Predictor
let allPickSlots = {}; // pickSlot# -> {team (abbrev), defaultProspect}
let contractsMap = {}; // playerName -> { yrs: [{sal, ch, st},...], totG }
let tradeValueMap = {}; // playerName (lowercase) -> trade value ($)
let preLotteryOrder = []; // team abbrevs in standings order (worst to best)
let STATE = null; // current GM state

// Reverse team map: abbreviation -> full name
const TEAMS_REV = {};
for (const [full, abbr] of Object.entries(TEAMS)) TEAMS_REV[abbr] = full;

const PHASES = [
  { id: 'pre_lottery', label: 'Pre-Lottery', icon: 'üìã' },
  { id: 'lottery', label: 'Draft Lottery', icon: 'üé±' },
  { id: 'pre_draft', label: 'Pre-Draft', icon: 'üèÄ' },
  { id: 'draft', label: 'Draft Night', icon: 'üéØ' },
  { id: 'pre_fa', label: 'Pre-Free Agency', icon: 'üìù' },
  { id: 'free_agency', label: 'Free Agency', icon: '‚úçÔ∏è' },
  { id: 'training_camp', label: 'Training Camp', icon: '‚õ∫' }
];

// Trade Machine base URL
const TRADE_MACHINE_URL = 'https://hoopsmatic.com';

const MIN_SALARY_2ND_RD = 1157379; // 2nd round minimum cap hold

function defaultState(team) {
  return { team, phase: 'pre_lottery', moves: [], optionDecisions: {}, renounced: new Set(), waived: new Set(), stretched: new Set(), draftSelections: {}, trades: [], signings: [], extensions: [], depthOrder: {}, lotteryResults: null, draftResults: [], draftCurrentPick: 0 };
}

function saveState() {
  if (!STATE) return;
  const s = {
    ...STATE,
    renounced: [...STATE.renounced],
    waived: [...STATE.waived],
    stretched: [...STATE.stretched]
  };
  localStorage.setItem('rm_state_' + STATE.team, JSON.stringify(s));
}

function loadState(team) {
  const raw = localStorage.getItem('rm_state_' + team);
  if (raw) {
    try {
      const s = JSON.parse(raw);
      s.renounced = new Set(s.renounced || []);
      s.waived = new Set(s.waived || []);
      s.stretched = new Set(s.stretched || []);
      s.draftSelections = s.draftSelections || {};
      s.trades = s.trades || [];
      s.signings = s.signings || [];
      s.extensions = s.extensions || [];
      s.depthOrder = s.depthOrder || {};
      s.lotteryResults = s.lotteryResults || null;
      s.draftResults = s.draftResults || [];
      s.draftCurrentPick = s.draftCurrentPick || 0;
      s.phase = s.phase || 'pre_lottery';
      return s;
    } catch(e) {}
  }
  return defaultState(team);
}

// ======================== DATA LOADING ========================
function parseMoney(s) {
  if (!s) return 0;
  const neg = s.includes('-');
  const num = parseInt(s.replace(/[$,\s()-]/g, '')) || 0;
  return neg ? -num : num;
}

function fmtMoney(n) {
  if (n === 0) return '$0';
  const abs = Math.abs(n);
  const s = abs >= 1e6 ? '$' + (abs / 1e6).toFixed(1) + 'M' : abs >= 1e3 ? '$' + (abs / 1e3).toFixed(0) + 'K' : '$' + abs;
  return n < 0 ? '-' + s : s;
}

function fmtMoneyFull(n) {
  if (n === 0) return '$0';
  const abs = Math.abs(n);
  const s = '$' + abs.toLocaleString('en-US');
  return n < 0 ? '-' + s : s;
}

async function fetchData() {
  const gid = '0';
  const urls = [
    `https://docs.google.com/spreadsheets/d/${SSID}/gviz/tq?tqx=out:csv&gid=${gid}`,
    `https://docs.google.com/spreadsheets/d/${SSID}/export?format=csv&gid=${gid}`
  ];
  for (const url of urls) {
    try {
      const r = await fetch(url);
      if (!r.ok) continue;
      const txt = await r.text();
      if (txt.includes('<!DOCTYPE') || txt.includes('<html')) continue;
      return txt;
    } catch(e) { continue; }
  }
  return null;
}

async function fetchDraftPicks() {
  const gid = '965849547';
  const urls = [
    `https://docs.google.com/spreadsheets/d/${SSID}/gviz/tq?tqx=out:csv&gid=${gid}`,
    `https://docs.google.com/spreadsheets/d/${SSID}/export?format=csv&gid=${gid}`
  ];
  for (const url of urls) {
    try {
      const r = await fetch(url);
      if (!r.ok) continue;
      const txt = await r.text();
      if (txt.includes('<!DOCTYPE') || txt.includes('<html')) continue;
      const rows = parseCSV(txt);

      // Columns: 0=Prospect name, 15=POS (pre-lottery standings rank), 16=TEAM (3-letter abbrev)
      const prospects = [];
      const pickSlots = {};
      const picks = {};

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const prospect = (row[0] || '').trim();
        const pickPos = parseInt((row[15] || '').trim()) || 0;
        const rawTeam = (row[16] || '').trim().toUpperCase();

        if (!prospect) continue;
        prospects.push(prospect);

        // First-round picks (1-30) get rookie scale cap holds
        // Second-round picks (31-60) get minimum salary cap hold
        if (pickPos < 1 || pickPos > 60 || !rawTeam) continue;
        const abbrev = rawTeam.length <= 3 ? rawTeam : (TEAMS[rawTeam] || rawTeam);
        const capHold = pickPos <= 30 ? (ROOKIE_SCALE[pickPos - 1] || 0) : MIN_SALARY_2ND_RD;

        pickSlots[pickPos] = { team: abbrev, defaultProspect: prospect };

        if (!picks[abbrev]) picks[abbrev] = [];
        picks[abbrev].push({ prospect, draftRnk: pickPos, capHold });
      }

      for (const t of Object.keys(picks)) picks[t].sort((a, b) => a.draftRnk - b.draftRnk);
      allProspects = prospects;
      allPickSlots = pickSlots;
      teamDraftPicks = picks;

      // Build pre-lottery order from picks 1-14 (column P = standings rank, 1 = worst record)
      preLotteryOrder = [];
      for (let i = 1; i <= 14; i++) {
        if (pickSlots[i]) preLotteryOrder.push(pickSlots[i].team);
      }
      console.log(`[DP] Pre-lottery order: ${preLotteryOrder.join(', ')}`);

      const totalPicks = Object.values(picks).reduce((s, arr) => s + arr.length, 0);
      console.log(`[DP] Loaded ${prospects.length} prospects, ${totalPicks} first-round picks for ${Object.keys(picks).length} teams`);
      return;
    } catch(e) { console.warn('[DP] Failed:', e); continue; }
  }
  console.warn('[DP] Could not load draft predictor data');
}

const CONTRACTS_GID = '1649473047';
const CONTRACT_YEARS = [
  { label: "'25-26", sc: 7, cc: 8, tc: 9, preFaOnly: true },
  { label: "'26-27", sc: 10, cc: 11, tc: 12 },
  { label: "'27-28", sc: 13, cc: 14, tc: 15 },
  { label: "'28-29", sc: 16, cc: 17, tc: 18 },
  { label: "'29-30", sc: 19, cc: 20, tc: 21 },
  { label: "'30-31", sc: 22, cc: 23, tc: 24 },
];

function normContractSt(s) {
  if (!s) return '';
  s = s.trim().toUpperCase();
  if (s.startsWith('GUAR')) return 'GUARANTEED';
  if (s === 'NOT G') return 'NOT G';
  if (s === 'PARTIAL G') return 'PARTIAL G';
  if (s === 'TEAM OPT') return 'TEAM OPT';
  if (s === 'PLAYER OPT') return 'PLAYER OPT';
  if (s === 'TWO-WAY') return 'TWO-WAY';
  return s;
}

async function fetchContracts() {
  contractsMap = {};
  const urls = [
    `https://docs.google.com/spreadsheets/d/${SSID}/gviz/tq?tqx=out:csv&gid=${CONTRACTS_GID}`,
    `https://docs.google.com/spreadsheets/d/${SSID}/export?format=csv&gid=${CONTRACTS_GID}`
  ];
  for (const url of urls) {
    try {
      const r = await fetch(url);
      if (!r.ok) continue;
      const txt = await r.text();
      if (txt.includes('<!DOCTYPE') || txt.includes('<html')) continue;
      const rows = parseCSV(txt);
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const name = (row[0] || '').trim();
        if (!name) continue;
        const yrs = CONTRACT_YEARS.map(yr => ({
          sal: parseMoney(row[yr.sc]),
          ch: parseMoney(row[yr.cc]),
          st: normContractSt(row[yr.tc])
        }));
        // Only store if player has at least one future year salary
        if (yrs.some(y => y.sal)) {
          contractsMap[name] = { yrs, totG: parseMoney(row[28]) };
        }
      }
      console.log(`[Contracts] Loaded ${Object.keys(contractsMap).length} players`);
      return;
    } catch(e) { console.warn('[Contracts] Failed:', e); continue; }
  }
}

const TV_GID = '1310971167';
async function fetchTradeValues() {
  tradeValueMap = {};
  const urls = [
    `https://docs.google.com/spreadsheets/d/${SSID}/gviz/tq?tqx=out:csv&gid=${TV_GID}`,
    `https://docs.google.com/spreadsheets/d/${SSID}/export?format=csv&gid=${TV_GID}`
  ];
  for (const url of urls) {
    try {
      const r = await fetch(url);
      if (!r.ok) continue;
      const txt = await r.text();
      if (txt.includes('<!DOCTYPE') || txt.includes('<html')) continue;
      const rows = parseCSV(txt);
      const roster = [], historical = []; let todayStr = null;
      for (const row of rows.slice(1)) {
        while (row.length < 22) row.push('');
        if (row[18] && !todayStr) todayStr = row[18];
        if (row[0] && row[1]) roster.push({ player: row[1].trim(), rat365: parseFloat(row[2])||0, salary: parseInt(row[3].replace(/[$,]/g,''))||0, birthday: row[4]||'', draftPick: parseInt(row[20])||null });
        if (row[6] && row[7]) { const g = parseInt(row[9])||0; if (g > 0) historical.push({ year: row[6], player: row[7].trim(), totalRat: parseFloat(row[8].replace(/,/g,''))||0, games: g }); }
      }
      const playerHist = {}; for (const h of historical) { const k = h.player.toLowerCase(); if (!playerHist[k]) playerHist[k] = []; playerHist[k].push(h); }
      const WEIGHTS = {'2025-26':1.0,'2024-25':0.6,'2023-24':0.36,'2022-23':0.216,'2021-22':0.1296};
      const EXPECTED = {'2021-22':82,'2022-23':82,'2023-24':82,'2024-25':82,'2025-26':48};
      const EXP=1.8, BETA=0.8, MAX_MULT=1.4, MIN_PCT=0.40, WM_W=0.85, RAT_W=0.15, AGE_BONUS=1.0, OLD_TH=35, OLD_PEN=0.03;
      for (const p of roster) {
        const hist = playerHist[p.player.toLowerCase()]||[]; let num=0, den=0;
        for (const h of hist) { const w = WEIGHTS[h.year]||0; if (w<=0||h.games<=0) continue; let pg = h.totalRat/h.games; const exp = EXPECTED[h.year]||82; if (h.games/exp >= MIN_PCT) pg *= Math.min(MAX_MULT, Math.pow(exp/h.games, BETA)); num += pg*w*h.games; den += w*h.games; }
        p.watermark = den > 0 ? num/den : 0;
        const cur = hist.filter(h => h.year==='2025-26'); const cg = cur.reduce((s,h) => s+h.games, 0);
        p.rat365adj = (cg > 0 && cg/48 >= MIN_PCT) ? p.rat365 * Math.min(MAX_MULT, Math.pow(48/cg, BETA)) : p.rat365;
      }
      const pd = s => { if (!s) return null; const p = s.split('/'); return p.length===3 ? new Date(+p[2],+p[0]-1,+p[1]) : null; };
      const today = pd(todayStr)||new Date(); const ages = [];
      for (const p of roster) { const bd = pd(p.birthday); p.age = bd ? (today-bd)/(365.25*864e5) : null; if (p.age) ages.push(p.age); }
      const avgAge = ages.length > 0 ? ages.reduce((a,b)=>a+b,0)/ages.length : 26;
      const maxDev = Math.max(1, avgAge - Math.min(...ages));
      for (const p of roster) {
        if (p.age!==null && p.age < avgAge) p.ageMult = 1.0 + AGE_BONUS*(avgAge-p.age)/maxDev;
        else if (p.age!==null && p.age >= OLD_TH) p.ageMult = Math.max(0.5, 1.0-OLD_PEN*(p.age-OLD_TH));
        else p.ageMult = 1.0;
      }
      const tSP = roster.reduce((s,p)=>s+p.salary,0);
      const tWM = roster.reduce((s,p)=>s+Math.pow(Math.max(p.watermark,0),EXP),0);
      const tRAT = roster.reduce((s,p)=>s+Math.pow(Math.max(p.rat365adj,0),EXP),0);
      for (const p of roster) {
        const tvWM = tWM>0 ? (Math.pow(Math.max(p.watermark,0),EXP)/tWM)*tSP : 0;
        const tvRAT = tRAT>0 ? (Math.pow(Math.max(p.rat365adj,0),EXP)/tRAT)*tSP : 0;
        p.tvWithAge = (WM_W*tvWM + RAT_W*tvRAT) * p.ageMult;
      }
      const tWA = roster.reduce((s,p)=>s+p.tvWithAge,0);
      for (const p of roster) {
        const baseTV = tWA>0 ? Math.round((p.tvWithAge/tWA)*tSP) : 0; let bonus = 0;
        if (p.age!==null && p.age<25 && p.draftPick && p.draftPick>=1 && p.draftPick<=60) { bonus = Math.round(7e6 * Math.exp(-0.05*(p.draftPick-1)) * Math.exp(-0.5*Math.max(0,p.age-18.82))); }
        tradeValueMap[p.player.toLowerCase()] = baseTV+bonus;
      }
      console.log(`[TV] Loaded ${Object.keys(tradeValueMap).length} trade values`);
      return;
    } catch(e) { console.warn('[TV] Failed:', e); continue; }
  }
}

function parseCSV(text) {
  const rows = []; let row = []; let cell = ''; let inQ = false;
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (inQ) {
      if (c === '"' && text[i+1] === '"') { cell += '"'; i++; }
      else if (c === '"') inQ = false;
      else cell += c;
    } else {
      if (c === '"') inQ = true;
      else if (c === ',') { row.push(cell); cell = ''; }
      else if (c === '\n' || c === '\r') {
        if (c === '\r' && text[i+1] === '\n') i++;
        row.push(cell); cell = '';
        if (row.some(c => c.trim())) rows.push(row);
        row = [];
      } else cell += c;
    }
  }
  if (cell || row.length) { row.push(cell); if (row.some(c => c.trim())) rows.push(row); }
  return rows;
}

function parseAllPlayers(csv) {
  const rows = parseCSV(csv);
  const players = [];
  // Header-based lookup for EXT_ELIGIBLE column
  const headers = rows[0] || [];
  const extColIdx = headers.findIndex(h => (h || '').trim().toUpperCase() === 'EXT_ELIGIBLE');
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    const name = (r[0] || '').trim();
    const team = (r[2] || '').trim();
    if (!name || !team || !TEAMS[team]) continue;

    const sal26 = parseMoney(r[3]);
    const ch26 = parseMoney(r[4]);
    const st26 = (r[5] || '').trim();
    const sal27 = parseMoney(r[6]);
    const ch27 = parseMoney(r[7]);
    const st27 = (r[8] || '').trim();
    const exception = (r[20] || '').trim();
    const logo = (r[24] || '').trim();
    const headshot = (r[25] || '').trim();
    const pos = (r[26] || '').trim();
    const age = (r[27] || '').trim();
    const end = parseInt((r[29] || '').trim()) || 0;
    const totalGuar = parseMoney(r[30]);
    const tradeKicker = parseFloat((r[31] || '').trim()) || 0;
    const rat365 = parseFloat((r[11] || '').trim()) || 0;
    const extEligible = extColIdx >= 0 ? (r[extColIdx] || '').trim() : '';

    if (logo && team) teamLogos[team] = logo;

    // Determine player category for 2026-27 offseason
    let category, capHold = 0;
    if (st26 === 'TWO-WAY' || st27 === 'TWO-WAY') {
      category = 'twoway';
    } else if (!sal27 && !st27) {
      // No 2026-27 salary = expiring, becomes free agent
      category = 'free_agent';
      capHold = calcCapHold(sal26, exception);
    } else if (st27 === 'TEAM OPT') {
      category = 'team_option';
    } else if (st27 === 'PLAYER OPT') {
      category = 'player_option';
    } else if (st27 === 'NOT G') {
      category = 'non_guaranteed';
    } else if (st27 === 'PARTIAL G') {
      category = 'partial_guaranteed';
    } else {
      category = 'under_contract'; // GUARANTEED
    }

    players.push({
      name, team, sal26, ch26, st26, sal27, ch27, st27,
      exception, logo, headshot, pos, age, end, totalGuar, tradeKicker,
      category, capHold, extEligible, rat365,
      tv: tradeValueMap[name.toLowerCase()] || 0
    });
  }
  return players;
}

function calcCapHold(priorSalary, exception) {
  const maxSalary = Math.round(T.cap * 0.35); // absolute max for any player
  if (!priorSalary) return MIN_SALARY_CAP_HOLD;
  let hold;
  const exc = exception.toLowerCase();
  if (exc.includes('bird') && !exc.includes('early') && !exc.includes('non')) {
    hold = Math.round(priorSalary * (priorSalary > EST_AVG_SALARY ? 2.50 : 1.90));
  } else if (exc.includes('early bird')) {
    hold = Math.max(Math.round(priorSalary * 1.90), Math.round(EST_AVG_SALARY * 1.30));
  } else if (exc.includes('non-bird') || exc.includes('non bird')) {
    hold = Math.max(Math.round(priorSalary * 1.50), MIN_SALARY_CAP_HOLD);
  } else if (exc.includes('minimum')) {
    hold = MIN_SALARY_CAP_HOLD;
  } else if (exc.includes('mid-level') || exc.includes('taxpayer') || exc.includes('room')) {
    hold = Math.max(Math.round(priorSalary * 1.50), MIN_SALARY_CAP_HOLD);
  } else if (exc.includes('rookie')) {
    hold = Math.round(priorSalary * 1.90);
  } else {
    hold = Math.max(Math.round(priorSalary * 1.50), MIN_SALARY_CAP_HOLD);
  }
  return Math.min(hold, maxSalary);
}

// ======================== CAP ENGINE ========================
function calcCapSheet(team) {
  const players = allPlayers.filter(p => p.team === team);
  let activeSalaries = 0, capHolds = 0, deadMoney = 0;
  let rosterCount = 0, twowayCount = 0;

  // Build set of traded-out player names
  const tradedOut = new Set();
  const tradedIn = []; // {name, salary, pos, fromTeam}
  for (const trade of (STATE.trades || [])) {
    for (const p of (trade.out || [])) tradedOut.add(p.name);
    for (const p of (trade.in || [])) tradedIn.push(p);
  }

  const roster = { under_contract: [], free_agent: [], non_guaranteed: [], partial_guaranteed: [], twoway: [], waived: [], draft_picks: [], signed: [] };

  for (const p of players) {
    // Skip traded-out players
    if (tradedOut.has(p.name)) continue;

    const waived = STATE.waived.has(p.name);
    const renounced = STATE.renounced.has(p.name);
    const optDecision = STATE.optionDecisions[p.name]; // 'pickup','exercise','decline'

    // === WAIVED ===
    if (waived) {
      let dead = 0;
      const isStretched = STATE.stretched.has(p.name);
      const wasPickedUp = STATE.optionDecisions[p.name] === 'pickup' || STATE.optionDecisions[p.name] === 'exercise';
      if (p.category === 'under_contract' || p.st27 === 'GUARANTEED' || wasPickedUp) {
        dead = p.sal27; // full guaranteed salary
      } else if (p.category === 'partial_guaranteed') {
        dead = p.ch27; // guaranteed portion
      }
      // Stretch provision: divide over (2*remaining_years + 1)
      if (isStretched && dead > 0) {
        const remainingYrs = Math.max(1, (p.end || 2027) - 2026);
        const stretchPeriod = 2 * remainingYrs + 1;
        dead = Math.round(dead / stretchPeriod);
      }
      if (dead) deadMoney += dead;
      roster.waived.push({ ...p, status: 'waived', deadAmount: dead, isStretched });
      continue;
    }

    // === TWO-WAY ===
    if (p.category === 'twoway') {
      twowayCount++;
      roster.twoway.push({ ...p, status: 'active' });
      continue;
    }

    // === TEAM OPTION ===
    if (p.category === 'team_option') {
      if (optDecision === 'pickup') {
        activeSalaries += p.sal27;
        rosterCount++;
        roster.under_contract.push({ ...p, status: 'picked_up', fromOption: 'TO' });
      } else if (optDecision === 'decline') {
        const hold = calcCapHold(p.sal26, p.exception);
        if (renounced) {
          roster.free_agent.push({ ...p, status: 'renounced', capHold: hold, fromOption: 'TO' });
        } else {
          capHolds += hold;
          roster.free_agent.push({ ...p, status: 'held', capHold: hold, fromOption: 'TO' });
        }
      } else {
        // Pending ‚Äî count salary provisionally
        activeSalaries += p.sal27;
        rosterCount++;
        roster.under_contract.push({ ...p, status: 'pending_to' });
      }
      continue;
    }

    // === PLAYER OPTION ===
    if (p.category === 'player_option') {
      if (optDecision === 'exercise') {
        activeSalaries += p.sal27;
        rosterCount++;
        roster.under_contract.push({ ...p, status: 'exercised', fromOption: 'PO' });
      } else if (optDecision === 'decline') {
        const hold = calcCapHold(p.sal26, p.exception);
        if (renounced) {
          roster.free_agent.push({ ...p, status: 'renounced', capHold: hold, fromOption: 'PO' });
        } else {
          capHolds += hold;
          roster.free_agent.push({ ...p, status: 'held', capHold: hold, fromOption: 'PO' });
        }
      } else {
        activeSalaries += p.sal27;
        rosterCount++;
        roster.under_contract.push({ ...p, status: 'pending_po' });
      }
      continue;
    }

    // === FREE AGENT ===
    if (p.category === 'free_agent') {
      if (renounced) {
        roster.free_agent.push({ ...p, status: 'renounced' });
      } else {
        capHolds += p.capHold;
        roster.free_agent.push({ ...p, status: 'held' });
      }
      continue;
    }

    // === NON-GUARANTEED ===
    if (p.category === 'non_guaranteed') {
      activeSalaries += p.sal27;
      rosterCount++;
      roster.non_guaranteed.push({ ...p, status: 'active' });
      continue;
    }

    // === PARTIAL GUARANTEED ===
    if (p.category === 'partial_guaranteed') {
      activeSalaries += p.sal27;
      rosterCount++;
      roster.partial_guaranteed.push({ ...p, status: 'active' });
      continue;
    }

    // === UNDER CONTRACT (GUARANTEED) ===
    activeSalaries += p.sal27;
    rosterCount++;
    roster.under_contract.push({ ...p, status: 'active' });
  }

  // Incomplete roster charge: if < 12 standard contracts, add minimum cap hold per empty slot
  const incompleteCharge = rosterCount < 12 ? (12 - rosterCount) * MIN_SALARY_CAP_HOLD : 0;

  // === DRAFT PICKS ===
  const teamAbbrev = TEAMS[team];
  const picks = teamDraftPicks[teamAbbrev] || [];
  let draftCapHolds = 0;
  for (const pick of picks) {
    if (STATE.renounced.has('PICK_' + pick.draftRnk)) continue;
    draftCapHolds += pick.capHold;
    const selectedProspect = (STATE.draftSelections && STATE.draftSelections[pick.draftRnk]) || pick.prospect;
    roster.draft_picks.push({ ...pick, selectedProspect });
  }
  capHolds += draftCapHolds;

  // === TRADED-IN PLAYERS ===
  for (const tp of tradedIn) {
    activeSalaries += tp.salary;
    rosterCount++;
    roster.under_contract.push({
      name: tp.name, sal27: tp.salary, pos: tp.pos || '', headshot: tp.headshot || '',
      exception: '', st27: 'GUARANTEED', status: 'traded_in', fromTeam: tp.fromTeam,
      end: tp.end || 0, tradeKicker: 0, tv: tradeValueMap[tp.name.toLowerCase()] || 0
    });
  }

  // === SIGNINGS (Free Agency) ===
  for (const sig of (STATE.signings || [])) {
    if (STATE.waived.has(sig.name)) {
      // Waived after signing ‚Äî full salary as dead money
      const dead = sig.salary;
      deadMoney += dead;
      roster.waived.push({
        name: sig.name, sal27: sig.salary, sal26: sig.salary, pos: sig.pos || '', headshot: sig.headshot || '',
        exception: sig.exception, st27: 'GUARANTEED', status: 'waived',
        deadAmount: dead, isStretched: false, tv: tradeValueMap[sig.name.toLowerCase()] || 0
      });
      continue;
    }
    activeSalaries += sig.salary;
    rosterCount++;
    roster.signed.push({
      name: sig.name, sal27: sig.salary, pos: sig.pos || '', headshot: sig.headshot || '',
      exception: sig.exception, st27: 'GUARANTEED', status: 'signed',
      end: sig.end || 2027, tradeKicker: 0, tv: tradeValueMap[sig.name.toLowerCase()] || 0
    });
  }

  const teamSalary = activeSalaries + capHolds + deadMoney + incompleteCharge;
  const capSpace = T.cap - teamSalary;
  const taxRoom = T.tax - teamSalary;
  const apron1Room = T.apron1 - teamSalary;
  const apron2Room = T.apron2 - teamSalary;

  // Available exceptions
  const hasCapSpace = capSpace > 0;
  const belowTax = taxRoom > 0;
  const belowApron1 = apron1Room > 0;
  const belowApron2 = apron2Room > 0;

  const exceptions = [];
  if (hasCapSpace) {
    exceptions.push({ name: 'Cap Space', amount: capSpace, available: true });
    exceptions.push({ name: 'Room MLE', amount: T.rmle, available: true });
  } else {
    exceptions.push({ name: 'Cap Space', amount: 0, available: false });
  }
  if (!hasCapSpace && belowApron1) {
    exceptions.push({ name: 'Non-Tax MLE', amount: T.ntmle, available: true });
    exceptions.push({ name: 'BAE', amount: T.bae, available: true });
  } else if (!hasCapSpace && !belowApron1 && belowApron2) {
    exceptions.push({ name: 'Tax MLE', amount: T.tmle, available: true });
  } else if (!hasCapSpace) {
    exceptions.push({ name: 'Non-Tax MLE', amount: T.ntmle, available: false });
    exceptions.push({ name: 'Tax MLE', amount: T.tmle, available: !hasCapSpace && !belowApron1 ? false : true });
    exceptions.push({ name: 'BAE', amount: T.bae, available: false });
  }
  exceptions.push({ name: 'Minimum', amount: MIN_SALARY_0YOS, available: true });

  // Track exception usage from signings
  const excUsage = {};
  for (const sig of (STATE.signings || [])) {
    const exc = sig.exception || 'Unknown';
    excUsage[exc] = (excUsage[exc] || 0) + sig.salary;
  }
  for (const exc of exceptions) {
    const used = excUsage[exc.name] || 0;
    if (used > 0) {
      exc.used = used;
      exc.remaining = Math.max(0, exc.amount - used);
    }
  }

  return {
    roster, activeSalaries, capHolds, deadMoney, incompleteCharge, draftCapHolds,
    teamSalary, capSpace, taxRoom, apron1Room, apron2Room,
    rosterCount, twowayCount, exceptions, hasCapSpace, belowTax, belowApron1, belowApron2
  };
}

// ======================== RENDERING ========================
function renderTeamDropdown() {
  const sel = document.getElementById('teamSelect');
  const sorted = Object.entries(TEAMS).sort((a,b) => a[0].localeCompare(b[0]));
  sel.innerHTML = '<option value="">Select team...</option>';
  for (const [full, abbr] of sorted) {
    const opt = document.createElement('option');
    opt.value = full;
    opt.textContent = `${abbr} ‚Äî ${full}`;
    if (STATE && STATE.team === full) opt.selected = true;
    sel.appendChild(opt);
  }
}

function selectTeam(team) {
  if (_draftAnimTimer) { clearInterval(_draftAnimTimer); _draftAnimTimer = null; }
  STATE = loadState(team);
  document.getElementById('teamSelect').value = team;
  document.getElementById('appContent').style.display = 'block';
  // Re-apply lottery results if they exist
  if (STATE.lotteryResults) applyLotteryResults(STATE.lotteryResults);
  // Team banner
  const abbr = TEAMS[team] || '';
  const logo = teamLogos[team] || '';
  const banner = document.getElementById('teamBanner');
  banner.innerHTML = `${logo ? `<img src="${logo}" alt="${abbr}">` : ''}<div><div class="tb-name">${team}</div><div class="tb-sub">${abbr} ¬∑ 2026-27 Offseason</div></div>`;
  render();
}

function render() {
  if (!STATE) return;
  renderPhaseBar();
  if (STATE.phase === 'lottery') {
    renderLottery();
    renderCapPanel(calcCapSheet(STATE.team));
  } else if (STATE.phase === 'draft') {
    renderDraftBoard();
    renderCapPanel(calcCapSheet(STATE.team));
  } else {
    const cap = calcCapSheet(STATE.team);
    renderRoster(cap);
    renderCapPanel(cap);
  }
}

function renderPhaseBar() {
  const bar = document.getElementById('phaseBar');
  const currentIdx = PHASES.findIndex(p => p.id === STATE.phase);
  let h = '';
  PHASES.forEach((phase, i) => {
    if (i > 0) h += `<span class="phase-arrow">‚ñ∂</span>`;
    const cls = i === currentIdx ? 'active' : i < currentIdx ? 'completed' : 'locked';
    h += `<div class="phase-step ${cls}" onclick="${i <= currentIdx ? `setPhase('${phase.id}')` : ''}">${phase.icon} ${phase.label}</div>`;
  });
  if (currentIdx < PHASES.length - 1) {
    const next = PHASES[currentIdx + 1];
    h += `<button class="phase-advance" onclick="advancePhase()">Proceed to ${next.label} ‚Üí</button>`;
  }
  bar.innerHTML = h;
}

// =============== DEPTH CHART HELPERS ===============
function getDepthPlayers(cap) {
  const players = [];
  for (const p of cap.roster.under_contract) players.push(p);
  for (const p of cap.roster.non_guaranteed) players.push(p);
  for (const p of cap.roster.partial_guaranteed) players.push(p);
  for (const p of cap.roster.signed) players.push({...p, _signed: true});
  for (const p of cap.roster.twoway) players.push({...p, _twoWay: true});
  return players;
}

function posOf(p) {
  const raw = (p.pos || 'SF').split('-')[0].split('/')[0].trim().toUpperCase();
  return ['PG','SG','SF','PF','C'].includes(raw) ? raw : 'SF';
}

function buildDepthPositions(players) {
  const POS = ['PG','SG','SF','PF','C'];
  const ALGO_VERSION = 3; // bump this to invalidate saved orders
  const saved = STATE.depthOrder || {};

  // Only use saved order if it was made with current algorithm
  if (saved._v === ALGO_VERSION && Object.keys(saved).length > 1) {
    const byPos = {}; POS.forEach(p => byPos[p] = []);
    const pm = {}; players.forEach(p => pm[p.name] = p);
    const placed = new Set();
    POS.forEach(pos => {
      if (saved[pos]) saved[pos].forEach(n => {
        if (pm[n] && !placed.has(n)) { byPos[pos].push(pm[n]); placed.add(n); }
      });
    });
    players.forEach(p => { if (!placed.has(p.name)) byPos[posOf(p)].push(p); });
    return byPos;
  }

  // === ROW-BY-ROW PLACEMENT ===
  // Fill starters (row 1) across all 5 positions first, then 2nd unit, then 3rd.
  // For each open slot, pick the highest-TV remaining player who can play that position.
  // This guarantees higher-TV players always land in higher rows.
  const ADJ = { PG:['SG'], SG:['PG','SF'], SF:['SG','PF'], PF:['SF','C'], C:['PF'] };
  const remaining = [...players].sort((a,b) => (b.tv||0) - (a.tv||0));
  const byPos = {}; POS.forEach(p => byPos[p] = []);
  const maxRows = Math.ceil(players.length / 5);

  for (let row = 0; row < maxRows; row++) {
    // For each position in this row, find best available player
    const rowPicks = [];
    for (const pos of POS) {
      // Find highest-TV remaining player whose natural or adjacent includes this position
      let bestIdx = -1, bestTV = -1;
      for (let i = 0; i < remaining.length; i++) {
        const p = remaining[i];
        const nat = posOf(p);
        const valid = [nat, ...ADJ[nat]];
        if (valid.includes(pos) && (p.tv||0) > bestTV) {
          bestTV = p.tv||0;
          bestIdx = i;
        }
      }
      if (bestIdx >= 0) {
        rowPicks.push({ pos, idx: bestIdx, tv: bestTV });
      }
    }
    // Assign picks ‚Äî but each player can only go to one position.
    // Sort picks by TV ascending so we process lowest first;
    // if a player is best for multiple positions, they go to the one
    // where they're most needed (handled by processing order).
    // Actually: process positions that have fewer candidates first to avoid conflicts.
    const used = new Set();
    // Sort: positions with fewer valid remaining candidates first (most constrained)
    rowPicks.sort((a,b) => {
      const countA = remaining.filter(p => !used.has(p) && [posOf(p), ...ADJ[posOf(p)]].includes(a.pos)).length;
      const countB = remaining.filter(p => !used.has(p) && [posOf(p), ...ADJ[posOf(p)]].includes(b.pos)).length;
      return countA - countB;
    });
    for (const pick of rowPicks) {
      // Re-find best for this position among unused
      let bestP = null, bestTV = -1, bestRI = -1;
      for (let i = 0; i < remaining.length; i++) {
        const p = remaining[i];
        if (used.has(p)) continue;
        const nat = posOf(p);
        const valid = [nat, ...ADJ[nat]];
        if (valid.includes(pick.pos) && (p.tv||0) > bestTV) {
          bestTV = p.tv||0;
          bestP = p;
          bestRI = i;
        }
      }
      if (bestP) {
        byPos[pick.pos].push(bestP);
        used.add(bestP);
        remaining.splice(bestRI, 1);
      }
    }
  }
  // Any leftover (shouldn't happen but safety)
  for (const p of remaining) byPos[posOf(p)].push(p);

  // Clear stale order
  STATE.depthOrder = {};
  saveState();

  return byPos;
}

function saveDepthOrder() {
  const cols = document.querySelectorAll('.pos-col');
  const order = { _v: 3 };
  cols.forEach(col => {
    const pos = col.dataset.position;
    order[pos] = [];
    col.querySelectorAll('.dc-card').forEach(card => {
      order[pos].push(card.dataset.player);
    });
  });
  STATE.depthOrder = order;
  saveState();
}

function dcBadge(p) {
  if (p.status === 'pending_to') return '<span class="dc-opt-badge to">TO</span>';
  if (p.status === 'pending_po') return '<span class="dc-opt-badge po">PO</span>';
  if (p.status === 'picked_up') return '<span class="dc-opt-badge" style="background:rgba(76,175,80,.15);color:var(--green)">‚úìTO</span>';
  if (p.status === 'exercised') return '<span class="dc-opt-badge" style="background:rgba(76,175,80,.15);color:var(--green)">‚úìPO</span>';
  if (p._signed) return '<span class="dc-opt-badge signed">FA</span>';
  if (p.status === 'traded_in') return '<span class="dc-opt-badge traded">TRD</span>';
  if (p._twoWay) return '<span class="dc-opt-badge" style="background:rgba(100,116,139,.15);color:#94a3b8">2W</span>';
  if (p.category === 'non_guaranteed') return '<span class="dc-opt-badge ng">NG</span>';
  if (p.category === 'partial_guaranteed') return '<span class="dc-opt-badge pg">PG</span>';
  return '';
}

function dcActions(p) {
  const phase = STATE.phase;
  let h = '';
  // Option decisions
  if (p.status === 'pending_to' && (phase === 'pre_lottery' || phase === 'pre_draft' || phase === 'pre_fa')) {
    h += `<button class="dc-btn opt" onclick="event.stopPropagation();doOption('${esc(p.name)}','pickup')">Pick Up</button>`;
    h += `<button class="dc-btn waive" onclick="event.stopPropagation();doOption('${esc(p.name)}','decline')">Decline</button>`;
    return h;
  }
  if (p.status === 'pending_po' && (phase === 'pre_lottery' || phase === 'pre_draft' || phase === 'pre_fa')) {
    h += `<button class="dc-btn opt" onclick="event.stopPropagation();doOption('${esc(p.name)}','exercise')">Exercise</button>`;
    h += `<button class="dc-btn waive" onclick="event.stopPropagation();doOption('${esc(p.name)}','decline')">Decline</button>`;
    return h;
  }
  // Waive (not for two-way, not during draft)
  if (!p._twoWay && phase !== 'draft' && (p.status === 'active' || p.status === 'picked_up' || p.status === 'exercised' || p.status === 'traded_in' || p.status === 'signed')) {
    h += `<button class="dc-btn waive" onclick="event.stopPropagation();openWaiveModal('${esc(p.name)}')">Waive</button>`;
  }
  // Trade
  if (!p._twoWay && phase !== 'training_camp' && (p.status === 'active' || p.status === 'picked_up' || p.status === 'exercised' || p.status === 'traded_in')) {
    h += `<button class="dc-btn trade" onclick="event.stopPropagation();openTradeModal('${esc(p.name)}')">Trade</button>`;
  }
  // Extend
  if ((phase === 'pre_lottery' || phase === 'pre_draft' || phase === 'pre_fa') && (p.status === 'active' || p.status === 'picked_up' || p.status === 'exercised') && p.extEligible) {
    if (!(STATE.extensions || []).some(e => e.name === p.name)) {
      h += `<button class="dc-btn opt" onclick="event.stopPropagation();openExtModal('${esc(p.name)}')">Ext</button>`;
    }
  }
  // Extension badge
  const ext = (STATE.extensions || []).find(e => e.name === p.name);
  if (ext) h += `<span style="font-size:.45rem;color:var(--accent);font-weight:700">EXT thru ${ext.endYear}</span>`;
  return h;
}

function dcCard(p) {
  const ini = p.name.split(' ').map(w => w[0]).join('');
  const hs = p.headshot
    ? `<img class="dc-hs" src="${p.headshot}" onerror="this.outerHTML='<div class=dc-ini>${ini}</div>'">`
    : `<div class="dc-ini">${ini}</div>`;
  return `<div class="dc-card" draggable="true" data-player="${p.name}">
    ${dcBadge(p)}
    <div class="dc-top">${hs}<div class="dc-name">${p.name}</div><div class="dc-sal">${fmtMoney(p.sal27 || 0)}</div></div>
    <div class="dc-actions">${dcActions(p)}</div></div>`;
}

// =============== CONTRACT TABLE ===============
function contractSalCell(yr) {
  if (!yr || (!yr.sal && !yr.st)) return '<td><span style="color:var(--muted)">‚Äî</span></td>';
  const cls = {'GUARANTEED':'sal-g','PARTIAL G':'sal-pg','NOT G':'sal-ng','TEAM OPT':'sal-to','PLAYER OPT':'sal-po','TWO-WAY':'sal-g'}[yr.st] || 'sal-g';
  let inner = `<span class="${cls}">${fmtMoney(yr.sal)}</span>`;
  if (yr.st === 'PARTIAL G' && yr.ch && yr.ch !== yr.sal) inner += `<div style="font-size:.55rem;color:var(--yellow)">G: ${fmtMoney(yr.ch)}</div>`;
  else if (yr.st === 'NOT G') inner += `<div style="font-size:.55rem;color:var(--red)">G: ${yr.ch ? fmtMoney(yr.ch) : '$0'}</div>`;
  else if (yr.st === 'PLAYER OPT') inner += `<div style="font-size:.55rem;color:var(--cyan)">PO</div>`;
  else if (yr.st === 'TEAM OPT') inner += `<div style="font-size:.55rem;color:var(--orange)">TO</div>`;
  return `<td>${inner}</td>`;
}

// =============== LOTTERY ===============
const LOTTERY_ODDS = [140, 140, 140, 125, 105, 90, 75, 60, 45, 30, 20, 15, 10, 5]; // per 1000

function getLotteryTeams() {
  // Use pre-lottery standings order if available (worst record = index 0)
  if (preLotteryOrder.length >= 14) {
    return preLotteryOrder.slice(0, 14).map((team, i) => ({ team, originalSlot: i + 1 }));
  }
  // Fallback: picks 1-14 from allPickSlots
  const teams = [];
  for (let i = 1; i <= 14; i++) {
    const slot = allPickSlots[i];
    if (slot) teams.push({ team: slot.team, originalSlot: i });
  }
  return teams;
}

function runLotterySimulation() {
  const lotteryTeams = getLotteryTeams();
  if (lotteryTeams.length < 14) return null;

  const remaining = lotteryTeams.map((t, i) => ({ ...t, weight: LOTTERY_ODDS[i] }));
  const results = [];

  // Draw top 4 picks by weighted random
  for (let pick = 1; pick <= 4; pick++) {
    const totalW = remaining.reduce((s, t) => s + t.weight, 0);
    let rand = Math.random() * totalW;
    let winner;
    for (const t of remaining) {
      rand -= t.weight;
      if (rand <= 0) { winner = t; break; }
    }
    if (!winner) winner = remaining[remaining.length - 1];
    results.push({ pick, team: winner.team, originalSlot: winner.originalSlot });
    remaining.splice(remaining.indexOf(winner), 1);
  }

  // Remaining 10 fill in original standings order (worst to best)
  remaining.sort((a, b) => a.originalSlot - b.originalSlot);
  for (let i = 0; i < remaining.length; i++) {
    results.push({ pick: 5 + i, team: remaining[i].team, originalSlot: remaining[i].originalSlot });
  }

  return results;
}

function applyLotteryResults(results) {
  if (!results) return;
  // Remap allPickSlots for picks 1-14: team changes, prospect stays with pick number
  for (const r of results) {
    if (allPickSlots[r.pick]) {
      allPickSlots[r.pick] = { ...allPickSlots[r.pick], team: r.team };
    }
  }
  // Rebuild teamDraftPicks from updated allPickSlots
  const picks = {};
  for (const [slot, info] of Object.entries(allPickSlots)) {
    const s = parseInt(slot);
    if (s < 1 || s > 60) continue;
    if (!picks[info.team]) picks[info.team] = [];
    const capHold = s <= 30 ? (ROOKIE_SCALE[s - 1] || 0) : MIN_SALARY_2ND_RD;
    picks[info.team].push({ prospect: info.defaultProspect, draftRnk: s, capHold });
  }
  for (const t of Object.keys(picks)) picks[t].sort((a, b) => a.draftRnk - b.draftRnk);
  teamDraftPicks = picks;
}

function doRunLottery() {
  const results = runLotterySimulation();
  STATE.lotteryResults = results;
  applyLotteryResults(results);
  saveState();
  render();
}

function renderLottery() {
  const panel = document.getElementById('rosterPanel');
  const teamAbbrev = TEAMS[STATE.team];
  const results = STATE.lotteryResults;
  let h = '';

  h += `<div class="dc-section-label">üé± 2026 NBA Draft Lottery</div>`;

  if (!results) {
    // Show odds table
    const lotteryTeams = getLotteryTeams();
    h += `<div style="font-size:.75rem;color:var(--muted);margin-bottom:1rem">14 lottery teams compete for the top 4 picks. Remaining teams fill picks 5-14 in original order.</div>`;
    h += `<div style="text-align:center;margin-bottom:1.25rem">`;
    h += `<button class="phase-advance" onclick="doRunLottery()" style="font-size:1rem;padding:.75rem 2rem">üé± Run Draft Lottery</button>`;
    h += `</div>`;
    h += `<div class="contract-wrap"><table class="contract-table"><thead><tr>`;
    h += `<th>Slot</th><th>Team</th><th>Odds (#1)</th><th>Top 4</th>`;
    h += `</tr></thead><tbody>`;
    const top4Odds = [
      [140,0,0,0],[140,0,0,0],[140,0,0,0],[125,0,0,0],[105,0,0,0],[90,0,0,0],[75,0,0,0],[60,0,0,0],[45,0,0,0],[30,0,0,0],[20,0,0,0],[15,0,0,0],[10,0,0,0],[5,0,0,0]
    ];
    // Approximate top-4 odds (simplified)
    const top4Approx = [52.1,52.1,52.1,48.1,42.1,37.2,31.9,26.3,20.8,14.5,10.1,7.6,5.2,2.4];
    for (let i = 0; i < lotteryTeams.length; i++) {
      const lt = lotteryTeams[i];
      const logo = teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === lt.team)] || '';
      const isUser = lt.team === teamAbbrev;
      const rowStyle = isUser ? ' style="background:rgba(102,126,234,.1)"' : '';
      h += `<tr${rowStyle}><td style="font-weight:700;color:var(--orange)">#${i+1}</td>`;
      h += `<td><div style="display:flex;align-items:center;gap:.4rem">${logo ? `<img src="${logo}" style="width:20px;height:20px">` : ''}`;
      h += `<span style="font-weight:${isUser?'700':'400'};color:${isUser?'var(--accent)':'var(--text)'}">${lt.team}</span></div></td>`;
      h += `<td style="font-weight:600">${(LOTTERY_ODDS[i]/10).toFixed(1)}%</td>`;
      h += `<td>${top4Approx[i].toFixed(1)}%</td>`;
      h += `</tr>`;
    }
    h += `</tbody></table></div>`;
  } else {
    // Show results
    if (STATE.lotteryResults) applyLotteryResults(STATE.lotteryResults);
    h += `<div style="font-size:.75rem;color:var(--muted);margin-bottom:1rem">Lottery complete! Top 4 picks have been drawn.</div>`;
    h += `<div class="contract-wrap"><table class="contract-table"><thead><tr>`;
    h += `<th>Pick</th><th>Team</th><th>Original</th><th>Movement</th>`;
    h += `</tr></thead><tbody>`;
    for (const r of results) {
      const logo = teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === r.team)] || '';
      const isUser = r.team === teamAbbrev;
      const diff = r.originalSlot - r.pick;
      const move = diff > 0 ? `<span style="color:var(--green);font-weight:700">‚ñ≤ ${diff}</span>` : diff < 0 ? `<span style="color:var(--red);font-weight:700">‚ñº ${Math.abs(diff)}</span>` : `<span style="color:var(--muted)">‚Äî</span>`;
      const rowStyle = isUser ? ' style="background:rgba(102,126,234,.1)"' : '';
      const isTop4 = r.pick <= 4;
      h += `<tr${rowStyle}><td style="font-weight:700;color:${isTop4?'var(--orange)':'var(--text)'}">`;
      h += `${isTop4?'üèÜ ':''}#${r.pick}</td>`;
      h += `<td><div style="display:flex;align-items:center;gap:.4rem">${logo ? `<img src="${logo}" style="width:20px;height:20px">` : ''}`;
      h += `<span style="font-weight:${isUser?'700':'400'};color:${isUser?'var(--accent)':'var(--text)'}">${r.team}</span></div></td>`;
      h += `<td style="color:var(--muted)">#${r.originalSlot}</td>`;
      h += `<td>${move}</td></tr>`;
    }
    h += `</tbody></table></div>`;
    h += `<div style="text-align:center;margin-top:1rem">`;
    h += `<button class="waive-cancel" onclick="doRunLottery()" style="font-size:.8rem;padding:.5rem 1.5rem;border:1px solid var(--orange);color:var(--orange)">üîÑ Reshuffle Lottery</button>`;
    h += `</div>`;
  }

  panel.innerHTML = h;
}

// =============== DRAFT SIMULATION ===============
function getDraftedProspects() {
  return new Set((STATE.draftResults || []).map(r => r.prospect));
}

function getPickTeam(pick) {
  // Use lottery results if available for picks 1-14
  if (STATE.lotteryResults && pick <= 14) {
    const lr = STATE.lotteryResults.find(r => r.pick === pick);
    if (lr) return lr.team;
  }
  const slot = allPickSlots[pick];
  return slot ? slot.team : null;
}

function autoDraftPick(pick) {
  const drafted = getDraftedProspects();
  // Pick highest-ranked remaining prospect (allProspects is consensus order)
  for (const name of allProspects) {
    if (!drafted.has(name)) return name;
  }
  return null;
}

let _draftAnimTimer = null;

function runDraftUntilUser() {
  // Animated: one pick per second, pauses at user's pick
  if (_draftAnimTimer) { clearInterval(_draftAnimTimer); _draftAnimTimer = null; }
  const teamAbbrev = TEAMS[STATE.team];

  function draftNextPick() {
    let current = STATE.draftCurrentPick || 1;
    if (current > 60) {
      clearInterval(_draftAnimTimer); _draftAnimTimer = null;
      saveState(); render();
      return;
    }
    const pickTeam = getPickTeam(current);
    if (!pickTeam) { STATE.draftCurrentPick = current + 1; render(); return; }

    if (pickTeam === teamAbbrev) {
      // User's turn ‚Äî pause animation
      clearInterval(_draftAnimTimer); _draftAnimTimer = null;
      saveState(); render();
      return;
    }

    // AI pick
    const prospect = autoDraftPick(current);
    if (prospect) {
      STATE.draftResults.push({ pick: current, team: pickTeam, prospect });
    }
    STATE.draftCurrentPick = current + 1;
    saveState();
    render();
  }

  _draftAnimTimer = setInterval(draftNextPick, 500);
}

function startDraft() {
  STATE.draftCurrentPick = 1;
  saveState();
  render();
  runDraftUntilUser();
}

function userDraftPick(prospect) {
  const pick = STATE.draftCurrentPick;
  const teamAbbrev = TEAMS[STATE.team];
  STATE.draftResults.push({ pick, team: teamAbbrev, prospect });
  STATE.draftSelections[pick] = prospect;
  STATE.moves.push({
    action: 'Draft',
    detail: `Pick #${pick}: ${prospect}`,
    undo: { type: 'draft_sim', pick }
  });
  STATE.draftCurrentPick = pick + 1;
  saveState();

  // Continue animated drafting
  render();
  runDraftUntilUser();
}

function renderDraftBoard() {
  const panel = document.getElementById('rosterPanel');
  const teamAbbrev = TEAMS[STATE.team];
  let h = '';

  const current = STATE.draftCurrentPick || 0;
  const draftNotStarted = current < 1;
  const isDraftComplete = current > 60;
  const drafted = getDraftedProspects();

  if (draftNotStarted) {
    h += `<div class="dc-section-label">üéØ 2026 NBA Draft</div>`;
    h += `<div style="font-size:.75rem;color:var(--muted);margin-bottom:1rem">60 picks across 2 rounds. The draft will simulate automatically, pausing when it's your turn to pick.</div>`;

    // Show user's picks
    const userPicks = (teamDraftPicks[teamAbbrev] || []).slice().sort((a,b) => a.draftRnk - b.draftRnk);
    if (userPicks.length) {
      h += `<div style="margin-bottom:1.25rem">`;
      h += `<div style="font-size:.7rem;font-weight:700;color:var(--accent);margin-bottom:.5rem">YOUR PICKS</div>`;
      for (const p of userPicks) {
        const rd = p.draftRnk <= 30 ? '1st' : '2nd';
        h += `<div style="display:flex;align-items:center;gap:.5rem;padding:.3rem .5rem;background:rgba(102,126,234,.06);border-radius:4px;margin-bottom:.2rem;font-size:.75rem">`;
        h += `<span style="font-weight:700;color:var(--orange)">#${p.draftRnk}</span>`;
        h += `<span>${rd} Round</span>`;
        h += `<span style="color:var(--muted)">¬∑ proj. ${p.prospect}</span>`;
        h += `</div>`;
      }
      h += `</div>`;
    }

    h += `<div style="text-align:center;margin-top:1rem">`;
    h += `<button class="phase-advance" onclick="startDraft()" style="font-size:1rem;padding:.75rem 2rem">üèÄ Start Draft</button>`;
    h += `</div>`;

    // Show full draft board preview (empty)
    h += `<div class="contract-wrap" style="margin-top:1.5rem"><table class="contract-table"><thead><tr>`;
    h += `<th>Pick</th><th>Team</th><th>Prospect</th>`;
    h += `</tr></thead><tbody>`;
    for (let pick = 1; pick <= 60; pick++) {
      if (pick === 1) h += `<tr><td colspan="3" style="font-weight:700;font-size:.7rem;color:var(--orange);padding:.6rem .5rem;background:rgba(255,152,0,.06);border-bottom:2px solid var(--orange)">ROUND 1</td></tr>`;
      if (pick === 31) h += `<tr><td colspan="3" style="font-weight:700;font-size:.7rem;color:var(--accent);padding:.6rem .5rem;background:rgba(102,126,234,.06);border-bottom:2px solid var(--accent)">ROUND 2</td></tr>`;
      const pickTeam = getPickTeam(pick);
      if (!pickTeam) continue;
      const isUser = pickTeam === teamAbbrev;
      const logo = teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === pickTeam)] || '';
      const rowStyle = isUser ? ' style="background:rgba(102,126,234,.1)"' : '';
      h += `<tr${rowStyle}>`;
      h += `<td style="font-weight:700;color:var(--muted)">#${pick}</td>`;
      h += `<td><div style="display:flex;align-items:center;gap:.3rem">${logo?`<img src="${logo}" style="width:18px;height:18px">`:''}<span style="font-weight:${isUser?'700':'400'};color:${isUser?'var(--accent)':'var(--text)'}">${pickTeam}</span></div></td>`;
      h += `<td style="color:var(--muted)">‚Äî</td>`;
      h += `</tr>`;
    }
    h += `</tbody></table></div>`;
    panel.innerHTML = h;
    return;
  }

  h += `<div class="dc-section-label">üèÄ 2026 NBA Draft ${isDraftComplete ? '‚Äî Complete' : `‚Äî ${current <= 30 ? 'Round 1' : 'Round 2'}, Pick #${current}`}</div>`;

  // User's pick selection (if it's their turn)
  if (!isDraftComplete && getPickTeam(current) === teamAbbrev) {
    h += `<div id="yourPickBox" class="your-pick-box" style="background:rgba(102,126,234,.1);border:2px solid var(--accent);border-radius:10px;padding:1rem;margin-bottom:1rem">`;
    h += `<h3 style="color:var(--accent);margin-bottom:.5rem;font-size:.9rem">üéØ Your Pick ‚Äî #${current}</h3>`;
    h += `<input id="draftSearchInput" class="trade-input" style="width:100%;margin-bottom:.5rem" placeholder="Filter prospects..." oninput="filterDraftProspects(this.value)">`;
    h += `<div id="draftProspectList" style="max-height:250px;overflow-y:auto">`;
    h += buildDraftProspectList('');
    h += `</div></div>`;
  }

  // Draft board
  h += `<div class="contract-wrap"><table class="contract-table"><thead><tr>`;
  h += `<th>Pick</th><th>Team</th><th>Prospect</th>`;
  h += `</tr></thead><tbody>`;

  for (let pick = 1; pick <= 60; pick++) {
    // Round dividers
    if (pick === 1) h += `<tr><td colspan="3" style="font-weight:700;font-size:.7rem;color:var(--orange);padding:.6rem .5rem;background:rgba(255,152,0,.06);border-bottom:2px solid var(--orange)">ROUND 1</td></tr>`;
    if (pick === 31) h += `<tr><td colspan="3" style="font-weight:700;font-size:.7rem;color:var(--accent);padding:.6rem .5rem;background:rgba(102,126,234,.06);border-bottom:2px solid var(--accent)">ROUND 2</td></tr>`;
    const pickTeam = getPickTeam(pick);
    if (!pickTeam) continue;
    const result = STATE.draftResults.find(r => r.pick === pick);
    const isUser = pickTeam === teamAbbrev;
    const isCurrent = pick === current && !isDraftComplete;
    const isPicked = !!result;

    let rowStyle = '';
    if (isUser) rowStyle = ' style="background:rgba(102,126,234,.1)"';
    else if (isCurrent) rowStyle = ' style="background:rgba(255,152,0,.08)"';

    const logo = teamLogos[Object.keys(TEAMS).find(k => TEAMS[k] === pickTeam)] || '';

    h += `<tr${rowStyle}${isCurrent?' data-current="1"':''}>`;
    h += `<td style="font-weight:700;color:${isCurrent?'var(--orange)':isPicked?'var(--green)':'var(--muted)'}">${isCurrent?'‚û°Ô∏è ':''}#${pick}</td>`;
    h += `<td><div style="display:flex;align-items:center;gap:.3rem">${logo?`<img src="${logo}" style="width:18px;height:18px">`:''}<span style="font-weight:${isUser?'700':'400'};color:${isUser?'var(--accent)':'var(--text)'}">${pickTeam}</span></div></td>`;
    if (isPicked) {
      h += `<td style="font-weight:600">${result.prospect}</td>`;
    } else if (isCurrent) {
      h += `<td style="color:var(--orange);font-style:italic">On the clock...</td>`;
    } else {
      h += `<td style="color:var(--muted)">‚Äî</td>`;
    }
    h += `</tr>`;
  }
  h += `</tbody></table></div>`;

  // Undrafted prospects (after draft complete)
  if (isDraftComplete) {
    const undrafted = allProspects.filter(n => !drafted.has(n));
    if (undrafted.length) {
      h += `<div class="dc-section-label" style="margin-top:1rem">üìã Undrafted Prospects <span class="dc-badge" style="background:rgba(100,116,139,.12);color:#94a3b8">${undrafted.length}</span></div>`;
      h += `<div style="font-size:.7rem;color:var(--muted);margin-bottom:.5rem">These players will be available as undrafted free agents.</div>`;
      h += `<div style="display:flex;flex-wrap:wrap;gap:.3rem">`;
      for (const n of undrafted.slice(0, 30)) {
        h += `<span style="font-size:.65rem;padding:.2rem .5rem;background:var(--surface);border-radius:4px;border:1px solid var(--border)">${n}</span>`;
      }
      if (undrafted.length > 30) h += `<span style="font-size:.65rem;padding:.2rem .5rem;color:var(--muted)">+${undrafted.length-30} more</span>`;
      h += `</div>`;
    }
  }

  panel.innerHTML = h;

  // Auto-scroll: prioritize Your Pick box when it's user's turn
  if (!isDraftComplete) {
    const yourBox = panel.querySelector('#yourPickBox');
    if (yourBox) {
      setTimeout(() => yourBox.scrollIntoView({ behavior: 'smooth', block: 'start' }), 80);
      // Focus the search input for immediate typing
      setTimeout(() => { const inp = panel.querySelector('#draftSearchInput'); if (inp) inp.focus(); }, 150);
    } else {
      const row = panel.querySelector('tr[data-current]');
      if (row) setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 50);
    }
  }
}

function buildDraftProspectList(filter) {
  const drafted = getDraftedProspects();
  const q = filter.toLowerCase();
  let h = '';
  let rank = 0;
  for (const name of allProspects) {
    rank++;
    if (drafted.has(name)) continue;
    if (q && !name.toLowerCase().includes(q)) continue;
    // Show projected pick info
    let proj = '';
    for (const [s, info] of Object.entries(allPickSlots)) {
      if (info.defaultProspect === name) { proj = `proj #${s}`; break; }
    }
    h += `<div class="draft-pick-option" onclick="userDraftPick('${esc(name)}')">`;
    h += `<span class="rank">${rank}</span>`;
    h += `<span class="name">${name}</span>`;
    if (proj) h += `<span class="assigned">${proj}</span>`;
    h += `</div>`;
  }
  if (!h) h = '<div style="padding:.5rem;text-align:center;color:var(--muted);font-size:.7rem">No prospects available</div>';
  return h;
}

function filterDraftProspects(query) {
  const list = document.getElementById('draftProspectList');
  if (list) list.innerHTML = buildDraftProspectList(query);
}

// =============== MAIN RENDER ===============
function renderRoster(cap) {
  const panel = document.getElementById('rosterPanel');
  const phase = STATE.phase;
  let h = '';

  // Action bar
  h += `<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.75rem">`;
  if (phase !== 'training_camp') {
    h += `<button class="action-btn trade" style="font-size:.7rem;padding:.35rem .75rem" onclick="openTradeModal()">üîÑ Trade Machine</button>`;
  }
  if (phase === 'free_agency') {
    h += `<button class="action-btn pickup" style="font-size:.7rem;padding:.35rem .75rem" onclick="openSignModal()">‚úçÔ∏è Sign Free Agent</button>`;
  }
  h += `</div>`;

  // Training camp compliance
  if (phase === 'training_camp') {
    const total = cap.rosterCount, twoWay = cap.twowayCount;
    if (total > 15) h += `<div class="camp-warning"><h4>‚ö†Ô∏è Roster Over Limit</h4><p>You have ${total} standard contracts ‚Äî must cut ${total - 15} player(s) to reach the 15-player limit.</p></div>`;
    else if (total < 14) h += `<div class="camp-warning"><h4>‚ö†Ô∏è Roster Under Minimum</h4><p>You have ${total} standard contracts ‚Äî need at least 14 for opening night.</p></div>`;
    else h += `<div class="camp-ok"><h4>‚úÖ Roster Compliant</h4><p>${total} standard contracts (limit: 15) ¬∑ ${twoWay} two-way (limit: 3)</p></div>`;
    if (twoWay > 3) h += `<div class="camp-warning"><h4>‚ö†Ô∏è Too Many Two-Way</h4><p>You have ${twoWay} two-way contracts ‚Äî must cut ${twoWay - 3} to reach the 3-player limit.</p></div>`;
  }

  // ======== DEPTH CHART ========
  const depthPlayers = getDepthPlayers(cap);
  const byPos = buildDepthPositions(depthPlayers);
  const POS = ['PG','SG','SF','PF','C'];
  const rosterTotal = depthPlayers.reduce((s,p) => s + (p.sal27||0), 0);
  h += `<div class="dc-section-label">üèÄ Depth Chart <span class="dc-badge" style="background:rgba(102,126,234,.15);color:var(--accent)">${depthPlayers.length} players</span><span class="dc-badge" style="background:rgba(76,175,80,.12);color:var(--green)">${fmtMoney(rosterTotal)}</span></div>`;
  h += `<div style="font-size:.6rem;color:var(--muted);margin-bottom:.5rem">üí° Drag players to rearrange positions</div>`;
  h += `<div class="depth-chart" id="depthChartGrid">`;
  POS.forEach(pos => {
    h += `<div class="pos-col" data-position="${pos}"><div class="pos-hdr">${pos}</div>`;
    byPos[pos].forEach(p => { h += dcCard(p); });
    h += `</div>`;
  });
  h += `</div>`;

  // ======== CONTRACT TABLE ========
  const contractPlayers = [...cap.roster.under_contract, ...cap.roster.non_guaranteed, ...cap.roster.partial_guaranteed, ...cap.roster.signed].sort((a,b) => (b.sal27||0) - (a.sal27||0));
  const showPreFa = phase === 'pre_lottery' || phase === 'pre_draft' || phase === 'lottery' || phase === 'draft' || phase === 'pre_fa';
  const visibleYears = CONTRACT_YEARS.filter(yr => !yr.preFaOnly || showPreFa);
  if (contractPlayers.length) {
    h += `<div class="dc-section-label">üìã Contracts <span class="dc-badge" style="background:rgba(76,175,80,.12);color:var(--green)">${contractPlayers.length} players</span></div>`;
    h += `<div class="contract-wrap"><table class="contract-table"><thead><tr>`;
    h += `<th style="min-width:150px">Player</th>`;
    visibleYears.forEach(yr => { h += `<th>${yr.label}</th>`; });
    h += `<th>Tot Guar</th></tr></thead><tbody>`;
    for (const p of contractPlayers) {
      const ini = p.name.split(' ').map(w => w[0]).join('');
      const hs = p.headshot
        ? `<img class="ct-hs" src="${p.headshot}" onerror="this.outerHTML='<div class=ct-ini>${ini}</div>'">`
        : `<div class="ct-ini">${ini}</div>`;
      h += `<tr><td><div class="player-cell">${hs}<div><div style="font-weight:600;font-size:.7rem">${p.name}</div><div style="font-size:.55rem;color:var(--muted)">${p.pos || ''} ${p.age ? '¬∑ ' + p.age : ''}</div></div></div></td>`;
      const cd = contractsMap[p.name];
      if (cd) {
        CONTRACT_YEARS.forEach((yr, i) => {
          if (yr.preFaOnly && !showPreFa) return;
          h += contractSalCell(cd.yrs[i]);
        });
        h += `<td style="font-weight:600;font-size:.65rem">${cd.totG ? fmtMoney(cd.totG) : '‚Äî'}</td>`;
      } else {
        // Fallback: show from roster data
        if (showPreFa) {
          const st26 = p.st26 || 'GUARANTEED';
          h += contractSalCell({sal: p.sal26, ch: p.ch26, st: st26});
        }
        const st27 = p._signed ? 'GUARANTEED' : (p.st27 || 'GUARANTEED');
        h += contractSalCell({sal: p.sal27, ch: p.ch27, st: st27});
        const remaining = visibleYears.length - (showPreFa ? 2 : 1);
        for (let i = 0; i < remaining; i++) h += `<td><span style="color:var(--muted)">‚Äî</span></td>`;
        h += `<td style="font-weight:600;font-size:.65rem">${p.totalGuar ? fmtMoney(p.totalGuar) : '‚Äî'}</td>`;
      }
      h += `</tr>`;
    }
    h += `</tbody></table></div>`;
  }

  // ======== TWO-WAY (if any) ========
  if (cap.roster.twoway.length) {
    h += `<div class="dc-section-label">üîÑ Two-Way Contracts <span class="dc-badge" style="background:rgba(100,116,139,.12);color:#94a3b8">${cap.roster.twoway.length}</span></div>`;
    h += `<div class="section"><div class="section-body">`;
    for (const p of cap.roster.twoway) {
      h += `<div class="player-row">`;
      h += p.headshot ? `<img class="hs" src="${p.headshot}" onerror="this.outerHTML='<div class=hs-ini>${p.name.split(' ').map(w=>w[0]).join('')}</div>'">` : `<div class="hs-ini">${p.name.split(' ').map(w=>w[0]).join('')}</div>`;
      h += `<div class="info"><div class="pname">${p.name}</div><div class="pdet">${p.pos || ''} ¬∑ Two-Way</div></div>`;
      h += `<div class="sal" style="color:#94a3b8">${fmtMoney(p.sal27 || 0)}</div>`;
      h += `</div>`;
    }
    h += `</div></div>`;
  }

  // ======== FREE AGENTS ========
  const fas = cap.roster.free_agent;
  if (fas.length) {
    const activeFas = fas.filter(p => p.status !== 'renounced');
    const renouncedFas = fas.filter(p => p.status === 'renounced');
    const totalHolds = activeFas.reduce((s,p) => s + (p.capHold||0), 0);
    h += `<div class="dc-section-label">üîì Free Agents <span class="dc-badge" style="background:rgba(102,126,234,.12);color:var(--accent)">${activeFas.length} held</span><span class="dc-badge" style="background:rgba(102,126,234,.12);color:var(--accent)">${fmtMoney(totalHolds)} cap holds</span></div>`;
    h += `<div class="section"><div class="section-body">`;
    for (const p of [...activeFas, ...renouncedFas].sort((a,b) => {
      if (a.status === 'renounced' && b.status !== 'renounced') return 1;
      if (b.status === 'renounced' && a.status !== 'renounced') return -1;
      return (b.capHold||0) - (a.capHold||0);
    })) {
      const acted = p.status === 'renounced';
      h += `<div class="player-row${acted ? ' acted' : ''}">`;
      h += p.headshot ? `<img class="hs" src="${p.headshot}" onerror="this.outerHTML='<div class=hs-ini>${p.name.split(' ').map(w=>w[0]).join('')}</div>'">` : `<div class="hs-ini">${p.name.split(' ').map(w=>w[0]).join('')}</div>`;
      h += `<div class="info"><div class="pname">${p.name}${p.fromOption ? ` <span style="font-size:.55rem;color:var(--muted)">(${p.fromOption} declined)</span>` : ''}</div>`;
      h += `<div class="pdet">${p.exception ? shortExc(p.exception) : ''}</div></div>`;
      if (acted) {
        h += `<div><div class="sal" style="color:var(--muted);text-decoration:line-through">${fmtMoney(p.capHold)}</div><div class="ch">renounced</div></div>`;
      } else {
        h += `<div><div class="sal" style="color:var(--accent)">${fmtMoney(p.capHold)}</div><div class="ch">cap hold</div></div>`;
      }
      h += `<div style="display:flex;gap:.3rem">`;
      if (!acted) {
        h += `<button class="action-btn renounce" onclick="doRenounce('${esc(p.name)}')">Renounce</button>`;
        if (phase === 'free_agency') h += `<button class="action-btn pickup" onclick="openSignModal('${esc(p.name)}', true)">Re-sign</button>`;
      }
      h += `</div></div>`;
    }
    h += `</div></div>`;
  }

  // ======== DRAFT PICKS ========
  const picks = cap.roster.draft_picks;
  if (picks.length) {
    const draftTotal = picks.reduce((s,p) => s + (p.capHold||0), 0);
    h += `<div class="dc-section-label">üèÄ Draft Picks <span class="dc-badge" style="background:rgba(255,152,0,.12);color:var(--orange)">${picks.length} picks</span><span class="dc-badge" style="background:rgba(255,152,0,.12);color:var(--orange)">${fmtMoney(draftTotal)} cap holds</span></div>`;
    h += `<div class="section"><div class="section-body">`;
    for (const p of picks) {
      const isSwapped = p.selectedProspect !== p.prospect;
      h += `<div class="player-row">`;
      h += `<div class="hs-ini" style="background:var(--orange);color:#000;font-weight:700;font-size:.7rem">#${p.draftRnk}</div>`;
      h += `<div class="info"><div class="pname">${p.selectedProspect || 'TBD'}${isSwapped ? ` <span style="font-size:.55rem;color:var(--muted)">(was: ${p.prospect})</span>` : ''}</div>`;
      const rdLabel = p.draftRnk <= 30 ? `1st Rd Pick #${p.draftRnk} ¬∑ Rookie Scale` : `2nd Rd Pick #${p.draftRnk} ¬∑ Min Salary`;
      h += `<div class="pdet">${rdLabel}</div></div>`;
      h += `<div><div class="sal" style="color:var(--orange)">${fmtMoney(p.capHold)}</div><div class="ch">cap hold</div></div>`;
      h += `<div style="display:flex;gap:.3rem">`;
      if (phase === 'draft') {
        h += `<button class="action-btn draft-swap" onclick="openDraftPicker(${p.draftRnk})">üîÑ Swap</button>`;
        if (isSwapped) h += `<button class="action-btn decline" onclick="resetDraftPick(${p.draftRnk})">‚Ü©</button>`;
      } else if (phase === 'pre_lottery' || phase === 'pre_draft' || phase === 'lottery') {
        h += `<span style="font-size:.6rem;color:var(--muted)">available in Draft Night</span>`;
      }
      h += `</div></div>`;
    }
    h += `</div></div>`;
  }

  // ======== WAIVED ========
  if (cap.roster.waived.length) {
    const totalDead = cap.roster.waived.reduce((s,p) => s + (p.deadAmount||0), 0);
    h += `<div class="dc-section-label">üóëÔ∏è Waived <span class="dc-badge" style="background:rgba(239,83,80,.12);color:var(--red)">${cap.roster.waived.length}</span><span class="dc-badge" style="background:rgba(239,83,80,.12);color:var(--red)">${fmtMoney(totalDead)} dead</span></div>`;
    h += `<div class="section"><div class="section-body">`;
    for (const p of cap.roster.waived) {
      h += `<div class="player-row acted">`;
      h += p.headshot ? `<img class="hs" src="${p.headshot}" onerror="this.outerHTML='<div class=hs-ini>${p.name.split(' ').map(w=>w[0]).join('')}</div>'">` : `<div class="hs-ini">${p.name.split(' ').map(w=>w[0]).join('')}</div>`;
      h += `<div class="info"><div class="pname">${p.name}</div><div class="pdet">${fmtMoney(p.sal27||p.sal26)} salary</div></div>`;
      h += `<div><div class="sal" style="color:var(--muted);text-decoration:line-through">${fmtMoney(p.sal27||p.sal26)}</div>`;
      h += `<div class="ch">${p.deadAmount ? fmtMoney(p.deadAmount) + ' dead' + (p.isStretched ? ' (str)' : '') : 'no dead cap'}</div></div>`;
      h += `</div>`;
    }
    h += `</div></div>`;
  }

  panel.innerHTML = h;
  setupDragDrop();
}

// =============== DRAG & DROP ===============
let _draggedCard = null;

function setupDragDrop() {
  const grid = document.getElementById('depthChartGrid');
  if (!grid) return;

  grid.querySelectorAll('.dc-card').forEach(card => {
    card.addEventListener('dragstart', e => {
      _draggedCard = card;
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', card.dataset.player);
    });
    card.addEventListener('dragend', () => {
      card.classList.remove('dragging');
      _draggedCard = null;
      grid.querySelectorAll('.dc-drop-indicator').forEach(el => el.remove());
      grid.querySelectorAll('.pos-col.drag-over').forEach(el => el.classList.remove('drag-over'));
    });
  });

  grid.querySelectorAll('.pos-col').forEach(col => {
    col.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      col.classList.add('drag-over');
      // Remove existing indicators
      grid.querySelectorAll('.dc-drop-indicator').forEach(el => el.remove());
      // Find closest card
      const cards = [...col.querySelectorAll('.dc-card:not(.dragging)')];
      const afterCard = cards.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = e.clientY - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) return { offset, el: child };
        return closest;
      }, { offset: -Infinity, el: null }).el;

      const indicator = document.createElement('div');
      indicator.className = 'dc-drop-indicator';
      if (afterCard) col.insertBefore(indicator, afterCard);
      else col.appendChild(indicator);
    });

    col.addEventListener('dragleave', e => {
      if (!col.contains(e.relatedTarget)) {
        col.classList.remove('drag-over');
        col.querySelectorAll('.dc-drop-indicator').forEach(el => el.remove());
      }
    });

    col.addEventListener('drop', e => {
      e.preventDefault();
      col.classList.remove('drag-over');
      grid.querySelectorAll('.dc-drop-indicator').forEach(el => el.remove());
      if (!_draggedCard) return;

      // Find insertion point
      const cards = [...col.querySelectorAll('.dc-card:not(.dragging)')];
      const afterCard = cards.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = e.clientY - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) return { offset, el: child };
        return closest;
      }, { offset: -Infinity, el: null }).el;

      if (afterCard) col.insertBefore(_draggedCard, afterCard);
      else col.appendChild(_draggedCard);

      saveDepthOrder();
    });
  });
}

function renderCapPanel(cap) {
  const panel = document.getElementById('capPanel');
  let h = '';

  // Team Salary breakdown
  h += `<div class="cap-card">`;
  h += `<h3>üí∞ Team Salary</h3>`;
  h += capRow('Active Salaries', cap.activeSalaries);
  h += capRow('Cap Holds (FAs)', cap.capHolds - (cap.draftCapHolds || 0));
  if (cap.draftCapHolds) h += capRow('Cap Holds (Draft)', cap.draftCapHolds);
  h += capRow('Dead Money', cap.deadMoney);
  if (cap.incompleteCharge) h += capRow('Incomplete Roster', cap.incompleteCharge, 'neg');
  h += `<div class="cap-row" style="border-top:1px solid var(--border);margin-top:.3rem;padding-top:.5rem">`;
  h += `<span class="label" style="font-weight:700;color:var(--text)">TEAM SALARY</span>`;
  h += `<span class="value" style="font-size:.85rem">${fmtMoneyFull(cap.teamSalary)}</span>`;
  h += `</div></div>`;

  // Cap Space & Thresholds
  h += `<div class="cap-card">`;
  h += `<h3>üìä Cap Space & Thresholds</h3>`;
  h += capRow('Salary Cap', T.cap);
  h += capRowDelta('Cap Space', cap.capSpace);
  h += `<div class="cap-bar"><div class="cap-bar-fill" style="width:${Math.min(100, cap.teamSalary / T.apron2 * 100)}%;background:${cap.teamSalary > T.apron2 ? 'var(--red)' : cap.teamSalary > T.apron1 ? 'var(--orange)' : cap.teamSalary > T.tax ? 'var(--yellow)' : 'var(--green)'}"></div></div>`;
  h += capRow('Luxury Tax', T.tax);
  h += capRowDelta('Tax Room', cap.taxRoom);
  h += capRow('1st Apron', T.apron1);
  h += capRowDelta('1st Apron Room', cap.apron1Room);
  h += capRow('2nd Apron', T.apron2);
  h += capRowDelta('2nd Apron Room', cap.apron2Room);
  h += `</div>`;

  // Roster count
  h += `<div class="cap-card">`;
  h += `<h3>üë• Roster</h3>`;
  h += capRow('Standard Contracts', cap.rosterCount + '/15');
  h += capRow('Two-Way Slots', cap.twowayCount + '/3');
  if (cap.rosterCount < 14) {
    h += `<div style="font-size:.65rem;color:var(--red);margin-top:.3rem">‚ö†Ô∏è Need at least 14 standard contracts by opening night</div>`;
  }
  h += `</div>`;

  // Exceptions
  h += `<div class="cap-card">`;
  h += `<h3>üé´ Available Exceptions</h3>`;
  h += `<div class="exc-list">`;
  for (const exc of cap.exceptions) {
    const usedLabel = exc.used ? ` (used: ${fmtMoney(exc.used)})` : '';
    h += `<div class="exc-chip ${exc.available ? 'available' : 'unavailable'}">${exc.name}: ${fmtMoney(exc.remaining !== undefined ? exc.remaining : exc.amount)}${usedLabel}</div>`;
  }
  h += `</div></div>`;

  // Move log
  h += `<div class="cap-card">`;
  h += `<h3>üìù Move Log</h3>`;
  if (STATE.moves.length) {
    h += `<div class="move-log">`;
    for (const m of [...STATE.moves].reverse()) {
      h += `<div class="move-entry"><span class="action">${m.action}</span> ${m.detail}</div>`;
    }
    h += `</div>`;
  } else {
    h += `<div style="font-size:.7rem;color:var(--muted)">No moves yet. Use the roster panel to make decisions.</div>`;
  }
  h += `<div class="controls">`;
  h += `<button class="ctrl-btn" onclick="undoLast()">‚Ü© Undo</button>`;
  h += `<button class="ctrl-btn reset" onclick="resetTeam()">üóë Reset All</button>`;
  h += `</div></div>`;

  panel.innerHTML = h;
}

function capRow(label, value, cls) {
  const display = typeof value === 'number' ? fmtMoneyFull(value) : value;
  return `<div class="cap-row"><span class="label">${label}</span><span class="value ${cls || ''}">${display}</span></div>`;
}

function capRowDelta(label, value) {
  const cls = value >= 0 ? 'pos' : 'neg';
  return `<div class="cap-row"><span class="label">${label}</span><span class="value ${cls}">${fmtMoneyFull(value)}</span></div>`;
}

function shortExc(e) {
  return { 'Bird Exception': 'Bird', 'Early Bird Exception': 'Early Bird', 'Non-Bird Exception': 'Non-Bird',
    'Mid-Level Exception': 'MLE', 'Taxpayer Mid-Level Exception': 'Tax MLE', 'Room Mid-Level Exception': 'Room MLE',
    'Biannual Exception': 'BAE', 'Minimum Salary Exception': 'Min', 'Rookie Exception': 'Rookie',
    'Second Round Exception': '2nd Rnd' }[e] || e || '';
}

function esc(s) { return s.replace(/'/g, "\\'"); }

// ======================== ACTIONS ========================
function doOption(name, decision) {
  STATE.optionDecisions[name] = decision;
  const label = decision === 'pickup' ? 'Picked up' : decision === 'exercise' ? 'Exercised' : 'Declined';
  const p = allPlayers.find(p => p.name === name && p.team === STATE.team);
  STATE.moves.push({ action: label, detail: `${name}'s option (${fmtMoney(p?.sal27 || 0)})`, undo: { type: 'option', name } });
  saveState();
  render();
}

function doRenounce(name) {
  STATE.renounced.add(name);
  const p = allPlayers.find(p => p.name === name && p.team === STATE.team);
  STATE.moves.push({ action: 'Renounced', detail: `${name} (freed ${fmtMoney(p?.capHold || 0)} cap hold)`, undo: { type: 'renounce', name } });
  saveState();
  render();
}

function doWaive(name, stretch = false) {
  STATE.waived.add(name);
  if (stretch) STATE.stretched.add(name);
  const p = allPlayers.find(p => p.name === name && p.team === STATE.team);
  let dead = 0;
  if (p?.category === 'under_contract' || p?.st27 === 'GUARANTEED') dead = p.sal27;
  else if (p?.category === 'partial_guaranteed') dead = p.ch27;
  if (stretch && dead > 0) {
    const rem = Math.max(1, (p.end || 2027) - 2026);
    const period = 2 * rem + 1;
    dead = Math.round(dead / period);
  }
  const detail = `${name} (${fmtMoney(p?.sal27 || 0)}${dead ? ', ' + fmtMoney(dead) + ' dead cap' + (stretch ? ' stretched' : '') : ''})`;
  STATE.moves.push({ action: stretch ? 'Waived & Stretched' : 'Waived', detail, undo: { type: 'waive', name } });
  saveState();
  render();
}

function openWaiveModal(name) {
  const p = allPlayers.find(p => p.name === name && p.team === STATE.team);
  if (!p) return;
  const modal = document.getElementById('waiveModal');

  // Calculate dead cap amounts
  let fullDead = 0;
  const wasPickedUp = STATE.optionDecisions[p.name] === 'pickup' || STATE.optionDecisions[p.name] === 'exercise';
  if (p.category === 'under_contract' || p.st27 === 'GUARANTEED' || wasPickedUp) fullDead = p.sal27;
  else if (p.category === 'partial_guaranteed') fullDead = p.ch27;

  const remainingYrs = Math.max(1, (p.end || 2027) - 2026);
  const stretchPeriod = 2 * remainingYrs + 1;
  const stretchedDead = fullDead > 0 ? Math.round(fullDead / stretchPeriod) : 0;
  const canStretch = fullDead > 0 && stretchPeriod > 1;

  let h = `<h3>Waive ${p.name}?</h3>`;
  h += `<div class="player-info"><div class="name">${p.name}</div>`;
  h += `${p.pos || ''} ¬∑ ${fmtMoney(p.sal27)} salary ¬∑ ${p.st27 || 'GUARANTEED'}`;
  if (p.end) h += ` ¬∑ contract thru ${p.end}`;
  h += `</div>`;

  if (p.category === 'non_guaranteed') {
    h += `<div class="waive-option" onclick="closeWaiveModal();doWaive('${esc(p.name)}')">`;
    h += `<div class="opt-title">Waive ‚Äî No dead cap</div>`;
    h += `<div class="opt-desc">Non-guaranteed contract, team owes nothing</div>`;
    h += `<div class="opt-amount" style="color:var(--green)">$0 dead cap</div>`;
    h += `</div>`;
  } else {
    h += `<div class="waive-option" onclick="closeWaiveModal();doWaive('${esc(p.name)}')">`;
    h += `<div class="opt-title">Waive</div>`;
    h += `<div class="opt-desc">Full guaranteed amount hits cap immediately</div>`;
    h += `<div class="opt-amount">${fmtMoney(fullDead)} dead cap in 2026-27</div>`;
    h += `</div>`;
    if (canStretch) {
      h += `<div class="waive-option" onclick="closeWaiveModal();doWaive('${esc(p.name)}', true)">`;
      h += `<div class="opt-title">Waive & Stretch</div>`;
      h += `<div class="opt-desc">Spread dead cap over ${stretchPeriod} years (${remainingYrs} remaining √ó 2 + 1)</div>`;
      h += `<div class="opt-amount">${fmtMoney(stretchedDead)}/yr for ${stretchPeriod} years</div>`;
      h += `</div>`;
    }
  }
  h += `<button class="waive-cancel" onclick="closeWaiveModal()">Cancel</button>`;
  modal.innerHTML = h;
  document.getElementById('waiveOverlay').style.display = 'flex';
}

function closeWaiveModal() {
  document.getElementById('waiveOverlay').style.display = 'none';
}

// ======================== PHASE NAVIGATION ========================
function setPhase(id) {
  const currentIdx = PHASES.findIndex(p => p.id === STATE.phase);
  const targetIdx = PHASES.findIndex(p => p.id === id);
  if (targetIdx <= currentIdx) {
    STATE.phase = id;
    saveState();
    render();
  }
}

function advancePhase() {
  const currentIdx = PHASES.findIndex(p => p.id === STATE.phase);
  if (currentIdx < PHASES.length - 1) {
    // Can't leave lottery without running it
    if (STATE.phase === 'lottery' && !STATE.lotteryResults) {
      alert('Run the lottery first!');
      return;
    }
    STATE.phase = PHASES[currentIdx + 1].id;
    STATE.moves.push({ action: 'Phase', detail: `Advanced to ${PHASES[currentIdx + 1].label}`, undo: { type: 'phase', prev: PHASES[currentIdx].id } });
    saveState();
    render();
  }
}

function undoLast() {
  if (!STATE.moves.length) return;
  const last = STATE.moves.pop();
  if (last.undo) {
    if (last.undo.type === 'option') delete STATE.optionDecisions[last.undo.name];
    if (last.undo.type === 'renounce') STATE.renounced.delete(last.undo.name);
    if (last.undo.type === 'waive') {
      STATE.waived.delete(last.undo.name);
      STATE.stretched.delete(last.undo.name);
    }
    if (last.undo.type === 'draft') {
      if (last.undo.prev) STATE.draftSelections[last.undo.slot] = last.undo.prev;
      else delete STATE.draftSelections[last.undo.slot];
    }
    if (last.undo.type === 'draft_sim') {
      // Remove last draft result and back up pick counter
      const pick = last.undo.pick;
      STATE.draftResults = (STATE.draftResults || []).filter(r => r.pick !== pick);
      delete STATE.draftSelections[pick];
      // Also remove AI picks after user's pick
      STATE.draftResults = STATE.draftResults.filter(r => r.pick < pick);
      STATE.draftCurrentPick = pick;
    }
    if (last.undo.type === 'phase') {
      STATE.phase = last.undo.prev;
    }
    if (last.undo.type === 'trade') {
      STATE.trades.pop();
    }
    if (last.undo.type === 'signing') {
      STATE.signings.pop();
    }
    if (last.undo.type === 'extension') {
      STATE.extensions.pop();
    }
  }
  saveState();
  render();
}

function resetTeam() {
  if (!confirm(`Reset all moves for ${STATE.team}?`)) return;
  localStorage.removeItem('rm_state_' + STATE.team);
  STATE = defaultState(STATE.team);
  render();
}

// ======================== TRADE MACHINE INTEGRATION ========================
let _tradeContext = null; // { playerName } or null for team-level

let _tmUrl = '';
let _tmBaseUrl = '';
let _tmPreloaded = false;

function preloadTradeMachine() {
  if (_tmPreloaded || !STATE) return;
  const abbrev = TEAMS[STATE.team];
  if (!abbrev) return;
  _tmBaseUrl = `${TRADE_MACHINE_URL}/?rm=${abbrev}&t=${abbrev},${getRandomTradePartner(abbrev)}`;
  const iframe = document.getElementById('tmIframe');
  if (iframe) {
    iframe.src = _tmBaseUrl;
    _tmPreloaded = true;
    iframe.onload = function() {
      iframe.dataset.ready = '1';
    };
    console.log('[TM] Preloading Trade Machine');
  }
}

function getRandomTradePartner(excludeAbbrev) {
  const allAbbrevs = Object.values(TEAMS).filter(a => a !== excludeAbbrev);
  return allAbbrevs[Math.floor(Math.random() * allAbbrevs.length)];
}

function openTradeModal(playerName) {
  const abbrev = TEAMS[STATE.team];
  const partner = getRandomTradePartner(abbrev);
  
  // Build Trade Machine URL with RM mode flag + both teams
  _tmUrl = `${TRADE_MACHINE_URL}/?rm=${abbrev}&t=${abbrev},${partner}`;
  
  if (playerName) {
    const p = allPlayers.find(p => p.name === playerName && p.team === STATE.team);
    const playerId = p?.headshot ? (p.headshot.match(/\/(\d+)\.png/)?.[1] || '') : '';
    const pParam = playerId || playerName.replace(/[^a-zA-Z0-9]+/g, '-').replace(/^-|-$/g, '');
    _tmUrl += `&p=${encodeURIComponent(pParam)}&pd=0-`;
  }
  
  const overlay = document.getElementById('tmOverlay');
  const iframe = document.getElementById('tmIframe');
  const loading = document.getElementById('tmLoading');
  const extLink = document.getElementById('tmExternalLink');
  
  extLink.href = _tmUrl;
  
  const iframeReady = iframe.dataset.ready === '1';
  
  if (iframeReady && !playerName) {
    // Team-level open with preloaded iframe ‚Äî show instantly
    loading.style.display = 'none';
    iframe.style.display = 'block';
  } else if (iframeReady && playerName) {
    // Player-specific but iframe already loaded ‚Äî navigate and show immediately
    iframe.style.display = 'block';
    loading.style.display = 'none';
    iframe.src = _tmUrl;
  } else {
    // Not yet loaded ‚Äî show iframe (it may be mid-load from preload) + spinner
    iframe.style.display = 'block';
    loading.style.display = 'flex';
    iframe.onload = function() {
      loading.style.display = 'none';
      iframe.dataset.ready = '1';
    };
    if (iframe.src === 'about:blank' || !iframe.src) {
      iframe.src = _tmUrl;
    }
  }
  
  overlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function tmFallbackNewTab() {
  closeTradeMachine();
  window.open(_tmUrl, '_blank');
}

function closeTradeMachine() {
  const overlay = document.getElementById('tmOverlay');
  // Don't destroy the iframe ‚Äî keep it loaded for next time
  overlay.style.display = 'none';
  document.body.style.overflow = '';
}

// Escape key closes Trade Machine overlay
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('tmOverlay').style.display !== 'none') {
    closeTradeMachine();
  }
});

function closeTradeModal() {
  closeTradeMachine();
}

// Listen for trade data from Trade Machine iframe
window.addEventListener('message', function(event) {
  if (!event.data) return;
  
  // Close message from Trade Machine
  if (event.data.type === 'ROSTER_MANAGER_CLOSE') {
    closeTradeMachine();
    return;
  }
  
  if (event.data.type !== 'ROSTER_MANAGER_TRADE') return;
  if (!STATE) return;
  
  const data = event.data;
  const teamAbbrev = TEAMS[STATE.team];
  
  // Verify this trade is for the current team
  if (data.team !== teamAbbrev) {
    console.warn('[RM] Trade team mismatch:', data.team, 'vs', teamAbbrev);
    return;
  }
  
  // Record the trade
  const trade = {
    out: (data.out || []).map(p => ({ name: p.name, salary: p.salary, pos: p.pos || '', headshot: p.headshot || '' })),
    in: (data.in || []).map(p => ({ name: p.name, salary: p.salary, pos: p.pos || '', headshot: p.headshot || '', fromTeam: p.fromTeam || '' })),
    timestamp: data.timestamp || Date.now()
  };
  
  STATE.trades.push(trade);
  
  const outNames = trade.out.map(p => p.name).join(', ') || 'none';
  const inNames = trade.in.map(p => `${p.name}${p.fromTeam ? ' (' + p.fromTeam + ')' : ''}`).join(', ') || 'none';
  STATE.moves.push({
    action: 'Trade',
    detail: `Sent: ${outNames} ‚Üí Received: ${inNames}`,
    undo: { type: 'trade' }
  });
  
  saveState();
  
  // Close the Trade Machine iframe overlay
  closeTradeMachine();
  
  render();
  
  console.log('[RM] Trade received from Trade Machine:', trade);
});

// ======================== EXTENSION ENGINE ========================
const EXT_CAP = 166000000; // 2026-27 projected salary cap
const EXT_RAISE_PCT = 0.08; // 8% annual raises for extensions

function parseExtCode(code) {
  // Format: RSE:25:5 or VET:30:4
  if (!code) return null;
  const parts = code.split(':');
  if (parts.length < 3) return null;
  const type = parts[0].toUpperCase(); // RSE or VET
  const maxPct = parseInt(parts[1]) || 25;
  const maxYears = parseInt(parts[2]) || 4;
  if (type !== 'RSE' && type !== 'VET') return null;
  return { type, maxPct, maxYears };
}

function calcExtension(maxPct, years, customStartSalary) {
  // Starting salary = cap √ó maxPct (or custom if user adjusts)
  const maxStarting = Math.round(EXT_CAP * (maxPct / 100));
  const startSalary = customStartSalary || maxStarting;
  const breakdown = [];
  let total = 0;
  for (let y = 0; y < years; y++) {
    // 8% raise each year from starting salary (not compounding from prior year in NBA extensions)
    // Actually NBA extensions use 8% of year-1 salary as the raise amount each year
    const raise = Math.round(startSalary * EXT_RAISE_PCT);
    const sal = startSalary + (raise * y);
    breakdown.push({ year: y + 1, salary: sal });
    total += sal;
  }
  return { startSalary, maxStarting, breakdown, total };
}

function openExtModal(playerName) {
  const p = allPlayers.find(p => p.name === playerName && p.team === STATE.team);
  if (!p || !p.extEligible) return;

  const ext = parseExtCode(p.extEligible);
  if (!ext) { alert('Invalid extension code: ' + p.extEligible); return; }

  document.getElementById('extModalTitle').textContent = `Extend ${playerName}`;
  const modal = document.getElementById('extModalBody');

  const maxStarting = Math.round(EXT_CAP * (ext.maxPct / 100));
  const initCalc = calcExtension(ext.maxPct, ext.maxYears);

  // Determine extension start year
  const extStartYear = p.end > 0 ? p.end + 1 : 2027;

  let h = '';

  // Player info
  h += `<div class="ext-player-info">`;
  if (p.headshot) h += `<img src="${p.headshot}" alt="">`;
  h += `<div>`;
  h += `<div class="name">${p.name}`;
  h += `<span class="ext-type-badge ${ext.type.toLowerCase()}">${ext.type === 'RSE' ? 'Rookie Scale' : 'Veteran'}</span>`;
  h += `</div>`;
  h += `<div class="meta">${p.pos || ''} ¬∑ ${p.age || ''} ¬∑ Current: ${fmtMoney(p.sal27 || p.sal26)}/yr ¬∑ Under contract thru ${p.end || '‚Äî'}</div>`;
  h += `</div></div>`;

  // Extension config
  h += `<div class="ext-config">`;

  // Max % info
  h += `<div class="ext-note">üìä Max starting salary: <strong>${ext.maxPct}% of cap</strong> = <strong>${fmtMoneyFull(maxStarting)}</strong> ¬∑ 8% annual raises ¬∑ Up to ${ext.maxYears} years</div>`;

  // Starting salary
  h += `<label>Starting Salary (Year 1)</label>`;
  h += `<div class="row">`;
  h += `<input type="range" id="extSalRange" min="${Math.round(maxStarting * 0.3)}" max="${maxStarting}" step="100000" value="${maxStarting}" oninput="updateExtPreview()">`;
  h += `<span class="sal-display" id="extSalDisplay">${fmtMoneyFull(maxStarting)}</span>`;
  h += `</div>`;
  h += `<div class="row">`;
  h += `<input type="number" id="extSalInput" value="${maxStarting}" min="1000000" max="${maxStarting}" step="100000" style="flex:1" oninput="syncExtSlider()">`;
  h += `</div>`;

  // Years
  h += `<label style="margin-top:.5rem">Extension Length</label>`;
  h += `<div class="row">`;
  h += `<select id="extYears" onchange="updateExtPreview()">`;
  for (let y = 1; y <= ext.maxYears; y++) {
    h += `<option value="${y}" ${y === ext.maxYears ? 'selected' : ''}>${y} year${y > 1 ? 's' : ''} (thru ${extStartYear + y - 1})</option>`;
  }
  h += `</select>`;
  h += `</div>`;
  h += `</div>`;

  // Breakdown placeholder
  h += `<div class="ext-breakdown" id="extBreakdown"></div>`;

  // Note about cap impact
  if (extStartYear > 2027) {
    h += `<div class="ext-note">‚ÑπÔ∏è Extension starts in ${extStartYear}-${String(extStartYear + 1).slice(2)}, after current contract. No impact on 2026-27 cap.</div>`;
  } else {
    h += `<div class="ext-note">‚ö° Extension starts in 2026-27. First-year salary will apply to the cap sheet.</div>`;
  }

  // Confirm
  h += `<button class="ext-confirm-btn" id="extConfirmBtn" onclick="confirmExtension()">‚úÖ Confirm Extension</button>`;
  h += `<button class="waive-cancel" onclick="closeExtModal()">Cancel</button>`;

  modal.innerHTML = h;

  // Store context
  window._extContext = { playerName, ext, extStartYear, maxStarting };

  document.getElementById('extOverlay').style.display = 'flex';

  // Initial breakdown
  updateExtPreview();
}

function closeExtModal() {
  document.getElementById('extOverlay').style.display = 'none';
  window._extContext = null;
}

function syncExtSlider() {
  const val = parseInt(document.getElementById('extSalInput').value) || 0;
  const ctx = window._extContext;
  if (!ctx) return;
  const clamped = Math.max(Math.round(ctx.maxStarting * 0.3), Math.min(val, ctx.maxStarting));
  document.getElementById('extSalRange').value = clamped;
  updateExtPreview();
}

function updateExtPreview() {
  const ctx = window._extContext;
  if (!ctx) return;

  const startSalary = parseInt(document.getElementById('extSalRange').value) || ctx.maxStarting;
  const years = parseInt(document.getElementById('extYears').value) || ctx.ext.maxYears;

  // Sync input field
  document.getElementById('extSalInput').value = startSalary;
  document.getElementById('extSalDisplay').textContent = fmtMoneyFull(startSalary);

  const calc = calcExtension(ctx.ext.maxPct, years, startSalary);

  let h = `<h4>üìã Year-by-Year Breakdown</h4>`;
  for (const yr of calc.breakdown) {
    const season = (ctx.extStartYear + yr.year - 1);
    const seasonLabel = `${season}-${String(season + 1).slice(2)}`;
    h += `<div class="ext-year-row">`;
    h += `<span class="yr">${seasonLabel}</span>`;
    h += `<span class="sal">${fmtMoneyFull(yr.salary)}</span>`;
    h += `</div>`;
  }
  h += `<div class="ext-total-row">`;
  h += `<span>Total Value</span>`;
  h += `<span>${fmtMoneyFull(calc.total)} / ${years}yr</span>`;
  h += `</div>`;

  document.getElementById('extBreakdown').innerHTML = h;
}

function confirmExtension() {
  const ctx = window._extContext;
  if (!ctx) return;

  const startSalary = parseInt(document.getElementById('extSalRange').value) || ctx.maxStarting;
  const years = parseInt(document.getElementById('extYears').value) || ctx.ext.maxYears;
  const calc = calcExtension(ctx.ext.maxPct, years, startSalary);
  const endYear = ctx.extStartYear + years - 1;

  const extension = {
    name: ctx.playerName,
    type: ctx.ext.type,
    maxPct: ctx.ext.maxPct,
    startSalary,
    years,
    endYear,
    extStartYear: ctx.extStartYear,
    breakdown: calc.breakdown,
    total: calc.total,
    timestamp: Date.now()
  };

  STATE.extensions.push(extension);

  STATE.moves.push({
    action: 'Extended',
    detail: `${ctx.playerName} ‚Äî ${years}yr / ${fmtMoney(calc.total)} (${fmtMoney(startSalary)}/yr starting, thru ${endYear})`,
    undo: { type: 'extension' }
  });

  saveState();
  closeExtModal();
  render();
}

// ======================== FREE AGENCY SIGNING ========================
function openSignModal(faName, isResign) {
  const modal = document.getElementById('signModalBody');
  document.getElementById('signModalTitle').textContent = isResign ? `Re-sign ${faName}` : 'Sign Free Agent';

  const cap = calcCapSheet(STATE.team);
  let h = '';

  if (!faName) {
    // Build full FA list
    const alreadySigned = new Set((STATE.signings || []).map(s => s.name));
    const allFAs = allPlayers.filter(p =>
      isProjectedFA(p) && p.team !== STATE.team && !alreadySigned.has(p.name)
    ).sort((a,b) => (b.tv||0) - (a.tv||0));

    h += `<div style="margin-bottom:.5rem">`;
    h += `<input id="signSearchInput" class="trade-input" style="width:100%" placeholder="Filter players..." oninput="filterSignList(this.value)">`;
    h += `</div>`;
    h += `<div id="signSearchResults" style="max-height:300px;overflow-y:auto;margin-bottom:.75rem">`;
    const undrafted = getUndraftedProspects();
    h += buildFAListHTML(allFAs, undrafted);
    h += `</div>`;
    h += `<div id="signExcSection" style="display:none">`;
  } else {
    h += `<div style="padding:.5rem;background:var(--surface);border-radius:6px;margin-bottom:.75rem;font-size:.75rem">`;
    h += `<span style="font-weight:600">${faName}</span>`;
    const p = allPlayers.find(p => p.name === faName);
    if (p) h += ` ¬∑ ${p.pos || ''} ¬∑ was ${fmtMoney(p.sal26)} in 25-26`;
    h += `</div>`;
    h += `<input type="hidden" id="signPlayerName" value="${faName}">`;
    h += `<div id="signExcSection">`;
  }

  // Exception options
  h += `<h4 style="font-size:.75rem;color:var(--muted);margin-bottom:.5rem">Choose Exception</h4>`;
  for (const exc of cap.exceptions) {
    const cls = exc.available ? '' : 'unavailable';
    h += `<div class="sign-exc-option ${cls}" ${exc.available ? `onclick="selectSignException('${esc(exc.name)}', ${exc.amount})"` : ''}>`;
    h += `<div class="exc-name">${exc.name}</div>`;
    h += `<div class="exc-detail">${exc.available ? 'Up to ' + fmtMoney(exc.amount) : 'Not available'}</div>`;
    h += `</div>`;
  }

  if (!faName) h += `</div>`; // close signExcSection
  h += `<div id="signSalarySection" style="display:none">`;
  h += `<div class="sign-salary-input">`;
  h += `<label>Salary:</label>`;
  h += `<input id="signSalaryInput" class="trade-input" type="number" placeholder="Annual salary" style="flex:1">`;
  h += `</div>`;
  h += `<div class="sign-salary-input">`;
  h += `<label>Years:</label>`;
  h += `<input id="signYearsInput" class="trade-input" type="number" placeholder="Contract length" value="1" min="1" max="5" style="flex:1">`;
  h += `</div>`;
  h += `<button class="trade-confirm-btn" onclick="confirmSigning()">‚úÖ Sign Player</button>`;
  h += `</div>`;
  h += `<button class="waive-cancel" onclick="closeSignModal()">Cancel</button>`;

  modal.innerHTML = h;
  document.getElementById('signOverlay').style.display = 'flex';
  window._signContext = { exception: null, maxAmount: 0 };
}

function buildFAListHTML(fas, undrafted) {
  if (!fas.length && !(undrafted && undrafted.length)) return `<div style="font-size:.7rem;color:var(--muted);padding:.5rem;text-align:center">No free agents available</div>`;
  let h = '';
  for (const p of fas) {
    let reason = 'expiring';
    if (p.category === 'team_option') reason = 'TO decline proj.';
    else if (p.category === 'player_option') reason = 'PO decline proj.';
    const ini = p.name.split(' ').map(w => w[0]).join('');
    const hs = p.headshot
      ? `<img src="${p.headshot}" style="width:28px;height:21px;border-radius:3px;object-fit:cover;background:var(--surface)" onerror="this.outerHTML='<span style=\\'display:inline-block;width:28px;text-align:center;font-size:.5rem;color:var(--muted)\\'>${ini}</span>'">`
      : `<span style="display:inline-block;width:28px;text-align:center;font-size:.5rem;color:var(--muted)">${ini}</span>`;
    h += `<div class="draft-pick-option" onclick="selectSignPlayer('${esc(p.name)}')" style="display:flex;align-items:center;gap:.4rem">`;
    h += hs;
    h += `<span class="name" style="flex:1">${p.name}</span>`;
    h += `<span class="assigned" style="font-size:.6rem">${TEAMS[p.team] || p.team} ¬∑ ${p.pos || ''} ¬∑ ${fmtMoney(p.sal26)} ¬∑ ${reason}</span>`;
    h += `</div>`;
  }
  // Undrafted prospects
  if (undrafted && undrafted.length) {
    h += `<div style="padding:.4rem .5rem;font-size:.6rem;font-weight:700;color:var(--orange);border-bottom:1px solid var(--border);margin-top:.3rem">UNDRAFTED FREE AGENTS</div>`;
    for (const name of undrafted) {
      const ini = name.split(' ').map(w => w[0]).join('');
      h += `<div class="draft-pick-option" onclick="selectSignPlayer('${esc(name)}')" style="display:flex;align-items:center;gap:.4rem">`;
      h += `<span style="display:inline-block;width:28px;text-align:center;font-size:.5rem;color:var(--muted)">${ini}</span>`;
      h += `<span class="name" style="flex:1">${name}</span>`;
      h += `<span class="assigned" style="font-size:.6rem">UDFA ¬∑ min salary</span>`;
      h += `</div>`;
    }
  }
  return h;
}

function getUndraftedProspects() {
  if (!STATE.draftResults || !STATE.draftResults.length || STATE.draftCurrentPick <= 60) return [];
  const drafted = getDraftedProspects();
  const alreadySigned = new Set((STATE.signings || []).map(s => s.name));
  return allProspects.filter(n => !drafted.has(n) && !alreadySigned.has(n));
}

function filterSignList(query) {
  const results = document.getElementById('signSearchResults');
  const alreadySigned = new Set((STATE.signings || []).map(s => s.name));
  const q = (query || '').toLowerCase();
  const fas = allPlayers.filter(p =>
    isProjectedFA(p) && p.team !== STATE.team && !alreadySigned.has(p.name) &&
    (!q || p.name.toLowerCase().includes(q) || (TEAMS[p.team]||'').toLowerCase().includes(q) || (p.pos||'').toLowerCase().includes(q))
  ).sort((a,b) => (b.tv||0) - (a.tv||0));
  const undrafted = getUndraftedProspects().filter(n => !q || n.toLowerCase().includes(q));
  results.innerHTML = buildFAListHTML(fas, undrafted);
}

function closeSignModal() {
  document.getElementById('signOverlay').style.display = 'none';
}

function isProjectedFA(p) {
  // Already a free agent (expiring contract)
  if (p.category === 'free_agent' || !p.sal27) return true;
  // Team option: team declines if player's trade value < their salary
  if (p.category === 'team_option' && (p.tv || 0) < (p.sal27 || 0)) return true;
  // Player option: player declines if trade value > salary (they'd get more on open market)
  if (p.category === 'player_option' && (p.tv || 0) > (p.sal27 || 0)) return true;
  return false;
}

function selectSignPlayer(name) {
  document.getElementById('signSearchResults').innerHTML = `<div style="padding:.4rem;background:var(--surface);border-radius:4px;font-size:.75rem"><strong>${name}</strong> selected</div>`;
  // Create hidden input
  let inp = document.getElementById('signPlayerName');
  if (!inp) {
    inp = document.createElement('input');
    inp.type = 'hidden';
    inp.id = 'signPlayerName';
    document.getElementById('signModalBody').appendChild(inp);
  }
  inp.value = name;
  document.getElementById('signExcSection').style.display = '';
}

function selectSignException(excName, maxAmount) {
  window._signContext = { exception: excName, maxAmount };
  document.getElementById('signSalarySection').style.display = '';
  document.getElementById('signSalaryInput').max = maxAmount;
  document.getElementById('signSalaryInput').placeholder = `Up to ${fmtMoney(maxAmount)}`;
  // Pre-fill with full exception amount (user can lower it)
  document.getElementById('signSalaryInput').value = excName === 'Minimum' ? MIN_SALARY_0YOS : maxAmount;
}

function confirmSigning() {
  const nameEl = document.getElementById('signPlayerName');
  if (!nameEl || !nameEl.value) { alert('Select a player first'); return; }
  const name = nameEl.value;
  const salary = parseInt(document.getElementById('signSalaryInput').value) || 0;
  const years = parseInt(document.getElementById('signYearsInput').value) || 1;
  if (!salary) { alert('Enter a salary amount'); return; }
  if (window._signContext.maxAmount && salary > window._signContext.maxAmount) {
    alert(`Salary exceeds ${window._signContext.exception} limit of ${fmtMoney(window._signContext.maxAmount)}`);
    return;
  }

  const p = allPlayers.find(p => p.name === name);
  const signing = {
    name,
    salary,
    years,
    exception: window._signContext.exception || 'FA',
    pos: p?.pos || '',
    headshot: p?.headshot || '',
    end: 2027 + years - 1
  };
  STATE.signings.push(signing);

  // Remove cap hold if this was an own FA
  if (STATE.renounced.has(name)) {
    // Already renounced, no hold to remove
  }

  STATE.moves.push({
    action: 'Signed',
    detail: `${name} for ${fmtMoney(salary)}/yr √ó ${years}yr via ${window._signContext.exception || 'FA'}`,
    undo: { type: 'signing' }
  });
  saveState();
  closeSignModal();
  render();
}

// ======================== DRAFT PICKER ========================
let _draftPickerSlot = null;

function openDraftPicker(slot) {
  _draftPickerSlot = slot;
  const overlay = document.getElementById('draftPickerOverlay');
  overlay.style.display = 'flex';
  document.getElementById('draftPickerTitle').textContent = `Select Prospect ‚Äî Pick #${slot}`;
  const input = overlay.querySelector('.draft-picker-search input');
  input.value = '';
  input.focus();
  renderDraftPickerList('');
}

function closeDraftPicker() {
  document.getElementById('draftPickerOverlay').style.display = 'none';
  _draftPickerSlot = null;
}

function renderDraftPickerList(filter) {
  const list = document.getElementById('draftPickerList');
  const slot = _draftPickerSlot;
  const teamAbbrev = TEAMS[STATE.team];
  const currentPick = (STATE.draftSelections && STATE.draftSelections[slot]) ||
    (allPickSlots[slot] ? allPickSlots[slot].defaultProspect : '');
  const filterLower = filter.toLowerCase();

  // Build set of prospects already selected by THIS team (other picks)
  const teamPicks = teamDraftPicks[teamAbbrev] || [];
  const takenByTeam = new Set();
  for (const tp of teamPicks) {
    if (tp.draftRnk === slot) continue;
    const sel = (STATE.draftSelections && STATE.draftSelections[tp.draftRnk]) || tp.prospect;
    takenByTeam.add(sel);
  }

  let h = '';
  const filtered = allProspects.filter(name =>
    name.toLowerCase().includes(filterLower)
  );

  for (let i = 0; i < filtered.length; i++) {
    const name = filtered[i];
    const isCurrent = name === currentPick;
    const isTaken = takenByTeam.has(name);
    // Find which team has this prospect as default
    let assignedTo = '';
    for (const [s, info] of Object.entries(allPickSlots)) {
      if (info.defaultProspect === name && info.team !== teamAbbrev) {
        assignedTo = `#${s} ${info.team}`;
        break;
      }
    }

    h += `<div class="draft-pick-option${isCurrent ? ' current' : ''}${isTaken ? ' taken' : ''}" `;
    if (!isTaken) h += `onclick="selectDraftProspect('${esc(name)}')"`;
    h += `>`;
    h += `<span class="rank">${i + 1}</span>`;
    h += `<span class="name">${name}</span>`;
    if (isCurrent) h += `<span class="assigned" style="color:var(--orange)">current</span>`;
    else if (assignedTo) h += `<span class="assigned">proj ${assignedTo}</span>`;
    h += `</div>`;
  }

  if (!filtered.length) h = '<div style="padding:1rem;text-align:center;color:var(--muted);font-size:.75rem">No prospects found</div>';
  list.innerHTML = h;
}

function selectDraftProspect(name) {
  const slot = _draftPickerSlot;
  if (!slot) return;
  const prev = STATE.draftSelections[slot] || null;
  STATE.draftSelections[slot] = name;
  const defaultName = allPickSlots[slot] ? allPickSlots[slot].defaultProspect : 'TBD';
  STATE.moves.push({
    action: 'Draft',
    detail: `Pick #${slot}: ${name}${name !== defaultName ? ' (was ' + defaultName + ')' : ''}`,
    undo: { type: 'draft', slot, prev }
  });
  saveState();
  closeDraftPicker();
  render();
}

function resetDraftPick(slot) {
  const prev = STATE.draftSelections[slot] || null;
  delete STATE.draftSelections[slot];
  const defaultName = allPickSlots[slot] ? allPickSlots[slot].defaultProspect : 'TBD';
  STATE.moves.push({
    action: 'Draft Reset',
    detail: `Pick #${slot}: back to ${defaultName}`,
    undo: { type: 'draft', slot, prev }
  });
  saveState();
  render();
}

// ======================== INIT ========================
async function init() {
  document.getElementById('loadingState').style.display = 'block';
  renderTeamDropdown();

  const [csv] = await Promise.all([fetchData(), fetchDraftPicks(), fetchContracts(), fetchTradeValues()]);
  if (!csv) {
    document.getElementById('loadingState').innerHTML = '<p style="color:var(--red)">Failed to load data. Try refreshing.</p>';
    const lb = document.getElementById('landingBody');
    if (lb) lb.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--red)">Failed to load data. Try refreshing.</div>';
    return;
  }

  allPlayers = parseAllPlayers(csv);
  document.getElementById('loadingState').style.display = 'none';
  renderTeamDropdown();
  renderLandingPage();

  // Hard refresh = clean slate: clear all saved state
  for (const key of Object.keys(localStorage)) {
    if (key.startsWith('rm_state_') || key === 'rm_last_team') localStorage.removeItem(key);
  }
}

function renderLandingPage() {
  const body = document.getElementById('landingBody');
  if (!body) return;

  const EAST = ['Atlanta','Boston','Brooklyn','Charlotte','Chicago','Cleveland','Detroit','Indiana','Miami','Milwaukee','New York','Orlando','Philadelphia','Toronto','Washington'];
  const WEST = ['Dallas','Denver','Golden State','Houston','LA Clippers','LA Lakers','Memphis','Minnesota','New Orleans','Oklahoma City','Phoenix','Portland','Sacramento','San Antonio','Utah'];

  function buildGrid(teams) {
    let h = '<div class="team-grid">';
    for (const full of teams) {
      const abbr = TEAMS[full] || full;
      const logo = teamLogos[full] || '';
      h += `<div class="team-card" onclick="pickTeamFromLanding('${full.replace(/'/g,"\\'")}')">`;
      if (logo) {
        h += `<img src="${logo}" alt="${abbr}">`;
      } else {
        h += `<div style="width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:var(--surface);border-radius:50%;font-size:1rem;font-weight:700;color:var(--accent)">${abbr}</div>`;
      }
      h += `<div class="tc-abbr">${abbr}</div>`;
      h += `<div class="tc-name">${full}</div>`;
      h += `</div>`;
    }
    h += '</div>';
    return h;
  }

  let h = '';
  h += `<div class="conf-label east">Eastern Conference</div>`;
  h += buildGrid(EAST);
  h += `<div class="conf-label west">Western Conference</div>`;
  h += buildGrid(WEST);
  body.innerHTML = h;
}

function pickTeamFromLanding(team) {
  const landing = document.getElementById('landingPage');
  if (landing) {
    landing.style.transition = 'opacity .3s ease';
    landing.style.opacity = '0';
    setTimeout(() => { landing.style.display = 'none'; }, 300);
  }
  selectTeam(team);
}

// Override selectTeam to also save last team and hide landing
const _selectTeam = selectTeam;
selectTeam = function(team) {
  localStorage.setItem('rm_last_team', team);
  const landing = document.getElementById('landingPage');
  if (landing && landing.style.display !== 'none') {
    landing.style.transition = 'opacity .3s ease';
    landing.style.opacity = '0';
    setTimeout(() => { landing.style.display = 'none'; }, 300);
  }
  _selectTeam(team);
  // Preload Trade Machine in background after a short delay
  _tmPreloaded = false; // Reset for new team
  setTimeout(preloadTradeMachine, 500);
};

init();
</script>
</body>
</html>
